webpackJsonp([40],{1260:function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function i(e,t,n){return t&&s(e.prototype,t),n&&s(e,n),e}n.d(t,"a",(function(){return u}));var a=n(351),r=n(138),c=(n.n(r),n(139)),u=(n.n(c),(function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1?arguments[1]:void 0;o(this,e),this.newMessageId=void 0,this.params=t,this.data=n,this.mSettings=ns.Model.get("settings")}return i(e,[{key:"getParams",value:function(){return this.params}},{key:"getMessageType",value:function(){return Daria.UA.isMobile&&Daria.UA.isTouch?"html":Daria.UA.isMobile?"plain":this.mSettings.isSet("enable_richedit")||Daria.isReactiveCompose()?"html":this.mMessageBody?this.mMessageBody.getSubtype():"plain"}},{key:"getFromName",value:function(){return this.mSettings.getSetting("from_name")}},{key:"getFromEmail",value:function(){return this.mMessage&&this.mMessage.getToEmail()||this.mSettings.getSetting("default_email")}},{key:"getAvailableFromEmails",value:function(){return ns.Model.get("account-information").getFromEmails()}},{key:"_getForwardMarkIds",value:function(){return this.mMessage?this.mMessage.isThread()&&1===this.mMessage.get(".count")?[this.mMessage.get(".last_mid")]:this.mMessage.isThread()?[]:[this.mMessage.get(".mid")]:[]}},{key:"isForward",value:function(){return Boolean("forward"===this.params.oper)}},{key:"isTemplate",value:function(){return!(!this.mMessage||!this.mMessage.isTemplate())||!(!this.data||this.data.save_symbol!==c.WellKnownFolderSymbol.TEMPLATE)}},{key:"isDraft",value:function(){return!this.isTemplate()&&(!(!this.data||"no"!==this.data.ign_overwrite||!this.data.overwrite)||!!(this.mMessage&&this.mMessageBody&&this.mMessage.isDraftLike()))}},{key:"isReplyAll",value:function(){return Boolean(this.mMessageBody&&"reply-all"===this.params.oper)}},{key:"isReply",value:function(){return Boolean(this.mMessageBody&&"reply"===this.params.oper)}},{key:"isReplyAny",value:function(){return this.isReply()||this.isReplyAll()}},{key:"getForwardData",value:function(){var e=this.getMessageType(),t=this.getFromEmail(),n=this.mMessage?this.mMessage.getFolderId():null,o=this.mMessageBody?this.mMessageBody.getForwardBody(e,t):Daria.signs.appendToBody("",e,!0),s=this.mMessageBody?this.mMessageBody.getMessageId():null;return{ttype:e,from_mailbox:t,from_name:this.getFromName(),cc:"",bcc:"",subj:"Fwd: "+this.messageSubject,send:o,inreplyto:s,current_folder:n,overwrite:this.params.ids,ign_overwrite:"yes",references:"",mark_ids:this._getForwardMarkIds(),mark_as:"forwarded",message_id:this.newMessageId}}},{key:"getDraftData",value:function(){var e=this.getMessageType(),t=this.mMessage.isTemplate()?c.WellKnownFolderSymbol.TEMPLATE:c.WellKnownFolderSymbol.DRAFT,n=_.clone(this.mMessage.get(".lid")),o=this.mMessage.getDelayedTime(),s=this.isTemplate()?this.newMessageId:this.mMessage.get(".message_id");if(!o){var i=ns.Model.get("labels").getDelayedMessageLabel();i&&(n=_.pull(n,i.lid))}return{overwrite:this.params.ids,ign_overwrite:"no",save_symbol:t,to:this.mMessageBody.getAddressField("to"),cc:this.mMessageBody.getAddressField("cc"),bcc:this.mMessageBody.getAddressField("bcc"),phone:this.mMessageBody.getAddressField("phone"),lids:n,from_name:this.mMessage.getFromName(),from_mailbox:this.mMessage.getFromEmail(),subj:this.messageSubjectWithPrefix,send:this.mMessageBody.getDraftBody(e),ttype:e,inreplyto:this.mMessageBody.getInReplyTo(),references:this.mMessageBody.getReferences(),current_folder:this.mMessage.getFolderId(),send_time:o,message_id:s}}},{key:"getTemplateData",value:function(){if(this.mMessage&&this.mMessageBody)return this.draftMessageData;var e=this.defaultMessageData;return e.save_symbol=c.WellKnownFolderSymbol.TEMPLATE,e}},{key:"getReplyData",value:function(){var e=this.getMessageType(),t=this.mMessageBody.getRecipients(this.isReplyAll()),n=this.mMessageBody.getMessageId(),o=this.mMessageBody.getReferences(),s=this.mMessageBody.getInReplyTo(),i=this.mMessageBody.getInfo("delivered-to")[0],a=this.fromEmail,r=this.params.isQuickReply?"":this.sendMessageData;return{from:{receiver:i},from_mailbox:a,from_name:this.getFromName(),overwrite:this.params.ids,ign_overwrite:"yes",mark_as:"replied",mark_ids:[this.params.ids],to:t.to,cc:t.cc,bcc:"",subj:"Re: "+this.messageSubject,send:r,ttype:e,inreplyto:n,references:_.trim((o||s||"")+" "+n),message_id:this.newMessageId}}},{key:"getSendMessage",value:function(){return(this.data&&this.data.qrText||"")+this.getReplyBody()}},{key:"getReplyBody",value:function(){var e=this.getMessageType(),t=this.fromEmail;return this.mMessageBody.getReplyBody(e,t)}},{key:"getDefaultData",value:function(){var e=this.getFromEmail()||ns.Model.get("account-information").getFromDefaultEmail(),t=this.getFromName(),n=this.getMessageType(),o=this.data&&this.data.send||"";return Object(r.isEmpty)(o)||"html"!==this.getMessageType()||(o="<div>".concat(o,"</div>")),{from_mailbox:e,from_name:t,ttype:n,send:Daria.signs.appendToBody(o,n,!0),message_id:this.newMessageId}}},{key:"getComposeMessageData",value:function(){return this.isDraft()?this.draftMessageData:this.isTemplate()?this.templateMessageData:this.isReplyAny()?this.replyMessageData:this.isForward()?this.forwardMessageData:this.defaultMessageData}},{key:"isPredefinedDataEmpty",value:function(){var e=Object(a.toJS)(this.data);return!e||0===Object.keys(e).length}},{key:"getRelatedThreadId",value:function(){return this.mMessage?this.mMessage.getThreadId():""}},{key:"isNewMessage",value:function(){return!this.isDraft()&&!this.isReplyAny()&&!this.isForward()}},{key:"isNewTemplate",value:function(){var e=this.data&&this.data.overwrite||this.mMessage&&this.mMessage.isDraftLike();return this.isTemplate()&&!e}},{key:"hasMessage",get:function(){return this.params.ids&&!this.params.tids}},{key:"mMessage",get:function(){return this.hasMessage?ns.Model.getValid("message",{ids:this.params.ids}):null}},{key:"mThread",get:function(){return this.hasMessage?null:ns.Model.getValid("message",{ids:this.params.tids})}},{key:"mMessageBody",get:function(){if(!this.hasMessage)return null;var e=ns.Model.infoLite("message-body").calculateParamsForMessageBody(this.params);return ns.Model.getValid("message-body",e)}},{key:"fromName",get:function(){return this.getFromName()}},{key:"fromEmail",get:function(){return this.getFromEmail()}},{key:"fromEmails",get:function(){return this.getAvailableFromEmails()}},{key:"forwardMessageData",get:function(){return this.getForwardData()}},{key:"messageSubject",get:function(){var e=this.mMessage||this.mThread;return e?e.getSubject(!0):""}},{key:"messageSubjectWithPrefix",get:function(){var e=this.mMessage||this.mThread;return e?e.getSubject():""}},{key:"draftMessageData",get:function(){return this.getDraftData()}},{key:"templateMessageData",get:function(){return this.getTemplateData()}},{key:"replyMessageData",get:function(){return this.getReplyData()}},{key:"sendMessageData",get:function(){return this.getSendMessage()}},{key:"defaultMessageData",get:function(){return this.getDefaultData()}},{key:"messageData",get:function(){return this.getComposeMessageData()}},{key:"relatedThreadId",get:function(){return this.getRelatedThreadId()}}]),e})())},1261:function(e,t,n){"use strict";function o(e){switch(e){case a.e.STATUS_DISK_FULL:return a.e.DISK_FULL;case a.e.DISK_TECHNICAL_WORK:return a.e.DISK_TECHNICAL_WORK;case a.e.DISK_TRAFFIC_LIMIT:return a.e.DISK_TRAFFIC_LIMIT;default:return a.e.UNKNOWN}}function s(e,t){if(e===a.e.DISK_TRAFFIC_LIMIT&&t&&t.error&&t.error.limit)return{limit:t.error.limit}}function i(e,t,n){var o=n.onError,s=n.onSuccess,i=t&&t.upload_url,u=t&&t.oid;if(!i||!u)return o({info:{errorType:"upload.disk.no_url_or_oid"},additionalInfo:t&&JSON.stringify(t),status:a.c.FAILED}),void Object(r.a)(e.file,{handlerName:c,isOk:!1});e.narod={oid:u,url:i},Object(r.a)(e.file,{handlerName:c,isOk:!0}),e.file&&s()}var a=n(369),r=n(789),c="do-attach-file-store";t.a=function(e,t){var n=t.onError,u=t.onSuccess,l={file:e.name,size:e.file&&e.file.size,checkLimit:!0};return ns.forcedRequest(c,l).then((function(t){return i(e,t[0].getData(),{onError:n,onSuccess:u})}),(function(t){var i=t&&t.invalid&&t.invalid[0]||{},u=i.error&&i.error.code,l=o(u);Object(r.a)(e.file,{handlerName:c,isOk:!1,errorCode:u}),n({info:{errorType:"fail-do-attach-file-store"},status:a.c.FAILED,errorCode:l,additionalInfo:s(u,i)})}))}},1262:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n.d(t,"LOCAL",(function(){return o})),n.d(t,"DISK",(function(){return s}));var o="local",s="disk"},1263:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n.d(t,"MB_SIZE",(function(){return o})),n.d(t,"GB_SIZE",(function(){return s})),n.d(t,"HAS_DISK",(function(){return i})),n.d(t,"MAX_TOTAL_ATTACHMENTS_SIZE",(function(){return a})),n.d(t,"MAX_SIZE_FOR_SINGLE_FILE",(function(){return r})),n.d(t,"IS_CORP",(function(){return c}));var o=1048576,s=1024*o,i=!Daria.IS_CORP&&-1!==Daria.SIDS.indexOf("59"),a=Daria.IS_CORP?40*o:24*o,r=i?2*s:a,c=Daria.IS_CORP},1264:function(e,t,n){"use strict";var o=n(369),s=n(789),i=n(790);t.a=function(e,t){var n=e.file,a=e.narod,r=t.onError,c=t.onUploadProgress,u=t.onUploadComplete,l=new FormData;l.append("file",n);var d=new XMLHttpRequest;return d.open("POST",a.url,!0),Object(i.a)(d,c),d.onreadystatechange=function(){4===this.readyState&&(this.status>=200&&this.status<300?u(this):(r({info:{errorType:"upload.disk.xhr_fail",status:this.status},additionalInfo:this.responseText,status:o.c.FAILED,errorCode:this.status===o.e.STATUS_DISK_FULL?o.e.DISK_FULL:o.e.UNKNOWN}),Object(s.a)(n,{handlerName:"diskUploadXhr",isOk:!1,errorCode:this.status})))},d.send(l),d}},1265:function(e,t,n){"use strict";function o(e,t,n){var o=n.onError,r=n.onUploadProgress,c=n.onUploadComplete,u=t[0].getData(),d=u.operation;if(!d)return void o({info:{errorType:"upload.disk.no_operation"},status:l.c.FAILED,errorCode:l.e.YADISK_ERROR});var h=d.status;switch(h){case"EXECUTING":case"WAITING":r(s(d));break;case"FAILED":o(i(d));break;case"DONE":return a(e,d,{onError:o,onUploadComplete:c});default:o({info:{errorType:"unknown_disk_status",status:h},additionalInfo:JSON.stringify(u)})}}function s(e){var t=e&&e.stages&&e.stages.stage||[],n=t.filter((function(e){return e&&"kladun_upload"===e.name}))[0],o=n&&n.progress;return void 0===o||100===Number(o)?100:o}function i(e){var t=Number(e&&e.error&&e.error.code);return t===l.e.VIRUS?{info:{errorType:"upload.disk.virus"},status:l.c.VIRUS,errorCode:l.e.VIRUS}:t===l.e.DISK_FULL?{info:{errorType:"upload.disk.quota_limit"},status:l.c.FAILED,errorCode:l.e.DISK_FULL}:{info:{errorType:"upload.disk.failed"},status:l.c.FAILED,errorCode:l.e.YADISK_ERROR}}function a(e,t,n){var o=n.onError,s=n.onUploadComplete,i=t.file;if(i)return r(e,i,{onError:o,onUploadComplete:s});o({info:{errorType:"upload.disk.no_fileinfo"},status:l.c.FAILED,errorCode:l.e.YADISK_ERROR})}function r(e,t,n){var o=n.onError,s=n.onUploadComplete;return e.narodUrl=t.meta&&t.meta.short_url,e.size=t.size,e.hash=t.meta&&t.meta.public_hash,c(t).then((function(t){e.narodPreview=t,u(e,{onError:o,onUploadComplete:s})}))}function c(e){var t=e&&e.meta||{},n=t.preview,o=t.public_hash;return n&&o?ns.Model.get("disk-resources").getPreview(o).always((function(e){return e})):Promise.resolve(n)}function u(e,t){var n=t.onError,o=t.onUploadComplete;delete e.narod,e.narodUrl&&e.size?o():n({info:{errorType:"upload.disk.no_size_or_nourl",disk_url:e.narodUrl,disk_size:e.size},status:l.c.FAILED,errorCode:l.e.YADISK_ERROR})}var l=n(369);t.a=function(e,t){var n=t.onError,s=t.onUploadProgress,i=t.onUploadComplete;if(e&&e.narod)return ns.forcedRequest("do-attach-file-status",{oid:e.narod.oid}).then((function(t){return o(e,t,{onError:n,onUploadProgress:s,onUploadComplete:i})}),(function(){return n({info:{errorType:"fail-do-attach-file-status"},status:l.c.FAILED})}))}},1266:function(e,t,n){"use strict";function o(e,t){s(e),e.getProgressTimer=setInterval(t,1500)}function s(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};clearInterval(e.getProgressTimer)}t.a=o,t.b=s},1267:function(e,t,n){"use strict";var o=n(790);t.a=function(e,t){var n=e.name,s=e.file,i=t.uploadUrl,a=t.onUploadProgress,r=t.onUploadComplete,c=new FormData;c.append("Filename",n);var u=new XMLHttpRequest;return u.open("POST",i,!0),Object(o.a)(u,a),u.onreadystatechange=function(){4===this.readyState&&r(this)},c.append("attachment",s,n),a(0),u.send(c),u}},1268:function(e,t,n){"use strict";var o=n(369);t.a=function(e,t){var n=e.info,s=e.previewSupported,i=e.xhr,a=t.onError,r=t.onSuccess,c=t.onAuthFail,u=i.responseText,l={};if(u)try{l=JSON.parse(u)}catch(e){return void a({info:{errorType:"simpleUpload.json_parse",xhr_status:i.status,xhr_readystate:i.readyState,xml_length:u?u.length:0},additionalInfo:u,status:o.c.FAILED,errorCode:o.e.UNKNOWN})}var d=l.write_attachment;d||!l.error||"AUTH_NO_AUTH"!==l.error.code&&"AUTH_WRONG_GUARD"!==l.error.code||c();var h=d&&d.id,p=d&&d.downloadUrl;if(!h||!p)return void a({info:{errorType:"simpleUpload",xhr_status:i.status,xhr_readystate:i.readyState,xml_length:u?u.length:0},additionalInfo:u,status:o.c.FAILED,errorCode:o.e.UNKNOWN});n.att_id=h,n.url=p.replace("http://","//");var f=d&&d.previewUrl;s&&f&&(n.previewHref=n.url+"&no_disposition=y",n.previewSrc=f.replace("http://","//")+"&no_disposition=y"),r()}},1269:function(e,t,n){"use strict";function o(e){return Daria.utils.getDiskParams(e)}var s=n(369);t.a=function(e,t){switch(e.type){case s.d.FILE:return{att_id:e.att_id,hid:e.hid,from_template:e.from_template,template_hid:e.template_hid,template_mid:e.template_mid};case s.d.YADISK:return{disk:t===s.c.COMPLETED?o(e):""}}}},1270:function(e,t,n){"use strict";function o(e,t){return e.narodUrl=t.url,e.hash=t.hash,e.narodPreview?ns.Model.get("disk-resources").getPreview(t.hash).always((function(t){return e.narodPreview=t})):Promise.resolve()}function s(e){var t=Object(a.a)(100),n=0;return setInterval((function(){return e(t(n++))}),100)}function i(e){clearInterval(e)}var a=n(901);t.a=function(e,t){var n=t.onFail,a=t.onSuccess,r=t.onUploadProgress,c=s(r);return ns.Model.get("disk-resources").attach(e.diskSrcPath,e.name).then((function(t){return o(e,t)})).then((function(){return a()})).fail((function(){return n()})).always((function(){return i(c)}))}},1272:function(e,t,n){"use strict";var o=n(138),s=(n.n(o),n(369));t.a=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,n={stid:t.getSTID(),mid:t.params.ids,bid:e.bid,hid:e.hid,name:Object(o.unescape)(e.name),"browser-supports":e["browser-supports"],from_template:e.from_template,template_hid:e.template_hid,template_mid:e.template_mid};return e.narod?(n.narodUrl=e.unsafeUrl,n.size=e.size,n.type=s.d.YADISK,n.folder=Boolean(e.folder),n.narodPreview=e.preview):(n.size=e.length,n.type=s.d.FILE,n.class=e.class,n.message=Boolean(e.message),n.external_transformer=e.external_transformer,n.external_transformer_filetype=e.external_transformer_filetype),n}},1273:function(e,t,n){"use strict";var o=n(369);t.a=function(e){return e.type===o.d.YADISK?Boolean(e.narodPreview):Boolean(e.extension.preview)||"audio"===e.class&&"mp3"===e.extension.icon}},1278:function(e,t,n){"use strict";var o=n(369),s=n(500);t.a=function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.meta,i=n&&n.mediatype||"unknown";"image"===i&&(e=n&&n.preview);var a,r=t.type===s.d;return a=r?n&&n.group&&n.group.size:n&&n.size,{name:t.name,type:o.d.YADISK,size:a,narodPreview:e,folder:r,mediaType:i,diskSrcPath:t.id}}},1279:function(e,t,n){"use strict";var o=n(369),s=n(529),i=function(e){return e.map((function(e){return Object(s.a)(e.info)||0})).reduce((function(e,t){return e+t}),0)};t.a=function(e){var t=e.filter((function(e){return e.info.type===o.d.FILE})),n=e.filter((function(e){return e.info.type===o.d.YADISK})),s=e.filter((function(e){return e.info.type===o.d.FORWARDED_MAIL})).map((function(e){return e.info.mid}));return{hasAttachments:e.length>0,fileAttachmentsCount:t.length,fileAttachmentsSize:i(t),diskAttachmentsCount:n.length,diskAttachmentsSize:i(n),forwardedMailsAttachmentsCount:s.length,relatedMailIds:s}}},1280:function(e,t,n){"use strict";var o=n(369),s=n(680);t.a=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2?arguments[2]:void 0;if(e.type===o.d.YADISK)return!1;var i;return e.att_id?i=t.filter((function(t){return t.att_id===e.att_id}))[0]:e.hid&&(i=t.filter((function(t){return t.old_hid===e.hid}))[0]),!!i&&(e.from_template=void 0,e.template_hid=void 0,e.template_mid=void 0,e.att_id=void 0,e.url=void 0,e.hid=i.hid,e.mid=n,e.id=Object(s.a)(e),t.splice(t.indexOf(i),1),!0)}},1281:function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function i(e,t,n){return t&&s(e.prototype,t),n&&s(e,n),e}n.d(t,"a",(function(){return a}));var a=(function(){function e(t,n){var s=this;o(this,e),this.isOn=!1,this.wasPageHidden=!1,this.prevTime=null,this.fpsLevels=[],this.counters={},this._onPageVisibilityChanged=function(e,t){s.wasPageHidden=s.wasPageHidden||!t.value},this.area=t,this.fpsLevels=Object.keys(n).map((function(e){return{key:e,value:n[e]}})).sort((function(e,t){return e.value-t.value})),this._resetCounters()}return i(e,[{key:"_hasPerformance",value:function(){return Boolean(window.performance&&window.performance.now)}},{key:"_resetCounters",value:function(){var e=this;this.counters={total:0},this.fpsLevels.forEach((function(t){return e.counters[t.key]=0}))}},{key:"processFrame",value:function(){var e=performance.now();if(this.prevTime&&!this.wasPageHidden){var t=e-this.prevTime,n=Math.round(1e3/t),o="";if(this.fpsLevels.some((function(e){return o=e.key,e.value>=n}))&&this.counters.hasOwnProperty(o)){var s=Math.floor(t/(1e3/30));this.counters[o]+=s}this.counters.total++}this.prevTime=e,this.wasPageHidden=!1}},{key:"start",value:function(){var e=this;this.stop(),this._resetCounters(),this.isOn=this._hasPerformance(),this.prevTime=null;!(function t(){e.isOn&&(e.processFrame(),requestAnimationFrame(t))})(),ns.events.on("pageVisible.change",this._onPageVisibilityChanged)}},{key:"stop",value:function(){this.isOn=!1,ns.events.off("pageVisible.change",this._onPageVisibilityChanged)}},{key:"logCounters",value:function(){this._hasPerformance()&&Daria.monitoring.performance.fps(this.area,this.counters)}},{key:"finish",value:function(){this.stop(),this.logCounters()}}]),e})();a.defaultConfig={slow:30,freeze:5}},1313:function(e,t){},1314:function(e,t,n){"use strict";var o=n(1315);n.d(t,"a",(function(){return o.a}))},1315:function(e,t,n){"use strict";function o(){return o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},o.apply(this,arguments)}function s(e){"@babel/helpers - typeof";return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(e,t){if(null==e)return{};var n,o,s=a(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(s[n]=e[n])}return s}function a(e,t){if(null==e)return{};var n,o,s={},i=Object.keys(e);for(o=0;o<i.length;o++)n=i[o],t.indexOf(n)>=0||(s[n]=e[n]);return s}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function c(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function u(e,t,n){return t&&c(e.prototype,t),n&&c(e,n),e}function l(e,t){return!t||"object"!==s(t)&&"function"!=typeof t?d(e):t}function d(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function h(e){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function m(e,t,n,o){y||(y="function"==typeof Symbol&&Symbol.for&&Symbol.for("react.element")||60103);var s=e&&e.defaultProps,i=arguments.length-3;if(t||0===i||(t={children:void 0}),1===i)t.children=o;else if(i>1){for(var a=new Array(i),r=0;r<i;r++)a[r]=arguments[r+3];t.children=a}if(t&&s)for(var c in s)void 0===t[c]&&(t[c]=s[c]);else t||(t=s||{});return{$$typeof:y,type:e,key:void 0===n?null:""+n,ref:null,props:t,_owner:null}}n.d(t,"a",(function(){return V}));var g,b,_,v,y,C=n(137),S=n.n(C),D=n(348),E=n.n(D),w=n(350),M=n.n(w),k=n(351),A=n(353),T=n(801),F=n.n(T),O=n(1316),I=n(659),P=n(487),N=n(1317),B=n(382),R=n(1318),x=(n.n(R),function(){return Jane.Services.runModules(["disk-resources.js","disk-resources.css"]).then((function(){return Daria.React.DiskResourcesContainer}))}),L=m("div",{className:"diskResources-Placeholder"},void 0,m(P.default,{size:"m"})),V=(g=Object(A.inject)("services"))(b=Object(A.observer)((v=_=(function(e){function t(){var e,n;r(this,t);for(var o=arguments.length,s=new Array(o),i=0;i<o;i++)s[i]=arguments[i];return n=l(this,(e=h(t)).call.apply(e,[this].concat(s))),n._disposer=new B.a,n._shortcutsConnected=!1,n}return p(t,e),u(t,[{key:"_renderPlaceholder",value:function(){return L}},{key:"componentDidMount",value:function(){var e=this;this._togglePageInteraction(this.props.isVisible),this._disposer.add(this,Object(k.reaction)((function(){return e.props.isVisible}),(function(t){return e._togglePageInteraction(t)})))}},{key:"componentWillUnmount",value:function(){this.props.isVisible&&this._togglePageInteraction(!1),this._disposer.dispose(this)}},{key:"_togglePageInteraction",value:function(e){Object(N.a)(e),this.toggleSelectionOutside(!e),this.toggleShortcuts(e)}},{key:"toggleSelectionOutside",value:function(e){document.body.onselectstart=function(){return e}}},{key:"toggleShortcuts",value:function(e){if(e){$.Shortcuts.modalListPush("disk-resources")&&(this._shortcutsConnected=!0)}else this._shortcutsConnected&&($.Shortcuts.modalListPop("disk-resources"),this._shortcutsConnected=!1)}},{key:"render",value:function(){var e=this.props,t=e.isVisible,n=e.onClose,s=i(e,["isVisible","onClose"]),a=this.props.services.settings.isMobile;s.isMobile=a;var r=M()("diskResources",a?"diskResources_mobile":"diskResources_desktop");return m(F.a,{cls:r,visible:t,fullscreen:!0,onClose:n},void 0,m("div",{className:"diskResources-Content"},void 0,S.a.createElement(I.a,o({},s,{loader:x,renderPlaceholder:this._renderPlaceholder}))))}}]),t})(S.a.Component),_.displayName="DiskResources",_.propTypes={isVisible:E.a.bool,services:O.a.isRequired,scope:E.a.instanceOf(Element),onClose:E.a.func},b=v))||b)||b},1316:function(e,t,n){"use strict";var o=n(348),s=n.n(o);t.a=s.a.shape({settings:s.a.shape({isMobile:s.a.bool})})},1317:function(e,t,n){"use strict";t.a=function(e){Daria.toggleVerticalScrollBar(e),Daria.toggleHorizontalScrollBar(e)}},1318:function(e,t){},1320:function(e,t,n){function o(e){return"string"!=typeof e?[]:e.split(d).filter((function(e){return Boolean(e)}))}function s(e){new(this||Daria.BaseBubble)(e).applyTo(e)}function i(e){return _.unescape(e.getAttribute("data-yabble-value"))||e.innerText}function a(e){var t=this||Daria.BaseBubble,n=t.toString(e),o=n.indexOf('"');o=-1!==o?o+1:0;var s=n.lastIndexOf('"');return s=s>o?s:n.length,{text:n,startOffset:o,endOffset:s}}function r(e){var t=Daria.Constants.CONTACTS.DELIMITER,n=this||Daria.BaseBubble;return e.map(n.toString,n).join(t)}function c(){return!0}function u(e){var t=this||Daria.BaseBubble;return Array.isArray(e)&&e.every((function(e){return e.className.split(" ").indexOf(t.BUBBLE_CLASS)>-1}))}var l=n(904).SEPARATORS,d=new RegExp("["+Object.keys(l).join("")+"]","g"),h={tokenizer:o,update:s,node2object:a,getCopyString:r,checkPaste:c,checkDrop:u,toString:i};e.exports=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(t){var n=Object.assign({},h,e);return Object.keys(n).forEach((function(e){t[e]=n[e].bind(t)})),t}}},1856:function(e,t,n){"use strict";var o=n(4050);t.a={DEBOUNCES:o.a}},1857:function(e,t,n){"use strict";function o(e,t,n,o,s,i,a){try{var r=e[i](a),c=r.value}catch(e){return void n(e)}r.done?t(c):Promise.resolve(c).then(o,s)}function s(e){return function(){var t=this,n=arguments;return new Promise(function(s,i){function a(e){o(c,s,i,a,r,"next",e)}function r(e){o(c,s,i,a,r,"throw",e)}var c=e.apply(t,n);a(void 0)})}}function i(){return i=s(regeneratorRuntime.mark((function e(t){var n,o,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.save({force:!0});case 3:return n=t.get(".overwrite"),o=n?{ids:n}:t.params,e.next=7,Daria.forceRefreshModelsForCompose(o);case 7:s=ns.page.history.getPreviousPageUrl({mismatch:"compose2"}),Daria.enableReactiveCompose(!0),ns.page.go(s||"#").always((function(){Daria.startScenarioForCompose(a.c)})),e.next=14;break;case 12:e.prev=12,e.t0=e.catch(0);case 14:case"end":return e.stop()}}),e,null,[[0,12]])}))),i.apply(this,arguments)}var a=n(421);t.a=function(e){return i.apply(this,arguments)}},208:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(3915);n.n(o);Jane.module("compose2.js",(function(){ns.View.prototype.composeUpdate=function(){this.info&&!this.info.isCollection&&this.invalidate(),this.isVisible()&&this.getModel("compose-state").trigger("ns-model:compose:update")},Daria.composeEqualRoutes=function(e,t){var n=_.omit(t.params,["_cuid"]),o=_.omit(e.params,["_cuid"]);return!(e.page!==t.page||!_.isEqual(o,n))},n(3916),n(3918),n(3919),n(3942),n(3967),n(3968),n(4078),n(4079)}))},366:function(e,t,n){"use strict";var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return s(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.BanReason=t.WorkModes=t.TimePresets=t.SuggestTypes=t.SmartSubjectType=t.Settings=t.SendError=t.ResolutionTypes=t.PromoTypes=t.Popups=t.Limits=t.LeaveTypes=t.InputTypes=t.FixedModes=void 0;var a=i(n(597));t.FixedModes=a;var r=i(n(598));t.InputTypes=r;var c=i(n(557));t.LeaveTypes=c;var u=i(n(558));t.Limits=u;var l=i(n(496));t.Popups=l;var d=i(n(599));t.PromoTypes=d;var h=i(n(600));t.ResolutionTypes=h;var p=i(n(663));t.SendError=p;var f=i(n(601));t.Settings=f;var m=i(n(602));t.SmartSubjectType=m;var g=i(n(603));t.SuggestTypes=g;var b=i(n(518));t.TimePresets=b;var _=i(n(604));t.WorkModes=_;var v=n(605);Object.defineProperty(t,"BanReason",{enumerable:!0,get:function(){return v.BanReason}})},369:function(e,t,n){"use strict";var o=n(787),s=n(679),i=n(788),a=n(1262),r=n(1263);n.d(t,"a",(function(){return r})),n.d(t,"c",(function(){return o})),n.d(t,"d",(function(){return i})),n.d(t,"b",(function(){return a})),n.d(t,"e",(function(){return s}))},382:function(e,t,n){"use strict";var o=n(395),s=n.n(o);n.d(t,"a",(function(){return s.a}))},3915:function(e,t){},3916:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(3917);Daria.utils=Daria.utils||{},Daria.utils.dirname=function(e){e=e||"";var t="/"===e.charAt(0),n=$.grep(e.split("/"),(function(e){return e.length}));return n.pop(),(t?"/":"")+n.join("/")},Daria.utils.checkReplaceFakeMessage=function(e){if("message"===ns.page.current.page)return!1;if("yes"!==ns.page.current.params.threaded)return!1;if(!ns.Model.get("settings").isThreaded())return!1;var t=no.jpath(".message.hdr_message_id",e),n=no.jpath(".message.mid",e),o=no.jpath(".message.thread_id",e);return!!(o&&t&&n)&&!!ns.Model.get("messages",{thread_id:"t"+o}).isValid()},Daria.utils.getDiskParams=o.a},3917:function(e,t,n){"use strict";function o(e){return Object(s.pick)({name:e.name,url:e.narodUrl,preview_url:e.previewSrc,size:e.size?Number(e.size):null,folder:e.folder?Object(i.default)("compose-react/Attachments_Disk_folder"):null,hash:e.hash},s.identity)}var s=n(138),i=(n.n(s),n(367));t.a=o},3918:function(e,t){Daria.UI=Daria.UI||{},Daria.UI.IEvent=function(e){function t(t){return o[t]||(a[t]=e[t]||"unique",o[t]=$.Callbacks(a[t])),o[t]}function n(e){if(i[e]){for(var n=0,o=i[e].length;n<o;n++)t(e).add(i[e][n]);delete i[e]}}e=e||{};var o={},s={},i={},a={};return{_events:{lock:function(e){s[e]=!0,i[e]=[]},unlock:function(e){delete s[e]},empty:function(e){e?(t(e).empty(),delete i[e]):(o={},i={})}},on:function(e,n){if(s[e]){-1===$.inArray(n,i[e])&&i[e].push(n)}else t(e).add(n);return this},off:function(e,n){if(s[e]){var o=$.inArray(n,i[e]);-1!==o&&i[e].splice(o,1)}return t(e).remove(n),this},trigger:function(e,o){if(!s[e]){var i=a[e]&&-1!==a[e].indexOf("memory");i||n(e),t(e).fireWith(this,o),i&&n(e)}return this}}}},3919:function(e,t,n){Daria.ComposeComponents={},n(3920),n(3921),n(3922),n(3924),n(3925),n(3926),n(3927),n(3928),n(3929),n(3930),n(3931),n(3932),n(3933),n(3934),n(3935),n(3937),n(3938),n(3939),n(3940),n(3941)},3920:function(e,t){ns.action.define("attachments.retry",(function(e,t){ns.events.trigger("daria:vComposeAttachArea:retryAttach",t)}))},3921:function(e,t,n){"use strict";function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function a(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}Object.defineProperty(t,"__esModule",{value:!0});var r=n(902),c=n(1267),u=n(1265),l=n(1264),d=n(791),h=n(1261),p=n(1270),f=n(1268),m=n(903),g=n(1272),b=n(1280),v=n(369),y=n(1266),C=n(369);!(function(){var e={ATTACHING_TO_DISK:"ATTACHING_TO_DISK",ATTACHING_TO_DISK_FAILED:"ATTACHING_TO_DISK_FAILED"},t=(function(){function t(e,n){s(this,t),this.bindMethodsToContext(),this._collection=n,this._aborted=!1,this.deleted=!1,this._uploadDeferred=$.Deferred(),this._requests=[];var o=Object(m.a)(e),i=o.info,a=o.previewSupported,r=o.status;this.info=i,this.previewSupported=a,this.status=r,ns.assert(i.mComposeMessage,"Daria.Attachment2",'"mComposeMessage" parameter is not passed to the constructor'),this.mComposeMessage=i.mComposeMessage}return a(t,null,[{key:"fromMessageBody",value:function(e,n,o){var s=Object(g.a)(e,n);return s.mComposeMessage=o,new t(s)}}]),a(t,[{key:"bindMethodsToContext",value:function(){this._updateShrinker=this._updateShrinker.bind(this)}},{key:"isCancelled",value:function(){return this._aborted||this.deleted}},{key:"setNode",value:function(e){return this._$node&&this._$node.replaceWith(e),this._$node=e,this.bindEvents(),_.defer(this._updateShrinker),this.status===v.c.FAILED&&this.setStatus(v.c.FAILED),this._addToComposeMessage(),this.trigger("update"),this}},{key:"bindEvents",value:function(){this._$node&&this._$node.on("click",".js-mark-deleted",this.markDeleted.bind(this)).on("click",".js-unmark-deleted",this.unmarkDeleted.bind(this)).on("click",".js-retry",this.retry.bind(this))}},{key:"getNode",value:function(e){if(e||!this._$node){var t=this._collection?this._collection.templateMode:"compose2:attachments",n=Jane.tt(t,{attachment:[this.getJSONForTransform()]});this.setNode($(n.firstChild))}return this._$node}},{key:"getJSONForTransform",value:function(){return Object(r.a)(this.info,{status:this.status,previewSupported:this.previewSupported})}},{key:"_updateShrinker",value:function(){var e=this.getNode().find(".b-shrinker");if(e[0]){var t=e.find(".b-shrinker__right").width();e.css("margin-right",t)}}},{key:"markDeleted",value:function(){return this.status===v.c.COMPLETED&&this.info.type===v.d.YADISK?(this.getNode().removeClass("b-file_deletable").addClass("b-file_deleted"),this.deleted=!0,this._removeFromComposeMessage(),!1):(this.forceRemove(),!0)}},{key:"forceRemove",value:function(){this.remove(),this._uploadDeferred.reject()}},{key:"unmarkDeleted",value:function(){this.getNode().removeClass("b-file_deleted").addClass("b-file_deletable"),this._addToComposeMessage(),this.deleted=!1}},{key:"removeIfMarked",value:function(){return!!this.deleted&&(this.remove(),!0)}},{key:"stop",value:function(){this.status!==v.c.COMPLETED&&(this.getNode().remove(),this._aborted=!0,this._requests.forEach((function(e){e instanceof Vow.Promise?e.notify("abort"):e.abort&&e.abort()})),this.info.diskSrcPath&&ns.Model.get("disk-resources").removeAttach(this.info.diskSrcPath),this._stopNarod(),this._requests=[])}},{key:"_stopNarod",value:function(){this.info.narod&&(Object(y.b)(this.info.narod),delete this.info.narod)}},{key:"remove",value:function(){this._removeFromComposeMessage(),this.stop(),this.getNode().remove(),this.deleted=!1,this.trigger("attachment.removed",this)}},{key:"metrika",value:function(t){var n=[],o=this.info.folder;switch(t){case e.ATTACHING_TO_DISK:n.push(["Аттачи из Диска","Прикрепление",o?"Папка":"Файл"]),o||n.push(["Аттачи из Диска","Типы файлов",this.info.mediaType]),Jane.Metrika.counter&&Jane.Metrika.counter.reachGoal("ATTACHFROMDISK");break;case e.ATTACHING_TO_DISK_FAILED:n.push(["Аттачи из Диска","Ошибка загрузки"])}n.forEach((function(e){Jane.c.apply(null,e)}))}},{key:"attachFromYaDisk",value:function(){var t=this;return this.setStatus(v.c.UPLOADING),this.retry=function(){return t.attachFromYaDisk()},this.metrika(e.ATTACHING_TO_DISK),Object(p.a)(this.info,{onUploadProgress:this._onUploadProgress.bind(this),onSuccess:function(){return t._onUploadSuccess(!0)},onFail:function(){t.metrika(e.ATTACHING_TO_DISK_FAILED),t.setStatus(v.c.FAILED)}})}},{key:"upload",value:function(){return this.status=v.c.UPLOADING,this.info.type===v.d.YADISK?this._fileUploadDisk():this.info.file&&this._fileUploadXHR(),this._uploadDeferred}},{key:"_getUploadUrl",value:function(){return Daria.url.upload()}},{key:"_onUploadProgress",value:function(e){if(this.status!==v.c.FAILED){var t=e>=0&&e<100;this._setBlockMod(t?"loading":"wait"),this.getNode().find(".js-progress").width("".concat(t?e:100,"%"))}}},{key:"_getDiskProgress",value:function(){var e=this;return Object(u.a)(this.info,{onError:function(t){var n=t.info,o=t.status,s=t.errorCode,i=t.additionalInfo;Object(y.b)(e.info.narod),Jane.ErrorLog.send(n,i),e.setStatus(o,s)},onUploadProgress:this._onUploadProgress.bind(this),onUploadComplete:function(){Object(y.b)(e.info.narod),e._onUploadSuccess(!0)}})}},{key:"_simpleUploadComplete",value:function(e){var t=this;this._removeRequest(e),Object(f.a)({info:this.info,previewSupported:this.previewSupported,xhr:e},{onAuthFail:function(){return Jane.doLogin("upload_attachment")},onError:function(e){var n=e.info,o=e.additionalInfo,s=e.status,i=e.errorCode;n.aborted=t._aborted,t._aborted||Jane.ErrorLog.send(n,o),t.setStatus(s,i)},onSuccess:function(){return t._onUploadSuccess(!0)}})}},{key:"_setBlockMod",value:function(e){e=e||"";var t=this.getNode();t.removeClass("b-file_wait b-file_loading b-file_error"),e&&t.addClass("b-file_"+e)}},{key:"setStatus",value:function(e,t){this.status=e,e===v.c.FAILED?(this._onUploadFail(t),this._setBlockMod("error")):e===v.c.VIRUS?(this._onUploadFail(t),this._setBlockMod("virus")):(delete this._failErrorCode,this._setBlockMod(""))}},{key:"retry",value:function(){Daria.Dialog.close(),this.setStatus(v.c.NEW),this._setBlockMod("wait"),this._uploadDeferred=$.Deferred()}},{key:"_onUploadSuccess",value:function(e){if(this.isCancelled())return void this._uploadDeferred.reject();this.previewSupported&&Object(d.a)(this.info),this.setStatus(v.c.COMPLETED),this.getNode(e),this._addToComposeMessage(),this._uploadDeferred.resolve()}},{key:"_addToComposeMessage",value:function(){this.mComposeMessage.addAttachment(this)}},{key:"_removeFromComposeMessage",value:function(){this.mComposeMessage.removeAttachment(this.info.id)}},{key:"_onUploadFail",value:function(e){var t,n=(t={},o(t,v.e.UNKNOWN,i18n("%Attachments_Error_Code_0")),o(t,v.e.FILE_LIMIT,this._getSizeError({prod:"%Attachments_Error_Code_1_prod",corp:"%Attachments_Error_Code_1_corp",prodNoDisk:"%Attachments_Error_Code_1_nodisk_prod"})),o(t,v.e.TOTAL_LIMIT,this._getSizeError({prod:"%Attachments_Error_Code_2_prod",corp:"%Attachments_Error_Code_2_corp",prodNoDisk:"%Attachments_Error_Code_2_prod_no_disk"})),o(t,v.e.VIRUS,i18n("%Attachments_Error_Code_106_full")),o(t,v.e.DISK_FULL,i18n("%Attachments_Error_Code_507",Daria.url.cleanUpYaDisk(),Daria.url.increaseYaDiskSize(),"b-pseudo-link")),t);e===v.e.VIRUS&&this.getNode(!0),e=e||this._failErrorCode||v.e.UNKNOWN,e in n||(e=v.e.UNKNOWN),this._failErrorCode=e;var s=n[e]+(e===v.e.UNKNOWN?'  <a class="b-pseudo-link ns-action" data-click-action="attachments.retry" data-params="id='+this.info.id+'">'+i18n("%Повторить")+"</a>":"");this.getNode().find(".b-file__fail").attr("data-params","width=30em&side=top&text="+encodeURIComponent(s)),this._aborted||(this.trigger("attachment.failed"),Jane.ErrorLog.send({errorType:"UploadFail",aborted:this._aborted,fileName:this.info.name,uploaderType:this.info.type,errorCode:e})),this._uploadDeferred.reject()}},{key:"_getSizeError",value:function(e){var t=e.prod,n=e.corp,o=e.prodNoDisk;if(C.a.HAS_DISK)return i18n(t);var s=C.a.MAX_SIZE_FOR_SINGLE_FILE/C.a.MB_SIZE;return C.a.IS_CORP?i18n(n,s):i18n(o,s,Daria.url.signUpDisk(),"b-pseudo-link")}},{key:"_diskUploadXHR",value:function(){var e=this,t=Object(l.a)(this.info,{onUploadProgress:this._onUploadProgress.bind(this),onUploadComplete:function(){e._removeRequest(t),e.info.narod&&Object(y.a)(e.info.narod,e._getDiskProgress.bind(e))},onError:function(n){var o=n.info,s=n.additionalInfo,i=n.status,a=n.errorCode;e._removeRequest(t),e._aborted||Jane.ErrorLog.send(o,s),e.setStatus(i,a)}});this._requests.push(t)}},{key:"_removeRequest",value:function(e){Jane.Array.remove(this._requests,e)}},{key:"_fileUploadXHR",value:function(){var e=Object(c.a)(this.info,{uploadUrl:this._getUploadUrl(),onUploadProgress:this._onUploadProgress.bind(this),onUploadComplete:this._simpleUploadComplete.bind(this)});this._requests.push(e)}},{key:"_fileUploadDisk",value:function(){var e=this,t=Object(h.a)(this.info,{onError:function(n){var o=n.info,s=n.additionalInfo,i=n.status,a=n.errorCode;e._removeRequest(t),e._aborted||Jane.ErrorLog.send(o,s),e.setStatus(i,a)},onSuccess:function(){return e._diskUploadXHR()}}).always((function(){return e._removeRequest(t)}));this._requests.push(t),this._onUploadProgress(0)}},{key:"updateInfo",value:function(e,t){var n=Object(b.a)(this.info,e,t);return n&&(this._removeFromComposeMessage(),this._onUploadSuccess()),n}}]),t})();t.AttachStatus=v.c,t.METRIKA_EVENTS=e,_.extend(t.prototype,ns.Events),Daria.Attachment2=t})()},3922:function(e,t,n){"use strict";function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Object.defineProperty(t,"__esModule",{value:!0});var a=n(369),r=n(3923),c=n(529),u=n(1278),l=n(1279);!(function(e,t){var n=t.AttachmentCollection2=function(e){this.bindMethodsToContext(),this._attachments={},this._totalAttachmentsSize=0,this._id=t.getRandomNumber(),this._init=!1,e&&this.setOptionsAndInit(e)};n.prototype={MAX_ATTACH_SIZE:a.a.MAX_TOTAL_ATTACHMENTS_SIZE,HAS_DISK:a.a.HAS_DISK,setOptionsAndInit:function(e){ns.assert(e,"Daria.AttachmentCollection2",'"options" parameter is not passed to the #setOptions method'),this.options=e,ns.assert(e.node||e.$node,"Daria.AttachmentCollection2",'neither "options.node" nor "options.$node" parameter is passed to the #setOptions method'),this.$node=$(e.node||e.$node),ns.assert(e.mComposeMessage,"Daria.AttachmentCollection2",'"options.mComposeMessage" parameter is not passed to the #setOptions method'),this.mComposeMessage=e.mComposeMessage,ns.assert(e.mComposeState,"Daria.AttachmentCollection2",'"options.mComposeState" parameter is not passed to the #setOptions method'),this.mComposeState=e.mComposeState,this.templateMode=e.templateMode||"compose2:js-attachments-collection",this.$files=this.$node.find(".js-compose-attachments-container");var t={_$attsImg:".js-compose-attachments-images",_$attsRecent:".js-compose-attachments-common",_$attsNarodCommon:".js-compose-attachments-narod-common",_$attsNarodImages:".js-compose-attachments-narod-images",_$attsDiskInfo:".js-compose-attachments-narod-header"};_.keys(t).forEach((function(e){this[e]=this.$files.find(t[e])}),this),this._init=!0,this.checkVisibility()},_appendAttach:function(e,t,n){var o=e.getNode(t);e.previewSupported?e.info.type===a.d.YADISK?this._$attsNarodImages.append(o):this._$attsImg.append(o):e.info.type===a.d.FILE?this._$attsRecent.append(o):this._$attsNarodCommon.append(o),n||(this.checkVisibility(),this.trigger("attachments.appended",e))},addAttachToCollection:function(e,t){t=t||{},t.processAttachSize=!_.isBoolean(t.processAttachSize)||t.processAttachSize,this._attachments[e.info.id]=e,t.processAttachSize&&this._processAttachmentSize(e),t.silent||this.trigger("attachments.added",e),this.bindEventsToAttach(e)},removeAttachFromCollection:function(e,t){t=t||{},this.unbindEventsFromAttach(e),this._reduceAttachmentsSize(e),this.checkVisibility(),delete this._attachments[e.info.id],t.silent||this.trigger("attachments.removed",e)},bindMethodsToContext:function(){this.onAttachmentUpdated=this.onAttachmentUpdated.bind(this),this.onAttachmentRemoved=this.onAttachmentRemoved.bind(this),this.onAttachmentFailed=this.onAttachmentFailed.bind(this),this._processAttachmentSize=this._processAttachmentSize.bind(this)},bindEventsToAttach:function(e){e.on("update",this.onAttachmentUpdated),e.on("attachment.removed",this.onAttachmentRemoved),e.on("attachment.failed",this.onAttachmentFailed)},unbindEventsFromAttach:function(e){e.off("update",this.onAttachmentUpdated),e.off("attachment.removed",this.onAttachmentRemoved),e.off("attachment.failed",this.onAttachmentFailed)},onAttachmentUpdated:function(){this.trigger("attachments.updated")},onAttachmentRemoved:function(e,t){this.removeAttachFromCollection(t)},onAttachmentFailed:function(){this.trigger("attachments.failed")},checkVisibility:function(){var e=this._$attsImg.find("> .b-file").length,t=this._$attsRecent.find("> .b-file").length,n=this._$attsNarodCommon.find("> .b-file").length,o=this._$attsNarodImages.find("> .b-file").length;this._$attsDiskInfo.toggleClass("g-hidden",n+o===0),this._$attsImg.toggleClass("g-hidden",0===e),this._$attsRecent.toggleClass("g-hidden",0===t),this._$attsNarodCommon.toggleClass("g-hidden",0===n),this._$attsNarodImages.toggleClass("g-hidden",0===o)},isCompleted:function(){return _.every(this._attachments,(function(e){return e.status!==a.c.NEW&&e.status!==a.c.UPLOADING}))},isUploading:function(){for(var e in this._attachments){var t=this._attachments[e];if(!t.isCancelled()&&t.status===a.c.UPLOADING)return!0}return!1},isFailed:function(){return _.some(this._attachments,(function(e){return e.status===a.c.FAILED}))},hasFiles:function(){return!$.isEmptyObject(this._attachments)},reset:function(){if(this._init){this.$node.off(),this.off(),$(document).off(".compose");for(var e in this._attachments)this._attachments[e].remove();this._attachments={},this._$attsImg.addClass("g-hidden").empty(),this._$attsRecent.addClass("g-hidden").empty(),this._$attsNarodCommon.addClass("g-hidden").empty(),this._$attsNarodImages.addClass("g-hidden").empty(),this.$dropzone&&this.$dropzone.remove()}},add:function(e,t){this.removeMarkedAsDeleted(),t?this._addAttaches(e,t):this._addAttach(e)},_addAttaches:function(e,n){for(var o=[],s=[],i=0,c=n.length;i<c;i++){var u=new t.Attachment2({mComposeMessage:this.mComposeMessage,input:e,file:n[i]},this);u.info.type=a.d.FILE,this.addAttachToCollection(u,{processAttachSize:!1}),s.push(Object(r.a)(u.info.file)),o.push(u)}$.when.apply(null,s).done(function(){for(var e=[],t=0,n=arguments.length;t<n;t++)if(!1!==arguments[t]){var s=o[t];this._attachments[s.info.id]=s,e.push(s),this._processAttachmentSize(s)}this.redrawAttachesBulk(e),this._uploadQueue()}.bind(this))},_processAttachmentSize:function(e){if(e.info.type===a.d.FILE){var t=Object(c.a)(e.info);if(t>this.MAX_FILE_SIZE)e.setStatus(a.c.FAILED,a.e.FILE_LIMIT);else{var n=Number(t)+this._totalAttachmentsSize,o=n<this.MAX_ATTACH_SIZE,s=this.HAS_DISK;if(!(e.status===a.c.NEW))return this._totalAttachmentsSize=n,void(e.inSize=!0);o?(e.inSize=!0,this._totalAttachmentsSize=n):s?(e.info.type=a.d.YADISK,"audio"===e.info.class&&(e.previewSupported=!1)):e.setStatus(a.c.FAILED,a.e.TOTAL_LIMIT)}}},getAttaches$Html:function(t,n,o){for(var s=[],i=0,a=t.length;i<a;i++)s.push(t[i].getJSONForTransform());var r={"collection-id":this._id,attachment:s};return n&&(r.mid=n),o&&(r=$.extend({},r,o)),$(e.tt(this.templateMode,r))},redrawAttachesBulk:function(e,t,n){e||(e=_(this._attachments).chain().values().filter((function(e){return!e.isCancelled()})).value());var o=this.getAttaches$Html(e,t);this._appendAttachBulk(e,o,n)},_appendAttachBulk:function(e,t,n){if(e.length){for(var o=0,s=e.length;o<s;o++){var i=e[o],a=i.info.id,r=t.find("#att_"+this._id+"_"+a);i.setNode(r),this._appendAttach(i,!1,!0)}n||(this.checkVisibility(),this.trigger("attachments.appended",e))}},_addAttach:function(e,n){var o=new t.Attachment2({mComposeMessage:this.mComposeMessage,input:e,file:n},this);o.info.type=a.d.FILE,this.addAttachToCollection(o,{processAttachSize:!1}),this._processAttachmentSize(o),this._appendAttach(o,!0),this._scrollToAttachInput(),this._uploadQueue()},addDiskAttach:function(e,n){var o=this,i=new t.Attachment2(s({},Object(u.a)(n),{mComposeMessage:this.mComposeMessage}),this);i.info.type=a.d.YADISK,this.addAttachToCollection(i,{processAttachSize:!1}),this._appendAttach(i,!0),i.attachFromYaDisk().then((function(){o._uploadQueue()})),this.removeMarkedAsDeleted()},_uploadQueue:function(){var e,t=this;for(var n in this._attachments){var o=this._attachments[n];if(o.status===a.c.UPLOADING)return!1;if(!e&&o.status===a.c.NEW){o.removeIfMarked()?(this._reduceAttachmentsSize(o),delete this._attachments[n]):e=o;break}}e?this.isUploading()||e.upload().always((function(){e.info.type===a.d.YADISK&&e._addToComposeMessage(),e.status===a.c.FAILED&&t._reduceAttachmentsSize(e),Promise.resolve().then((function(){t._uploadQueue()}))})):ns.events.trigger("attachments.all-uploaded")},removeMarkedAsDeleted:function(){for(var e in this._attachments){var t=this._attachments[e];t.removeIfMarked()&&(this._reduceAttachmentsSize(t),delete this._attachments[e])}this.checkVisibility(),this.isUploading()||ns.events.trigger("attachments.all-uploaded")},_reduceAttachmentsSize:function(e){if(e.inSize){e.inSize=!1;var t=Object(c.a)(e.info);this._totalAttachmentsSize-=t}},updateAfterSave:function(e,t,n){if(e){var o=[],s={};_.each(this._attachments,(function(n,i){if(n.updateInfo(e,t)){var a=n.info.id;s[a]=n,o.push(n)}else s[i]=n})),this._attachments=s,this.redrawAttachesBulk(o,t,n)}},stopUploading:function(){for(var e in this._attachments)this._attachments[e].stop();this.checkVisibility()},retryAttach:function(e){var t=this._attachments[e];t&&(t.retry(),this._uploadQueue())},getSummary:function(){var e=this,t=Object.keys(this._attachments).map((function(t){return e._attachments[t]}));return Object(l.a)(t)}},_.extend(n.prototype,ns.Events),n.prototype.MAX_FILE_SIZE=a.a.MAX_SIZE_FOR_SINGLE_FILE})(Jane,Daria)},3923:function(e,t,n){"use strict";t.a=function(e){if(!e||Modernizr.webkit)return Promise.resolve(!0);if(!window.FileReader){var t=e.size,n=0===t||102===t||4096===t;return Promise.resolve(!(n&&""===e.type&&-1===e.name.indexOf(".")))}return window.opera&&navigator.platform.toLowerCase().indexOf("mac")>-1&&"12.00"===window.opera.version()?Promise.resolve(null):e.size>4096?Promise.resolve(!0):new Promise(function(t){try{var n=new FileReader;n.onerror=function(){n.onloadend=n.onprogress=n.onerror=null,t(!1)},n.onloadend=n.onprogress=function(e){n.onloadend=n.onprogress=n.onerror=null;try{"loadend"!==e.type&&n.abort()}catch(e){}t(!0)},n.readAsDataURL(e)}catch(e){t(!1)}})}},3924:function(e,t){!(function(){function e(e,t){this.$node=e,this.selector=t,this.$target=null,this.currentValue=""}$.fn.startEmulateInputEvent=function(t){return"string"==typeof t?this.each((function(){var n=$(this),o=new e(n,t);o.init(),n.data("inputEmulator",o)})):this},$.fn.stopEmulateInputEvent=function(){return this.each((function(){var t=$(this),n=t.data("inputEmulator");n instanceof e&&n.destroy(),t.data("inputEmulator",null)}))},e.prototype.$doc=$(document),e.prototype.init=function(){"string"==typeof this.selector&&this.$node.on("focusin.inputEmulator",this.selector,this.startEmulate.bind(this)).on("focusout.inputEmulator",this.selector,this.stopEmulate.bind(this))},e.prototype.destroy=function(){this.stopEmulate(),this.$node.off(".inputEmulator")},e.prototype.startEmulate=function(e){this.$target=$(e.currentTarget),this.currentValue=this.$target.val(),this.$target.on("keydown.inputEmulator keyup.inputEmulator",this.triggerInputEvent.bind(this)),this.$doc.on("selectionchange.inputEmulator",this.triggerInputEvent.bind(this))},e.prototype.stopEmulate=function(){this.$target&&this.$target.off(".inputEmulator"),this.$target=null,this.currentValue="",this.$doc.off(".inputEmulator")},e.prototype.triggerInputEvent=function(){if(this.$target){var e=this.$target.val();e!==this.currentValue&&this.$target.trigger("input"),this.currentValue=e}},Daria.InputEventEmulator=e})()},3925:function(e,t){!(function(){Daria.ComposeComponents.confirmations={_confirmations:{},addConfirmation:function(e,t){this._confirmations[e]=t},getConfirmation:function(e){return this._confirmations[e]},getConfirmations:function(){return _.map(this._confirmations,(function(e){return e}))}}})()},3926:function(e,t){!(function(){var e="send-without-to",t=function(t){var n=t.get(".to"),o=t.get(".cc"),s=t.get(".bcc");return!(n||!o&&!s)&&e};Daria.ComposeComponents.confirmations.addConfirmation(e,t)})()},3927:function(e,t){!(function(){var e="attachments-forgotten",t=["attach","аттач","прилагается","приложил","прикладываю","прикрепляю","приложенный","приложенном","вложил","вложение","вложенном","вложенный","вкладываю","прилагаю","см. файл","см.файл","лови файл","прикрепил","во вложении","в приложении"],n=new RegExp(t.join("|"),"i"),o=function(t,o){if(t.hasAttach())return!1;var s=t.get(".send"),i=t.get(".subj");/^RE:/i.test(i)||(s=i+" "+s),s=s.replace(new RegExp("(?:^\\s*>.*$)|(?:[\\n\\r])","gmi"),""),s=s.replace(/<blockquote[^>]*>.*<\/blockquote>/gi,""),s=s.replace(/<[^>]+>/g,"");var a=n.exec(s);if(!a)return!1;var r=[];return $.each([a.index,a.index+a[0].length-1],(function(e,t){e=2*e-1;for(var n=3,o=!1,i=t,a=s.length;i>=0&&i<a;i+=e)if(/[\s,.!?\-+:;()]/i.test(s.charAt(i))){if(!o){if(!--n)break;o=!0}}else o=!1;r.push(i)})),o.stopWordGroup=$.trim(s.substring.apply(s,r)),e};Daria.ComposeComponents.confirmations.addConfirmation(e,o)})()},3928:function(e,t){!(function(e,t){"use strict";t.Signature=function(){e.extend(this,t.UI.IEvent()),this._log("create"),this.__init=!1,this._isMouseenter=!1,this._isMouseleave=!0,this._coordYBegin=0,this._coordYEnd=0,this._currentYCursor=0,this._limitRangeFind=100,this._maxSignLine=100,this._range=[],this._updateCoords=_.debounce(this._updateCoords,0),this._onInput=_.debounce(this._onInput,50)};var n=t.Signature.prototype;n._log=function(){},n._mouseEnter=function(){this._isMouseenter||(this._isMouseenter=!0,this._isMouseleave=!1,this.trigger("mouseenter",[this]))},n._mouseLeave=function(){this._isMouseleave||(this._isMouseleave=!0,this._isMouseenter=!1,this.trigger("mouseleave",[this]))},n._mouseMove=function(e){if(this._coordYBegin>=this._coordYEnd)return void this._mouseLeave();this._currentYCursor=e,this._currentYCursor>=this._coordYBegin&&this._currentYCursor<=this._coordYEnd?(this._mouseEnter(),this.trigger("mousemove",[this])):this._mouseLeave()},n._updateCoords=function(){var e=this._offset();e&&(this._log("_updateCoords"),this._coordYBegin===e.top&&this._coordYEnd===e.bottom||(this._coordYBegin=e.top>0?e.top:0,this._coordYEnd=e.bottom>0?e.bottom:0,this._currentYCursor&&this._mouseMove(this._currentYCursor),this.trigger("change",[this])))},n.__onInput=function(){if(this._log("__onInput"),this._range=this._findRange(),!this._range.length)return this._coordYBegin=0,this._coordYEnd=0,void this._mouseLeave();this._updateCoords()},n._onInput=function(t){t&&e.inArray(t.keyCode,[37,38,39,40,16,17,18])>-1||(this._log("_onInput"),this.__onInput())},n._onClick=function(){this._range.length&&this._isMouseenter&&(this._log("_onClick"),this.trigger("click",[this]))},n._onScroll=function(){this._range.length&&(this._log("_onScroll"),this._updateCoords())},n.isMouseEntered=function(){return this._isMouseenter},n.offset=function(){return{top:this._coordYBegin,bottom:this._coordYEnd}},n.update=function(){this._range=this._findRange();var e=this._offset();e&&(this._coordYBegin=e.top>0?e.top:0,this._coordYEnd=e.bottom>0?e.bottom:0,this._currentYCursor&&this._mouseMove(this._currentYCursor),this.trigger("change",[this]))},n._destroy=function(e){this.__init&&(this._log("_destroy"),this.__init=!1,this._updateCoords.cancel(),this._onInput.cancel(),this._events.empty(),this._range=[],this._currentYCursor=0,this._coordYBegin=0,this._coordYEnd=0,this._isMouseenter=!1,this._isMouseleave=!0,e&&e.call(this))},n._init=function(e){this.__init||(this._log("_init"),this.__init=!0,e&&e.call(this),this.__onInput())},n.__offsetY=function(e){var t;return void 0!==e.offsetY?t=e.offsetY:e.originalEvent&&void 0!==e.originalEvent.layerY&&(t=e.originalEvent.layerY),t},n.setFirstSignatureMatch=function(e){this._firstSignatureMatch=e},n.getFirstSignatureMatch=function(){return this._firstSignatureMatch||"--\\s"},n._offset=function(){},n.getLinesCount=function(){return 0},n._findRange=function(){return[]},n._onMouseMove=function(){},n._onMouseLeave=function(){},n._onMouseEnter=function(){},n.destroy=function(){},n.init=function(){},n.select=function(){},n.replace=function(){},n.get=function(){},n.getText=function(){}})(jQuery,Daria)},3929:function(e,t){!(function(e,t){"use strict";t.SignatureTextarea=function(n){t.SignatureTextarea.superClass.constructor.apply(this,arguments),this._$node=e(n)},Jane.extend(t.SignatureTextarea,t.Signature);var n=t.Signature.prototype;n._widthNode=function(){var e=0,t=this._$node[0].scrollWidth||this._$node[0].clientWidth;return window.getComputedStyle&&(e=window.getComputedStyle(this._$node[0],null).getPropertyValue("width"),e=-1!==e.indexOf("px")?parseFloat(e):0),e?Math.min(e,t):t},n._textCoords=function(t,n,o){this._$placeholder.width(this._widthNode()).text(t);var s=parseInt(this._$placeholder.css("top"),10),i=this._$placeholder[0].firstChild,a=document.createRange();a.setStart(i,n),a.setEnd(i,o);var r=a.cloneRange(),c={};if(!Modernizr.msie&&!Modernizr.opera&&(r.getBoundingClientRect&&(c=r.getBoundingClientRect(),c={top:c.top,bottom:c.bottom}),!c.top&&!c.bottom&&r.getClientRects)){var u=r.getClientRects();u.length&&(c.top=u[0].top,c.bottom=u[u.length-1].bottom)}if(c.top||c.bottom){var l=e(window).scrollTop();c.top=c.top+l,c.bottom=c.bottom+l}else{r.surroundContents(this._highlight);var d=e(this._highlight);c.top=d.offset().top,c.bottom=c.top+d.height()}return c.top&&c.bottom?(c.top=c.top-s,c.bottom=c.bottom-s,c):null},n._offset=function(){if(!this._range.length)return null;var e=this._$node.scrollTop();return{top:this._range[0].top-e,bottom:this._range[1].bottom-e}},n._findRange=function(){if(!this._lineHeight)return[];for(var e,t=new RegExp("^"+this.getFirstSignatureMatch()+"$","gm"),n=this._$node.val(),o=/^--------[^\-]+.*--------$/gm,s=[-1,-1],i=!1;null!==(e=o.exec(n));)i||(i=!0,s[0]=e.index),s[1]=o.lastIndex;var a,r,c=t.exec(n);if(c&&c.index>s[0]&&c.index<s[1]&&(t.lastIndex=s[1],c=t.exec(n)),c){a={simbol:c.index,simbolOffset:t.lastIndex+1,top:void 0};var u,l=this._maxSignLine,d=/^.+$/gm,h=!1,p=[0,0],f=/^\s*>/,m=/^\s*$/;for(d.lastIndex=t.lastIndex;null!==(u=d.exec(n))&&l;){if(f.test(u[0])){h=!0;break}if(d.lastIndex>=s[0]&&d.lastIndex<=s[1])break;m.test(u[0])||(p=[d.lastIndex,p[0]]),l--}if(p=h&&p[1]?p[1]:p[0]?p[0]:a.simbolOffset-1){r={simbol:p,bottom:void 0};var g=this._textCoords(n,a.simbol,r.simbol);g?(a.top=g.top,r.bottom=g.bottom):(a=null,r=null)}}return a&&r?[a,r]:[]},n._onMouseMove=function(e){this._isNodeMouseenter||this._onMouseEnter(e),this._log("mousemove"),this._mouseMove(this.__offsetY(e))},n._onMouseLeave=function(){this._log("mouseleave"),this._mouseLeave(),this._currentYCursor=0,this._isNodeMouseenter=!1},n._onMouseEnter=function(e){this._log("mouseenter"),this._currentYCursor=this.__offsetY(e),this.__onInput(),this._isNodeMouseenter=!0},n.get=function(){return this._range.length?this._$node.val().slice(this._range[0].simbol,this._range[1].simbol):""},n.getText=function(){return this.get()},n.replace=function(e){if(this._range.length){var t=this._$node.val();t=t.substr(0,this._range[0].simbol)+e+t.substr(this._range[1].simbol),this._$node.val(t),this.__onInput()}},n.select=function(){this._range.length&&t.setSelection(this._$node[0],this._range[0].simbol,this._range[1].simbol)},n.init=function(t,n){t=t||{},this._init((function(){this.setFirstSignatureMatch(t.firstSignatureMatch);var o=parseInt(this._$node.css("font-size"),10)||13;if(this._lineHeight=o+2,this._$node.css("line-height",this._lineHeight+"px"),this._highlight=document.createElement("span"),this._$placeholder=e("<pre></pre>").css({font:this._$node.css("font"),fontFamily:this._$node.css("fontFamily"),fontSize:this._$node.css("fontSize"),fontStyle:this._$node.css("fontStyle"),fontVariant:this._$node.css("fontVariant"),fontWeight:this._$node.css("fontWeight"),lineHeight:this._$node.css("lineHeight"),padding:this._$node.css("padding"),paddingTop:this._$node.css("paddingTop"),paddingBottom:this._$node.css("paddingTop"),paddingLeft:this._$node.css("paddingLeft"),paddingRight:this._$node.css("paddingRight"),margin:this._$node.css("margin"),marginTop:this._$node.css("marginTop"),marginBottom:this._$node.css("marginTop"),marginLeft:this._$node.css("marginLeft"),marginRight:this._$node.css("marginRight"),width:this._widthNode()+"px",wordWrap:"break-word",whiteSpace:"pre-wrap",visibility:"hidden",position:"absolute",top:"-9999px",left:"-9999px"}).appendTo("body"),this._$node.on("keyup",e.proxy(this._onInput,this)).on("mouseleave",e.proxy(this._onMouseLeave,this)).on("mouseenter",e.proxy(this._onMouseEnter,this)).on("click",e.proxy(this._onClick,this)).on("mousemove",e.proxy(this._onMouseMove,this)).on("scroll",e.proxy(this._onScroll,this)),Modernizr.msie){var s=this,i=this._$node.css("overflow-y");this._$node.css("overflow-y","hidden"),setTimeout((function(){s._$node.css("overflow-y",i)}),0)}n&&n.call(this)}))},n.destroy=function(){this._destroy((function(){this._highlight=null,this._$placeholder.remove(),this._$placeholder=null,this._lineHeight=0,this._$node.off("keyup",e.proxy(this._onInput,this)).off("mouseleave",e.proxy(this._onMouseLeave,this)).off("mouseenter",e.proxy(this._onMouseEnter,this)).off("click",e.proxy(this._onClick,this)).off("mousemove",e.proxy(this._onMouseMove,this)).off("scroll",e.proxy(this._onScroll,this))}))},e.fn.signature=function(){return this.each((function(){this.signature||(this.signature=new t.SignatureTextarea(this))}))},e.fn.signatureDestroy=function(){return this.each((function(){this.signature&&(this.signature.destroy(),this.signature=null,delete this.signature)}))}})(jQuery,Daria)},3930:function(e,t){!(function(e,t){"use strict";t.SignatureCkeditor=function(n){t.SignatureCkeditor.superClass.constructor.apply(this,arguments),this._ed=n,this._$node=e(this._ed.editable().$),this._isFirstSignature=!0,this._isNormalizeSupport="normalize"in document.createElement("div")},Jane.extend(t.SignatureCkeditor,t.Signature);var n=t.SignatureCkeditor.prototype;n._offset=function(){if(!this._range.length)return null;var e,t,n;try{if(e=this._range[0][0].getBoundingClientRect(),!e.height)return null;if(t=this._range[1][0].getBoundingClientRect(),!t.height)return null;if(n=this._$node[0].getBoundingClientRect(),!n.height)return null}catch(e){return null}return{top:e.top-n.top,bottom:t.bottom-n.top}},n._findForwardRange=function(){var t=[-1,-1],n=this._ed.getData(!0);if(void 0===n)return t;if(!/<div>--------[^\-]+.*--------<\/div>/i.test(n))return t;var o=this._$node[0],s=o.childNodes.length;if(!s)return t;for(var i,a=0,r=/^--------[^\-]+.*--------$/;a<s;a++)if(i=o.childNodes[a],"DIV"===i.nodeName&&r.test(e.text(i))){t[0]=a;break}for(;s--;)if(i=o.childNodes[s],"DIV"===i.nodeName&&r.test(e.text(i))){t[1]=s;break}return t},n._checkFirstRange=function(e){var n=t.Html2Text.html2text(e.innerHTML),o=new RegExp("^"+this.getFirstSignatureMatch()+"$","m"),s=o.exec(n);return!(!s||0!==s.index)},n._findFirstRangeForward=function(e,t){var n,o,s=this._$node[0],i=s.childNodes.length,a=0;if(!((o=e?Math.min(this._limitRangeFind,i-this._limitRangeFind):Math.min(this._limitRangeFind,i))<=a)){for(;a<o;a++)if(!(a>=t[0]&&a<=t[1])){var r=s.childNodes[a];if(this._checkFirstRange(r)){n=r;break}}return n}},n._findFirstRangeBack=function(e,t){var n,o,s=this._$node[0],i=s.childNodes.length,a=i-1;if(o=e?Math.max(this._limitRangeFind,i-this._limitRangeFind):Math.max(0,i-this._limitRangeFind),!(a<o)){for(;a>=o;--a)if(!(a>=t[0]&&a<=t[1])){var r=s.childNodes[a];if(this._checkFirstRange(r)){n=r;break}}return n}},n._findFirstRange=function(){var e,t=this._findForwardRange();return this._isFirstSignature?(e=this._findFirstRangeForward(!1,t))||(e=this._findFirstRangeBack(!0,t)):(e=this._findFirstRangeBack(!1,t))||(e=this._findFirstRangeForward(!0,t)),e},n._findRange=function(){var t,n=this._findFirstRange();if(n){t=[];var o=this._maxSignLine,s=!1,i=/^--------[^\-]+.*--------$/,a=/^\s*>/,r=/^\s*$/,c=/<img[^>]*>/;e(n).nextAll().each((function(){if("BLOCKQUOTE"===this.nodeName)return s=!0,!1;var n=e.text(this);return a.test(n)?(s=!0,!1):!i.test(n)&&(!!o&&(r.test(n)?this.childNodes.length>0&&c.test(this.innerHTML)&&(t=[this,t[0]]):t=[this,t[0]],void o--))})),t=s&&t[1]?t[1]:t[0]?t[0]:n}return n&&t?[e(n),e(t)]:[]},n._createRange=function(){if(!this._range.length)return!1;var e=this._ed.createRange();return this._range[0][0]===this._range[1][0]?e.selectNodeContents(new CKEDITOR.dom.node(this._range[0][0])):(e.setStartBefore(new CKEDITOR.dom.node(this._range[0][0])),e.setEndAfter(new CKEDITOR.dom.node(this._range[1][0]))),e},n._onMouseMove=function(e){this._isNodeMouseenter||this._onMouseEnter(e),this._log("mousemove");var t=e.currentTarget.getBoundingClientRect(),n=e.clientY-t.top;this._mouseMove(n)},n._onMouseLeave=function(){this._log("mouseleave"),this._mouseLeave(),this._currentYCursor=0,this._isNodeMouseenter=!1},n._onMouseEnter=function(e){this._log("mouseenter"),this._currentYCursor=this.__offsetY(e),this.__onInput(),this._isNodeMouseenter=!0},n.get=function(){if(this._range.length)return this._range[0][0]===this._range[1][0]?this._range[0]:this._range[0].nextUntil(this._range[1]).andSelf().add(this._range[1])},n.getText=function(){var e=this.get();return e?e.map((function(){return t.Html2Text.html2text(this.innerHTML).replace(/^[\u0020\u00a0]+$/gm,"")})).get().join("\n"):""},n.replace=function(e){if(this._range.length){var t=this._createRange();this._ed.insertHtml(e,"html",t),this.__onInput()}},n.select=function(){if(!this._range.length)return!1;var e=this._createRange();return this._ed.getSelection().selectRanges([e]),!0},n.init=function(t,n){t=t||{},this._init((function(){"firstSignature"in t&&(this._isFirstSignature=Boolean(t.firstSignature)),this.setFirstSignatureMatch(t.firstSignatureMatch),this._$node.on("mouseleave",e.proxy(this._onMouseLeave,this)).on("mouseenter",e.proxy(this._onMouseEnter,this)).on("scroll",e.proxy(this._onScroll,this)).on("keyup",e.proxy(this._onInput,this)).on("mousemove",e.proxy(this._onMouseMove,this)).on("click",e.proxy(this._onClick,this)),this._ed.on("setData",e.proxy(this.__onInput,this)),n&&n.call(this)}))},n.destroy=function(){this._destroy((function(){this._$node.off("mouseleave",e.proxy(this._onMouseLeave,this)).off("mouseenter",e.proxy(this._onMouseEnter,this)).off("scroll",e.proxy(this._onScroll,this)).off("mousemove",e.proxy(this._onMouseMove,this)).off("click",e.proxy(this._onClick,this)).off("keyup",e.proxy(this._onInput,this)),this._ed.removeListener("setData",e.proxy(this.__onInput,this))}))}})(jQuery,Daria)},3931:function(e,t,n){function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function i(e,t,n){return t&&s(e.prototype,t),n&&s(e,n),e}var a,r,c,u,l=n(1320),d={value:null},h=(a=l())((u=c=(function(){function e(t){var n=this;o(this,e),this.AVATAR_SIZE=20;var s=t.dataset,i=this._fields;this._data=Object.keys(i).reduce((function(e,t){var o="yabble".concat(_.capitalize(t)),a=_.unescape(s[o]);return a=i[t]?_.method(i[t][0],a)(n):a,e[t]=a,e}),{})}return i(e,[{key:"_fields",get:function(){return d}}],[{key:"updateBubbleAtNode",value:function(e){if(e.classList.contains(Daria.ContactBubble.BUBBLE_CLASS))Daria.ContactBubble.update(e);else if(e.classList.contains(Daria.PhoneBubble.BUBBLE_CLASS))Daria.PhoneBubble.update(e);else{if(Daria.debug.enabled)throw new Error("uknown bubble type");Daria.BaseBubble.update(e)}}}]),i(e,[{key:"toString",value:function(){return String(this.get("value"))}},{key:"needUpdate",value:function(){return!1}},{key:"get",value:function(e){return _.get(this._data,e)}},{key:"getText",value:function(){return this.get("value")}},{key:"getAvatar",value:function(){return{href:!1,size:this.AVATAR_SIZE,className:"mail-Bubble-Avatar mail-User-Avatar"}}},{key:"applyTo",value:function(e){var t=this,n=this.renderBubbleNode();for(Object.keys(this._data).forEach((function(n){var o=t._data[n];(o=t._fields[n]?_.method(t._fields[n][1],o)(t):o)&&e.setAttribute("data-yabble-".concat(n),_.escape(o))})),this.get("tid")&&e.setAttribute("readonly","readonly");e.firstChild;)e.removeChild(e.firstChild);e.appendChild(n)}},{key:"getCustomProps",value:function(){return{}}},{key:"renderBubbleNode",value:function(){return ns.renderNode(_.extend({avatar:Daria.Recipients.add(this.getAvatar()),text:this.getText()},this.getCustomProps()),"bubble","compose2")}},{key:"_fieldToArray",value:function(e){return _.compact(this.constructor.tokenizer(String(e||"").trim()))}},{key:"_fieldToString",value:function(e){return String(e)}}]),e})(),c.BUBBLE_CLASS="js-base-bubble",r=u))||r;Daria.BaseBubble=h},3932:function(e,t,n){function o(e){"@babel/helpers - typeof";return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){return!t||"object"!==o(t)&&"function"!=typeof t?a(e):t}function a(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function r(e){return(r=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function c(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function u(e,t,n){return t&&c(e.prototype,t),n&&c(e,n),e}function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&d(e,t)}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(e){return y(e)}function p(e){return Jane.FormValidation.checkContacts(e)}var f,m,g,b,v=n(1320),y=n(904)(),C={cid:null,tid:null,name:null,type:null,phone:null,shared:null,email:["_fieldToArray","_fieldToString"],value:["_fieldToArray","_fieldToString"]},S=(f=v({tokenizer:h,checkPaste:p}))((b=g=(function(e){function t(e){var n;if(s(this,t),n=i(this,r(t).call(this,e)),n.get("tid"))return i(n);if(_.isEmpty(n.get("value"))){var o=Jane.FormValidation.contact2obj(e.innerText);n._data.name=o.name,n._data.email=n._fieldToArray(o.email)}if(!n.get("cid")&&!_.isEmpty(n.get("email"))){var a=ns.Model.get("abook-contacts").getContactDataByEmail(n.getHeadEmail());a&&(n._data.cid=a.cid,n._data.shared=Number(a.isShared))}var c=n.get("cid"),u=Boolean(Number(n.get("shared")));if(c){var l=ns.Model.get("abook-contact",{cid:c,shared:u});l.isValid()&&(n.get("name")||(n._data.name=l.getName()),n.get("phone")||(n._data.phone=l.getPhone()))}return n._data.value=n._fieldToArray(Jane.FormValidation.obj2contact({name:n.get("name"),email:n.getHeadEmail()})),n}return l(t,e),u(t,[{key:"_fields",get:function(){return C}}]),u(t,[{key:"getCustomProps",value:function(){return{isGroup:this.isGroup(),isContact:this.isContact(),hasInvalidEmail:this.hasInvalidEmail(),hasExternalEmail:this.hasExternalEmail()}}},{key:"needUpdate",value:function(){var e=!this.get("tid")&&!this.get("cid"),t=!this.hasInvalidEmail()&&this.getHeadEmail()&&this.getHeadEmail().length<this.constructor.EMAIL_LEN_REQUEST;return e&&t}},{key:"setEmail",value:function(e){this._data.email=this._fieldToArray(e),this._data.value=this._fieldToArray(Jane.FormValidation.obj2contact({name:this._data.name,email:e}))}},{key:"appendEmail",value:function(e,t){this._data.email=_.uniq(this.get("email").concat(e));for(var n=Jane.FormValidation.obj2contact({name:t,email:e}),o=!1,s=0;s<this._data.value.length;){var i=Jane.FormValidation.contact2obj(this.get("value")[s]);i.email===e&&(i.name!==t&&this._data.value.splice(s,1,n),o=!0),s++}o||this._data.value.push(n)}},{key:"removeEmail",value:function(e){this._data.email=_.difference(this.get("email"),[e]);for(var t=0;t<this._data.value.length;){Jane.FormValidation.contact2obj(this.get("value")[t]).email===e?this._data.value.splice(t,1):t++}}},{key:"getHeadEmail",value:function(){return this.get("email")[0]}},{key:"getPhone",value:function(){if(this.get("phone"))return{status:this.constructor.PHONE.FOUND,value:this.get("phone")};var e,t;if(!this.isContact()&&!this.isGroup()||this.hasInvalidEmail()||1!==this.get("email").length)return{status:this.constructor.PHONE.NOT_FOUND,value:null};if(this.isContact())t=ns.Model.get("abook-contact",{cid:this.get("cid"),shared:Boolean(Number(this.get("shared")))}),e=t.isValid()?t.getPhone():null;else if(this.isGroup()&&1===this.get("email").length){if(t=ns.Model.get("abook-contacts").getContactDataByEmail(this.getHeadEmail()),t=ns.Model.get("abook-contact",{cid:t&&t.cid,shared:t&&t.isShared||!1}),!t.isValid())return{status:this.constructor.PHONE.SHOULD_REQUEST,value:null};e=t.getPhone()}return e?{status:this.constructor.PHONE.FOUND,value:e}:{status:this.constructor.PHONE.NOT_FOUND,value:null}}},{key:"isGroup",value:function(){return Boolean(this.get("tid"))}},{key:"isContact",value:function(){return Boolean(this.get("cid"))}},{key:"hasExternalEmail",value:function(){return this._data.email&&this._data.email.some(Jane.FormValidation.checkExternalEmail)}},{key:"hasInvalidEmail",value:function(){return this._data.email&&!this._data.email.every(Jane.FormValidation.checkEmail.bind(Jane.FormValidation))}},{key:"getText",value:function(){return this.get("name")||this.getHeadEmail()}},{key:"getAvatar",value:function(){return{email:this._data.tid?this._data.tid:_.escape(this.getHeadEmail()),name:_.escape(this.getText()),href:!1,size:this.AVATAR_SIZE,className:"mail-Bubble-Avatar",isGroup:this.isGroup()}}}]),t})(Daria.BaseBubble),g.EMAIL_LEN_REQUEST=256,g.BUBBLE_CLASS="js-contact-bubble",g.PHONE={FOUND:"found",SHOULD_REQUEST:"should_request",NOT_FOUND:"not_found"},m=b))||m;Daria.ContactBubble=S},3933:function(e,t,n){function o(e){"@babel/helpers - typeof";return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){return!t||"object"!==o(t)&&"function"!=typeof t?a(e):t}function a(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function r(e){return(r=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function c(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function u(e,t,n){return t&&c(e.prototype,t),n&&c(e,n),e}function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&d(e,t)}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(e){return Jane.FormValidation.checkPhoneNumber(e)}function p(e){return Jane.FormValidation.splitPhones(e)}var f,m,g,b,v=n(1320),y={phone:null,value:null,email:null,name:null,cid:null,type:null,shared:null},C=(f=v({checkPaste:h,tokenizer:p}))((b=g=(function(e){function t(e){var n;s(this,t),n=i(this,r(t).call(this,e)),n.get("phone")||(n._data.phone=e.innerText);var o=n.get("phone");if(!n.get("cid")&&o){var a=ns.Model.get("abook-contacts").getContactDataByPhone(o);a&&(n._data.cid=a.cid,n._data.shared=Number(a.isShared))}var c=n.get("cid"),u=Boolean(Number(n.get("shared"))),l=c?ns.Model.get("abook-contact",{cid:c,shared:u}):ns.Model.get("abook-contact").findContactByPhone(o);return l&&l.isValid()&&(n._data.cid=c||l.get(".cid"),n._data.shared=n.get("shared")||Number(l.isShared()),n._data.email=n.get("email")||l.getHeadEmail(),n._data.name=n.get("name")||l.getName()),n._data.value=n.get("phone"),n}return l(t,e),u(t,[{key:"_fields",get:function(){return y}}]),u(t,[{key:"renderBubbleNode",value:function(){return ns.renderNode({isPhone:!0,isValid:this.isValidPhoneNumber(),avatar:Daria.Recipients.add(this.getAvatar()),text:this.getText()},"bubble-phone","compose2")}},{key:"needUpdate",value:function(){return!1}},{key:"isValidPhoneNumber",value:function(){return!this.getText()||Jane.FormValidation.checkPhoneNumber(this.getText())}},{key:"getAvatar",value:function(){return{email:_.escape(this._data.email),name:_.escape(this._data.name||this._data.email),href:!1,size:this.AVATAR_SIZE,className:"mail-Bubble-Avatar",isGroup:!1}}}]),t})(Daria.BaseBubble),g.BUBBLE_CLASS="js-phone-bubble",m=b))||m;Daria.PhoneBubble=C},3934:function(e,t){ns.action.define("yabble.change-email",(function(e,t){return Daria.Dropdown.closeAll(),ns.events.trigger(e,t),!0})),ns.action.copy("yabble.change-email","yabble.edit"),ns.action.copy("yabble.change-email","yabble.remove"),ns.action.copy("yabble.change-email","yabble.single-target"),ns.action.define("yabble.change-group",(function(e,t){return ns.events.trigger(e,t),!0})),ns.action.define("yabble.add-to-abook",(function(e,t){Jane.Services.run("#contacts",(function(){ns.View.create("abook-person-popup").open({where:$(window),how:{my:"center",at:"center",of:window,fixed:!0}},{email:[t.email],first_name:t.name,yabbleId:t.id})})),Daria.Dropdown.closeAll()}))},3935:function(e,t,n){function o(e){"@babel/helpers - typeof";return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}!(function(e,t){Daria.Yabble=function(e){var t=this;this.id=Daria.Yabble.genId(),this.value={},e&&this.val(e),this.root=$(Daria.Yabble.getHTML()),this.text=this.root.find(".js-yabble-content"),this.input=this.root.find(".js-yabble-input"),this.$smsLink=this.root.find(".js-sms-open-link"),this.$smsLink.on("click",(function(e){e.stopPropagation();var n=t.value;t.$smsLink.trigger("sms-link-click",n)})),this.$smsLink.on("dblclick",(function(e){e.stopPropagation()})),this.hideSmsLink(),Modernizr.msie&&this.root.on("selectstart",(function(e){t.focused||e.preventDefault()})),$.isEmptyObject(this.value)||this.pasteValue()},Daria.Yabble.KEY={UP:38,LEFT:37,RIGHT:39,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:44,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8,SHIFT:16,SEMI:59,SPACE:32,META:91,END:35,HOME:36,C:67,X:88,V:86,A:65,Z:90,ALT:18};var s=0,i={contact:"mail-Yabble_contact",group:"mail-Yabble_group",unreachable:"mail-Yabble_unreachable",external:"mail-Yabble_external",selected:"mail-Yabble_selected",focused:"mail-Yabble_focused"};Daria.Yabble.YC=i,Daria.Yabble.genId=function(){return s++},Daria.Yabble.getHTML=function(){return Daria.Yabble.template||(Daria.Yabble.template=$("<div></div>").html(Jane.tt("compose2:yabble"))),Daria.Yabble.template.html()},Daria.Yabble.template=null,Daria.Yabble.mergeContact=function(t,n){return"string"==typeof t&&(t=e.contact2obj(t)),"string"==typeof n&&(n=e.contact2obj(n)),n.email!==t.email?$.extend({},n):$.extend({},t,n)},Daria.Yabble.prototype={value:null,focused:!1,selected:!1,isContact:!1,isGroup:!1,isUnreachable:!1,isExternal:!0,doInput:function(e,t){var n=this.input[0];switch(e){case"focus":try{(t||document.activeElement!==n)&&(n.focus(),n.select())}catch(e){Jane.ErrorLog.sendException("activeElement",e)}break;case"enable":n.removeAttribute("disabled");break;case"disable":n.setAttribute("disabled","disabled")}},focus:function(){if(!this.focused&&!this.isGroup){this.deselect(!0),this.focused=!0;var t=e.obj2contact(this.value),n=this.value.name;this.doInput("enable"),this.doInput("focus"),t&&(this.text.text(t),this.input.val(t),Daria.setSelection(this.input[0],n?1:0,n?n.length+1:t.length)),this.root&&this.root.length&&(Modernizr.msie&&this.root.css("min-width",this.root.parent().width()-this.root.position().left-20),this.root.attr("draggable",""),this.root.addClass(i.focused))}},blur:function(e){this.focused&&(this.val(Daria.Yabble.mergeContact(this.value,this.getValue())),this.pasteValue(),e||this.doInput("disable"),this.root.attr("draggable","true"),Modernizr.msie&&this.root.removeAttr("style"),this.focused=!1)},select:function(){if(this.selected)return void this.doInput("focus");this.blur(!0),this.selected=!0,this.root.addClass(i.selected),this.doInput("enable"),this.doInput("focus")},deselect:function(e){this.selected&&(e||this.doInput("disable"),this.root&&(this.root.removeClass(i.selected),this.selected=!1))},validate:function(){this.value.email?(this.isUnreachable=!e.checkEmail(this.value.email),this.root.toggleClass(i.unreachable,this.isUnreachable),this.isExternal=e.checkExternalEmail(this.value.email),this.root.toggleClass(i.external,this.isExternal)):this.isUnreachable=!1},pasteValue:function(){var e=this.value.name||this.value.email,t=this.root.find(".js-yabble-avatar");if(t.length){var n={href:!1,size:20,className:"mail-Yabble__avatar"};this.value&&this.value.email&&(n.email=this.value.email,n.name=e),t.replaceWith(Daria.Recipients.add(n))}this.input.val(this.val()),this.text.text(e),this.root.removeClass(i.focused),this.isContact=Boolean(this.value.cid),this.isGroup=Boolean(this.value.tid),this.root.toggleClass(i.contact,this.isContact),this.root.toggleClass(i.group,this.isGroup),this.validate()},userVal:function(){return this.input.val()},getValue:function(){var e=this.input,t=e.data("suggest")||$.trim(this.userVal()).replace(/(?:,|;)$/,"");return e.removeData("suggest"),t},val:function(t){var n=Daria.Constants.CONTACTS.DELIMITER;if(void 0===t)return this.value.tid?$.map(this.value.contacts,(function(t){return!t.ignored&&e.obj2contact(t)||null})).join(n):e.obj2contact(this.value);"object"===o(t)?this.value=t:this.value=e.contact2obj(t)},showSmsLink:function(){this.$smsLink.removeClass("is-hidden")},hideSmsLink:function(){this.$smsLink.addClass("is-hidden")},destroy:function(){this.root.remove(),this.root=this.text=this.input=null},onkeypress:function(){this.focused&&this.text.text(this.userVal())},onkeyup:function(){this.focused&&this.text.text(this.userVal())}},n(3936)})(Jane.FormValidation)},3936:function(e,t){var n=".b-mail-dropdown__box__content_yabble-",o={timeout:null,request:null,delay:150,template:"compose2:yabble-dropdown",json:{},toggle:function(e){var t=$(n+e.id).is(":visible");o.close(e),t||(o.remove(e),this.yabble=e,this.getParams(),this.load())},close:function(e){"number"==typeof this.timeout?(clearTimeout(this.timeout),this.timeout=null):this.request?(this.request.notify("abort"),this.request=null):(Daria.Dropdown.closeCurrent(),e&&o.remove(e))},remove:function(e){$(n+e.id).remove()},getParams:function(){var e=this.yabble,t=e.id,n=e.value,o=_.escape(n.name||""),s=_.escape(n.email||"");switch(!0){case e.isPhone:this.params=null,this.handlers=null,this.template="compose2:yabble-dropdown-phone",this.json={email:s,id:t};break;case e.isContact:this.params={cid:n.cid},this.handlers=["abook-contact"],this.template="compose2:yabble-dropdown-contact",this.json={email:s,id:t};break;case e.isGroup:this.params={tid:n.tid},this.handlers=["abook-contacts"],this.template="compose2:yabble-dropdown-group",this.json={id:t,email:$.map(n.contacts,(function(e){return!e.ignored&&e.email||null}))};break;case e.isUnreachable:this.params=null,this.handlers=null,this.template="compose2:yabble-dropdown",this.json={id:t,name:o,email:s};break;case e.fromMessage:this.params=null,this.handlers=null,this.template="message:dropdown-contact",this.json={id:t,email:s,name:o,my:e.my,cid:e.cid};break;default:this.params=null,this.handlers=null,this.template="compose2:yabble-dropdown",this.json={id:t,email:s,name:o}}},load:function(){var e=this.delay;if(this.handlers){var t,n=$.now();this.request=ns.request(this.handlers,this.params).then((function(){e-=$.now()-n,t=!0,this.request=null,this.open(e<0?0:e)}),this),t&&(this.request=null)}else this.open(e)},initializeNanoislands:function(e){nb.init(e)},open:function(e){var t=this,o=this.yabble,s=n+o.id,i=$(Jane.tt(this.template,this.json,this.handlers,this.params));e="delay"in o?o.delay:e,this.initializeNanoislands(i),$(s).remove();var a=function(){t.timeout=null,Daria.Dropdown.toggle(null,{content:$(i).find(s),dropdown:t.yabble.root,handle:t.yabble.root}),o.value&&o.value.email&&ns.action.run("common.copy",{container:s,text:o.value.email,onmouseup:function(){$(document).trigger("b-mail-dropdown-closeall")},doNotCloseDropdown:!0})};e<0?a():this.timeout=setTimeout(a,e)}};Daria.YabbleDropdown=o},3937:function(e,t){!(function(){var e=Daria.Constants.CONTACTS.DELIMITER,t=Jane.FormValidation,n={onlyFirstEmail:!0,joinName:!0},o=function(e,t){this.options=$.extend({},{maxItems:Number.MAX_VALUE,yabbleCtor:Daria.Yabble,yabbleType:"contact"},t||{}),this.id=Daria.Yabble.genId(),this.ids={},this.yabbles=[],this.strVal="",this.root=e,this.wrapper=e.find(".js-yabbles-container"),this.input=e.find(".js-yabbles-controller"),this.init(),this.multi=new Daria.YabbleMulti(this),Daria.YabbleHistory.start(this)};o.actions=["yabble.change-email","yabble.change-group","yabble.edit","yabble.remove","yabble.add-to-abook","yabble.single-target"],o.yabbleEvents=["dblclick","paste","keydown","keypress","keyup","focusout","focusin"],o.directEvents=["mousedown","mouseup","click"],o.prototype={option:function(e,t){var n=arguments.length;if(1===n)return this.options[e];2===n&&(this.options[e]=t)},getEmails:function(){return _.uniq($.map(this.yabbles,(function(e){return e.value.email})).sort())},recalcStrVal:function(t){t=t||{};var n=[];$.each(this.yabbles,(function(e,t){n.push(t.val())})),this.strVal=$.map(n,(function(e){return e||null})).join(e),this.root.find("input[type=hidden]").val(this.strVal),t.silent||this.trigger("change")},init:function(){var e=this;this.input.focus((function(){e.focus()})),$.each(o.directEvents,(function(t,n){e["ondirect"+n]&&e.root.bind(n,(function(t){e.e=t,e["ondirect"+n].apply(e,arguments)}))})),$.each(o.yabbleEvents,(function(t,n){e._setYabbleEvent(n)})),this.onactionRef=function(){e.onaction.apply(e,arguments)},o.actions.forEach((function(t){ns.events.on(t,e.onactionRef)}))},ondirectmousedown:function(e){if(!Daria.isLeftButton(e))return e.preventDefault(),void(Modernizr.opera||Modernizr.msie?this.add().focus():setTimeout(function(){this.add().focus()}.bind(this),200));var t=this.find("fromEvent",e);this.clicked=!1,this.mousedownId=null,t&&(this.mousedownId=t.id,this.onmousedown&&this.onmousedown(e,t))},ondirectmouseup:function(e){if(Daria.isLeftButton(e)&&this.mousedownId){var t=this.find("fromEvent",e),n=this.find("id",this.mousedownId);this.onmouseup&&this.onmouseup(e,n),n!==t&&(this.onclick&&this.onclick(e,n),this.clicked=!0,this.mousedownId=null)}},ondirectclick:function(e){if(Daria.isLeftButton(e)){var t=this.find("fromEvent",e);if(this.mousedownId){var n=this.find("id",this.mousedownId);n!==t&&this.onmouseup&&this.onmouseup(e,n),this.onclick&&this.onclick(e,n),this.clicked=!0,this.mousedownId=null}t||this.clicked||($(e.target).hasClass("js-sms-open-link")||(this.directclick=!0),this.add().focus(),this.directclick=!1)}},onaction:function(e,t){if(t.id in this.ids){var n=this.find("id",t.id);switch(e){case"yabble.change-email":n.value.email=t.email,n.pasteValue(),this.recalcStrVal(),n.select();break;case"yabble.change-group":$.each(n.value.contacts,(function(e,n){n.cid===t.cid&&n.email===t.email&&(n.ignored=!n.ignored)})),this.recalcStrVal();break;case"yabble.edit":n.focus();break;case"yabble.single-target":this.trigger("single-target",n);break;case"yabble.remove":this.remove(n);break;case"yabble.add-to-abook":this.update(n,t.cid)}}},onclick:function(e,t){if(!t.focused){t.select()||Daria.YabbleDropdown.toggle(t)}},ondblclick:function(e,t){Daria.YabbleDropdown.close(),t.focus()},onfocusin:function(e,t){e=e||$.Event("focusin",{target:this.root[0]});var n=this;if(Daria.composeParams){var o=this.input.closest(".js-compose-mail-input_to").length>0;Daria.composeParams["field-to-focused"]=o}var s=this.option("suggest");s&&(s.changeInputField(t.input[0]),t.focused?(s.setOptions({hide:function(){s.options.yabble.blur()},disabled:!1,timeoutOfCopyToSms:!0,yabble:t,previousValues:n.val().split(/,\s*/)}),this.directclick&&(s.show(""),setTimeout(function(){this.directclick=!1}.bind(this)))):s.setOptions({disabled:!0,hide:_.noop})),t.id!==this.mousedownId&&Daria.YabbleDropdown.close(),this.input.attr("disabled","disabled"),this.root.trigger($.Event(e,{target:this.root[0]}))},onfocusout:function(e,n){var o=this;if(this.mousedownId!==n.id){var s=this.option("suggest");if(s){if(s.dontClose)return;s.setOptions({hide:_.noop}),s.hide()}var i=$.trim(n.userVal()).replace(/(?:,|;)$/,"");if(i||n.input.data("suggest"))if(n.focused){if(Daria.YabbleHistory.push(o),Daria.YabbleHistory.ignore=!0,i.indexOf(",")>-1||i.indexOf(";")>-1){var a=t.splitContacts(i),r=[];$.each(a,(function(e,t){r.push(o.add(t,n))})),this.remove(n),"contact"===this.options.yabbleType&&this.resolveContacts(a,r)}else n.blur(),this.recalcStrVal(),n.isContact||n.isGroup||n.isUnreachable||"contact"===this.options.yabbleType&&this.resolveContacts([n.value],[n]);Daria.YabbleHistory.ignore=!1}else n.selected&&n.deselect();else this.remove(n);this.input.removeAttr("disabled"),this.root.trigger($.Event(e,{target:this.root[0]}))}},onkeydown:function(e,t){var n=this;switch(e.which){case Daria.Yabble.KEY.TAB:!e.shiftKey&&this.options.maxItems>this.yabbles.length&&(t.focused&&$.trim(t.userVal())||t.selected)&&(e.preventDefault(),this.add().focus());break;case Daria.Yabble.KEY.RETURN:Daria.isCtrlPressed(e)||e.preventDefault(),this.multi.history.length>1?this.add().focus():$.trim(t.userVal())&&(t.focused?this.add().focus():(t.focus(),this.onfocusin(null,t)));break;case Daria.Yabble.KEY.BACKSPACE:case Daria.Yabble.KEY.DEL:if(this.multi.history.length>1)e.preventDefault(),this.multi.remove();else{var o=this.find(e.which===Daria.Yabble.KEY.DEL?"next":"prev",t),s=this.find(e.which===Daria.Yabble.KEY.DEL?"prev":"next",t);(t.focused&&!$.trim(t.userVal())&&(o||s)||t.selected)&&(e.preventDefault(),this.remove(t),o?o.select():s?s.select():this.add().focus())}break;case Daria.Yabble.KEY.LEFT:if(t.selected||t.focused&&!$.trim(t.userVal())){e.preventDefault();var i=this.find("prev",t);i&&i.select()}break;case Daria.Yabble.KEY.RIGHT:if(t.selected){e.preventDefault();var a=this.find("next",t);a?a.select():this.add().focus()}break;case Daria.Yabble.KEY.HOME:if(t.selected||t.focused&&!$.trim(t.userVal())){e.preventDefault();var r=this.find("first");r&&r.select()}break;case Daria.Yabble.KEY.END:if(t.selected){e.preventDefault();var c=this.find("last");c&&c.select()}break;default:if(t.focused)Daria.isCtrlPressed(e)&&!$.trim(t.val())&&(e.which===Daria.Yabble.KEY.A?this.multi.selectAll():e.which===Daria.Yabble.KEY.Z&&Daria.YabbleHistory.pop(this));else if(Daria.isCtrlPressed(e))switch(e.which){case Daria.Yabble.KEY.C:this.multi.onCtrlC(t);break;case 17:case 91:case 224:break;case Daria.Yabble.KEY.V:n.add().focus();break;case Daria.Yabble.KEY.X:n.multi.history.length&&(n.multi.onCtrlX(t),setTimeout((function(){n.multi.remove()}),16));break;case Daria.Yabble.KEY.A:this.multi.selectAll();break;case Daria.Yabble.KEY.Z:Daria.YabbleHistory.pop(this);break;default:n.add().focus()}else e.which!==Daria.Yabble.KEY.SHIFT&&this.add().focus()}},onkeypress:function(e,n){var o,s=this;switch(e.which){case Daria.Yabble.KEY.SPACE:case Daria.Yabble.KEY.SEMI:case Daria.Yabble.KEY.COMMA:if(o=n.userVal().replace(/[,;\s]/g,""),n.focused&&o){if(e.which===Daria.Yabble.KEY.SPACE&&!t.checkEmail(o))break;setTimeout((function(){s.add().focus()}),0)}else e.preventDefault()}},onpaste:function(e,t){var n=this;setTimeout((function(){n.add().focus(),t.isUnreachable&&(t.focus(),Daria.setSelection(t.input[0],9999))}),0)},add:function(e,t){if(this.options.maxItems<=this.yabbles.length){var n=this.find("last");return n&&n.input&&n.input.val()?(n.select(),this.recalcStrVal()):n&&n.focus(),{focus:$.noop}}var o=this.multi.wrap(new this.options.yabbleCtor(e)),s=t&&$.inArray(t,this.yabbles);return this.ids[o.id]=!0,e&&Daria.YabbleHistory.push(this),s>-1?(o.root.insertBefore(t.root),this.yabbles.splice(s,0,o)):(this.wrapper.append(o.root),this.yabbles.push(o)),o},showSmsYabble:function(){this.yabbles.forEach((function(e){e.showSmsLink&&e.showSmsLink()}))},hideSmsYabble:function(){this.yabbles.forEach((function(e){e.hideSmsLink&&e.hideSmsLink()}))},update:function(e,t){ns.request("abook-contact",{cid:t}).then((function(t){var o=t[0],s=o.getContactInfo(n);$.isEmptyObject(s)||(e.val(s),e.pasteValue()),e.select()}))},remove:function(e,t){var n=$.inArray(e,this.yabbles);if(-1!==n){Daria.YabbleHistory.push(this),this.yabbles.splice(n,1),delete this.ids[e.id],Daria.YabbleDropdown.close(e),e.destroy();var o=this.option("suggest");o&&o.destroy(),this.recalcStrVal(t)}},find:function(e,t){var n;if("fromEvent"===e)return(n=$(t.target).closest(".js-yabble",this.wrapper[0])[0])&&this.find("target",n);if("first"===e)return this.yabbles[0];if("last"===e)return this.yabbles[this.yabbles.length-1];for(var o=0;o<this.yabbles.length;o++)if(n=this.yabbles[o],"target"===e){if(n.root[0]===t)return n}else if("prev"===e||"next"===e){if(n===t){if("prev"===e)return this.yabbles[o-1];if("next"===e)return this.yabbles[o+1]}}else if("id"===e){if(n.id===t)return n}else if(n[e])return n},_setYabbleEvent:function(e,t){var n=this;t=t||this["on"+e],this.root.on(e,".js-yabble",(function(o){if(n.e=o,"focusout"!==e||"input"===o.target.tagName.toLowerCase()){var s=n.find("target",o.currentTarget);s&&(t&&t.call(n,o,s),s["on"+e]&&s["on"+e].call(s,o))}}))},resolveContacts:function(e,t){if(e.length){var o=this;t=t||this.yabbles;var s,i=1/0,a=[];e.forEach((function(e){e.email.length<256&&(i+=e.email.length+1,i>256&&(i=0,s=[],a.push(s)),s.push(e.email))})),a.forEach((function(s){var i=[],a=s.join(",");i.push({id:"abook-contacts",params:{emails:a}}),Daria.Config.workspace&&i.push({id:"abook-contacts",params:{emails:a,shared:1}}),ns.request(i).then((function(i){var a=!1,r=i[0].getContactsInfoByEmails(s,n),c=i[1]?i[1].getContactsInfoByEmails(s,_.extend({shared:!0},n)):[],u=c.concat(r);$.each(e,(function(e,n){var o=n.email,s=t[e];if(s&&s.value.email===o)for(var i=u.length;i--;)if(o===u[i].email)return a=!0,s.val(Daria.Yabble.mergeContact(u[i],s.value)),s.pasteValue(),!0})),a&&o.recalcStrVal()}))}))}},val:function(e){var n=this;if(void 0===e)return this.strVal;for(;this.yabbles[0];)this.remove(this.yabbles[0],{silent:!0});if("string"==typeof e&&e){var o;o="contact"===this.options.yabbleType?t.splitContacts(e):e.split(/[;\s]/),$.each(o,(function(e,t){n.add(t)})),"contact"===this.options.yabbleType&&(n.recalcStrVal(),n.resolveContacts(o))}else $.isArray(e)&&($.each(e,(function(e,t){n.add(t)})),"contact"===this.options.yabbleType&&(n.recalcStrVal(),n.resolveContacts(e)));Daria.YabbleHistory.ignore||Daria.YabbleHistory.start(this)},focus:function(e){e&&(this.directclick=!0),this.add().focus()},isFocused:function(){return _.some(this.yabbles,"focused",!0)},validate:function(){for(var e=this.yabbles.length;e--;)if(this.yabbles[e].isUnreachable)return!1;return!0},destroy:function(){var e=this;this.val(""),o.actions.forEach((function(t){ns.events.off(t,e.onactionRef)})),this.root.unbind(),this.input.unbind(),this.multi.destroy(),Daria.YabbleHistory.stop(this);var t=this.option("suggest");t&&t.destroy()}},no.extend(o.prototype,ns.Events),Daria.Yabbles=o})()},3938:function(e,t){!(function(){var e=Daria.Constants.CONTACTS.DELIMITER,t=Daria.Yabble.prototype,n=Daria.YabbleMulti=function(e){this.set=e,this.clear()};n.prototype={history:null,push:function(e){this.pop(e),this.history.push(e),this.focusLast=void 0},pop:function(e){for(var t=this.history.length;t--;)this.history[t]===e&&this.history.splice(t,1)},clear:function(){this.shiftFirst=void 0,this.focusLast=void 0,this.history=[]},first:function(){return this.history[0]},last:function(){return this.history[this.history.length-1]},val:function(){return $.map(this.history,(function(e){return e.val()})).join(e)},ids:function(){return $.map(this.history,(function(e){return e.id}))},wrap:function(e){var n=this;return e.deselect=function(){var e=n.set.mousedownId;if(!n.set.find("id",e)){var t=n.ids().join(",");setTimeout((function(){t===n.ids().join(",")&&n.deselectAll()}),0)}},e.select=function(){var o=n.set.e||{},s=Daria.isCtrlPressed(o),i=o.shiftKey,a=$.inArray(o.which,[Daria.Yabble.KEY.LEFT,Daria.Yabble.KEY.RIGHT])>-1;if(i&&(!a||0!==n.history.length)||s&&!a)return i?n.selectTo(e):e.selected?(n.pop(e),t.deselect.apply(e),n.last()&&t.select.apply(n.last())):(t.select.apply(e,arguments),n.push(e)),!0;n.deselectAll(),n.push(e),t.select.apply(this,arguments)},e.focus=function(){var o=n.set.find("prev",e);n.deselectAll(),setTimeout((function(){n.focusLast=o}),16),t.focus.apply(e,arguments)},e.destroy=function(){n.pop(e),t.destroy.apply(e,arguments)},e},onCtrlC:function(e){if(this.history.length>1){var t=this.val();e.input.val(t),e.doInput("focus",!0),e.input.one("keyup blur",(function(){e.root&&e.doInput("focus",!0)}))}},remove:function(){var e=this;Daria.YabbleHistory.push(this.set),Daria.YabbleHistory.ignore=!0,$.each(this.history.slice(),(function(t,n){e.set.remove(n)}));var t=e.set.add();t&&t.focus(),Daria.YabbleHistory.ignore=!1},selectAll:function(){var e=this,n=$.map(this.set.yabbles,(function(e){return e.selected?null:e}));$.each(n,(function(n,o){o&&!o.focused&&(t.select.apply(o),e.push(o))}))},selectTo:function(e){var n=this,o=this.shiftFirst||this.focusLast||this.last()||this.set.yabbles[0];this.deselectAll(),this.shiftFirst=o;for(var s=$.inArray(o,this.set.yabbles),i=$.inArray(e,this.set.yabbles),a=s>i?"prev":"next";o&&o!==e;)t.select.apply(o),n.push(o),o=this.set.find(a,o);t.select.apply(e),n.push(e)},deselectAll:function(){this.clear(),$.each(this.set.yabbles,(function(e,n){t.deselect.apply(n)}))},unwrap:function(e){},destroy:function(){this.clear()}},n.prototype.onCtrlX=n.prototype.onCtrlC})()},3939:function(e,t){!(function(){Daria.YabbleHistory={sets:{},history:{},ignore:!1,start:function(e){this.history[e.id]=[],this.sets[e.id]=e},stop:function(e){delete this.history[e.id]},key:function(e){return $.map(e,(function(e){return e.email||""})).join(",")},values:function(e){return $.map(e.yabbles,(function(e){return!$.isEmptyObject(e.value)&&$.extend({},e.value)||null}))},push:function(e,t){if(!this.ignore&&this.history[e.id]){var n=this.history[e.id],o=n[n.length-1],s=this.values(e),i=this.key(s);if(o&&o.key===i)t&&(o.link=t);else{var a={values:s,key:i};t&&(a.link=t),n.push(a)}}},pop:function(e){this.ignore=!0;var t=this.history[e.id];if(t&&t.length){var n=t.pop();e.val(n.values);var o=e.add();if(o&&o.focus(),n.link)for(var s in this.history){var i=this.history[s];i.length&&n.link===i[i.length-1].link&&this.pop(this.sets[s])}}this.ignore=!1}}})()},3940:function(e,t){function n(e){"@babel/helpers - typeof";return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}Daria.YabblePhone=function(){Daria.Yabble.apply(this,arguments)},Jane.extend(Daria.YabblePhone,Daria.Yabble),Daria.YabblePhone.prototype.validate=function(){var e=this.value;e?(this.isUnreachable=!Jane.FormValidation.checkPhoneNumber(e),this.root.toggleClass(Daria.Yabble.YC.unreachable,this.isUnreachable)):this.isUnreachable=!1},Daria.YabblePhone.prototype.blur=function(e){this.focused&&(this.val(this.getValue()),this.pasteValue(),e||this.doInput("disable"),this.root.attr("draggable","true"),Modernizr.msie&&this.root.removeAttr("style"),this.focused=!1)},Daria.YabblePhone.prototype.val=function(e){if(void 0===e)return this.value;"object"===n(e)?this.value=e.phone:this.value=e},Daria.YabblePhone.prototype.pasteValue=function(){var e=this.value;this.input.val(this.val()),this.text.text(e),this.root.removeClass(Daria.Yabble.YC.focused),this.isContact=!0,this.isPhone=!0,this.isGroup=!1,this.root.toggleClass(Daria.Yabble.YC.contact,this.isContact),this.root.toggleClass(Daria.Yabble.YC.group,this.isGroup);var t=this.root.find(".js-yabble-avatar");t.length&&t.replaceWith(Daria.Recipients.add({href:!1,size:20,className:"mail-Yabble__avatar"})),this.validate()}},3941:function(e,t){!(function(){if("ontouchend"in window&&/iPad|iPhone/.test(navigator.userAgent)){var e=Daria.Yabble.KEY,t=Daria.Yabbles;t.directEvents=["touchend"];var n=t.prototype.onkeydown;$.extend(t.prototype,{ondirecttouchend:function(e){var t=this.find("fromEvent",e);if(t&&this.onclick&&(!t.focused||t.userVal()))this.onclick(e,t);else{var n=this.add();n&&n.focus()}},onkeydown:function(t,o){if(t.which===e.BACKSPACE||t.which===e.DEL){var s=this.find(t.which===e.DEL?"next":"prev",o),i=this.find(t.which===e.DEL?"prev":"next",o);if(o.focused&&!$.trim(o.userVal())&&(s||i))t.preventDefault(),s?this.remove(s):i&&this.remove(i);else if(o.selected)if(t.preventDefault(),this.remove(o),s)s.select();else if(i)i.select();else{var a=this.add();a&&a.focus()}}else n.apply(this,arguments)}})}})()},3942:function(e,t,n){n(3943),n(3944),n(3945),n(3946),n(3947),n(3948),n(3949),n(3950),n(3951),n(3953),n(3955),n(3956),n(3957),n(3958),n(3959),n(3960),n(3961),n(3962),n(3963),n(3964),n(3965),n(3966)},3943:function(e,t){!(function(){ns.Model.define("do-attach-file-status",{params:{oid:null}})})()},3944:function(e,t){!(function(){ns.Model.define("do-attach-file-store",{params:{file:null,checkLimit:null,size:null}})})()},3945:function(e,t){!(function(){var e=ns.ModelStatic,t=["attachments.added","attachments.appended","attachments.updated","attachments.removed","attachments.failed"];ns.Model.define("compose-attachments",{params:{ids:null,tids:null,oper:null},ctor:function(){this._attachments=null,this.processCollectionEvent=this.processCollectionEvent.bind(this)},methods:{canRequest:function(){var e=this.super_.canRequest.call(this),t=!this._mComposeMessage||this._mComposeMessage.canRequest();return e&&t},request:function(){var e=this,t=ns.Model.info("message-body").calculateParamsForMessageBody(this.params);return t?ns.request(["message-body","compose-message"],t).then((function(t){e._initByModels(t[0],t[1])})):(e.setData({}),vow.resolve())},init:function(e){this._attachments?this._attachments.setOptionsAndInit(e):(this._attachments=new Daria.AttachmentCollection2(e),this.bindEventsToAttachments())},_initByModels:function(e,t){this.setData({}),this._mMessageBody=e,this._mComposeMessage=t;var n=new Daria.AttachmentCollection2;n.mComposeMessage=t,this._attachments=n,this.bindEventsToAttachments(),t.isReplyAny()||e.getAttachments().forEach((function(e){e.inline||this.addAttachData(e)}),this)},addAttachData:function(e,t){if(this._attachments){var n=t&&t.mMessageBody?t.mMessageBody:this._mMessageBody,o=t&&t.mComposeMessage?t.mComposeMessage:this._mComposeMessage,s=Daria.Attachment2.fromMessageBody(e,n,o);return this._attachments.addAttachToCollection(s,{silent:!0,processAttachSize:!0}),s}},destroy:function(){e.prototype.destroy.apply(this,arguments),this.unbindEventsFromAttachments(),this._attachments&&(this._attachments.reset(),this._attachments=null)},bindEventsToAttachments:function(){this._attachments&&_.each(t,(function(e){this._attachments.on(e,this.processCollectionEvent)}),this)},unbindEventsFromAttachments:function(){this._attachments&&_.each(t,(function(e){this._attachments.off(e,this.processCollectionEvent)}),this)},processCollectionEvent:function(e,t){this.trigger("ns-model:"+e,t)},addAttach:function(e){this._attachments&&(e.resource?this._attachments.addDiskAttach(e.id,e.resource):this._attachments.add(e.input,e.files))},appendAttach:function(e,t,n){this._attachments&&this._attachments._appendAttach(e,t,n)},drawAttaches:function(){if(this._attachments){var e=this.params.ids||Daria.getPageComposeIds();this._attachments.redrawAttachesBulk(null,e)}},updateAfterSave:function(e,t){this._attachments&&this._attachments.updateAfterSave(e,t,!0)},isUploading:function(){return this._attachments&&this._attachments.isUploading()},isFailed:function(){return!!this._attachments&&this._attachments.isFailed()},hasFiles:function(){return this._attachments&&this._attachments.hasFiles()},retryAttach:function(e){this._attachments.retryAttach(e)},getSummary:function(){return this._attachments.getSummary()}}})})()},3946:function(e,t){!(function(){ns.Model.define("disk-default-folders",{methods:{isPhotostream:function(e){return e&&this.get(".photostream")===e}}})})()},3947:function(e,t){!(function(e,t){function n(e){e.meta&&e.meta.sizes&&$.each(e.meta.sizes,(function(n,i){var a=t.Config["downloader-domain-zone"];"mail"===e.service?-1===i.url.indexOf("yandex.net")&&(i.url=s(i.url,a)):"ua"===a&&(i.url=s(i.url,"ru")),i.url=o(i.url)}))}function o(e){return e.replace(r,"")}function s(e,t){var n=e.match(/(?:(?:https?\:)?\/\/)?[^\/]*/g)[0];return e.replace(n,n.replace(a,t))}var i=null;ns.Model.define("disk-resources",{params:{path:null,offset:null,sort:null,order:null},methods:{cancelledAttachPaths:[],getDefaultSort:function(e){return ns.Model.get("disk-default-folders").isPhotostream(e)?"etime":"name"},removeAttach:function(e){this.cancelledAttachPaths.push(e)},getDefaultOrder:function(e){return ns.Model.get("disk-default-folders").isPhotostream(e)?"0":"1"},deselect:function(){var e=i;i=null,ns.events.trigger("disk-resources.selected",{before:e})},select:function(e){if(e&&e!==i){var t=i;i=e,ns.events.trigger("disk-resources.selected",{before:t,now:e})}},getSelected:function(){return i},extractError:function(e){return 404===Number(jpath(e,".error.http_status")[0])?(ns.events.trigger("disk-resources.not-found",e.error),e.data={},null):e.error},preprocessData:function(e){var t=jpath(e,".resource.resource")[0];if(Array.isArray(t)){if(t.forEach(n),this.params.hasOwnProperty("offset")){var o=$.extend({},this.params);delete o.offset;var s=ns.Model.get(this.id,o),i=s.getData();if(i){var a=no.jpath(".resource",i)[0];a&&(Array.prototype.push.apply(a.resource,t),s.__offset=t.length+(s.__offset||0))}else s.setData(e),s.__offset=t.length;return s.__complete=0===t.length,e}this.__offset=t.length,this.__complete=0===t.length}return e},getPreview:function(e){var t=$.Deferred(),n={private_hash:e,meta:"preview"};return ns.request("do-disk-get-public-preview",n).then((function(e){var n=jpath(e[0].getData(),".resource.meta.preview")[0];n?t.resolve(n):t.reject("no disk preview")}),(function(){t.reject()})),t.promise()},attach:function(e,t){var n=$.Deferred(),o=this;return (function(e,t){ns.forcedRequest("do-disk-attach-file",{src:e,dst:t}).then((function(t){var s=t[0];if(s.getError())ns.Model.invalidate(o.id),n.reject(s.getError());else{var i=s.getData();if(i&&i.oid){var a={oid:i.oid,meta:"short_url,public,size,public_hash"};o.poll(a,e).done((function(e){var t=e.file||e.folder;t.type=e.file?"file":"dir",n.resolve({url:t.meta&&t.meta.short_url,name:t.name,type:t.type,size:t.meta&&t.meta.size,hash:t.meta&&t.meta.public_hash})})).fail((function(e){n.reject(e)}))}else n.reject("disk-attach-file: no data oid")}}),(function(e){ns.Model.invalidate(o.id),n.reject(e.data||e)}))})(e,t),n.promise()},poll:function(e,t){function n(){ns.forcedRequest("do-attach-file-status",e).then((function(e){var a=e[0],r=jpath(a.getData(),".operation")[0];if(!r)return o.reject("attach file status: unknown operation");if(-1!==i.cancelledAttachPaths.indexOf(t))return _.remove(i.cancelledAttachPaths,t),o.reject("attach file status: uknown resourceId");var c=r.status;"EXECUTING"===c||"WAITING"===c?window.setTimeout(n,s):"FAILED"===c?o.reject(c.error):"DONE"===c&&o.resolve(r)}),(function(){o.reject()}))}var o=$.Deferred(),s=1500,i=this;return n(),o.promise()},loadMore:function(e){var t=$.Deferred(),n=$.extend({},e);delete n.offset;var o=ns.Model.get(this.id,n);return o.__complete?t.reject():(ns.forcedRequest("disk-resources",$.extend({offset:o.__offset},n)).then((function(e){var n=e[0],o=no.jpath(".resource.resource",n.getData())[0];if(o){var s=o[0];if(s)return t.resolve(s)}t.reject("disk-resources: no resource")}),(function(){t.reject()})),t.promise())},find:function(e){var n=t.utils.dirname(e)+"/",o=ns.Model.get(this.id,{path:n,sort:this.getDefaultSort(n),order:this.getDefaultOrder(n)});if(!o.getData()||!o.get(".resource")||!o.get(".resource")[0])return!1;for(var s=o.get(".resource")[0],i=0,a=s.resource.length;i<a;i+=1)if(s.resource[i].id===e)return s.resource[i];return!1}}});var a=new RegExp("("+t.Config.domainZonesForReg+"|([^\\.]+)$)"),r=/^(https?:)/})(Jane,Daria)},3948:function(e,t){!(function(){ns.Model.define("do-disk-attach-file",{params:{dst:null,src:null}})})()},3949:function(e,t){!(function(){ns.Model.define("do-disk-get-public-preview",{params:{private_hash:null,meta:null}})})()},3950:function(e,t){!(function(){var e={IS_OPTION_SET:"no_reply_notify",TIME_DELTA:"no_reply_notify_time",WAS_FIRST_VISIT_POPUP_SHOWN:"noreply_popup_shown"},t=[{time:{hours:1}},{time:{hours:12}},{time:{days:1}},{time:{days:2}},{time:{days:3}},{time:{days:5},default:!0},{time:{weeks:1}},{time:{weeks:2}}];ns.Model.define("compose-notify-noreply-options",{params:{ids:null,oper:null},methods:{request:function(){var e=this._constructModelRequest();return ns.request(e).then(this._initFromModels,this)},_constructModelRequest:function(){return[{id:"settings"}]},_initFromModels:function(e){this.mSettings=e[0],this.setData({enabledNotify:!1,alwaysNotify:!1,currentTimeDelta:null,timeDeltaItems:this._generateTimeDeltaItems(t)}),this.initData()},_getTimeDeltasUnitToStore:function(){return"seconds"},_generateTimeDeltaItems:function(e){var t=this.mSettings.getSetting("no_reply_notify_time"),n=this._getTimeDeltasUnitToStore(),o=Boolean(this.isSetInSettings()&&t);return t=t?parseInt(t,10):0,e=_.clone(e,!0),_.map(e,(function(e){var s=!1,i=Daria.timify(e.time,n);return o?s=i===t:e.default&&(s=!0),_.extend(e,{value:Daria.timify(e.time,n),text:Jane.Date.daysIntervalLocalization(e.time,!0),selected:s})}))},getCurrentTimeDelta:function(){return this.get(".currentTimeDelta")},setCurrentTimeDelta:function(e){e=this.findTimeDeltaItem(e),e||(e=this.getDefaultTimeDeltaItem()),this.set(".currentTimeDelta",e),this.set(".enabledNotify",!0)},getCurrentTimeDeltaLocalizedText:function(){var e=Jane.Date.daysIntervalLocalization(this.getCurrentTimeDelta().time);return i18n("%Compose_Checkbox_No_Reply_Active_Text_3",e)},findTimeDeltaItem:function(e){var t=e;return e&&e.value&&(t={value:Number(e.value)}),_.find(this.get(".timeDeltaItems"),t)},getSelectedTimeDeltaItem:function(){return this.findTimeDeltaItem({selected:!0})},getDefaultTimeDeltaItem:function(){return this.findTimeDeltaItem({default:!0})},isSetInSettings:function(){return Boolean(this.mSettings.isSet(e.IS_OPTION_SET))},setAlwaysNotifyOption:function(t){var n={};t?(n[e.IS_OPTION_SET]=!0,n[e.TIME_DELTA]=this.getCurrentTimeDelta().value,this.set(".alwaysNotify",!0),this.set(".enabledNotify",!0)):(n[e.IS_OPTION_SET]=!1,this.set(".alwaysNotify",!1)),this.mSettings.setSettings(n)},wasFirstVisitPopupShown:function(){return this.mSettings.isSet(e.WAS_FIRST_VISIT_POPUP_SHOWN)},setFirstVisitPopupWasShown:function(){this.mSettings.setSettingOn(e.WAS_FIRST_VISIT_POPUP_SHOWN)},initData:function(){this.set(".currentTimeDelta",this.getSelectedTimeDeltaItem()),this.set(".enabledNotify",this.isSetInSettings()),this.set(".alwaysNotify",this.isSetInSettings())}}})})()},3951:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(3952);!(function(){var e=Daria.Constants.CONTACTS.DELIMITER,t=Vow.resolve();ns.Model.define("compose-predefined-data",{events:{"ns-model-init":"_onInit"},params:{},methods:{request:function(){return t},_replaceParams:{mailto:"to",body:"send",subject:"subj"},_pickableParams:["to","cc","bcc","save_symbol","send","subj","qrText"],_normalizableParams:["to","cc","bcc"],_onInit:function(){var e=this._createDataFromUrl();this.setData(e),_.isEmpty(e)||this._cleanUrl()},_replaceParamsCallback:function(e,t){this.hasOwnProperty(t)&&(this[e]=this[t],delete this[t])},_createDataFromUrl:function(){return Daria.isComposePage()?this.extractDataFromParams(ns.page.current.params):{}},extractDataFromParams:function(t){var n=_.clone(t);_.forEach(this._replaceParams,this._replaceParamsCallback,n),_.forEach(this._normalizableParams,(function(t){var o=n[t];if(o){var s=Jane.FormValidation.splitContacts(o);s.forEach((function(e){Jane.FormValidation.reEmail.test(e.name||"")&&(e.name=e.email)}));var i=_.map(s,Jane.FormValidation.obj2contact);n[t]=i.join(e)}}));var o=_.pick(n,this._pickableParams);return o.send&&(o.send=this._getBody(o.send)),o.qrText&&(o.qrText=this._getBody(o.qrText)),o},_getBody:function(e){return this._shouldReturnPlainText()?this._isHtml(e)?Daria.Html2Text.html2text(e):e:this._isHtml(e)?o.a.sanitize(e):o.a.sanitize(_.escape(e).replace(/(?:\r\n|\r|\n)/g,"<br>"))},_isHtml:function(e){var t=(new DOMParser).parseFromString(e,"text/html");return Array.from(t.body.childNodes).some((function(e){return 1===e.nodeType}))},_shouldReturnPlainText:function(){return Daria.UA.isMobile},_cleanUrl:function(){var e=this._pickableParams.concat(Object.keys(this._replaceParams)),t=_.omit(ns.page.current.params,e);ns.page.replacePage(ns.page.current.page,t)}}})})()},3953:function(e,t,n){"use strict";function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Object.defineProperty(t,"__esModule",{value:!0});var a=n(3954),r=n(785),c=n(1269),u=n(1282),l=n(366),d=(n.n(l),n(139));n.n(d);!(function(){var e=Daria.Constants.CONTACTS.DELIMITER,t={att_ids:null,bcc:"",captcha_entered:null,captcha_key:null,cc:"",charset:null,confirm_limit:null,current_folder:null,doit:null,errors:{to:"",cc:"",bcc:"",phone:""},fid:null,from_mailbox:null,from_name:null,get_abook:null,html:null,idcs:null,ids:[],ign_overwrite:null,initial_cc:"",initial_to:"",inreplyto:null,lids:[],mark_as:null,mark_ids:[],disk_att:null,nosave:null,nosend:null,notify_on_send:null,overwrite:null,parts:null,phone:null,references:null,remind_period:null,"recipients-diff":{added:[],removed:[]},retpath:null,returl:null,saveDraft:null,save_symbol:d.WellKnownFolderSymbol.DRAFT,send:"",send_time:null,store_fid:null,store_name:null,strict_charset:null,style:null,subj:null,to:"",ttype:null,where:null,withUpdatedUndoAndDelayedErrorHandling:"yes"},n=["to","cc","bcc","phone","subj","send","from_mailbox","from_name","ttype","att_ids","parts","disk_att","save_symbol","lids"],o=_.map(n,(function(e){return"."+e})),i=ns.Model;ns.Model.define("compose-message",{params:{ids:null,tids:null,oper:null},events:{"ns-model-destroyed":"_onDestroyed","ns-model-changed.to":"_onRecipientsChanged","ns-model-changed.cc":"_onRecipientsChanged","ns-model-changed.bcc":"_onRecipientsChanged"},ctor:function(){this._attachments={},this.mSettings=null,this.mComposePredefinedData=null,this.mMessage=null,this.mMessageBody=null,this.mComposeState=null,this._saveDraftPromise=null,this._cancelled=!1,this._cancelSendCallback=null,this._isIgnoreUndo=!1,this._syncService=new r.b},methods:{_onDestroyed:function(){this._isDirty=!1,this._cancelled=!1,this._cancelSendCallback=null,this._isIgnoreUndo=!1},setIfChanged:function(e,t){if(this.isValid()&&this.data){var n=!0;if(-1!==[".to",".cc",".bcc"].indexOf(e)){var o=/,\s*$/;n=this.get(e).replace(o,"")!==t.replace(o,"")}n&&ns.Model.prototype.setIfChanged.apply(this,arguments)}},_dataPathToActionLogName:{".to":"редактирование письма/получатель (To:)",".subj":"редактирование письма/тема",".send":"редактирование письма/текст",".parts":"редактирование письма/аттачи",".disk_att":"редактирование письма/аттачи",".parts_json":"редактирование письма/аттачи"},set:function(e,t){if(!_.isEqual(t,this.get(e))){_.contains(o,e)&&(this._isDirty=!0);var n=Daria.SendMail.getUndoSendLogger(this.params.ids),s=this._dataPathToActionLogName[e];return s&&n.logActionOnceAfterCancel(s),i.prototype.set.apply(this,arguments)}},setData:function(){return this._isDirty=!0,i.prototype.setData.apply(this,arguments)},setPhoneIfExist:function(e,t){if(!this.get(".phone")||t){var n=ns.Model.get("abook-contacts").getContactDataByEmail(e);if(n&&n.cid){var o=ns.Model.get("abook-contact",{cid:n.cid,shared:n.isShared}),s=o.isValid()&&o.getPhone();return s&&this.setIfChanged(".phone",s),vow.Promise.resolve()}return ns.request("abook-contact",{email:e}).then((function(e){var t=e[0],n=t.getPhone();n&&this.setIfChanged(".phone",n)}),this)}},setSingleRecipient:function(e){this.setIfChanged(".to",e),this.setIfChanged(".cc",""),this.setIfChanged(".bcc","")},canRequest:function(){var e=ns.Model.infoLite("message-body").calculateParamsForMessageBody(this.params),t=ns.Model.get("message-body",e),n=ns.Model.get("signs");return t.canRequest()&&!t.get(".error")&&n.status!==ns.M.STATUS.ERROR},request:function(){var e=this;return Daria.requestModelsForCompose(this.params).then((function(t){return e._initFromModels(t)}))},isDraft:function(){return this.composeParamsService.isDraft()},getMessageType:function(){return this.composeParamsService.getMessageType()},getDraftMid:function(){var e=this.get(".overwrite");if(this.isDraft()&&e)return e},getTemplateMid:function(){var e=this.get(".overwrite");if(this.isTemplate()&&e)return e},_constructModelRequest:function(){var e=[{id:"settings"},{id:"compose-predefined-data"}];return this.params.ids&&_.isString(this.params.ids)&&!this.params.tids&&e.push({id:"message",params:{ids:this.params.ids}},{id:"message-body",params:ns.Model.infoLite("message-body").calculateParamsForMessageBody(this.params)}),e},_prepareDataForSet:function(e){var n=_.extend(_.cloneDeep(t),this.mComposePredefinedData.getData(),e,this._customizerPrepareData),o=Object(r.c)(n),i=s({},n,{},o);return this.mComposePredefinedData.destroy(),i},_customizerPrepareData:function(e,t,n){return"send"===n?t||e:t},_initFromModels:function(e){this.mMessage=_.find(e,"id","message"),this.mSettings=_.find(e,"id","settings"),this.mMessageBody=_.find(e,"id","message-body"),this.mComposePredefinedData=_.find(e,"id","compose-predefined-data"),this.mComposeState=ns.Model.get("compose-state",this.params);var t=this.mComposePredefinedData.getData();this.composeParamsService=new r.a(this.params,t),this.composeParamsService.newMessageId=Object(u.a)(e);var n=this.composeParamsService.getComposeMessageData();this.needCollapsedQuotedMessage()&&(n.send="",n.collapsedMessage=!0);var o=this._prepareDataForSet(n);this.setData(o),this.markSaved(),this.composeParamsService.data=this.data},isMessageCollapsed:function(){return Boolean(this.get(".collapsedMessage"))},needCollapsedQuotedMessage:function(){return!Daria.isComposePage()},expandMessage:function(){this.isMessageCollapsed()&&(this.isReplyAny()&&this.set(".send",this.getSendMessage()),this.set(".collapsedMessage",!1))},getSendMessage:function(){var e=this.get(".send");if(this.isMessageCollapsed()&&this.isReplyAny()){var t=this.get(".ttype"),n=this.get(".from_mailbox");e+=this.mMessageBody.getReplyBody(t,n)}return e},isHtmlType:function(){return"html"===this.get(".ttype")},isDirty:function(){return this._isDirty},wasSendCancelled:function(){return this._cancelled},setDirty:function(e){this._isDirty=e},setSendWithoutUndo:function(){this._isIgnoreUndo=!0},markSaved:function(){this._isDirty=!1},changeRecipientsToOpposite:function(){var e=this.isReplyAll(),t={to:this.get(".to"),cc:this.get(".cc")},n=this.mMessageBody.getRecipients(e),o=this.mMessageBody.getRecipients(!e);this.set(".to",this._calculateOppositeRecipients(t.to,n.to,o.to)),this.set(".cc",this._calculateOppositeRecipients(t.cc,n.cc,o.cc))},_extractEmailsFromContacts:function(e){return _(e).pluck("email").compact().value()},_calculateOppositeRecipients:function(e,t,n){e=Jane.FormValidation.splitContacts(e),t=Jane.FormValidation.splitContacts(t),n=Jane.FormValidation.splitContacts(n);var o=this._extractEmailsFromContacts(t),s=_.filter(e,(function(e){return!_.contains(o,e.email)})),i=this._extractEmailsFromContacts(s),a=_.filter(n,(function(e){return!_.contains(i,e.email)}));return Daria.formatContacts([].concat(s,a))},_checkData:function(){return a.a.validate(this)},storeErrors:function(e){_.each(e,(function(e,t){this.setIfChanged(".errors."+t,e)}),this),this.triggerFieldErrors(e)},triggerFieldErrors:function(e){this.trigger("ns-model:validation-error",e)},cleanErrors:function(){_.each(["to","cc","bcc","phone","att_ids"],(function(e){this.setIfChanged(".errors."+e,"")}),this)},getFieldError:function(e){return this.get(".errors."+e)},confirmations:Daria.ComposeComponents.confirmations.getConfirmations(),checkConfirmations:function(){var e=!1,t={};return _.each(this.confirmations,(function(n){return!(e=n(this,t))}),this),e&&this.trigger("ns-model:need-to-confirm:"+e,t),e},hasAttach:function(){return!_.isEmpty(this._attachments)||this.get(".ids").length},_getAttributeFromData:function(e,t){return _(e).pluck(t).compact().value()},_excludeFromProperty:function(e,t){return _.without(this.get("."+e),t)},addAttachment:function(e,t){this._attachments[e.info.id]=e,this._saveAttachmentData(),t&&this._savePartsJsonAttachmentData()},removeAttachment:function(e){delete this._attachments[e],this._saveAttachmentData()},addTextFromMessageBody:function(e){var t=this.get(".ttype"),n=e.getComposeHTML();"html"===t?n+="<br>":n=Daria.Html2Text.html2text(n)+"\n";var o=this.get(".send");this.set(".send",n+o)},addAttachmentsFromTemplateMessageBody:function(e){var t=ns.Model.get("compose-attachments",this.params);e.getAttachments().forEach((function(n){if(!n.inline){n=_.extend({},n,{from_template:!0,template_mid:e.params.ids,template_hid:n.hid}),delete n.hid;var o=t.addAttachData(n,{mMessageBody:e,mComposeMessage:this});o.mComposeMessage.addAttachment(o,!0),t.appendAttach(o,!0)}}),this)},setRecepientsFromMessageBody:function(e){var t=this;["to","cc","bcc"].forEach((function(n){var o=e.getAddressField(n);o&&t.set("."+n,o)})),this.mComposeState.set(".isCcVisible",Boolean(this.get(".cc"))),this.mComposeState.set(".isBccVisible",Boolean(this.get(".bcc")))},addForwardedMessages:function(e){if("forwarded"===this.get(".mark_as")){e=$.makeArray(e);var t=_.uniq(this.get(".mark_ids").concat(e));this.set(".mark_ids",t);var n=_.uniq(this.get(".ids").concat(e));this.set(".ids",n)}},removeForwardedMessages:function(e){if("forwarded"===this.get(".mark_as")){e=$.makeArray(e);var t=_.difference(this.get(".mark_ids"),e);this.set(".mark_ids",t);var n=_.difference(this.get(".ids"),e);this.set(".ids",n)}},_saveAttachmentData:function(){var e=_.map(this._attachments,(function(e){return Object(c.a)(e.info,e.status)}));this.set(".att_ids",this._getAttributeFromData(e,"att_id")),this.set(".parts",this._getAttributeFromData(e,"hid"));var t=this._getAttributeFromData(e,"disk"),n=t.length?JSON.stringify(t):"";this.set(".disk_att",n)},_savePartsJsonAttachmentData:function(){var e=_.map(this._attachments,(function(e){return Object(c.a)(e.info,e.status)}));this.set(".parts_json",this._getPartsJsonFromAttachmentData(e))},_getPartsJsonFromAttachmentData:function(e){var t=_.filter(e,"from_template").map((function(e){return{mid:e.template_mid,hid:e.template_hid}}));return t.length>0?JSON.stringify(t):""},_getCommonSendParams:function(){var e={};return ns.request.addRequestParams(e),e},_updateDataAfterSave:function(e){this.set(".ign_overwrite","no"),e.storedmid&&this.set(".overwrite",e.storedmid),e.store_fid&&this.set(".current_folder",e.store_fid),this.composeParamsService.data=this.data},_processSaveResponse:function(e){var t,n=e.storedmid||this.getDraftMid();if(n&&this.mMessage){t=this.mMessage.get(".mid");var o=ns.Model.get("message-draft",{ids:this.mMessage.params.ids});o.isValid()&&o.setIfChanged(".mid",n)}if(!e.storedmid||this.inNotInitedState())return this.isDraft()?e.storedmid?this._syncService.updateDraftAfterAction(!0,e.storedmid):this._syncService.updateFolders(d.DraftLikeFoldersShort):this.isTemplate()&&this._syncService.updateFolders(d.DraftTemplateLikeFoldersShort),vow.Promise.reject(e.storedmid?"no response mid":"leave compose");if(this._updateDataAfterSave(e),this.isDraft())this._syncService.updateDraftAfterAction(!0,this.getDraftMid());else if(this.isTemplate()){this._syncService.updateTemplateAfterAction(this.getTemplateMid());var s=this.getTemplateMid();ns.events.trigger("daria:mComposeMessage:template-saved",{oldMid:t,mid:s})}return this.markSaved(),this.trigger("ns-model:draft-saved",{mid:e.storedmid,attachments:e.attachment}),e},_processSendResponse:function(e){var t=no.jpath(".limited.recipient",e);t&&this.set(".limited",this._parseLimited(t));var n=no.jpath(".message_id",e);n&&this.set(".sentMessageId",n);var o=no.jpath(".storedmid",e);o&&this.set(".sentMid",o),this._syncService.updateDraftAfterAction(!1,this.getDraftMid()),this._syncService.updateMessageFlagsAfterSend(this.get(".mark_ids"),{isForward:this.isForward(),isReply:this.isReplyAny(),replyMessageId:this.get(".inreplyto")})},_parseLimited:function(t){var n=[],o=[],s={},i=function(e,t){n.push(t.limit),o.push("<"+t.login+"@"+t.$t+">")};return $.isArray(t)?($.each(t,i),n.sort(),s.recipients=o.join(e)):(i(0,t),s.recipient=o[0]),s.limit=Jane.getHumanSize(n[0]),s},isTemplate:function(){return this.composeParamsService.isTemplate()},isNewMessage:function(){return!this.params.ids},isForward:function(){return this.composeParamsService.isForward()},isReplyAll:function(){return this.composeParamsService.isReplyAll()},isReply:function(){return this.composeParamsService.isReply()},isReplyAny:function(){return this.composeParamsService.isReplyAny()},isNewTemplate:function(){var e=!1;return this.mMessage||this.get(".save_symbol")!==d.WellKnownFolderSymbol.TEMPLATE||(e=!0),e},isAutosaveEnabled:function(){return!this.isTemplate()&&(Daria.isReactiveCompose()||this.mSettings.isSet("enable_autosave"))},withUndo:function(){var e=Daria.SendMail.getUndoSendTime();return!this._isIgnoreUndo&&e>0},_prepareDataForMailSend:function(e,t){if(e=_.omit(e,["errors","recipients-diff"]),e.current_time=Math.floor(Daria.now()/1e3),t?(e.lids=_.filter(e.lids,_.negate(this._systemLabelFilter),this),e.remind_period=null,e.send_time=null):(this.isTemplate()&&(e.ign_overwrite="yes"),this.withUndo()&&!this.isDelayed()&&(e.send_time=Daria.SendMail.getUndoSendTime(),e.relative=!0)),Daria.IS_CORP&&!this.mComposeState.get(".recipients-diff-pane-close")){var n="",o=this._getRecipientsDiffStr();o.length>0&&(n=this.isHtmlType()?Daria.Html2Text.text2html(o)+"<div>&nbsp;</div>":o+"\n\n",e.send=n+e.send)}return e},createTemplateFolder:function(){var e=ns.Model.get("folders"),t=e.getFidBySymbol(d.WellKnownFolderSymbol.TEMPLATE),n=vow.Promise.resolve();return t?this.set(".templates_fid",t):n=e.createTemplateFolder().then((function(e){return this.set(".templates_fid",e.fid),e}),this),n},save:function(e){var t=this;return this._saveDraftPromise=this._save(e).always((function(e){return t._saveDraftPromise=null,e})),this._saveDraftPromise},_save:function(e){e=e||{};var t=vow.Promise.resolve();if(!e.force&&!this.isDirty())return t;this.isTemplate()&&(t=this.createTemplateFolder());var n=this.getData(),o=this._getCommonSendParams(),s={nosend:"yes"},i=_.extend({},n,o,s);i=this._prepareDataForMailSend(i,!0),i.send=this.getSendMessage();var a=t.then(this.makeRequest.bind(this,i,"_save=true","save")),r=a.then(this._processSaveResponse,this);return e.httpResponse?a:r},waitForDraftSave:function(){return this._saveDraftPromise?this._saveDraftPromise.always((function(){return vow.resolve()})):vow.resolve()},makeRequest:function(e,t,n){var o=this;if(this._cancelled)return vow.reject("send-cancelled");var s=this;return this.isTemplate()&&!e.templates_fid&&(e.templates_fid=this.get(".templates_fid")),new vow.Promise(function(i,a){o._cancelSendCallback=function(){Jane.ErrorLog.send({errorType:"cancel_send_while_sending",overwriteMid:e.overwrite}),Daria.SendMail.showMessageSentCancelling()},e._eexp=Daria.Config["eexp-boxes"],$.ajax({url:Daria.api["do-send"]+"?"+t,method:"POST",dataType:"json",cache:!1,data:e,success:function(t,o,r){if(Daria.parseLoginInfo(t)){s.onXHRSuccess(t,i,a,n);var c=s.isDelayed()&&!e.relative;s._cancelIfNeeded(t,c)}else s.onXHRError(r,"no_auth",a,n)},error:function(e,t){s.onXHRError(e,t,a,n)},complete:function(){s._cancelSendCallback=null}})})},_cancelIfNeeded:function(e,t){var n=no.jpath(".storedmid",e);n&&this._cancelled&&Daria.SendMail.cancelSendMessage(n,"sending_message",t)},_waitForAttachmentsUploaded:function(){var e=this;return this._cancelled?vow.reject("send-cancelled"):new vow.Promise(function(t,n){e._cancelSendCallback=n;var o=ns.Model.get("compose-attachments",e.params);o.isValid()&&o.isUploading()?(ns.events.once("attachments.all-uploaded",t),o.once("ns-model:attachments.failed",(function(){e._checkData().fail((function(t){e.storeErrors(t),n("attachments-failed")}))}))):t()})},_preSend:function(e){var t=this;return this._cancelled=!1,this.cleanErrors(),new vow.Promise(function(n,o){t._cancelSendCallback=o,t._checkData().fail((function(e){return t.storeErrors(e),vow.reject("message-not-valid")})).then((function(){if(t._cancelled)return vow.reject("send-cancelled");if(!e.force&&t.checkConfirmations())return vow.reject("need-confirm");var n={};if(t.withUndo()){var o=Daria.SendMail.getUndoSendLogger(t.params.ids);o.logShow(),n.onClose=function(){o.logClose()},n.onCancel=function(){o.logCancel(),t._cancelled=!0,t._cancelSendCallback&&(t._cancelSendCallback("send-cancelled"),t._cancelSendCallback=null)}}return Daria.SendMail.showSendingMessage(n),t.trigger("ns-model:store-subject-for-autocomplete"),t._waitForAttachmentsUploaded()})).then(n,o)})},_send:function(){var e=this;if(this._cancelled)return vow.reject("send-cancelled");var t=this.getData(),n=this._getCommonSendParams(),o=_.extend({},t,n);return o.send=this.getSendMessage(),o=this._prepareDataForMailSend(o,!1),this._draftMid=this.getDraftMid(),ns.Model.get("message-failed").setMid(this._draftMid),new vow.Promise(function(t,n){e._cancelSendCallback=n,e.makeRequest(o,"_send=true","send").then(e._processSendResponse,e).then(t,n)})},send:function(e){var t=this;e=e||{};var n=Daria.SendMail.getUndoSendLogger(this.params.ids);return n.logActionOnceAfterCancel("Клик в Отправить"),n.cancelled=!1,n.resetStartTime(),this._preSend(e).then(this._send,this).always((function(e){return t._cancelled&&t._draftMid&&(ns.Model.get("message-failed").removeMid(t._draftMid),t._draftMid=null),t._cancelSendCallback=null,e}))},onXHRError:function(e,t,n,o){var s,i,a=e&&e.status;"parsererror"===t?(i="bad_json",s="no_data"):"no_auth"===t?(i="NoAuth",s="no_auth"):s=413===a?"attachment_too_big":a>0?"no_data":"http_status_0",i=i||s,Jane.ErrorLog.send({errorType:"compose.http",status:i,ckey:ns.Model.get("account-information").get(".ckey")},e.responseText),"NoAuth"!==i&&this.onSendError(s,n,o)},onXHRSuccess:function(e,t,n,o){var s=jpath(e,".limited.recipient")[0],i=Array.isArray(s)&&s.length?"ok":jpath(e,".status")[0];switch(i){case"ok":t(e);break;case"captcha_request":e.captcha_key&&ns.Model.get("captcha").setData({key:e.captcha_key,url:e.captcha_url,_:e.captcha_key}),this.trigger("ns-model:captcha-request"),this.onSendError(i,n,o);break;case l.SendError.UNDO_MESSAGE_SAVED:case l.SendError.DELAYED_MESSAGE_SAVED:this._updateDataAfterSave(e),this.onSendError(i,n,o);break;default:this.onSendError(i,n,o)}},onSendError:function(e,t,n){e=e||"internal_error",Jane.ErrorLog.send({errorType:"compose."+n+".failed",status:e,ckey:ns.Model.get("account-information").get(".ckey")}),ns.Model.get("message-failed").removeMid(this.getDraftMid()),t(e)},isSystemLabel:function(e){var t=ns.Model.get("labels"),n=t.getLabelById(e);if(!n)return!1;if(n.user)return!1;var o=t.getWaitingForReplyLabel(),s=t.getDelayedMessageLabel();return _.contains([o,s],n)},getLabelsHash:function(){var e=ns.Model.get("labels").getLabelsHash(),t=this.get(".lids")||[];return _.each(t,(function(t){e[t]=1})),e},addLid:function(e){e=$.makeArray(e);var t=this.get(".lids")||[];if(e=_.difference(e,t),e.length){t=t.concat(e);var n=_.all(e,this._systemLabelFilter,this);this.set(".lids",t,{silent:n})}},removeLid:function(e){e=$.makeArray(e);var t=this.get(".lids");t&&t.length&&(t=_.difference(t,e),t.length?this.set(".lids",t,{silent:this.isSystemLabel(e)}):(this.set(".lids",[]),delete this.getData().lids))},hasUserLabels:function(){return!_(this.get(".lids")).filter(this._userLabelFilter,this).isEmpty()},getUserLabels:function(){return _(this.get(".lids")).filter(this._userLabelFilter,this).value()},_userLabelFilter:function(e){var t=ns.Model.get("labels"),n=t.getLabelById(e),o=t.getImportantLID();return n&&(n.user||e===o)&&!this.isSystemLabel(e)},_systemLabelFilter:function(e){return this.isSystemLabel(e)},getFromEmails:function(){var e=String(this.get(".from_mailbox")||"");return _.map(ns.Model.get("account-information").getFromEmails(),(function(t){return{text:t,value:t,selected:e.toLowerCase()===t.toLowerCase()}}))},getLanguage:function(){var e="ru";if(this.isReply()){var t=this.params.ids;if(!(e=Daria.Translate.getLangByMid(t))){var n=this.mMessageBody.getComposeHTML();e=Daria.Translate.defineLanguage(n)}}else{var o=this.get(".send");_.trim(o.replace(/\&nbsp;/gi,"")).length?e=Daria.Translate.defineLanguage(o):_.contains(Daria.Translate.langs.all.s,Daria.Config.locale)&&(e=Daria.Config.locale)}return e},formatContacts:function(e,t){var n=this.get("."+e);return Jane.FormValidation.splitContacts(n).map((function(n){return n.type=e,n.ref=t.getEmailRef(n.email),n}),this)},getContacts:function(e){var t=this.get("."+e);return"phone"===e?Jane.FormValidation.splitPhones(t):Jane.FormValidation.splitContacts(t)},getAllRecepients:function(){var e=this.getContacts("to"),t=this.getContacts("cc"),n=this.getContacts("bcc");return Array.prototype.concat.call(e,t,n)},getAllRecepientEmails:function(){return{to:this._extractEmailsFromContacts(this.getContacts("to")),cc:this._extractEmailsFromContacts(this.getContacts("cc")),bcc:this._extractEmailsFromContacts(this.getContacts("bcc"))}},setContacts:function(t,n){var o="."+t;this.set(o,_.map(n,(function(e){return Jane.FormValidation.obj2contact(e)})).join(e)+",")},appendContact:function(e,t){t&&this.setContacts(e,this.getContacts(e).concat(t))},isDelayed:function(){return Boolean(this.get(".send_time"))},resetDelayed:function(){this.setIfChanged(".send_time",null)},getPassportSendDate:function(){var e=Jane.Date.parseCalendarDate(this.get(".send_time"));return e?Daria.getPassportDate(e):void 0},_getArrayOfEmails:function(e){return e.map((function(e){return e.email}))},_onRecipientsChanged:function(){if(!Daria.IS_CORP)return vow.resolve();if(this.isTemplate()||this.isNewMessage()||this.isForward())return vow.resolve();if(!this.get(".initial_to")&&!this.get(".initial_cc"))return vow.resolve();var e=this;return vow.resolve().then((function(){var t=_.union(Jane.FormValidation.splitContacts(e.get(".initial_to")||""),Jane.FormValidation.splitContacts(e.get(".initial_cc")||"")),n=_.union(Jane.FormValidation.splitContacts(e.get(".to")||""),Jane.FormValidation.splitContacts(e.get(".cc")||"")),o=_.uniq(e._getArrayOfEmails(t)),s=_.uniq(e._getArrayOfEmails(n)),i=_.difference(s,o).sort(),a=_.difference(o,s);return o.length-a.length<2&&a.length>0?o.length-a.length==1?ns.Model.get("get-maillists-static").getMaillists(s).then((function(e){return 0===e.length&&(a=[i18n("%All")]),{removed:a,added:i}})).fail((function(e){throw e})):(a=[i18n("%All")],{removed:a,added:i}):{removed:a,added:i}})).then((function(t){e.set(".recipients-diff",{added:t.added,removed:t.removed})})).fail((function(e){throw e}))},_getRecipientsDiffStr:function(){var t=this.get(".recipients-diff"),n=[];return 0===t.added.length&&0===t.removed.length?n=[]:(t.added.length>0&&n.push("+ "+t.added.join(e)),t.removed.length>0&&n.push("- "+t.removed.join(e))),n.join("\n")},hasOnlyOneValidRecipient:function(e){e=["to","cc","bcc"].indexOf(e)>-1?e:"";var t=e?this.getContacts(e):this.getAllRecepients();return Array.isArray(t)&&1===t.length&&Jane.FormValidation.checkEmail(t[0].email||"")}}})})()},3954:function(e,t,n){"use strict";var o=function(e){var t=Jane.FormValidation.splitContacts(e);return Daria.Recipients.requestContacts(t).always((function(){return t.filter((function(e){return!Jane.FormValidation.checkEmail(e.email)}))}))},s=function(e,t){return new vow.Promise(function(n,o){e||t.get(".cc")||t.get(".bcc")?n():o(i18n("%Compose_Email_Required"))})},i=function(e){return o(e).then((function(e){if(!e.length)return vow.resolve();var t=e.map((function(e){return e.name?"".concat(e.email," (").concat(e.name,")"):e.email})).join(", ");return vow.reject("".concat(i18n("%Compose_Error_Invalid_Emails")," ").concat(t))}))},a=function(e){return new vow.Promise(function(t,n){e&&!Jane.FormValidation.checkPhoneNumber(e)?n(i18n("%ValidatePhoneError_badnumformat")):t()})},r=function(e,t){return new vow.Promise(function(e,n){var o=ns.Model.get("compose-attachments",t.params);o.isValid()&&o.isFailed()?n(i18n("%Compose_Attachment_Failed")):e()})},c={to:[s,i],phone:[a],cc:[i],bcc:[i],att_ids:[r]};t.a={validate:function(e){return new vow.Promise(function(t,n){var o=e.getData(),s={},i=!0;vow.all(Object.keys(o).map((function(t){var n=o[t];return vow.all((c[t]||[]).map((function(o){return o(n,e).fail((function(e){s[t]=s[t]||e,i=!1}))})))}))).always((function(){i?t():n(s)}))})}}},3955:function(e,t){!(function(){var e={editorMode:"",editorMaximize:2,messageHeight:190,bodyPos:0,editorBookmark:null,isCcVisible:!1,isBccVisible:!1,isReplyAllNoticeVisible:!1,isPhoneVisible:!1,isPhoneEnabled:!1,isOpenedWithToolbarAttachPopup:!1,saveTemplateAndLeave:!1,saveTemplateAndReset:!1,submitButtonText:i18n("%Отправить"),activeActionButtonView:"compose-send-link",focusField:"to",waitSuggest:!1,formRect:null,"recipients-diff-pane-close":!1,visibleNotices:{to:[],phone:[],cc:[],bcc:[]},translationEnabled:!1},t=ns.Model.prototype;ns.Model.define("compose-state",{events:{"ns-model-before-destroyed":"onBeforeDestroyed"},params:{ids:null,tids:null,oper:null},ctor:function(){this._onComposeMessageFieldChanged=this._onComposeMessageFieldChanged.bind(this),this._refreshSubmitButtonText=this._refreshSubmitButtonText.bind(this)},methods:{canRequest:function(){var e=this.super_.canRequest.call(this),t=!this._mComposeMessage||this._mComposeMessage.canRequest();return e&&t},request:function(){var e=this._constructModelRequest();return ns.request(e).then(this._initFromModels,this)},_constructModelRequest:function(){var e=[{id:"compose-message",params:this.params}];return this.params.ids&&_.isString(this.params.ids)&&!this.params.tids&&e.push({id:"message-body",params:ns.Model.infoLite("message-body").calculateParamsForMessageBody(this.params)}),e},_initFromModels:function(t){this.mComposeMessage=_.find(t,"id","compose-message"),this.mMessageBody=_.find(t,"id","message-body"),this._bindModelEvents();var n="reply"===this.params.oper&&this.mMessageBody&&this.mMessageBody.allowedReplyAll();this.setData(_.extend({},e,{isReplyAllNoticeVisible:n,isCcVisible:Boolean(this.mComposeMessage&&this.mComposeMessage.get(".cc")),isBccVisible:Boolean(this.mComposeMessage&&this.mComposeMessage.get(".bcc")),isPhoneVisible:Boolean(this.mComposeMessage&&this.mComposeMessage.get(".phone")),focusField:this.mComposeMessage.isReplyAny()?"send":e.focusField})),this._refreshSubmitButtonText()},onBeforeDestroyed:function(){this._unbindModelEvents()},_bindModelEvents:function(){this.on("ns-model-changed.translationEnabled",this._refreshSubmitButtonText),this.mComposeMessage&&(this.mComposeMessage.on("ns-model-changed.send_time",this._refreshSubmitButtonText),_.each(["to","phone","cc","bcc"],(function(e){this.mComposeMessage.on("ns-model-changed."+e,this._onComposeMessageFieldChanged)}),this))},_unbindModelEvents:function(){this.mComposeMessage&&(this.mComposeMessage.off("ns-model-changed.send_time",this._refreshSubmitButtonText),_.each(["to","phone","cc","bcc"],(function(e){this.mComposeMessage.off("ns-model-changed."+e,this._onComposeMessageFieldChanged)}),this))},_isNdaNoticeNeeded:function(e){if(Daria.IS_CORP)return!1;var t=this.mComposeMessage.getContacts(e),n=!1,o=!1;return _(t).pluck("email").each((function(e){Jane.FormValidation.checkExternalEmail(e)?o=!0:n=!0})).value(),n&&o},_onComposeMessageFieldChanged:function(e,t){var n=t.substr(1),o={nda:this._isNdaNoticeNeeded.bind(this,n)},s=this.get(".visibleNotices."+n);_.each(o,(function(e,t){s=e()?_.uniq(s.concat(t)):_.without(s,t)})),this.setIfChanged(".visibleNotices."+n,s)},setFocusField:function(e,t){this.set(".focusField",e,t)},getFocusField:function(){return this.get(".focusField")},setWaitSuggest:function(e,t){this.set(".waitSuggest",e,t)},getWaitSuggest:function(){return this.get(".waitSuggest")},set:function(e,n,o){o||(o={});var s=this.get(e);_.isEqual(s,n)&&!o.force||t.set.call(this,e,n,o)},setMessageHeight:function(e){e<190&&(e=190),this.set(".messageHeight",e)},hasSpellingCheck:function(){return"TUR"!==Daria.Config.product&&!_.contains(["ka","hy","ro"],Daria.Config.locale)},hasEnSpellingCheckIcon:function(){return!_.contains(["ru","uk","be"],Daria.Config.locale)},hasDisk:function(){return _.contains(Daria.SIDS,"59")},isFieldEnabled:function(e){return!_.contains(["phone"],e)||this.get(".is"+_.capitalize(e)+"Enabled")},isFieldVisible:function(e){return!_.contains(["phone","cc","bcc"],e)||this.get(".is"+_.capitalize(e)+"Visible")},isCcVisible:function(){return this.get(".isCcVisible")},isBccVisible:function(){return this.get(".isBccVisible")},isPhoneVisible:function(){return this.get(".isPhoneVisible")},isReplyAllNoticeVisible:function(e){return"to"===e&&this.get(".isReplyAllNoticeVisible")},isNdaNoticeVisible:function(e){return Daria.IS_CORP&&_.contains(this.get(".visibleNotices."+e),"nda")},setLastSaveTime:function(){this.set(".lastSaveTime",Jane.Date.format("%R",Daria.now()))},isMinWidth:function(){var e=ns.Model.get("settings"),t=Number(e.getSetting("size-view-app")),n=Number(e.getSetting("size-layout-left")),o=Daria.resize.elements.leftPane.params.maxWidth;return 1024===t&&n===o},getSubmitButtonText:function(){var e=this.get(".translationEnabled"),t=this.mComposeMessage.getPassportSendDate();if(t){var n=Jane.Date.toHumanFormat(t),o=Jane.Date.format("%Date_HM__colon",t);return e?i18n("%Compose_Translate_Send_With_Deferred_Option",n,o):i18n("%Compose_Send_With_Deferred_Option",n,o)}return e?i18n("%Compose_Translate_Send"):i18n("%Отправить")},_refreshSubmitButtonText:function(){this.setIfChanged(".submitButtonText",this.getSubmitButtonText())}}})})()},3956:function(e,t){!(function(){ns.Model.define("compose-forwarded-messages",{params:{ids:null,tids:null,oper:null},methods:{canRequest:function(){var e=this.super_.canRequest.call(this),t=!this.mComposeMessage||this.mComposeMessage.canRequest();return e&&t},request:function(){return this.mComposeMessage=ns.Model.get("compose-message",_.clone(this.params)),ns.request([this.mComposeMessage]).then((function(){this.setData([]),ns.request(this._constructModelRequest()).then(this._initFromModels,this)}),null,this)},_constructModelRequest:function(){var e=[];if("forward"!==this.params.oper)return e;var t=$.makeArray(this.params.tids),n=$.makeArray(this.params.ids);return e=e.concat(_.map(t,(function(e){return{id:"messages",params:{thread_id:e,first:0,count:ns.Model.get("message",{ids:e}).getThreadCount()||500}}}))),e=e.concat(_.map(n,(function(e){return{id:"message",params:{ids:e}}})))},_initFromModels:function(e){var t=[];_.each(e,(function(e){switch(e.id){case"messages":t.push.apply(t,e.models);break;case"message":t.push(e)}})),this._setMessages(t)},_setMessages:function(e){var t=!1;e.length>1&&(t=!0);var n=_.map(e,(function(e){return{mid:e.get(".mid"),subject:e.get(".subject"),checked:t,link:e.getMessageLink()}}));this.setData(n),t&&this.mComposeMessage.addForwardedMessages(_.pluck(n,"mid"))},checkMessage:function(e){_.find(this.getData(),{mid:e}).checked=!0,this.mComposeMessage.addForwardedMessages(e)},uncheckMessage:function(e){_.find(this.getData(),{mid:e}).checked=!1,this.mComposeMessage.removeForwardedMessages(e)},getMessagesIds:function(){return this.getData().filter((function(e){return e.checked})).map((function(e){return e.mid}))}}})})()},3957:function(e,t){!(function(){ns.Model.define("compose-fsm",{params:{ids:null,oper:null},methods:{start:"edit",transitions:{save:["edit","sending","cancel"],edit:["save","sending","cancel"],sending:["edit","sent"],cancel:["edit"]},canAutosave:function(){return this._checkTransitionToState("save")}}},ns.ModelFsm)})()},3958:function(e,t){ns.Model.define("compose-signature",{params:{ids:null,tids:null,oper:null},methods:{canRequest:function(){var e=this.super_.canRequest.call(this),t=!this.mComposeMessage||this.mComposeMessage.canRequest();return e&&t},request:function(){var e=this._constructModelRequest();return ns.request(e).then(this._initFromModels,this)},_constructModelRequest:function(){return[{id:"settings"},{id:"compose-message",params:_.clone(this.params)}]},_initFromModels:function(e){this.mSettings=e[0],this.mComposeMessage=e[1],this.setData({signature:""})},getSignatureList:function(){var e=this.mComposeMessage.get(".from_mailbox"),t=this.mComposeMessage.getLanguage(),n={mode:this.mComposeMessage.get(".ttype"),signs:[]};switch(n.mode){case"html":n.signs=Daria.signs.getHtml();break;case"plain":n.signs=Daria.signs.getPlain()}var o=Daria.signs.getFilteredSigns(n.signs,e);return 0===o.length?n.noSuitableSignature=!0:o.sort(Daria.signs.sort(e,t)),n.signs=_.uniq([].concat(o,n.signs)),n},hasSignatureControl:function(){return!Daria.Config.NO_SETTINGS&&!Modernizr.ios}}})},3959:function(e,t){ns.Model.define("do-cancel-send-delayed",{params:{ids:null}})},3960:function(e,t){ns.Model.define("do-cancel-send-undo",{params:{ids:null}})},3961:function(e,t){function n(e){return i(e)||s(e)||o()}function o(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function s(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function i(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}!(function(){ns.Model.define("compose-popular-contacts",{events:{},params:{ids:null,oper:null,count:null},methods:{canRequest:function(){var e=this.super_.canRequest.call(this),t=ns.Model.get("compose-message",this.params),n=!t||t.canRequest();return e&&n},request:function(){var e=this._constructModelRequest();return ns.request(e).then((function(e){var t=_.zipObject(_.pluck(e,"id"),e);this._initFromModels(t)}),this)},_constructModelRequest:function(){return[{id:"abook-suggest",params:{q:"",popular:!0,climit:this.params.count}},{id:"compose-message",params:this.params},{id:"index-data"}]},_initFromModels:function(e){var t=e["abook-suggest"],o=e["compose-message"],s=e["index-data"].get(".email"),i=o.getAllRecepients(),a=_.filter(t.get(".contacts"),(function(e){return e.email!==s})),r={name:i18n("%Compose_Send_it_to_me"),email:s},c=_.map([r].concat(n(a)),(function(e){return e.name||(e.name=e.email),e.phone=_.get(e,["phones",0]),_.extend({},e,{used:_.any(i,{email:e.email})})}),this);this.setData(c)},getContact:function(e){return _.find(this.getData(),e)},actualizeUsedContacts:function(e){_.each(this.getData(),(function(t){t.used=_.any(e,{email:t.email})}))},isAnyUnusedContact:function(){return!this.isValid()||_.any(this.getData(),(function(e){return!e.used}))},getUnusedContacts:function(){return _.filter(this.getData(),(function(e){return!e.used}))},clean:function(){_.each(this.getData(),(function(e){e.used=!1}))}}})})()},3962:function(e,t){ns.Model.define("compose-field-notice",{events:{"ns-model-init":"_onInit"},params:{ids:null,oper:null,field:null,type:null},methods:{_onInit:function(){this.setData({type:null})}}},ns.ModelStatic),ns.Model.define("compose-field-extras",{events:{"ns-model-init":"_onInit"},params:{ids:null,oper:null,field:null,type:null},methods:{_onInit:function(){this.setData({type:null})}}},ns.ModelStatic)},3963:function(e,t){ns.Model.define("compose-field-notices",{isCollection:!0,events:{"ns-model-init":"_onInit"},params:{ids:null,oper:null,field:null},methods:{_onInit:function(){this.setData({})}}},ns.ModelCollectionStatic),ns.Model.define("compose-field-extras-collection",{isCollection:!0,events:{"ns-model-init":"_onInit"},params:{ids:null,oper:null,field:null},methods:{_onInit:function(){this.setData({})}}},ns.ModelCollectionStatic)},3964:function(e,t){ns.Model.define("compose-emoticons",{events:{"ns-model-init":"_onInit"},params:{},methods:{_onInit:function(){this.setData({items:[{suid:21,name:"Улыбается"},{suid:22,name:"Подмигивает"},{suid:23,name:"Показывает язык"},{suid:24,name:"Благодарит"},{suid:25,name:"Крутой"},{suid:26,name:"Удивляется"},{suid:27,name:"Огорчается"},{suid:28,name:"Обижается"},{suid:29,name:"Плачет"},{suid:30,name:"Зевает"},{suid:31,name:"Смущается"},{suid:32,name:"Не может сказать вслух"},{suid:33,name:"Не в себе"},{suid:34,name:"Сумасшедший"},{suid:35,name:"Ехидный"},{suid:36,name:"Ангелочек"},{suid:37,name:"Влюбленный"},{suid:38,name:"Сердце разбито"},{suid:45,name:"Отдых"},{suid:51,name:"Подарок"},{suid:40,name:"Мокро"},{suid:43,name:"Дождь"},{suid:46,name:"Солнечно"},{suid:47,name:"Холодно"},{suid:50,name:"Планета"},{suid:42,name:"Не одобряю"},{suid:41,name:"Одобряю"},{suid:48,name:"Бомба"},{suid:49,name:"Идея!"},{suid:44,name:"Музыка"}]})}}},ns.ModelStatic)},3965:function(e,t){function n(e,t){return i(e)||s(e,t)||o()}function o(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function s(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var n=[],o=!0,s=!1,i=void 0;try{for(var a,r=e[Symbol.iterator]();!(o=(a=r.next()).done)&&(n.push(a.value),!t||n.length!==t);o=!0);}catch(e){s=!0,i=e}finally{try{o||null==r.return||r.return()}finally{if(s)throw i}}return n}}function i(e){if(Array.isArray(e))return e}var a=function(){};ns.Model.define("compose-autocomplete",{params:{text:null,id:null,text_limit:null,message_id:null,thread_id:null,init_session:null,extra_params:null,allow_pers_data:null},ctor:function(){this._failedRequests=0},methods:{MAX_FAILED_REQUESTS:3,_getTextLimit:function(){return 4096},canRequest:function(){return this.retries<1},getItemsData:function(e){var t=this,n=e,o=this._getTextLimit();return n.length>o&&(n=n.slice(n.length-o)),vow.Promise.resolve().then((function(){return t._requestItemsData(n)})).then((function(e){var n=e.items,o=e.requestId;return t.setData({items:n,autocompleteRequestId:o}),t.getData()})).catch((function(e){return t._logErrors(e)}))},initSession:function(){return ns.forcedRequest(this.id,{id:this.params.id,thread_id:this.params.thread_id,init_session:!0,message_id:this.params.message_id}).then(a).fail(a)},request:function(){var e=this;return this._httpRequest().then((function(t){if(!1===ns.request.canProcessResponse(t))return Vow.reject({error:"CANT_PROCESS",invalid:[e],valid:[]});ns.request.extractModel(e,t.models[0])}),(function(t){var n=t.error;ns.request.extractModel(e,{error:n})}))},setError:function(e){var t=ns.key("model=".concat(this.id),this._getParamsForLog());ns.Model.prototype.setError.apply(this,[e,t])},_httpRequest:function(){var e=this,t=this.id,n="".concat(ns.request.URL,"?_m=").concat(t),o={models:[{name:t,params:ns.parseQuery(ns.params2query(this.getRequestParams())),meta:{requestAttempt:this.retries}}]};ns.request.addRequestParams(o);var s=Object.assign({},ns.H.DEFAULTS,{contentType:"application/json; encoding=utf-8",url:n,data:JSON.stringify(o),traditional:!0}),i=new Vow.Promise;return $.ajax(s).done((function(e){i.fulfill(e)})).fail((function(t,n,o){var s={models:[{name:e.id,params:e._getParamsForLog()}]};Jane.ErrorLog.send({errorType:"handlersjsx.httperror",status:t.status,headers:t.getAllResponseHeaders()},JSON.stringify(s));var a=o||n||"unknown error";i.reject({error:a,xhr:t})})),i},_requestItemsData:function(e){var t=this;return vow.Promise.resolve().then((function(){return t._failedRequests>=t.MAX_FAILED_REQUESTS?{items:[],requestId:""}:ns.forcedRequest(t.id,{id:t.params.id,text:e,text_limit:t._getTextLimit(),thread_id:t.params.thread_id,message_id:t.params.message_id,allow_pers_data:t._getPersonalDataSetting()}).then((function(e){var o=n(e,1),s=o[0];t._failedRequests=0;var i=s.get(".items"),a=s.get(".autocompleteRequestId");return s.destroy(),{items:i,requestId:a}})).fail((function(){return++t._failedRequests,{items:[],requestId:""}}))}))},_getPersonalDataSetting:function(){return ns.Model.get("settings").getSign("allow_pers_data_autocomplete")?"on":""},_getParamsForLog:function(){var e=this.params.text;return{text_length:e?e.length:0,id:this.params.id,thread_id:this.params.thread_id,text_limit:this.params.text_limit}},_logErrors:function(e){var t=e&&e.message?e.message:"";Jane.ErrorLog.send({errorType:"compose_autocomplete",message:t,sessionId:this.id},"",e instanceof Error?e.stack:null)}}})},3966:function(e,t){function n(e,t){return i(e)||s(e,t)||o()}function o(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function s(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var n=[],o=!0,s=!1,i=void 0;try{for(var a,r=e[Symbol.iterator]();!(o=(a=r.next()).done)&&(n.push(a.value),!t||n.length!==t);o=!0);}catch(e){s=!0,i=e}finally{try{o||null==r.return||r.return()}finally{if(s)throw i}}return n}}function i(e){if(Array.isArray(e))return e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){c(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u={TEXT:20480,ADDRESSES:100,ATTACHES:100},l=1;ns.Model.define("compose-smartsubject",{params:{id:null,position:null,message_id:null,thread_id:null,text:null,to:null,cc:null,bcc:null,from:null,attaches:null,extra_params:null},ctor:function(){this._failedRequests=0},methods:{MAX_FAILED_REQUESTS:3,canRequest:function(){return this.retries<1},getItemsData:function(e){var t=this,n=e.text,o=e.addresses,s=e.attaches;return vow.Promise.resolve().then((function(){return t._requestItemsData({text:n,addresses:o,attaches:s})})).then((function(e){var n=e.items,o=e.requestId;return t.setData({items:n,requestId:o}),t.getData()})).catch((function(e){return t._logErrors(e)}))},request:function(){var e=this;return this._httpRequest().then((function(t){if(!1===ns.request.canProcessResponse(t))return Vow.reject({error:"CANT_PROCESS",invalid:[e],valid:[]});ns.request.extractModel(e,t.models[0])}),(function(t){var n=t.error;ns.request.extractModel(e,{error:n})}))},setError:function(e){var t=ns.key("model=".concat(this.id),this._getParamsForLog());ns.Model.prototype.setError.apply(this,[e,t])},_httpRequest:function(){var e=this,t=this.id,n="".concat(ns.request.URL,"?_m=").concat(t),o={models:[{name:t,params:ns.parseQuery(ns.params2query(this.getRequestParams())),meta:{requestAttempt:this.retries}}]};ns.request.addRequestParams(o);var s=Object.assign({},ns.H.DEFAULTS,{contentType:"application/json; encoding=utf-8",url:n,data:JSON.stringify(o),traditional:!0}),i=new Vow.Promise;return $.ajax(s).done((function(e){i.fulfill(e)})).fail((function(t,n,o){var s={models:[{name:e.id,params:e._getParamsForLog()}]};Jane.ErrorLog.send({errorType:"handlersjsx.httperror",status:t.status,headers:t.getAllResponseHeaders()},JSON.stringify(s));var a=o||n||"unknown error";i.reject({error:a,xhr:t})})),i},_requestItemsData:function(e){var t=this,o=e.text,s=e.addresses,i=e.attaches;return vow.Promise.resolve().then((function(){if(t._failedRequests>=t.MAX_FAILED_REQUESTS)return{items:[],requestId:""};var e="ssreq-".concat(Daria.uid,"-").concat(t.params.message_id,"-").concat(Daria.now()).concat(l++);return ns.forcedRequest(t.id,r({},t.params,{id:e,text:(o||"").substr(0,u.TEXT),to:JSON.stringify(t._limitAddresses(s.to)),cc:JSON.stringify(t._limitAddresses(s.cc)),bcc:JSON.stringify(t._limitAddresses(s.bcc)),from:JSON.stringify(s.from),attaches:JSON.stringify(t._mapAttaches(t._limitAttaches(i))),extra_params:t._getExtraParams()})).then((function(e){var o=n(e,1),s=o[0];t._failedRequests=0;var i=s.get(".items"),a=s.get(".smartSubjectRequestId");return s.destroy(),{items:i,requestId:a}})).fail((function(){return++t._failedRequests,{items:[],requestId:""}}))}))},_limitAddresses:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).slice(0,u.ADDRESSES)},_limitAttaches:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).slice(0,u.ATTACHES)},_mapAttaches:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).map((function(e){var t=e.info;return{id:t.id,name:t.name,mediaType:t.class}}))},_getExtraParams:function(){return"exp=line_popup_final&chain=prod"},_getParamsForLog:function(){return{text_length:(this.params.text||"").length,id:this.params.id,message_id:this.params.message_id,thread_id:this.params.thread_id,recipients_length:(this.params.to||[]).length+(this.params.cc||[]).length+(this.params.bcc||[]).length,from:this.params.from,attaches_length:(this.params.attaches||[]).length}},_logErrors:function(e){var t=e&&e.message?e.message:"";Jane.ErrorLog.send({errorType:"compose_smartsubject",message:t,sessionId:this.id},"",e instanceof Error?e.stack:null)}}})},3967:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(680);yr.externals["get-attachment-id"]=function(e){var t=yr.nodeset2data(e);return Object(o.a)(t)}},3968:function(e,t,n){n(3969),n(3970),n(3971),n(3972),n(3973),n(3974),n(3977),n(3978),n(3979),n(3980),n(3981),n(3982),n(3983),n(3984),n(3985),n(3986),n(3987),n(3988),n(3989),n(3990),n(3991),n(3992),n(3993),n(3994),n(3995),n(3996),n(3997),n(3998),n(3999),n(4e3),n(4001),n(4002),n(4003),n(4004),n(4005),n(4006),n(4007),n(4008),n(4009),n(4010),n(4011),n(4012),n(4013),n(4014),n(4015),n(4016),n(4017),n(4018),n(4019),n(4020),n(4021),n(4022),n(4023),n(4024),n(4025),n(4026),n(4027),n(4028),n(4029),n(4030),n(4031),n(4032),n(4033),n(4034),n(4035),n(4036),n(4037),n(4038),n(4039),n(4040),n(4041),n(4042),n(4043),n(4044),n(4045),n(4046),n(4047),n(4048),n(4049),n(4051),n(4052),n(4053),n(4054),n(4055),n(4056),n(4057),n(4058),n(4059),n(4060),n(4061),n(4062),n(4063),n(4064),n(4065),n(4066),n(4067),n(4068),n(4069),n(4070),n(4071),n(4072),n(4073),n(4074)},3969:function(e,t){!(function(){ns.View.edefine("labels-actions-compose",{models:{labels:!1,settings:!1,"compose-message":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{_yateModule:"mail"})},yateModule:"toolbar",methods:{onShow:function(){this.$labelsHolder=this.$node.find(".js-labels-list"),this.$searchInput=this.$node.find(".js-search-input"),this.filterByComposeMessage()},filterByComposeMessage:function(){var e=this.getModel("compose-message").getLabelsHash();this._filterByLabelsHash(e,{showReadLabel:!1,showUnreadLabel:!1,messagesCount:1})},_onLabelClick:function(e){var t=this._getDataFromClickedLabel(e),n=this.getModel("compose-message");switch(t.action){case"label":n.addLid(t.lid);break;case"unlabel":n.removeLid(t.lid)}this.nbPopup.close()},getLabelCreatedCallback:function(){return this.getModel("compose-message").addLid.bind(this.getModel("compose-message"))}}},"labels-actions")})()},3970:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(384),s=n(792),i=n(425),a=n(786);!(function(){function e(e,t){Jane.ErrorLog.send(_.assign({},t,{event:"after_send_failed",loadingHash:e})),Daria.Dialog.notice({title:i18n("%Произошла_ошибка"),body:"<p>"+i18n("%Compose_after_sent_leave_failed")+"</p>"})}ns.View.define("compose-leave-mixin",{yateModule:"compose2",events:{"beforeunload@show window":"onBeforeUnloadPage"},methods:{onBeforeUnloadPage:function(){this._areThereAnyUnsavedChanges()&&Daria.addUnloadText(i18n("%Setup_beforeunload"))},leaveInit:function(){ns.assert(this.getModel("compose-message"),"Daria.vComposeLeaveMixin","требует наличия модели mComposeMessage в зависимостях"),ns.assert(this.getModel("compose-fsm"),"Daria.vComposeLeaveMixin","требует наличия модели mComposeFsm в зависимостях"),ns.assert(this.getModel("compose-state"),"Daria.vComposeLeaveMixin","требует наличия модели mComposeState в зависимостях"),this.leaveComposeController=new a.a,this.leaveComposeController.pageGoUrl=null,_.bindAll(this,["_leaveOnPageGo","_leaveOnSent","_leaveOnCancel","_nbSaveChangesPopupResolve","_nbSaveChangesPopupReject","_onExternalComposeButtonClick"])},leaveStart:function(){ns.page.block.add(this._leaveOnPageGo);var e=this.getModel("compose-fsm");e.on("# sent",this._leaveOnSent),e.on("# cancel",this._leaveOnCancel);var t=this.getModel("compose-state");t.on("nbSaveChangesPopup:resolve",this._nbSaveChangesPopupResolve),t.on("nbSaveChangesPopup:reject",this._nbSaveChangesPopupReject),ns.events.on("daria:vLeftColToolbar:composeClick",this._onExternalComposeButtonClick)},leaveStop:function(){ns.page.block.remove(this._leaveOnPageGo);var e=this.getModel("compose-fsm");e.off("# sent",this._leaveOnSent),e.off("# cancel",this._leaveOnCancel);var t=this.getModel("compose-state");t.off("nbSaveChangesPopup:resolve",this._nbSaveChangesPopupResolve),t.off("nbSaveChangesPopup:reject",this._nbSaveChangesPopupReject),ns.events.off("daria:vLeftColToolbar:composeClick",this._onExternalComposeButtonClick)},checkSameUrlParams:function(e){if(!e)return!1;var t=ns.router(ns.page.currentUrl),n=ns.router(e);if(Daria.composeEqualRoutes(t,n))return!0;var o=_.get(n,"params._cuid");return!("compose2"!==n.page&&!Daria.composeHasParams(o))},_onExternalComposeButtonClick:function(){var e=Daria.composeGo();this._leaveOnPageGo(e,!0)},_leaveOnPageGo:function(e,t){var n=this.getModel("compose-state"),a=n.get(".nbSaveChangesPopup");return(!a||!a.isOpen())&&(!t&&e===ns.page.currentUrl||(!(t||!e||!this.checkSameUrlParams(e))||(this.leaveComposeController.pageGoUrl=e,this._areThereAnyUnsavedChanges()?!this._showSaveChangesPopup(t):(t&&this.hardResetCompose(),i.a.finishScenario(o.a,s.c),!0))))},_areThereAnyUnsavedChanges:function(){var e=this.getModel("compose-message").isDirty(),t=!this.getModel("compose-fsm").isCurrentState(["save","sent"]);return e&&t},_showSaveChangesPopup:function(e){var t=this,n=this.getModel("compose-state");if(n.get(".nbSaveChangesPopup"))return!1;this.autosaveStop(),nb.trigger("popup-close"),Daria.Dropdown.closeAll(),Daria.Dialog.close();var o=this.params,s=ns.View.create("compose-unsaved-popup");return s.on("resolve",(function(t,n){ns.Model.get("compose-state",o).trigger("nbSaveChangesPopup:resolve",n,e)})),s.on("reject",(function(){ns.Model.get("compose-state",o).trigger("nbSaveChangesPopup:reject"),t.autosaveStart()})),n.set(".nbSaveChangesPopup",s,{silent:!0}),s.open(),!0},_nbSaveChangesPopupResolve:function(e,t,n){var a=this.getModel("compose-state");a.set(".nbSaveChangesPopup",null,{silent:!0}),this.getModel("compose-fsm").isCurrentState("sending")||(this.getModel("compose-fsm").switchOff(),"save"===t?(n&&a.set(".saveTemplateAndReset",!0),this.getModel("compose-message").save({force:!0,httpResponse:!0}).then((function(){i.a.finishScenario(o.a,s.f)}),(function(){i.a.finishScenario(o.a,s.d)}))):n&&this.hardResetCompose(),"save"!==t&&i.a.finishScenario(o.a,s.b),this.leaveComposeController.leaveCompose({clearPageBlock:!0}))},_nbSaveChangesPopupReject:function(){this.getModel("compose-state").set(".nbSaveChangesPopup",null,{silent:!0}),this.getModel("compose-fsm").isCurrentState("sending")||(this.getModel("compose-fsm").setState("edit"),ns.Model.get("focus").setLastActionFocus(),ns.page.refresh())},_showMessageSentNotification:function(e){var t=this.getModel("compose-message");this.leaveComposeController.showMessageSentNotification({fromQR:e,sentMid:t.get(".sentMid"),wasSendCancelled:t.wasSendCancelled(),withUndo:t.withUndo(),isDelayed:t.isDelayed(),sendTime:t.getPassportSendDate()})},_onAfterSent:function(){var t=this;this._showMessageSentNotification(!1);var n=this.getModel("compose-message"),o=this.leaveComposeController.pageGoUrl=n.get(".limited")?"#done":this.leaveComposeController.whereToGoAfterSend();return vow.resolve().then((function(){if("#done"===o)return Jane.Services.run("#done").then((function(){ns.Model.get("done").fromComposeMessage(n)}))})).fail(_.noop).then((function(){return t.leaveComposeController.leaveCompose({clearPageBlock:!0,neverReturn:!0})})).fail((function(t){return e(o,t)})).always((function(){return vow.resolve()}))},_leaveOnSent:function(){return this.leaveComposeController.sendMetrika(),this._onAfterSent()},_leaveOnCancel:function(){return this.leaveComposeController.leaveCompose()},shouldGoToDonePage:function(){return"done"===this.leaveComposeController.getPageAfterSent()}}})})()},3971:function(e,t){ns.View.define("compose-autosave-mixin",{yateModule:"compose2",methods:{AUTOSAVE_PERIOD:Daria.timify({seconds:10}),autosaveInit:function(){ns.assert(this.getModel("compose-message"),"Daria.vComposeAutosaveMixin","требует наличия модели mComposeMessage в зависимостях"),ns.assert(this.getModel("compose-fsm"),"Daria.vComposeAutosaveMixin","требует наличия модели mComposeFsm в зависимостях"),this._autosaveSaveMessageModel=this._autosaveSaveMessageModel.bind(this),this._autosaveTimerAction=this._autosaveTimerAction.bind(this),this._autosaveTimer=0},autosaveStart:function(){this.getModel("compose-fsm").on("# save",this._autosaveSaveMessageModel),this._setAutosaveTimeout()},autosaveStop:function(){this._clearAutosaveTimeout(),this.getModel("compose-fsm").off("# save",this._autosaveSaveMessageModel)},_isAutosaveEnabled:function(){return this.isValid()&&this.getModel("compose-message").isAutosaveEnabled()},_autosaveSaveMessageModel:function(){this._clearAutosaveTimeout(),this.getModel("compose-message").save().always(this._onAutosave,this)},_onAutosave:function(){if(this.isValid()){var e=this.getModel("compose-fsm");e.isCurrentState("save")&&!e.inTransition()&&(e.setState("edit"),this._setAutosaveTimeout())}},_clearAutosaveTimeout:function(){this._autosaveTimer&&(window.clearTimeout(this._autosaveTimer),this._autosaveTimer=0)},_setAutosaveTimeout:function(){this._isAutosaveEnabled()&&(this._clearAutosaveTimeout(),this._autosaveTimer=window.setTimeout(this._autosaveTimerAction,this.AUTOSAVE_PERIOD))},_autosaveTimerAction:function(){var e=this.getModel("compose-fsm");e.canAutosave()?e.setState("save"):this._setAutosaveTimeout()}}})},3972:function(e,t){!(function(){ns.View.define("compose-disable-on-sending-mixin",{yateModule:"compose2",methods:{disableOnSendingInit:function(){ns.assert(this.getModel("compose-fsm"),"vComposeDisableOnSendingMixin","должен иметь mComposeFsm в зависимостях"),this.onToggleControl=this.onToggleControl.bind(this)},disableOnSendingStart:function(){var e=this.getModel("compose-fsm");e.on("# *",this.onToggleControl),e.on("* > *",this.onToggleControl)},disableOnSendingStop:function(){var e=this.getModel("compose-fsm");e.off("# *",this.onToggleControl),e.off("* > *",this.onToggleControl)},onToggleControl:function(e,t){var n=!0,o=this.getModel("compose-fsm");if(o.isCurrentState(["edit","save"])){if(o.inTransition()){var s=_([t.from,t.to]).difference(["save","edit"]).isEmpty();s||(n=!1)}}else n=!1;this.$node.toggleClass("is-disabled",!n)}}})})()},3973:function(e,t){!(function(){ns.View.define("compose-field-base-hotkeys",{yateModule:"compose2",events:{"keydown@show":"_onKeydown"},methods:{_onKeydown:function(e){var t=ns.Model.get("settings"),n=t.getSetting("enable_hotkeys");if("compose2"!==ns.page.current.page&&n){Boolean(Modernizr.mac?e.metaKey:e.ctrlKey)&&e.keyCode===Jane.Common.keyCode.ENTER&&(e.preventDefault(),this.getModel("compose-fsm").setState("sending"))}}}})})()},3974:function(e,t,n){"use strict";function o(e,t,n,o,s,i,a){try{var r=e[i](a),c=r.value}catch(e){return void n(e)}r.done?t(c):Promise.resolve(c).then(o,s)}function s(e){return function(){var t=this,n=arguments;return new Promise(function(s,i){function a(e){o(c,s,i,a,r,"next",e)}function r(e){o(c,s,i,a,r,"throw",e)}var c=e.apply(t,n);a(void 0)})}}Object.defineProperty(t,"__esModule",{value:!0});var i=n(3975),a=n(531);Daria.AttachDiskPopupMixin={_openDiskOnClick:function(){this._popup=i.a.create({path:this._getPath(),onCancel:this._onDiskPopupClosed.bind(this),onAttach:this._onAttachAdded.bind(this)})},_onAttachAdded:function(e){var t=e.selectedItems,n=t.map((function(e){return{id:e.id,resource:e}}));this._attachDirectly(n)},_attachDirectly:function(e){var t=ns.Model.get("compose-attachments",this.params);e.forEach((function(e){return t.addAttach(e)})),this._onDiskPopupClosed()},_onDiskPopupClosed:(function(){function e(){return t.apply(this,arguments)}var t=s(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._popup){e.next=4;break}return e.next=3,this._popup.unmount();case 3:this._popup=null;case 4:case"end":return e.stop()}}),e,this)})));return e})(),_getMetrikaPart:function(){return this.METRIKA_PARTS[this.MODE]},_getPath:function(){return this.PATHS[this.MODE]},METRIKA_PARTS:{mail:"Клик по Прикрепить из почты",disk:"Клик по Прикрепить с диска"},PATHS:{mail:a.b,disk:a.a}}},3975:function(e,t,n){"use strict";var o=n(3976);Daria.DiskResources=new o.a,t.a=Daria.DiskResources},3976:function(e,t,n){"use strict";function o(e,t,n,o,s,i,a){try{var r=e[i](a),c=r.value}catch(e){return void n(e)}r.done?t(c):Promise.resolve(c).then(o,s)}function s(e){return function(){var t=this,n=arguments;return new Promise(function(s,i){function a(e){o(c,s,i,a,r,"next",e)}function r(e){o(c,s,i,a,r,"throw",e)}var c=e.apply(t,n);a(void 0)})}}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function l(e,t,n){return t&&u(e.prototype,t),n&&u(e,n),e}function d(e,t,n,o){h||(h="function"==typeof Symbol&&Symbol.for&&Symbol.for("react.element")||60103);var s=e&&e.defaultProps,i=arguments.length-3;if(t||0===i||(t={children:void 0}),1===i)t.children=o;else if(i>1){for(var a=new Array(i),r=0;r<i;r++)a[r]=arguments[r+3];t.children=a}if(t&&s)for(var c in s)void 0===t[c]&&(t[c]=s[c]);else t||(t=s||{});return{$$typeof:h,type:e,key:void 0===n?null:""+n,ref:null,props:t,_owner:null}}n.d(t,"a",(function(){return y}));var h,p=n(137),f=n.n(p),m=n(141),g=n.n(m),b=n(353),_=n(1314),v=function(e){return new Promise(function(t){return setTimeout(t,e)})},y=(function(){function e(){c(this,e),this.services={settings:{isMobile:!1}}}return l(e,[{key:"create",value:function(e){return this.rendered||(this.rendered=!0,this.props=e,this.node=document.createElement("div"),document.body.appendChild(this.node),this._render(a({isVisible:!0},e))),this}},{key:"_render",value:function(e){g.a.render(d(b.Provider,{services:this.services},void 0,f.a.createElement(_.a,e)),this.node)}},{key:"unmount",value:(function(){function e(){return t.apply(this,arguments)}var t=s(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.rendered){e.next=7;break}return this._render(a({isVisible:!1},this.props)),this.rendered=!1,e.next=5,v(200);case 5:g.a.unmountComponentAtNode(this.node),this.node=null;case 7:case"end":return e.stop()}}),e,this)})));return e})()}]),e})()},3977:function(e,t){!(function(){ns.View.edefine("compose-attach-open-disk-mixin",{yateModule:"compose2",methods:_.extend({openDiskInit:function(){this.openDiskOnClick=this.openDiskOnClick.bind(this),this.$node.on("click",this.openDiskOnClick)},openDiskDestroy:function(){this.$node.off("click",this.openDiskOnClick)},openDiskOnClick:function(e){this._openDiskOnClick(e)},_popup:null,PATH:null},Daria.AttachDiskPopupMixin,{_onAttachAdded:function(e){var t=e.selectedItems,n=t.map((function(e){return{id:e.id,resource:e}}));this._attachDirectly(n)}})},ns.View)})()},3978:function(e,t){!(function(){ns.View.define("compose-field-phone-error-mixin",{yateModule:"compose2",methods:{getErrorMessage:function(){var e=this.getModel("compose-message"),t=e.getAllRecepients();return t.length>1?i18n("%Compose_Phone_Error_Manymail"):t.some((function(e){return ns.Model.get("account-information").isMyEmail(e.email)}))?i18n("%Compose_Phone_Error_Usermail"):""}}})})()},3979:function(e,t){!(function(){ns.View.define("compose-template-list-popup-mixin",{yateModule:"compose2",methods:{openTemplateListInit:function(){this._openTemplateListOnClick=this._openTemplateListOnClick.bind(this),this.$node.on("click",this._openTemplateListOnClick)},openTemplateListDestroy:function(){this.$node.off("click",this._openTemplateListOnClick),this.popup&&this.popup.close()},_openTemplateListOnClick:function(){this.popup=ns.View.create("compose-template-list",this.params),this.popup.open({where:this.node,autofocus:!0}),Jane.c("Написание письма","Шапка письма",'Клик в "Шаблон"')}}})})()},3980:function(e,t,n){"use strict";function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Object.defineProperty(t,"__esModule",{value:!0});var a=n(384),r=n(421),c=n(681),u=n(792),l=n(663),d=(n.n(l),n(425)),h=n(908),p=n(606),f=n(139);n.n(f);!(function(){var e,t=(e={virus_found:i18n("%Compose_virus_found"),strongspam_found:i18n("%Compose_strongspam_found"),incorrect_to:i18n("%Compose_incorrect_to"),incorrect_cc:i18n("%Compose_incorrect_cc"),incorrect_bcc:i18n("%Compose_incorrect_bcc"),msg_too_big:i18n("%Compose_msg_too_big"),no_recipients:i18n("%Compose_no_recipients"),fail_limit:i18n("%Compose_fail_limit"),too_many_emails:i18n("%Compose_too_many_emails"),max_email_addr_reached:i18n("%Compose_exceeded_limit_of_N_recipients",Daria.Constants.MAX_MESSAGES_TO_SEND),no_data:i18n("%Compose_no_data"),http_status_0:i18n("%Нет_доступа_к_интернету"),attachment_too_big:i18n("%_Compose_attachment_too_big_custom",Daria.Constants.MAX_MESSAGES_TO_FORWARD,Daria.Constants.MAX_TOTAL_SIZE_OF_ATTACHMENTS),internal_error:i18n("%Compose_internal_error"),access_denied:i18n("%Compose_access_denied_error"),illegal_params:i18n("%Compose_illegal_params_error")},i(e,l.UNDO_CANNOT_SAVE,i18n("%Compose_undo_cannot_save_error")),i(e,l.UNDO_MESSAGE_SAVED,i18n("%Compose_undo_message_saved_error")),i(e,l.DELAYED_CANNOT_SAVE,i18n("%Compose_delayed_cannot_save_error")),i(e,l.DELAYED_MESSAGE_SAVED,i18n("%Compose_delayed_message_saved_error")),e),n=[void 0,"","message-not-valid","captcha_request","need-confirm","attachments-failed","send-cancelled"],o=["compose-forwarded-messages","compose-state","compose-fsm","compose-attachments","compose-notify-noreply-options","compose-signature","compose-message"],m=["to","cc","bcc"];Daria.composeKey=function(e){return e&&e._cuid||"compose"};var g=_.memoize((function(e){return _.pick(e,["ids","tids","oper","qrIds","_cuid"])}),Daria.composeKey);Daria.getPageComposeIds=function(){var e=ns.page.current.params,t=Daria.composeKey(e);if(Daria.composeHasParams(t))return t},Daria.getRealComposeIds=function(e){var t=e.ids,n=ns.page.current.params;return!t&&g.cache.has(Daria.composeKey(n))&&Daria.isComposePage()&&n._cuid&&n.ids&&(t=n.ids),t},Daria.composeHasParams=function(e){var t=g.cache.get(e);return!_.isUndefined(t)&&ns.Model.get("compose-message",t).isValid()},Daria.composeKeyParams=function(e){return{_cuid:Daria.composeKey(e)}},ns.View.edefine("compose2",{events:{"ns-view-init":"onInit","ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","ns-view-destroyed":"onDestroyed","ns-page-before-load@show":"onPageBeforeLoad","daria:MOPS:delete":"onMessageRemoved","daria:vCompose2:send@show":"onSend","daria:vCompose2:save@show":"onSave"},models:{"compose-message":{"ns-model-changed":!1,"ns-model-changed.lids":"onLidsChange","ns-model:validation-error":"onValidationError","ns-model:draft-saved":"onDraftSaved","ns-model:captcha-request":"showCaptcha","ns-model:need-to-confirm:send-without-to":"showConfirmPopup","ns-model:need-to-confirm:attachments-forgotten":"showForgottenAttachmentsDialog"},"compose-state":{"ns-model-changed":!1,"ns-model:compose:update":"_composeUpdate"},"compose-fsm":{"ns-model-changed":!1,"# sending":"onSending","# cancel":"onCancel","# sent":"onSent","save > sending":"onSaveToSending","sending > sent":"onSendingToSent","sending !> sent":"onSendingToSentFailed"},"compose-attachments":!1,"compose-forwarded-messages":!1,"compose-notify-noreply-options":!1,"compose-signature":!1,signs:!1},params:function(e){return g(e)},ctor:function(){this._forgottenAttachView=null,this._popup=null,this._composeUpdate=_.debounce(this._composeUpdate.bind(this),50)},yateModule:"compose2",methods:{ERROR_CODES:t,VIEWPORT_PADDING_WITH_LEFT_COL_COMPOSE_BUTTON:8,_composeUpdate:function(){this.isVisible()&&this.update()},onInit:function(){this.autosaveInit()},onMessageRemoved:function(e,t){if(t.originalAction&&"remove.draft"===t.originalAction&&t.messageInfo&&t.messageInfo.data){var n=ns.router.generateUrl("messages",{current_folder:t.messageInfo.data.fid});ns.page.go(n),Jane.c("Написание письма","Шапка письма",'Клик в "Удалить черновик"')}},onHtmlInit:function(){this.leaveInit(),Daria.isComposePage()&&ns.Model.get("focus").resetFocus(!0);var e=this.getModel("compose-message");if((e.isTemplate()||e.isDraft())&&e.mMessage){var t=ns.Model.get("messages-checked");t.resetChecked(),t.check(e.mMessage,!0)}this.scrollToComposeTop()},onShow:function(){this.isDestroyed=!1,this.getModel("compose-fsm").switchOn(),this.autosaveStart(),this.leaveStart(),ns.events.trigger("daria:vToolbarButton:restruct",{force:!0}),this._logComposeOpen(d.a);var e=ns.Model.get("settings").isSet("liza_minified_header");Daria.isComposePage()&&($(".js-mail-Layout-Panes").addClass("mail-Layout-Panes_compose"),ns.Model.get("app-state").updatePageClasses({"mail-Page_compose":!0,"mail-Page_compose-minified":e})),this._preloadDonePage(),Daria.SendMail.getUndoSendLogger(this.params.ids).composeLoaded=!0},_logComposeOpen:function(e){if(e.hasActiveScenario(a.a)){var t=e.getActiveScenario(a.a),n=t.getTimeFromStart();t.logStep(c.d,{duration:n})}else if(ns.page.history.getPrevious())e.startScenario(a.a,r.d);else{var o=_.get(window,"performance.timing.navigationStart");if(o){var s=Date.now()-o,i=Daria.now()-s,u=e.startScenario(a.a,r.e,{startTime:i});u.logStep(c.d,{duration:s})}else e.startScenario(a.a,r.e)}},onHide:function(){Daria.SendMail.getUndoSendLogger(this.params.ids).composeLoaded=!1,this.autosaveStop(),this.leaveStop(),_.defer((function(){"message"!==ns.page.current.page&&(ns.Model.get("messages-checked").resetChecked(),ns.events.trigger("daria:vToolbarButton:restruct",{force:!0}))})),$(".js-mail-Layout-Panes").removeClass("mail-Layout-Panes_compose"),ns.Model.get("app-state").updatePageClasses({"mail-Page_compose":!1,"mail-Page_compose-minified":!1})},onDestroyed:function(){this._destroy()},onPageBeforeLoad:function(e,t,n){if(n!==ns.page.currentUrl){var o=t[0],s=t[1];if(!Daria.composeEqualRoutes(o,s)){var i=s.params._cuid,a=s.params.save_symbol===f.WellKnownFolderSymbol.TEMPLATE&&!o.params.save_symbol,r=this.getModel("compose-message").wasSendCancelled();if(!a&&s.params.ids&&(!o.params.ids||o.params.ids!==s.params.ids)){a=ns.Model.get("message",{ids:s.params.ids}).isTemplate()}if(("compose2"!==o.page||a||r||"compose2"!==s.page&&!Daria.composeHasParams(i))&&("compose2"===o.page||"compose2"!==s.page||!Daria.composeHasParams(i))){if("compose2"!==s.page){Daria.SendMail.getUndoSendLogger(s.params.ids).composeLoaded=!1}this.shouldClearModel=!0,this._destroy()}}}},onDraftSaved:function(e,t){if(this.isVisible()){var n=this.getModel("compose-state");if(n.get(".saveTemplateAndLeave"))return void n.set(".saveTemplateAndLeave",!1);if(n.get(".saveTemplateAndReset"))return n.set(".saveTemplateAndReset",!1),void this.hardResetCompose();var o=_(ns.page.current.params).pick("_cuid").assign({ids:t.mid}).value(),s=ns.router.generateUrl("compose2",o);ns.page.go(s,"replace")}},hardResetCompose:function(){this.clean(),Daria.composeGo()},_destroy:function(){this.isDestroyed||(this.isDestroyed=!0,this.shouldClearModel&&(delete this.shouldClearModel,this.clean()))},setState:function(e,t){return this.getModel("compose-fsm").setState(e,t)},onSending:function(e,t){this.isVisible()&&(this.setState("sent",t.data),d.a.hasActiveScenario(a.a)&&d.a.getActiveScenario(a.a).logStep(c.f))},onCancel:function(){this.isVisible()&&(this.shouldClearModel=!0)},onSent:function(){if(this.isVisible()){this.shouldClearModel=!0;var e=this.getModel("compose-message"),t=this.getModel("compose-attachments"),n=this.getModel("compose-forwarded-messages"),o=e.isDelayed()?u.g:u.h,i=t.getSummary(),r=n.getMessagesIds(),c=i.fileAttachmentsCount,l=i.diskAttachmentsCount,f=c+l+r.length>0,m=r.length?r:e.get(".mark_ids");d.a.finishScenario(a.a,o,s({autocomplete:Object(p.c)()},i,{bodyLength:Object(h.a)(e.get(".send")),hasAttachments:f,forwardedMailsAttachmentsCount:r.length,relatedMailIds:m}))}},onSaveToSending:function(){return Daria.Statusline.show({name:"before_sending_message",hideOnTimeout:!1,isCloseButtonVisible:!1,hideOnClick:!1}),this.getModel("compose-message").waitForDraftSave()},onSendingToSent:function(e,t){if(this.isVisible())return this.closePopup(),this.send(t.data)},onSendingToSentFailed:function(e,t){if(this.isVisible()){if(this.setState("edit"),!_.contains(this.silentStatuses,t.error)&&(this.showErrorPopup(t.error),d.a.hasActiveScenario(a.a))){var n=this.getModel("compose-message"),o=n.isDelayed()?c.e:c.g,s={error:t.error};d.a.getActiveScenario(a.a).logStep(o,s)}Daria.Statusline.hide()}},send:function(e){return e=_.extend({},{force:this.params.sendWithForce},e),this.getModel("compose-message").send(e)},silentStatuses:n,showErrorPopup:function(e){var t=this,n=i18n("%Произошла_ошибка"),o=this.getErrorMessageByCode(e);[l.UNDO_CANNOT_SAVE,l.UNDO_MESSAGE_SAVED].includes(e)?Daria.SendMail.showTryAgainPopup({title:n,message:o,onRetry:function(){t.getModel("compose-message").setSendWithoutUndo(),t.onSend()},onCancel:null}):[l.DELAYED_CANNOT_SAVE,l.DELAYED_MESSAGE_SAVED].includes(e)?Daria.SendMail.showTryAgainPopup({title:n,message:o,isDelayed:!0,onRetry:function(){var e=t.getModel("compose-message");e.setSendWithoutUndo(),e.resetDelayed(),t.onSend()},onCancel:null}):Daria.Dialog.notice({title:n,body:"<p>"+o+"</p>"})},getErrorMessageByCode:function(e){var t=this.ERROR_CODES[e];return t||(t=i18n("%Compose_send_failed")),t},showCaptcha:function(){if(this.isVisible()){var e=ns.View.create("compose-captcha");e.update().then((function(){Daria.Dialog.open({title:e.popupData.title,body:e.$node,width:e.popupData.width,onopen:function(){e.focusInput()},onclose:function(){e.invalidate(),e.destroy()}})})),d.a.hasActiveScenario(a.a)&&d.a.getActiveScenario(a.a).logStep(c.a)}},showForgottenAttachmentsDialog:function(e,t){if(this.isVisible()){var n=_.clone(this.params),o=this._forgottenAttachView=ns.View.create("compose-forgotten-attach",n);o.data=t,o.updateByLayout("forgotten-attach",n).then(this.onForgottenAttachUpdated.bind(this)),o.once("ns-view:close",this.onForgottenAttachClose.bind(this))}},onForgottenAttachUpdated:function(){var e=this._forgottenAttachView;this.closePopup(),this._popup=Daria.Dialog.open({width:e.popupData.width,body:e.$node})},onForgottenAttachClose:function(){this.closePopup();var e=this._forgottenAttachView;setTimeout((function(){e.destroy(),e=null}),0)},closePopup:function(){this._popup&&this._popup.isOpen()&&(this._popup.close(),this._popup=null)},showConfirmPopup:function(){this.isVisible()&&Daria.Dialog.confirm({body:'<div class="b-popup__p">'+i18n("%Compose_Empty_To")+"</div>",width:360,okValue:i18n("%Отправить"),okHandler:function(){this.setState("sending",{force:!0})}.bind(this),oncancel:function(){}})},onLidsChange:function(){this.isVisible()&&this._composeUpdate()},onValidationError:function(e,t){if(this.isVisible()){var n=_.find(m,(function(e){return t.hasOwnProperty(e)}));this.scrollToComposeTop(),this.getModel("compose-state").setFocusField(n,{force:!0})}},scrollToComposeTop:function(){var e=this.node.getBoundingClientRect(),t=e.top;window.scrollTo(0,window.pageYOffset+t-this.VIEWPORT_PADDING_WITH_LEFT_COL_COMPOSE_BUTTON)},clean:function(){_.each(o,(function(e){this.getModel(e).destroy()}),this);var e=ns.View.infoLite("compose-popular-contacts").params(this.params);ns.Model.get("compose-popular-contacts",e).clean(),this.invalidate(),g.cache.delete(Daria.composeKey(this.params))},onSend:function(){this.setState("sending")},onSave:function(){this.setState("save")},_preloadDonePage:function(){Daria.isComposePage()&&this.shouldGoToDonePage()&&Jane.Services.runModules(["done.js"],(function(){ns.forcedRequest("done-promos")}))}}},"compose-autosave-mixin","compose-leave-mixin",ns.View)})()},3981:function(e,t){ns.View.define("compose-send-loader",{models:{"compose-fsm":{"sending > sent":"showLoader","# *":"hideLoader"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{CLASS_HIDDEN:"is-hidden",showLoader:function(){this.$node.removeClass(this.CLASS_HIDDEN)},hideLoader:function(){this.$node.addClass(this.CLASS_HIDDEN)}}})},3982:function(e,t){ns.View.define("compose-head",{params:ns.View.info("compose2").params,yateModule:"compose2"})},3983:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(139);n.n(o);ns.View.define("compose-template-list",{models:{messages:!1,"compose-message":!1,"compose-state":!1,"compose-fsm":!1},events:{"click@show":"_onClick","click@show .js-template-item":"onTemplateClick","click@show .js-new-template":"onCreateTemplateClick","click@show .js-create-template":"onCreateTemplateClick","click@show .js-save-template":"onSaveTemplateClick"},ctor:function(){this._defaultOptions={withoutTail:!1,autofocus:!1,autoclose:!0},this._options={},this._popup=null},yateModule:"compose2",params:function(e){var t=ns.Model.get("folders").getFidBySymbol(o.WellKnownFolderSymbol.TEMPLATE);return _.extend({},ns.View.info("compose2").params(e),{current_folder:t,allow_empty:!0})},methods:{onTemplateClick:function(e){var t=$(e.currentTarget).data("mid");if(t){Jane.c("Шаблоны:","Шаблоны дропдаун","Выбор шаблона");var n=this.getModel("compose-message");n.isDraft()||n.isReplyAny()||n.isForward()?ns.request(["message","message-body"],{ids:t,draft:!0}).then(this.onMessageBodyRequestSuccess.bind(this,n)):ns.page.go(ns.router.generateUrl("compose2",{ids:t}))}},onMessageBodyRequestSuccess:function(e,t){var n=t[0],o=t[1];if(e.addTextFromMessageBody(o),0===e.getAllRecepients().length&&e.setRecepientsFromMessageBody(o),!e.get(".subj")){var s=n.get(".subject");s&&e.set(".subj",s)}e.addAttachmentsFromTemplateMessageBody(o)},onCreateTemplateClick:function(){Jane.c("Шаблоны:","Шаблоны дропдаун","Новый шаблон");var e=this.getModel("compose-message"),t={save_symbol:o.WellKnownFolderSymbol.TEMPLATE},n=ns.Model.get("compose-predefined-data"),s=e.getData(),i=Object.assign({},s,t);n.setData(i),ns.page.go(ns.router.generateUrl("compose2",t)).then((function(){ns.Model.get("compose-message",t).setDirty(!0)}))},onSaveTemplateClick:function(){Jane.c("Шаблоны:","Шаблоны дропдаун","Сохранить шаблон");var e=this.getModel("compose-message"),t=this.getModel("compose-fsm");e.set(".save_symbol",o.WellKnownFolderSymbol.TEMPLATE),t.setState("save")},open:function(e){return this._options=_.extend({},this._defaultOptions,e),this.updateByLayout("compose-template-list",this.params).then(this._onAfterRender,this)},close:function(){this._popup&&this._popup.close()},_onClick:function(){this.close()},_onAfterRender:function(){this._popup=nb.block(Jane.tt("compose2:js-compose-template-list")),this._popup.setContent(this.node),this._popup.on("nb-closed",this._onDestroyed.bind(this)),this._popup.open(this._options)},_onDestroyed:function(){this._popup&&(this._popup.destroy(),this._popup=null),this._options={},this.destroy()}}})},3984:function(e,t){!(function(){ns.View.edefine("compose-template-list-button",{models:{},events:{"ns-view-show":"onShow","ns-view-hide":"onHide"},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onShow:function(){this.openTemplateListInit()},onHide:function(){this.openTemplateListDestroy()}}},"compose-template-list-popup-mixin")})()},3985:function(e,t){ns.View.define("compose-field-message-resize",{yateModule:"compose2",methods:{messageResizeInit:function(){ns.assert(this.getModel("compose-state"),"Daria.vComposeFieldMessageResize","Должна быть определена модель compose-state"),this._messageResizeInitShow=this._messageResizeInitShow.bind(this),this._onChangeMessageHeight=this._onChangeMessageHeight.bind(this)},messageResizeStart:function(){this.getModel("compose-state").on("ns-model-changed.messageHeight",this._onChangeMessageHeight),ns.Model.get("app-state").on("ns-model-changed.timelineHeight",this._messageResizeInitShow),this._messageResizeInitShow()},messageResizeStop:function(){this.getModel("compose-state").off("ns-model-changed.messageHeight",this._onChangeMessageHeight),ns.Model.get("app-state").off("ns-model-changed.timelineHeight",this._messageResizeInitShow)},getHeight:function(){return this._getHeight()},onChangeHeight:function(){ns.assert(!1,"Daria.vComposeFieldMessageResize",'"onChangeHeight" must be implemented by subclass')},_onChangeMessageHeight:function(){this.onChangeHeight()},_getHeight:function(){return this.getModel("compose-state").get(".messageHeight")},_messageResizeInitShow:function(){var e=this.$node.closest(".js-form").children(":last-child");if(e.length){var t=e[0].getBoundingClientRect();if(t&&(t.width||t.height)){var n=this._$window.height(),o=ns.Model.get("app-state").get(".timelineHeight");if(n&&!(n<t.bottom)){var s=this.$node.outerHeight(!1)-10,i=Math.floor(s+n-t.bottom-o);this.getModel("compose-state").setMessageHeight(i)}}}}}})},3986:function(e,t){ns.View.define("compose-field-base-abook",{models:{"compose-message":!1},events:{"click .js-field-caption":"onCaptionClick"},yateModule:"compose2",methods:{abookInit:function(){this._loadModulesOnce()},isAbookPopupAvailable:!0,onCaptionClick:function(e){e.preventDefault(),e.stopImmediatePropagation(),this.showAbookContactsPopup("compose-field-caption")},showAbookContactsPopup:function(e){Jane.Services.runModules(["abook.css","abook.js","abook.yate"],this._showPopupWhenReady.bind(this,e))},_showPopupWhenReady:function(e){var t={};t[this.FIELD_NAME]=this.getModel("compose-message").getContacts(this.FIELD_NAME);var n=new vow.Deferred;n.promise().then(this.onAbookContactsSelected.bind(this),this.onAbookPopupClosed.bind(this)),ns.action.run("mail-common.abook-popup",{popupType:"select",emails:t,resultDeferred:n}),this._countAbookPopupShow(e)},onAbookContactsSelected:function(e){this.getModel("compose-message").setContacts(this.FIELD_NAME,e),this.onAbookPopupClosed()},onAbookPopupClosed:function(){this.focus()},_countInfo:{sourceType:{"compose-field-caption":"через клик на подпись поля композа","compose-field-suggest":'через клик на "Все контакты" в саджесте'},fieldName:{to:"Кому",cc:"Копия",bcc:"Скрытая копия"}},_countAbookPopupShow:function(e){Jane.c(["АК в саджесте композа","показ попапа",this._countInfo.sourceType[e],this._countInfo.fieldName[this.FIELD_NAME]])},_loadModulesOnce:(function(){var e=!1;return function(){e||(e=!0,Jane.Services.load("#abook"))}})()}})},3987:function(e,t){ns.View.define("compose-field-base-suggest",{yateModule:"compose2",methods:{suggestInit:function(e,t){this._suggestItemSelect=this._suggestItemSelect.bind(this),this._suggestValueSet=this._suggestValueSet.bind(this),this._suggestGetPositionNode=this._suggestGetPositionNode.bind(this);var n=$.extend({getPositionNode:this._suggestGetPositionNode,fieldType:this.FIELD_NAME,multiple:this.areYabblesDisabled(),position:{my:"left top",at:"left+9px bottom-1px",collision:"none"},showAbookPopupButton:this.isAbookPopupAvailable},t);"phone"===e?this.suggestInstance=new Daria.Suggest.Phones(null,n):(n.exclude=function(){var e=this.getModel("compose-message").getAllRecepientEmails();return this.areYabblesDisabled()&&e[this.FIELD_NAME].pop(),e}.bind(this),this.suggestInstance=new Daria.Suggest.Contacts(null,n))},suggestStart:function(){return!!this.areYabblesDisabled()&&(this.suggestInstance.on("select",this._suggestItemSelect),this.suggestInstance.on("value-set",this._suggestValueSet),this.suggestInstance.changeInputField(this.getControllerNode()),!0)},suggestStop:function(){return!!this.areYabblesDisabled()&&(this.suggestInstance.off("select",this._suggestItemSelect),this.suggestInstance.off("value-set",this._suggestValueSet),this.suggestInstance.destroy(),!0)},_suggestGetPositionNode:function(){return this.node},_suggestValueSet:function(e,t,n,o){this.setFieldData(o)},_suggestItemSelect:function(e,t,n){switch(n.item.type){case"abook-popup-button":t.preventDefault(),this.isAbookPopupAvailable&&this.showAbookContactsPopup("compose-field-suggest")}}}})},3988:function(e,t){!(function(){function e(e,t){return t.reduce((function(t,n){var o=_.isPlainObject(n),s=o?n.from:n,i="yabble-"+(o?n.to:n),a=e[s];return a&&(t[i]=a),t}),{})}var t=Daria.Constants.CONTACTS.DELIMITER;ns.View.define("compose-field-base-yabble-ng",{models:{"compose-state":!1,"compose-message":!1},yateModule:"compose2",methods:{CLASS_YABBLE_FOCUS:"mail-Bubbles-FocusArea",_bindMethods:function(){_.bindAll(this,["_bubbleSuggestItemSelect","_bubbleSuggestOpen","_bubbleSuggestClose","_yabbleSyncViewToData","_bubbleDragStart","_bubbleDragEnter","_bubbleDragLeave","_bubbleDragEnd","_bubbleEdit","_bubbleInput","_bubblesetFocus","_bubblesetBlur","_bubblesetKeydown","_bubblesetClick","_bubbleClick","_bubblesUpdate","_onBubbleDropdownDestroy","_onBubbleDropdownOpened","_onBubbleDropdownClosed","_onBubbleFieldValueChanged"])},yabbleInit:function(){this._bindMethods(),this._BubbleClass=this._BubbleClass||Daria.BaseBubble,this.CLASS_CUSTOM_BUBBLE=this._BubbleClass.BUBBLE_CLASS,this._bubblesUpdateDebounce=_.debounce(this._bubblesUpdate,100),this._bubbleClickDebounce=_.debounce(this._bubbleClick,200),this._onBubbleFieldValueChangedDebounce=_.debounce(this._onBubbleFieldValueChanged,50)},getCustomBubbleClass:function(){return this.CLASS_CUSTOM_BUBBLE},yabbleStart:function(){if(this.areYabblesDisabled())return!1;var e=this.getControllerNode();return e&&e[0]&&e[0].options&&e[0].options("lineBreakReplacer","; "),e.on({blur:this._bubblesetBlur,"bubble-input":this._bubbleInput,"bubble-edit":this._bubbleEdit,change:this._yabbleSyncViewToData,click:this._bubblesetClick,dragstart:this._bubbleDragStart,dragenter:this._bubbleDragEnter,dragleave:this._bubbleDragLeave,dragend:this._bubbleDragEnd,focus:this._bubblesetFocus,keydown:this._bubblesetKeydown}),this.suggestInstance&&(this.$suggestProxy=this.$node.find(".js-suggest-proxy"),this.suggestInstance.on("select",this._bubbleSuggestItemSelect).on("open",this._bubbleSuggestOpen).on("close",this._bubbleSuggestClose)),this._customSyncDataToView=this._yabbleSyncDataToView,this._customSyncViewToData=this._yabbleSyncViewToData,this._customOnInput=_.noop,this._bubblesUpdateDebounce(),this._onBubbleFieldValueChanged(),!0},yabbleStop:function(){return!this.areYabblesDisabled()&&(this.getControllerNode().off(),this.suggestInstance&&(this.$suggestProxy=null,this.suggestInstance.off("select",this._bubbleSuggestItemSelect).off("open",this._bubbleSuggestOpen).off("close",this._bubbleSuggestClose),this.suggestInstance.destroy()),this._customSyncDataToView=null,this._customSyncViewToData=null,this._customOnInput=null,!0)},_getBubbleset:function(){return this.getControllerNode()[0]},_bubbleSuggestOpen:function(){this._getBubbleset().options("disableControls",!0)},_bubbleSuggestClose:function(){this._getBubbleset().options("disableControls",!1)},_bubbleInput:function(e){this.$suggestProxy.val(e.originalEvent.detail.data).trigger("keydown")},_bubbleEdit:function(){this._bubbleClickDebounce.cancel(),this._bubbleDropdownDestroy()},_bubblesetFocus:function(){this.suggestInstance.changeInputField(this.$suggestProxy)},_bubblesetBlur:function(){this.suggestInstance&&this.suggestInstance.hide()},_bubblesetKeydown:function(e){if(this.suggestInstance){var t=e.charCode||e.keyCode,n=Jane.Common.keyCode;switch(t){case n.TAB:this.suggestInstance.isOpen()&&this.suggestInstance.focusedSelect();break;case n.ENTER:case n.ESC:case n.UP:case n.DOWN:this.suggestInstance.isOpen()&&this.suggestInstance.$inputField.trigger(e)}}},onWaitSuggestChanged:function(){var e=this.getModel("compose-state"),t=e.getFocusField(),n=e.getWaitSuggest();this.isVisible()&&this.FIELD_NAME===t&&n&&(this.getControllerNode().focus(),e.setWaitSuggest(!1))},_onBubbleFieldValueChanged:function(){},_bubbleSuggestItemSelect:function(t,n,o){n.preventDefault();var s=o.item,i=this._getBubbleset();i.focus();var a;switch(s.type){case"group":i.addBubble(s.name,e(s,[{from:"id",to:"tid"},"value","email","name","type"]));break;case"contact":case"wsContainer":i.addBubble(s.value,e(s,[{from:"id",to:"cid"},"type","phone","email","name"]));break;case"popdom":a=Object.assign({},s),a.id<0&&delete a.id,i.addBubble(a.value,e(a,[{from:"id",to:"cid"},"type"]));break;case"abook-popup-button":this.isAbookPopupAvailable&&this.showAbookContactsPopup("compose-field-suggest")}this._yabbleSyncViewToData()},_bubblesetChange:function(){var e=this.getControllerNode().prop("items"),n=e.map(this._BubbleClass.toString).join(t);this.setFieldData(n),this._bubblesUpdateDebounce()},_bubbleDragStart:function(e){this.suggestInstance&&this.suggestInstance.hide();var t=_.get(e,"detail.target")||e.target;this._toggleGlobalDragData(t)},_bubbleDragEnter:function(){this._getDragClasses().indexOf(this.CLASS_CUSTOM_BUBBLE)>-1&&this.$node.addClass(this.CLASS_YABBLE_FOCUS)},_bubbleDragLeave:function(){this.$node.removeClass(this.CLASS_YABBLE_FOCUS)},_bubbleDragEnd:function(e){this._bubbleDragLeave(e),this._toggleGlobalDragData()},_toggleGlobalDragData:function(e){var t=document.documentElement;e?(t.setAttribute("data-dragged-yabbles-class-names",e.className),t.classList.add("yabbles-drag")):(t.removeAttribute("data-dragged-yabbles-class-names"),t.classList.remove("yabbles-drag"))},_getDragClasses:function(){var e=document.documentElement,t=e.getAttribute("data-dragged-yabbles-class-names");return t?t.split(" "):[]},_yabbleSyncDataToView:function(){var e=this.getModel("compose-message").getContacts(this.FIELD_NAME);this._getBubbleset().setContent(this._syncDataToViewFormatContacts(e).join(t))},_syncDataToViewFormatContacts:function(e){return e},_yabbleSyncViewToData:function(){this.suggestInstance&&(this.suggestInstance.hide(),(this.suggestInstance.currentTerm||this.suggestInstance.prevTerm)&&this.suggestInstance.log({suggest_used:"no"})),this._bubbleDropdown&&this._bubbleDropdown.destroy(),this._bubblesetChange()},_bubblesUpdate:function(){},_onBubbleDropdownDestroy:function(){this._bubbleDropdown&&this._bubbleDropdown.$node&&this._unsetBubbleDropdownEventHandlers(this._bubbleDropdown.$node),this._bubbleDropdown=null},_onBubbleDropdownOpened:function(e,t){if(!_.get(t,"where.parentNode"))return void t.destroy();var n=this;_.defer((function(){var e=t.$node&&t.$node.find(".js-bubble-copy");if(e.length){var o=new Daria.Clipboard(e);o.on("ready",(function(){if(t.where){var o=new n._BubbleClass(t.where).getHeadEmail();this.setText(o),e.removeClass("is-disabled")}})),o.on("complete",(function(){t.destroy()})),t.on("nb-closed",_.debounce((function(){o.destroy()}),50))}})),this._onBubbleDropdownDestroy=t.destroy.bind(t),this._$window.one("scroll",this._onBubbleDropdownDestroy),this._$document.one("keydown",this._onBubbleDropdownDestroy),ns.events.once("daria:vScrollerCompose:scroll",this._onBubbleDropdownDestroy),ns.events.once("daria:layout-changed",this._onBubbleDropdownDestroy)},_onBubbleDropdownClosed:function(e,t){this._onBubbleDropdownDestroy&&(this._$window.off("scroll",this._onBubbleDropdownDestroy),this._$document.off("keydown",this._onBubbleDropdownDestroy),ns.events.off("daria:vScrollerCompose:scroll",this._onBubbleDropdownDestroy),ns.events.off("daria:layout-changed",this._onBubbleDropdownDestroy),delete this._onBubbleDropdownDestroy),t.destroy()},_bubblesetClick:function(e){var t=$(e.target).closest("[bubble]")[0];if(t){var n=!0;this._bubbleDropdown&&(n=this._bubbleDropdown.where!==t,this._bubbleDropdown.close()),this._bubbleClickDebounce(e,t,n)}else this.suggestInstance.show()},_bubbleClick:function(e,t,n){if(n){var o=new this._BubbleClass(t);t.parentNode&&this._bubbleOpenDropdown(o,t)}},_getBubbleDropdownData:function(){return{}},_setBubbleDropdownEventHandlers:function(){},_unsetBubbleDropdownEventHandlers:function(){},_bubbleOpenDropdown:function(e,t){this._bubbleDropdown=nb.block(ns.renderNode(this._getBubbleDropdownData(e),"js-bubble-dropdown","compose2")),this._bubbleDropdown.on("nb-destroyed",this._onBubbleDropdownDestroy),this._bubbleDropdown.on("nb-opened",this._onBubbleDropdownOpened),this._bubbleDropdown.on("nb-closed",this._onBubbleDropdownClosed),this._setBubbleDropdownEventHandlers(this._bubbleDropdown.$node,e,t),this._updateItemsGroupBubble(),this._bubbleDropdown.open({withoutTail:!1,autofocus:!1,animation:!1,where:t})},_bubbleDropdownDestroy:function(){this._bubbleDropdown&&this._bubbleDropdown.destroy()},_onClickRemoveBubble:function(e){this._bubbleDropdownDestroy(),this._getBubbleset().removeBubble(e)},_onClickSingleTargetBubble:function(e){this._bubbleDropdownDestroy();var t=new this._BubbleClass(e),n=this._getBubbleset();n.items.forEach((function(t){t!==e&&n.removeBubble(t)})),this.getModel("compose-message").setSingleRecipient(t.toString())},_onClickEditBubble:function(e){this._bubbleDropdownDestroy();var t=this._getBubbleset();t.focus(),t.editBubble(e)},_onClickAddAbookBubble:function(e){this._bubbleDropdownDestroy(),this._onSuccessAddAbookBubble&&(ns.events.off("yabble.add-to-abook",this._onSuccessAddAbookBubble),this._onSuccessAddAbookBubble=null);var t=_.uniqueId(),n=new this._BubbleClass(e);ns.action.run("yabble.add-to-abook",{id:t,name:n.get("name"),email:n.getHeadEmail()}),this._onSuccessAddAbookBubble=_.bind((function(n,o){this._onSuccessAddAbookBubble=null,o.id===t&&e.parentNode&&this._bubblesUpdate()}),this),ns.events.once("yabble.add-to-abook",this._onSuccessAddAbookBubble)},_onClickChangeEmailBubble:function(e,t){this._bubbleDropdownDestroy();var n=$(t.currentTarget).data("email"),o=new this._BubbleClass(e);o.setEmail(n),o.applyTo(e),this._bubblesetChange()},_onChangeGroupBubble:function(e,t){var n=$(t.currentTarget),o=n.find("input"),s=o.prop("checked"),i=o.val(),a=new this._BubbleClass(e);s?a.appendEmail(i,n.data("name")):a.removeEmail(i),a.applyTo(e),this._updateItemsGroupBubble(),this._bubblesetChange()},_updateItemsGroupBubble:function(){if(this._bubbleDropdown){var e=this._bubbleDropdown.$node.find("input:checked");e.closest(".js-bubble-change-group").toggleClass("is-disabled",1===e.length)}}}})})()},3989:function(e,t){!(function(){var e=ns.View.info("compose-field-base-yabble-ng");ns.View.edefine("compose-field-contact-yabble-ng",{yateModule:"compose2",methods:{CLASS_YABBLE_SMS_LINK:"mail-Bubbles-Sms",_BubbleClass:Daria.ContactBubble,_bindMethods:function(){e.methods._bindMethods.call(this),this._onBubbleSmsLinkToggle=this._onBubbleSmsLinkToggle.bind(this)},yabbleStart:function(){var t=e.methods.yabbleStart.call(this);return t&&(this.getModel("compose-state").on("sms-link-toggle",this._onBubbleSmsLinkToggle),this.getModel("compose-message").on("ns-model-changed.to",this._onBubbleFieldValueChangedDebounce).on("ns-model-changed.cc",this._onBubbleFieldValueChangedDebounce).on("ns-model-changed.bcc",this._onBubbleFieldValueChangedDebounce)),t},yabbleStop:function(){var t=e.methods.yabbleStop.call(this);return t&&(this.getModel("compose-state").off("sms-link-toggle",this._onBubbleSmsLinkToggle),this.getModel("compose-message").off("ns-model-changed.to",this._onBubbleFieldValueChangedDebounce).off("ns-model-changed.cc",this._onBubbleFieldValueChangedDebounce).off("ns-model-changed.bcc",this._onBubbleFieldValueChangedDebounce)),t},_bubblesUpdate:function(){for(var e=this.getControllerNode(),t=e.prop("items"),n=t.length,o=[];n--;){var s=t[n];if(!s.hasAttribute("lock")){var i=new this._BubbleClass(s);i.needUpdate()&&(o.push(i.getHeadEmail()),s.setAttribute("lock","lock"))}}if(o.length){var a,r=1/0,c=this;o.reduce((function(e,t){return t.length<c._BubbleClass.EMAIL_LEN_REQUEST&&(r+=t.length+1,r>c._BubbleClass.EMAIL_LEN_REQUEST&&(r=0,a=[],e.push(a)),a.push(t)),e}),[]).forEach((function(t){var n=[],o=t.join(",");n.push({id:"abook-contacts",params:{emails:o}}),Daria.Config.workspace&&n.push({id:"abook-contacts",params:{emails:o,shared:1}}),ns.request(n).then((function(n){for(var o=n[0].getContactsInfoByEmails(t,{onlyFirstEmail:!0,joinName:!0}),s=n[1]?n[1].getContactsInfoByEmails(t,{onlyFirstEmail:!0,joinName:!0,shared:!0}):[],i=s.concat(o).reduce((function(e,t){return e[t.email]=!0,e}),{}),a=e.prop("items"),r=a.length;r--;){var u=a[r],l=new c._BubbleClass(u);i[l.getHeadEmail()]&&l.applyTo(u)}c._bubblesetChange()}))}))}},_bubbleClick:function(e,t,n){var o,s,i=Boolean($(e.target).closest(".js-sms-open-link").length),a=new this._BubbleClass(t);if(i)return o=a.getPhone(),s={phone:o.value,email:a.getHeadEmail(),name:a.getText(),canRequest:o.status!==this._BubbleClass.PHONE.NOT_FOUND},void this.getModel("compose-state").trigger("sms-link-click",s);if(n){this._bubbleDropdownPromise&&!this._bubbleDropdownPromise.isResolved()&&this._bubbleDropdownPromise.reject();var r=vow.resolve();a.isGroup()?r=ns.request("abook-contacts",{tid:a.get("tid")}):a.isContact()&&(r=ns.request("abook-contact",{cid:a.get("cid"),shared:Boolean(a.get("shared"))})),r.then((function(){t.parentNode&&this._bubbleOpenDropdown(a,t)}),this),this._bubbleDropdownPromise=r}},_onBubbleFieldValueChanged:function(){this._toggleSmsLink(this._canShowSmsLink())},_bubbleDragStart:function(){e.methods._bubbleDragStart.apply(this,arguments);var t=this.getModel("compose-state");t.setIfChanged(".isCcVisible",!0),t.setIfChanged(".isBccVisible",!0)},_canShowSmsLink:function(){var e=this.getModel("compose-state");if(!e.get(".isPhoneEnabled")||e.get(".isPhoneVisible"))return!1;var t=this.getModel("compose-message"),n=t.getAllRecepients(),o=t.getContacts(this.FIELD_NAME);return 1===n.length&&1===o.length},_toggleSmsLink:function(e){this.getControllerNode().toggleClass(this.CLASS_YABBLE_SMS_LINK,e)},_onBubbleSmsLinkToggle:function(e,t){this._toggleSmsLink(this._canShowSmsLink()&&t)},_syncDataToViewFormatContacts:function(e){return e.map(Jane.FormValidation.obj2contact)},_getBubbleDropdownData:function(e){var t={canCopy:Daria.Clipboard.canUse,contact:{isContact:e.isContact(),isGroup:e.isGroup(),email:e.getHeadEmail()},emails:e.get("email")};if(e.isGroup())t.contacts=ns.Model.get("abook-contacts",{tid:e.get("tid")}).get(".contact"),t.contacts=_(t.contacts).chain().reduce((function(e,n){return _.forEach(n.email,(function(o){e.push({name:_.get(n,"name.full"),email:o.value,checked:-1!==t.emails.indexOf(o.value)})})),e}),[]).value();else if(e.isContact()){var n=ns.Model.get("abook-contact",{cid:e.get("cid"),shared:Boolean(e.get("shared"))}).get(".email");t.emails=_(n).chain().map("value").concat(t.emails).compact().uniq().value()}return t},_setBubbleDropdownEventHandlers:function(e,t,n){e.on("click",".js-bubble-remove",this._onClickRemoveBubble.bind(this,n)).on("click",".js-bubble-single-target",this._onClickSingleTargetBubble.bind(this,n)).on("click",".js-bubble-edit",this._onClickEditBubble.bind(this,n)).on("click",".js-bubble-add-to-abook",this._onClickAddAbookBubble.bind(this,n)).on("click",".js-bubble-change-email",this._onClickChangeEmailBubble.bind(this,n)).on("change",".js-bubble-change-group",this._onChangeGroupBubble.bind(this,n))},_unsetBubbleDropdownEventHandlers:function(e){e.off("click",".js-bubble-remove").off("click",".js-bubble-single-target").off("click",".js-bubble-edit").off("click",".js-bubble-add-to-abook").off("click",".js-bubble-change-email").off("change",".js-bubble-change-group")}}},"compose-field-base-yabble-ng",ns.View)})()},3990:function(e,t){!(function(){ns.View.edefine("compose-field-phone-yabble-ng",{yateModule:"compose2",methods:{_BubbleClass:Daria.PhoneBubble,_getBubbleDropdownData:function(){return{canCopy:Daria.Clipboard.canUse,contact:{isPhone:!0}}},_setBubbleDropdownEventHandlers:function(e,t,n){e.on("click",".js-bubble-remove",this._onClickRemoveBubble.bind(this,n)).on("click",".js-bubble-edit",this._onClickEditBubble.bind(this,n))},_unsetBubbleDropdownEventHandlers:function(e){e.off("click",".js-bubble-remove").off("click",".js-bubble-edit")}}},"compose-field-base-yabble-ng",ns.View)})()},3991:function(e,t){ns.View.define("compose-field-base-sms-controls",{yateModule:"compose2",methods:{smsControlsInit:function(){this.suggestItemButtonClick=this.suggestItemButtonClick.bind(this),this.onFieldValueChanged=this.onFieldValueChanged.bind(this),this.onPhoneFieldStateChanged=this.onPhoneFieldStateChanged.bind(this),this.smsLinkClick=this.smsLinkClick.bind(this)},smsControlsStart:function(){this.getModel("compose-message").on("ns-model-changed."+this.FIELD_NAME,this.onFieldValueChanged);var e=this.getModel("compose-state");return e&&(e.on("ns-model-changed.isPhoneEnabled",this.onPhoneFieldStateChanged),e.on("ns-model-changed.isPhoneVisible",this.onPhoneFieldStateChanged),e.on("sms-link-click",this.smsLinkClick)),this.suggestInstance&&this.suggestInstance.on("button-click",this.suggestItemButtonClick),this.onPhoneFieldStateChanged(),!0},smsControlsStop:function(){this.getModel("compose-message").off("ns-model-changed."+this.FIELD_NAME,this.onFieldValueChanged);var e=this.getModel("compose-state");return e&&(e.off("ns-model-changed.isPhoneEnabled",this.onPhoneFieldStateChanged),e.off("ns-model-changed.isPhoneVisible",this.onPhoneFieldStateChanged),e.off("sms-link-click",this.smsLinkClick)),this.suggestInstance&&this.suggestInstance.off("button-click",this.suggestItemButtonClick),!0},onFieldValueChanged:function(){var e=this.getModel("compose-state").get(".isPhoneEnabled"),t=this.getModel("compose-state").get(".isPhoneVisible");if(e&&t){var n=this.getModel("compose-message");if(n.hasOnlyOneValidRecipient(this.FIELD_NAME)){var o=n.getContacts(this.FIELD_NAME);n.setPhoneIfExist(o[0].email)}}},onPhoneFieldStateChanged:function(){var e=this.getModel("compose-state"),t=e.get(".isPhoneEnabled"),n=e.get(".isPhoneVisible");this.refreshSmsYabbles(t,n)},refreshSmsYabbles:function(e,t){this.getModel("compose-state").atrigger("sms-link-toggle",e&&!t)},suggestItemButtonClick:function(e,t,n){var o=n.item,s=o.email,i=o.phone;n.button.hasClass("js-compose-add-phone")&&i&&this.setPhoneValue({email:s,phone:i,canRequest:!0})},smsLinkClick:function(e,t){t=t||{},this.setPhoneValue(t)},setPhoneValue:function(e){var t=this.getModel("compose-state"),n=this.getModel("compose-message"),o=e.email,s=e.canRequest;if(t.get(".isPhoneEnabled"))return t.setIfChanged(".isPhoneVisible",!0),s?n.setPhoneIfExist(o,!0).then((function(){t.setFocusField("phone")})):void t.setFocusField("phone")}}})},3992:function(e,t){ns.View.define("compose-field-base-resize",{yateModule:"compose2",methods:{resizeInit:function(){this._$resizeInputController=null,this._$resizeMeasurer=null,this._resizeMeasurerHeight=0,this._resizeKeypressPrevent=this._resizeKeypressPrevent.bind(this),this._resizeCheck=this._resizeCheck.bind(this),this._resizeCheckDebounce=_.debounce(this._resizeCheck,50)},resizeStart:function(){return!!this.areYabblesDisabled()&&(this._$resizeInputController=this.getControllerNode(),this._resizeMeasurerInit(),this._resizeBindEvents(),!0)},resizeStop:function(){return!!this.areYabblesDisabled()&&(this._resizeUnbindEvents(),this._resizeMeasurerDestroy(),this._$resizeInputController=null,!0)},_resizeBindEvents:function(){this._$resizeInputController.on("keypress",this._resizeKeypressPrevent),this.on("ns-view-show",this._resizeCheck),this.getModel("compose-message").on("ns-model-changed."+this.FIELD_NAME,this._resizeCheckDebounce)},_resizeUnbindEvents:function(){this._$resizeInputController.off("keypress",this._resizeKeypressPrevent),this.off("ns-view-show",this._resizeCheck),this.getModel("compose-message").off("ns-model-changed."+this.FIELD_NAME,this._resizeCheckDebounce)},_resizeKeypressPrevent:function(e){e.which===Jane.Common.keyCode.ENTER&&e.preventDefault()},_resizeMeasurerInit:function(){this._$resizeMeasurer=$('<div class="is-vhidden">measurer</div>').insertAfter(this._$resizeInputController),this._resizeMeasurerHeight=this._$resizeMeasurer.height()},_resizeMeasurerDestroy:function(){this._$resizeMeasurer.remove(),this._$resizeMeasurer=null,this._resizeMeasurerHeight=0},_resizeCheck:function(){var e=1,t="auto";if(this._resizeMeasurerHeight){this._$resizeMeasurer.text(this.getFieldData()),this._$resizeMeasurer.width(this._$resizeInputController.width()),e=Math.ceil(this._$resizeMeasurer.height()/this._resizeMeasurerHeight);var n=e;e<1?n=1:e>3&&(n=3),t=n*this._resizeMeasurerHeight}this._$resizeInputController.height(t).toggleClass("is-multiline",e>3)}}})},3993:function(e,t){ns.View.define("compose-field-base-focus",{events:{"focusin@show .js-compose-field":"onFocus","focusout@show .js-compose-field":"onBlur"},yateModule:"compose2",methods:{FIELD_NAME:null,CLASS_FOCUSED:"is-focused",_customFocus:null,_customIsFocused:null,focusInit:function(){this.onFocusFieldChanged()},focusDestroy:function(){},onFocusFieldChanged:function(){var e=this.getModel("compose-state").getFocusField();this.isVisible()&&this.FIELD_NAME===e&&this.focus()},onFocus:function(){this.toggleFocus(!0)},onBlur:function(){this.toggleFocus(!1)},toggleFocus:function(e){this.getModel("compose-state").setFocusField(e?this.FIELD_NAME:null,{silent:!0}),this.$node.toggleClass(this.CLASS_FOCUSED,e),this.$node.find(".js-compose-field-wrapper").toggleClass(this.CLASS_FOCUSED,e)},focus:function(){this._customFocus?this._customFocus():this.$node.find(".js-compose-field").focus(0)},isFocused:function(){return this._customIsFocused?this._customIsFocused():this.$node.find(".js-compose-field").is(":focus")}}})},3994:function(e,t){!(function(){ns.View.edefine("compose-field-base",{models:{"compose-message":!1,"compose-state":!1},events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide","input@show .js-compose-field":"onInput"},params:{},ctor:function(){this.onFieldDataChanged=this.onFieldDataChanged.bind(this)},yateModule:"compose2",methods:{NEED_TO_EMULATE:Modernizr.ie9&&Modernizr.opera<15,_customSyncDataToView:null,_customSyncViewToData:null,getContextNode:function(){return this.$node.closest(".js-form")},getControllerNode:function(){return this.$node.find(".js-compose-field")},setFieldData:function(e){var t={data:{needUpdate:!1}};this.getModel("compose-message").setIfChanged("."+this.FIELD_NAME,e,t)},getFieldData:function(){return this.getModel("compose-message").get("."+this.FIELD_NAME)},onFieldDataChanged:function(e,t,n,o){o=o||{},!1!==o.needUpdate&&this.syncDataToView()},syncDataToView:function(){this.isVisible()&&(this._customSyncDataToView?this._customSyncDataToView():this.getControllerNode().val(this.getFieldData()))},syncViewToData:function(){if(this.isVisible())if(this._customSyncViewToData)this._customSyncViewToData();else{var e=this.getControllerNode().val();this.setFieldData(e)}},onInit:function(){},onShow:function(){this.startEmulateInputEvent(),this.focusInit(),this.getModel("compose-message").on("ns-model-changed."+this.FIELD_NAME,this.onFieldDataChanged)},onHide:function(){this.stopEmulateInputEvent(),this.focusDestroy(),this.getModel("compose-message").off("ns-model-changed."+this.FIELD_NAME,this.onFieldDataChanged)},startEmulateInputEvent:function(){this.NEED_TO_EMULATE&&this.$node.startEmulateInputEvent(".js-compose-field")},stopEmulateInputEvent:function(){this.NEED_TO_EMULATE&&this.$node.stopEmulateInputEvent()},onInput:function(e){if(e.target===e.currentTarget)if(this._customOnInput)this._customOnInput();else{var t=$(e.currentTarget);this.setFieldData(t.val())}},areYabblesDisabled:function(){return ns.Model.get("settings").isSet("disable_yabbles")}}},"compose-field-base-focus")})()},3995:function(e,t){!(function(){var e=ns.View.infoLite("compose-field-base");ns.View.defineNg("compose-field-to",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide"},models:{"compose-state":ns.View.defineModelEvents({"ns-model-changed.focusField":"onFocusFieldChanged","ns-model-changed.waitSuggest":"onWaitSuggestChanged"}),"compose-message":ns.View.defineModelEvents({"ns-model-changed.to":"onFieldValueChanged"}),"compose-fsm":!1},mixins:["compose-field-contact-yabble-ng"],params:ns.View.info("compose2").params,ctor:function(){e.ctor.apply(this,arguments)},yateModule:"compose2",methods:{FIELD_NAME:"to",onInit:function(){this.resizeInit(),this.suggestInit("contact"),this.yabbleInit(),this.smsControlsInit(),this.abookInit(),e.methods.onInit.apply(this,arguments)},onShow:function(){this.resizeStart(),this.suggestStart(),this.yabbleStart(),this.smsControlsStart(),e.methods.onShow.apply(this,arguments)},onHide:function(){this.resizeStop(),this.suggestStop(),this.yabbleStop(),this.smsControlsStop(),e.methods.onHide.apply(this,arguments)}}},"compose-field-base-resize","compose-field-base-suggest","compose-field-base-sms-controls","compose-field-base-hotkeys","compose-field-base-abook","compose-field-base")})()},3996:function(e,t){!(function(){var e=ns.View.infoLite("compose-field-base");ns.View.defineNg("compose-field-cc",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide"},models:{"compose-state":ns.View.defineModelEvents({"ns-model-changed.isCcVisible":"composeUpdate","ns-model-changed.focusField":"onFocusFieldChanged","ns-model-changed.waitSuggest":"onWaitSuggestChanged"}),"compose-message":!1,"compose-fsm":!1},mixins:["compose-field-contact-yabble-ng"],params:ns.View.info("compose2").params,ctor:function(){e.ctor.apply(this,arguments)},yateModule:"compose2",methods:{FIELD_NAME:"cc",onInit:function(){this.resizeInit(),this.suggestInit("contact"),this.yabbleInit(),this.smsControlsInit(),this.abookInit(),e.methods.onInit.apply(this,arguments)},onShow:function(){this.resizeStart(),this.suggestStart(),this.yabbleStart(),this.smsControlsStart(),e.methods.onShow.apply(this,arguments)},onHide:function(){this.resizeStop(),this.suggestStop(),this.yabbleStop(),this.smsControlsStop(),e.methods.onHide.apply(this,arguments)}}},"compose-field-base-resize","compose-field-base-suggest","compose-field-base-sms-controls","compose-field-base-hotkeys","compose-field-base-abook","compose-field-base")})()},3997:function(e,t){!(function(){var e=ns.View.infoLite("compose-field-base");ns.View.defineNg("compose-field-bcc",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide"},models:{"compose-state":ns.View.defineModelEvents({"ns-model-changed.isBccVisible":"composeUpdate","ns-model-changed.focusField":"onFocusFieldChanged","ns-model-changed.waitSuggest":"onWaitSuggestChanged"}),"compose-message":!1,"compose-fsm":!1},mixins:["compose-field-contact-yabble-ng"],params:ns.View.info("compose2").params,ctor:function(){e.ctor.apply(this,arguments)},yateModule:"compose2",methods:{FIELD_NAME:"bcc",onInit:function(){this.resizeInit(),this.suggestInit("contact"),this.yabbleInit(),this.smsControlsInit(),this.abookInit(),e.methods.onInit.apply(this,arguments)},onShow:function(){this.resizeStart(),this.suggestStart(),this.yabbleStart(),this.smsControlsStart(),e.methods.onShow.apply(this,arguments)},onHide:function(){this.resizeStop(),this.suggestStop(),this.yabbleStop(),this.smsControlsStop(),e.methods.onHide.apply(this,arguments)}}},"compose-field-base-resize","compose-field-base-suggest","compose-field-base-sms-controls","compose-field-base-hotkeys","compose-field-base-abook","compose-field-base")})()},3998:function(e,t){ns.View.define("compose-field-phone",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.isPhoneVisible":"composeUpdate","ns-model-changed.isPhoneEnabled":"composeUpdate"},"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){return this.getModel("compose-state").get(".isPhoneEnabled")?"layout-compose-field-phone-input":"layout-compose-field-phone-input-error"}}})},3999:function(e,t){!(function(){var e=ns.View.infoLite("compose-field-base");ns.View.defineNg("compose-field-phone-input",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide"},models:{"compose-state":ns.View.defineModelEvents({"ns-model-changed.focusField":"onFocusFieldChanged"}),"compose-message":!1},mixins:["compose-field-phone-yabble-ng"],params:ns.View.info("compose2").params,ctor:function(){e.ctor.apply(this,arguments)},yateModule:"compose2",methods:{FIELD_NAME:"phone",onInit:function(){this.resizeInit(),this.suggestInit("phone",{multiple:!1}),this.yabbleInit(),e.methods.onInit.apply(this,arguments)},onShow:function(){this.resizeStart(),this.suggestStart(),this.yabbleStart(),e.methods.onShow.apply(this,arguments)},onHide:function(){this.resizeStop(),this.suggestStop(),this.yabbleStop(),e.methods.onHide.apply(this,arguments)}}},"compose-field-base-resize","compose-field-base-suggest","compose-field-base")})()},4e3:function(e,t){!(function(){ns.View.define("compose-field-phone-input-error",{models:{"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{}},"compose-field-phone-error-mixin")})()},4001:function(e,t){!(function(){ns.View.edefine("compose-field-subject",{models:{"compose-message":{"ns-model-changed":!1,"ns-model:store-subject-for-autocomplete":"_storeSubjectForAutocomplete"},"compose-state":{"ns-model-changed":!1,"ns-model-changed.focusField":"onFocusFieldChanged"},"compose-fsm":!1},events:{"focus .js-editor-tabfocus-prev":"preventSelectAllOnTabFocus"},params:ns.View.info("compose2").params,ctor:function(){ns.View.info("compose-field-base").ctor.apply(this,arguments)},yateModule:"compose2",methods:{FIELD_NAME:"subj",preventSelectAllOnTabFocus:function(e){setTimeout((function(){return e.target.selectionStart=e.target.selectionEnd}))},_storeSubjectForAutocomplete:function(){var e=this.$node.find(".js-compose-field");if(e.length){var t="subj-".concat(Daria.getRandomString()),n="/monitoring_liza.txt?ffs=".concat(t),o=$('<iframe name="'.concat(t,'" class="is-hidden">')).appendTo(document.body),s=$('<form target="'.concat(t,'" class="is-hidden">')).attr("action",n).appendTo(document.body);e.clone().appendTo(s),$('<button type="submit"></button>').appendTo(s).click(),s.remove(),o.remove()}}}},"compose-field-base-hotkeys","compose-field-base")})()},4002:function(e,t){ns.View.define("compose-field-placeholder",{events:{"click@show .js-recipient":"onClickRecipient","mouseenter@show .js-recipient":"onMouseEnterLeaveRecipient","mouseleave@show .js-recipient":"onMouseEnterLeaveRecipient","click@show .js-recipients-edit":"onClickEditButton"},models:{"compose-state":!1,"compose-message":{"ns-model-changed":"keepValid","ns-model-changed.to":"invalidate","ns-model-changed.cc":"invalidate","ns-model-changed.bcc":"invalidate"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onMouseEnterLeaveRecipient:function(e){var t=$(e.target).closest(".js-recipients"),n="mouseenter"===e.type;t.toggleClass("has-inner-target",n)},onClickRecipient:function(e){var t=this.getModel("compose-message"),n=t.get(".to"),o=t.get(".cc"),s=t.get(".bcc"),i=Jane.FormValidation.obj2contact({name:e.target.dataset.name,email:e.target.dataset.email});(o||s||n!==i)&&(e.preventDefault(),e.stopPropagation(),t.setSingleRecipient(i))},onClickEditButton:function(e){e.preventDefault(),e.stopPropagation();var t=this.getModel("compose-state"),n=$(e.target).data("field");t.setFocusField(n),t.setWaitSuggest(!0)},_getFieldItems:function(e){var t=this.getModel("compose-message"),n=t.get("."+e);return n?Jane.FormValidation.splitContacts(n):""},getRecipients:function(){return this._getFieldItems("to")},getCopies:function(){return this._getFieldItems("cc")},getCopyCount:function(){return this.getCopies().length}}})},4003:function(e,t){ns.View.define("compose-field-to-extras",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.isCcVisible":"composeUpdate","ns-model-changed.isBccVisible":"composeUpdate","ns-model-changed.isPhoneVisible":"composeUpdate","ns-model-changed.isPhoneEnabled":"composeUpdate"},"compose-field-extras-collection":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"to"})},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("compose-state"),t=this.getModel("compose-field-extras-collection");return t.clear(),e.isFieldVisible("cc")||t.insert(ns.Model.get("compose-field-extras",_.extend({type:"extras-cc"},this.params)).setData({type:"extras-cc"})),e.isFieldVisible("bcc")||t.insert(ns.Model.get("compose-field-extras",_.extend({type:"extras-bcc"},this.params)).setData({type:"extras-bcc"})),"layout-compose-field-to-extras"}}})},4004:function(e,t){ns.View.define("compose-field-to-extras-cc",{events:{"click@show":"onClick"},models:{"compose-state":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onClick:function(e){e.preventDefault();var t=this.getModel("compose-state"),n=ns.View.infoLite("compose-field-cc").methods.FIELD_NAME;t.setFocusField(n),t.setIfChanged(".isCcVisible",!0),Jane.c("Написание письма","Шапка письма",'Клик в "Копия"')}}})},4005:function(e,t){ns.View.define("compose-field-to-extras-bcc",{events:{"click@show":"onClick"},models:{"compose-state":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onClick:function(e){e.preventDefault();var t=this.getModel("compose-state"),n=ns.View.infoLite("compose-field-bcc").methods.FIELD_NAME;t.setFocusField(n),t.setIfChanged(".isBccVisible",!0),Jane.c("Написание письма","Шапка письма",'Клик в "Скрытая копия"')}}})},4006:function(e,t){ns.View.define("compose-field-to-extras-phone",{events:{"click@show":"onClick"},models:{"compose-message":!1,"compose-state":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onClick:function(e){e.preventDefault();var t=this.getModel("compose-state"),n=ns.View.infoLite("compose-field-phone-input").methods.FIELD_NAME;if(t.get(".isPhoneEnabled")){t.setFocusField(n),t.setIfChanged(".isPhoneVisible",!0);var o=this.getModel("compose-message");if(o.hasOnlyOneValidRecipient()){var s=o.getAllRecepients();o.setPhoneIfExist(s[0].email,!0)}}else{var i=nb.block(Jane.tt("common:js-hint",{content:this.getErrorMessage()}));i.on("nb-closed",(function(){this.destroy()})),i.open({where:this.$node,how:{autoclose:!0,at:"center bottom",my:"center top"}}),$(window).one("scroll",(function(){i.close()}))}Jane.c("Написание письма","Шапка письма",'Клик в "СМС"')}}},"compose-field-phone-error-mixin")},4007:function(e,t){ns.View.define("compose-field-to-notice-replyall",{events:{"click@show .js-reply-all-link":"onReplyAllLinkClick"},models:{"compose-state":!1,"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onReplyAllLinkClick:function(e){e.preventDefault();var t=this.getModel("compose-state"),n=this.getModel("compose-message");n.changeRecipientsToOpposite(),t.set(".isReplyAllNoticeVisible",!1),t.set(".isCcVisible",Boolean(n.get(".cc")),{force:t.isCcVisible()}),t.set(".isBccVisible",Boolean(n.get(".bcc")),{force:t.isBccVisible()})}}})},4008:function(e,t){!(function(){ns.View.define("compose-field-to-notice-nda",{yateModule:"compose2"})})()},4009:function(e,t){!(function(){ns.View.define("compose-field-cc-notice-nda",{yateModule:"compose2"})})()},4010:function(e,t){!(function(){ns.View.define("compose-field-bcc-notice-nda",{yateModule:"compose2"})})()},4011:function(e,t){!(function(){ns.View.define("compose-field-phone-notice-help",{yateModule:"compose2"})})()},4012:function(e,t){ns.View.edefine("compose-recipients",{models:{"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{_getFieldItems:function(e){var t=this.getModel("compose-message").get("."+e);return t?Jane.FormValidation.splitContacts(t):""},getRecipients:function(){return this._getFieldItems("to")},getCopies:function(){return this._getFieldItems("cc")},getCopyCount:function(){return this.getCopies().length}}})},4013:function(e,t){!(function(){ns.View.define("compose-field-error-mixin",{yateModule:"compose2",methods:{FIELD_NAME:null,getErrorMessage:function(){return this.getModel("compose-message").getFieldError(this.FIELD_NAME)}}})})()},4014:function(e,t){!(function(){ns.View.define("compose-field-to-error",{models:{"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{FIELD_NAME:"to"}},"compose-field-error-mixin")})()},4015:function(e,t){!(function(){ns.View.define("compose-field-phone-error",{models:{"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{FIELD_NAME:"phone"}},"compose-field-error-mixin")})()},4016:function(e,t){!(function(){ns.View.define("compose-field-cc-error",{models:{"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{FIELD_NAME:"cc"}},"compose-field-error-mixin")})()},4017:function(e,t){!(function(){ns.View.define("compose-field-bcc-error",{models:{"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{FIELD_NAME:"bcc"}},"compose-field-error-mixin")})()},4018:function(e,t){ns.View.define("compose-field-att_ids-error",{models:{"compose-message":!1},params:ns.View.infoLite("compose2").params,yateModule:"compose2",methods:{FIELD_NAME:"att_ids"}},"compose-field-error-mixin")},4019:function(e,t){ns.View.define("compose-field-to-notices-wrapper",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.visibleNotices.to":"composeUpdate","ns-model-changed.isReplyAllNoticeVisible":"composeUpdate"},"compose-message":{"ns-model-changed":!1,"ns-model-changed.to":"onFieldChanged","ns-model-changed.errors.to":"composeUpdate"},"compose-field-notices":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"to"})},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("compose-message"),t=this.getModel("compose-state"),n=this.getModel("compose-field-notices");return n.clear(),e.getFieldError("to")&&n.insert(ns.Model.get("compose-field-notice",_.extend({type:"error"},this.params)).setData({type:"error"})),t.isFieldVisible("to")&&t.isNdaNoticeVisible("to")&&n.insert(ns.Model.get("compose-field-notice",_.extend({type:"nda"},this.params)).setData({type:"nda"})),t.isReplyAllNoticeVisible("to")&&n.insert(ns.Model.get("compose-field-notice",_.extend({type:"replyall"},this.params)).setData({type:"replyall"})),"layout-compose-field-notices-to"},onFieldChanged:function(){this.getModel("compose-message").setIfChanged(".errors.to","")}}})},4020:function(e,t){!(function(){ns.View.define("compose-field-cc-notices-wrapper",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.visibleNotices.cc":"composeUpdate"},"compose-message":{"ns-model-changed":!1,"ns-model-changed.cc":"onFieldChanged","ns-model-changed.errors.cc":"composeUpdate"},"compose-field-notices":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"cc"})},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("compose-message"),t=this.getModel("compose-state"),n=this.getModel("compose-field-notices");return n.clear(),e.getFieldError("cc")&&n.insert(ns.Model.get("compose-field-notice",_.extend({type:"error"},this.params)).setData({type:"error"})),t.isFieldVisible("cc")&&t.isNdaNoticeVisible("cc")&&n.insert(ns.Model.get("compose-field-notice",_.extend({type:"nda"},this.params)).setData({type:"nda"})),t.isReplyAllNoticeVisible("cc")&&n.insert(ns.Model.get("compose-field-notice",_.extend({type:"replyall"},this.params)).setData({type:"replyall"})),"layout-compose-field-notices-cc"},onFieldChanged:function(){this.getModel("compose-message").setIfChanged(".errors.cc","")}}})})()},4021:function(e,t){!(function(){ns.View.define("compose-field-bcc-notices-wrapper",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.visibleNotices.bcc":"composeUpdate"},"compose-message":{"ns-model-changed":!1,"ns-model-changed.bcc":"onFieldChanged","ns-model-changed.errors.bcc":"composeUpdate"},"compose-field-notices":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"bcc"})},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("compose-message"),t=this.getModel("compose-state"),n=this.getModel("compose-field-notices");return n.clear(),e.getFieldError("bcc")&&n.insert(ns.Model.get("compose-field-notice",_.extend({type:"error"},this.params)).setData({type:"error"})),t.isFieldVisible("bcc")&&t.isNdaNoticeVisible("bcc")&&n.insert(ns.Model.get("compose-field-notice",_.extend({type:"nda"},this.params)).setData({type:"nda"})),t.isReplyAllNoticeVisible("bcc")&&n.insert(ns.Model.get("compose-field-notice",_.extend({type:"replyall"},this.params)).setData({type:"replyall"})),"layout-compose-field-notices-bcc"},onFieldChanged:function(){this.getModel("compose-message").setIfChanged(".errors.bcc","")}}})})()},4022:function(e,t){ns.View.define("compose-field-phone-notices-wrapper",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.visibleNotices.phone":"composeUpdate"},"compose-message":{"ns-model-changed":!1,"ns-model-changed.phone":"onFieldChanged","ns-model-changed.errors.phone":"composeUpdate"},"compose-field-notices":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"phone"})},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("compose-message"),t=this.getModel("compose-state"),n=this.getModel("compose-field-notices");return n.clear(),e.getFieldError("phone")?n.insert(ns.Model.get("compose-field-notice",_.extend({type:"error"},this.params)).setData({type:"error"})):t.isFieldVisible("phone")&&t.isFieldEnabled("phone")&&n.insert(ns.Model.get("compose-field-notice",_.extend({type:"help"},this.params)).setData({type:"help"})),"layout-compose-field-notices-phone"},onFieldChanged:function(){this.getModel("compose-message").setIfChanged(".errors.phone","")}}})},4023:function(e,t){ns.View.define("compose-field-att_ids-notices-wrapper",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide"},models:{"compose-message":{"ns-model-changed":!1,"ns-model-changed.att_ids":"onFieldChanged","ns-model-changed.errors.att_ids":"onErrorChanged"},"compose-field-notices":!1,"compose-state":!1},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"att_ids"})},ctor:function(){this._autoHide=!1,this.autoHideDebounce=_.debounce(this.autoHide.bind(this),5e3)},yateModule:"compose2",methods:{patchLayout:function(){var e=this.getModel("compose-message"),t=this.getModel("compose-field-notices");return t.clear(),!this._autoHide&&e.getFieldError("att_ids")&&t.insert(ns.Model.get("compose-field-notice",_.extend({type:"error"},this.params)).setData({type:"error"})),"layout-compose-field-notices-att_ids"},onShow:function(){this.getModel("compose-field-notices").models.length&&this.autoHideDebounce()},onHide:function(){this.autoHideDebounce.cancel()},onFieldChanged:function(){this.getModel("compose-message").setIfChanged(".errors.att_ids","")},onErrorChanged:function(){this._autoHide=!1,this.composeUpdate()},autoHide:function(){this._autoHide=!0,this.getModel("compose-field-notices").clear(),this.composeUpdate()}}})},4024:function(e,t){ns.View.define("compose-fields-wrapper",{models:{"compose-state":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){return"layout-compose-fields"}}})},4025:function(e,t,n){"use strict";function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Object.defineProperty(t,"__esModule",{value:!0});var s=n(639);!(function(){var e={show:Daria.hasExperiment("77088")};ns.View.define("compose-popular-contacts",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-htmldestroy":"onHtmlDestroy","ns-view-init":"onInit","click .js-contact":"onContactClick","click .js-close":"onCloseClick",mouseenter:"onMouseEnter",mouseleave:"onMouseLeave"},models:{"index-data":"keepValid","compose-state":!1,"compose-message":{"ns-model-changed":!1,"ns-model-changed.to":"onRecipientFieldChanged","ns-model-changed.cc":"onRecipientFieldChanged","ns-model-changed.bcc":"onRecipientFieldChanged"},"compose-popular-contacts":!1},params:function(e){return _.extend({},ns.View.info("compose2").params(e),{count:10})},ctor:function(){this.onMouseEnter=this.onHover.bind(this,!0),this.onMouseLeave=this.onHover.bind(this,!1),this._$closeButton=null},yateModule:"compose2",methods:{onHtmlInit:function(){this._$closeButton=this.$node.find(".js-close")},onHtmlDestroy:function(){this._$closeButton=null},onInit:function(){if(e.show){if(ns.Model.get("settings").getSetting("popular-contacts_s"))return void(e.show=!1);this.on("ns-view-show",this.showPromo.bind(this)),this.on("ns-view-hide",this.hidePromo.bind(this))}},onContactClick:function(e){var t=$(e.currentTarget),n=["email","name"],o=_.zipObject(n,_.map(n,(function(e){return t.data(e)})));this.log({email:o.email,position:t.data("position")});var s=_.clone(this.getModel("compose-popular-contacts").getContact(o)),i=this.getModel("index-data").get(".email");s&&s.email===i&&s.name===i18n("%Compose_Send_it_to_me")&&delete s.name,this.getModel("compose-message").appendContact("to",s),this.updateContacts()},onCloseClick:function(){var e=ns.Model.get("settings"),t=e.getSign(e.POPULAR_CONTACTS_SETTING_NAME);if(void 0===e.getSetting(e.POPULAR_CONTACTS_SETTING_NAME)){var n={};n[e.POPULAR_CONTACTS_SETTING_NAME]=t,e.setSettings(n)}e.setSettingOff(e.POPULAR_CONTACTS_SETTING_NAME),this.getModel("compose-state").trigger("ns-model:contacts:redraw"),Jane.c("Написание письма","Шапка письма",'Клик в крестик "Скрыть favorites"')},onHover:function(e){this._$closeButton.toggleClass("is-hidden",!e)},onRecipientFieldChanged:function(){this.updateContacts(),this.composeUpdate()},updateContacts:function(){var e=this.getModel("compose-message").getAllRecepients();this.getModel("compose-popular-contacts").actualizeUsedContacts(e)},log:function(e){var t=e.email,n=e.position,o={project:"search_mail",action:"suggest-compose",product:s.b,uid:Daria.uid,filed:"to",field:"to",suggest_used:"yes",suggest_show:"yes",pos:n,count:Math.min(this.getModel("compose-popular-contacts").getUnusedContacts().length,6),search_text:encodeURIComponent(t)};1===n&&this.getModel("index-data").get(".email")===t?(o.self="yes",Jane.c("Написание письма","Шапка письма",'Клик в саджест контакта "себе"')):Jane.c("Написание письма","Шапка письма","Клик в саджест другого контакта"),Daria.searchClickCounter(_.pairs(o).map((function(e){return e.join("=")})))},showPromo:function(){var t=e;if(t.show){var n=this.$node.find(".js-contact").get(0);if(!n)return void(t.show=!1);t.setAnchor||Object.assign(t,Daria.React.promoPopularContacts.create((function(){ns.Model.get("settings").setSettings(o({},"popular-contacts_s",Date.now())),t.show=!1}))),t.timer&&(clearTimeout(t.timer),t.timer=null),t.setAnchor(n)}},hidePromo:function(){var t=e;t.timer||(t.timer=setTimeout((function(){return t.close()}),150))}}})})()},4026:function(e,t){!(function(){ns.View.define("compose-popular-contacts-wrapper",{models:{"compose-state":{"ns-model-changed":!1,"ns-model:contacts:redraw":"composeUpdate"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){var e=ns.Model.get("settings");return e.getSign(e.POPULAR_CONTACTS_SETTING_NAME)?"layout-compose-popular-contacts":"layout-compose-popular-contacts-empty"}}})})()},4027:function(e,t){!(function(){ns.View.define("compose-popup-button",{yateModule:"compose2",methods:{ASSERT_CLASS_NAME:"Daria.vComposePopupButton",onHtmlInit:function(){this.initNbs()},onHtmlDestroy:function(){this.destroyNbs()},initNbs:function(){this.nbs={},this.nanoislands&&(_.each(this.nanoislands.blocks,(function(e,t){this.nbs[t]=nb.$block(e,this.$node)}),this),this._nbsInited=!0,this.bindNbs())},destroyNbs:function(){this.unbindNbs(),this._nbsInited=!1,nb.destroy(this.node)},bindNbs:function(){this.handleBinding("on")},unbindNbs:function(){this.handleBinding("off")},handleBinding:function(e){this._nbsInited&&this.nanoislands&&_.each(this.nanoislands.events,(function(t,n){var o;n=n.split(" ");var s=n[0],i=n[1],a=n[2];if(!this.nbs[i])return void ns.assert(!1,this.ASSERT_CLASS_NAME,"Don't exist nanoblock with name of "+i);switch(o=3===n.length?this.nbs[i].$node.find(a):this.nbs[i],e){case"on":o.on(s,this[t].bind(this));break;default:o.off(s)}}),this)},showBubble:function(){this.containerSelector||ns.assert(!1,this.ASSERT_CLASS_NAME,"Don't exist selector of container for popup");var e=this.nbs.popup;return e.isOpen()?vow.reject():(e.open({where:this.$node.find(this.containerSelector),how:{at:"top",my:"bottom"}}),vow.resolve(e))},setCheckboxState:function(e,t){var n=this.nbs[e];if(!n)return void ns.assert(!1,this.ASSERT_CLASS_NAME,"Can't find nbCheckbox with name of "+e);n.isChecked()!==t&&(t?n.check():n.uncheck())}}})})()},4028:function(e,t){ns.View.define("compose-action-buttons",{models:{"compose-state":!1,"compose-message":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){var e,t,n=this.getModel("compose-message"),o=this.getModel("compose-state");return n.isTemplate()?n.isNewTemplate()?(e="compose-save-link",t="layout-compose-action-buttons-new-template"):(e="compose-send-link",t="layout-compose-action-buttons-template"):(e="compose-send-link",t="layout-compose-action-buttons"),o.set(".activeActionButtonView",e),t}}})},4029:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(139);n.n(o);!(function(){ns.View.define("compose-save-link",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide","click .js-save-button":"onSave"},params:ns.View.info("compose2").params,models:{"compose-message":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.activeActionButtonView":"composeUpdate"},"compose-fsm":!1},yateModule:"compose2",methods:{onInit:function(){this.disableOnSendingInit()},onShow:function(){this.disableOnSendingStart()},onHide:function(){this.disableOnSendingStop()},setState:function(e){return this.getModel("compose-fsm").setState(e)},onSave:function(){this.getModel("compose-state").set(".saveTemplateAndLeave",!0),this.getModel("compose-message").once("ns-model:draft-saved",(function(){var e=ns.Model.get("folders").getFidBySymbol(o.WellKnownFolderSymbol.TEMPLATE),t=ns.router.generateUrl("messages",{current_folder:e});ns.page.go(t)})),this.setState("save")}}},"compose-disable-on-sending-mixin")})()},4030:function(e,t){!(function(){var e={size:"m",text:i18n("%Отправить"),highlight:!0,class:["js-send-button"],type:"submit",attrs:{tabindex:"10",title:i18n("%Compose_send_letter")+Daria.Shortcuts.getShortcutLabelFor("Send","compose2",!0)}};ns.View.define("compose-send-link",{events:{"ns-view-init":"onInit","ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-hide":"onHide","ns-view-destroy":"onHtmlDestroy","click .js-send-button":"onSendingToSent"},params:ns.View.info("compose2").params,models:{"compose-message":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.submitButtonText":"onChangeSubmitButtonText","ns-model-changed.activeActionButtonView":"composeUpdate"},"compose-fsm":!1},ctor:function(){this._nbButton=null},yateModule:"compose2",methods:{onInit:function(){this.disableOnSendingInit()},onHtmlInit:function(){nb.init(this.node),this._nbButton=nb.$block(".js-send-button",this.node)},onHtmlDestroy:function(){nb.destroy(this.node),this._nbButton=null},onShow:function(){this.disableOnSendingStart()},onHide:function(){this.disableOnSendingStop()},setState:function(e){return this.getModel("compose-fsm").setState(e)},onSendingToSent:function(){this.onSendingToSentWithMetricSource()},onSendingToSentWithMetricSource:function(e){this.composeMetrics(e),this.setState("sending")},getButtonSpec:function(){var t=this.getModel("compose-state"),n=t.get(".submitButtonText"),o=t.get(".activeActionButtonView");return e.highlight="compose-send-link"===o,n&&(e.text=n),e},onChangeSubmitButtonText:function(){var e=this.getModel("compose-state").get(".submitButtonText");this._nbButton.setContent(e)},composeMetrics:function(e){Jane.c("Написание письма",e||"Шапка письма",'Клик в "Отправить"'),Jane.c("Отправка письма","compose")}}},"compose-disable-on-sending-mixin")})()},4031:function(e,t){!(function(){ns.View.define("compose-cancel-button",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide","click@show":"onClick"},models:{"compose-fsm":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onInit:function(){this.disableOnSendingInit()},onShow:function(){this.disableOnSendingStart()},onHide:function(){this.disableOnSendingStop()},onClick:function(){this.getModel("compose-fsm").setState("cancel"),Jane.c("Написание письма","Шапка письма","Клик в крестик")}}},"compose-disable-on-sending-mixin")})()},4032:function(e,t){ns.View.define("compose-delete-button",{events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide",click:"onClick"},models:{"compose-message":!1,"compose-fsm":{"ns-model-changed":!1,"# save":"onSaving","# edit":"onSaveComplete"}},params:ns.View.info("compose2").params,ctor:function(){this._isSaving=!1,this._isRemovePending=!1},yateModule:"compose2",methods:{_getMessage:function(e){return ns.Model.get("message",{ids:e})},onInit:function(){this.disableOnSendingInit()},onShow:function(){if(this.disableOnSendingStart(),this.params.ids){this._getMessage(this.params.ids).isDraftLike()||this.$node.addClass("is-hidden")}},onHide:function(){this.disableOnSendingStop()},_closeCompose:function(){this.getModel("compose-fsm").setState("cancel")},_removeDraft:function(){var e=this.getModel("compose-message").getDraftMid();e&&Daria.MOPS["remove.draft"](this._getMessage(e).getMessagesCheckedModel()),this._closeCompose()},onClick:function(){return this._isSaving?void(this._isRemovePending=!0):this.getModel("compose-message").isDirty()?(this._isRemovePending=!0,void this.getModel("compose-fsm").setState("save")):void this._removeDraft()},onSaveComplete:function(){this._isSaving=!1,this._isRemovePending&&(this._isRemovePending=!1,this._removeDraft())},onSaving:function(){this._isSaving=!0}}},"compose-disable-on-sending-mixin")},4033:function(e,t){ns.View.define("compose-label-button",{events:{click:"onClick"},yateModule:"compose2",methods:{onClick:function(e,t){t=t||ns.action.getParams(e.currentTarget),Jane.ToolbarMetric.setToolbarMetrics(e,t,"label",this.getCurrentMessageIfSingle()),this.vLabelsActions&&this.vLabelsActions._isOpen||(this.vLabelsActions=ns.View.create.apply(null,["labels-actions-compose",ns.page.current.params]),this.vLabelsActions.open(e.currentTarget,ns.Model.get("messages-checked"),t))},getCurrentMessageIfSingle:function(){var e=ns.Model.get("messages-checked");if(!e)return null;var t=e.getIds();if(t&&0===t.tids.length&&1===t.ids.length){return ns.Model.get("messages",ns.page.current.params).getMessageByMid(t.ids[0])}return null}}})},4034:function(e,t){!(function(){var e=ns.View.infoLite("compose-send-link");ns.View.edefine("compose-send-button-complex",{models:{"compose-message":{"ns-model-changed":!1,"ns-model-changed.send_time":"onChangedSendTime"},"compose-state":{"ns-model-changed":!1,"ns-model-changed.submitButtonText":"onChangeSubmitButtonText"},"compose-fsm":{"ns-model-changed":!1,"# sent":"onSendingMessage"}},events:{"ns-view-show":"onShow","ns-view-hide":"onHide","click@show .js-send":"onSendingToSentWithMetricSource"},params:ns.View.info("compose2").params,yateModule:"compose2",ctor:function(){this.onSendingToSentWithMetricSource=this.onSendingToSentWithMetricSource.bind(this,"Подвал письма"),_.bindAll(this,["onClickSendtime","onClosedSendtimePopup"])},methods:{onShow:function(){e.methods.onShow.apply(this,arguments),this.nbSendtime=nb.$block(".js-sendtime",this.node),this.nbSendtime.on("click",this.onClickSendtime),this.nbSend=nb.$block(".js-send",this.node)},onHide:function(){e.methods.onHide.apply(this,arguments),nb.destroy(this.node)},onClickSendtime:function(e){e.preventDefault(),this._sendtimePopup?this._sendtimePopup.close():(this._sendtimePopup=ns.View.create("compose-send-button-complex-popup",_.clone(this.params)),this._sendtimePopup.on("closed",this.onClosedSendtimePopup),this._sendtimePopup.open({where:e.currentTarget})),Jane.c("Написание письма","Подвал письма",'Клик в "Отправить сегодня в ..."')},onClosedSendtimePopup:function(){delete this._sendtimePopup},onChangedSendTime:function(){this.getModel("compose-message").get(".send_time")?this.nbSendtime.check():this.nbSendtime.uncheck()},onSendingMessage:function(){this.getModel("compose-message").get(".send_time")&&Jane.c("Написание письма","Подвал письма",'Клик в "Отправить сегодня в ..."',"Отправка письма с настройкой")},onChangeSubmitButtonText:function(){var e=this.getModel("compose-state").get(".submitButtonText");this.nbSend.setContent(e)}}},"compose-send-link")})()},4035:function(e,t){ns.View.define("compose-send-button-complex-popup",{events:{"ns-view-show":"_onShow","click@show .send_time-date":"_onClickSendDateTime","click@show .js-help":"_onClickShowHelp","click@show .js-close":"_onClickClose","daria:vScrollerMessages:scroll@show":"_onScroll","daria:vScrollerMessage:scroll@show":"_onScroll","daria:layout-changed@show":"_onScroll"},models:{"compose-state":!1,"compose-message":!1},params:ns.View.info("compose2").params,ctor:function(){this._defaultOptions={withoutTail:!0,autofocus:!0,autoclose:!0,how:{my:"center bottom",at:"center top"}},this._options={},this._popup=null,this._date=null},yateModule:"compose2",methods:{open:function(e){return this._date=this.getModel("compose-message").getPassportSendDate(),this._options=_.extend({},this._defaultOptions,e),this._dateValidation(),this.update(this.params,{execFlag:ns.U.EXEC.PARALLEL}).then(this._onAfterRender,this)},close:function(){_.method("close")(this._popup)},_onClickClose:function(){this.close(),Jane.c("Написание письма","Подвал письма",'Клик в "Отправить сегодня в ..."',"Клик в крестик")},_onScroll:function(){var e=_.get(this._popup,"node.widget");_.method("_position")(e)},_onAfterRender:function(){this._popup=nb.block(ns.renderNode({},"js-compose-send-button-complex-popup","compose2"));var e=this,t=this._popup._move;this._popup._move=function(){var n=Array.prototype.slice.call(arguments);t.apply(this,n),e._popupMove()},this._popup.setContent(this.node),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open(this._options)},_popupMove:function(){var e=this,t=this._popup.$node.data("nbContextDialog").close;this._popup.$node.data("nbContextDialog").close=function(n){e._nbContextDialogClose.call(this,e,t,n)}},_nbContextDialogClose:function(e,t,n){var o=e._nbTime&&e._nbTime.$dropdown&&e._nbTime.$dropdown[0],s=n&&n.target;if(s&&o&&o.contains(s))return void(this.options.closedByOuterClick=!1);t.call(this,n)},_onOpened:function(){this.trigger("opened")},_onClosed:function(e,t){t.destroy(),this.trigger("closed")},_onDestroyed:function(){delete this._popup,this._options={},this.destroy()},_onShow:function(){this._nbTime=nb.$block(".js-time",this.node),this._nbTime.on("nb-changed",this._onChangedTime.bind(this)),this._nbActivate=nb.$block(".js-activate",this.node),this._nbActivate.on("nb-checked",this._onCheckedActivate.bind(this)),this._nbActivate.on("nb-unchecked",this._onUncheckedActivate.bind(this));var e=Daria.passportNow(),t=new Date(e),n=new Date(e);n.setFullYear(n.getFullYear()+1),this.$node.find(".send_time-date").date_input({action:"click",zIndex:105,container:this.$node,usePosition:!0,autoOrientation:!0,minDate:t,maxDate:n,dateToString:this._dateToString,stringToDate:this._stringToDate,keydownHandler:!1,setInputVal:this._onSetInputVal.bind(this),getInputVal:this._onGetInputVal.bind(this)}),this._updateDisplay()},_onGetInputVal:function(){return this._dateToString(this._date)},_onSetInputVal:function(e){var t=this._stringToDate(e);if(t){var n=t.getFullYear(),o=t.getMonth(),s=t.getDate();this._date.getFullYear()===n&&this._date.getMonth()===o&&this._date.getDate()===s||(this._date.setFullYear(t.getFullYear(),t.getMonth(),t.getDate()),this._updateDisplay())}},_onClickSendDateTime:function(e){e.stopPropagation(),e.preventDefault(),this._nbActivate.isChecked()||this._nbActivate.check()},_onCheckedActivate:function(){Jane.c("Написание письма","Подвал письма",'Клик в "Отправить сегодня в ..."',"Простановка чекбокса"),this._nbTime.enable(),this._updateData()},_onUncheckedActivate:function(){this._nbTime.disable(),this._updateData()},_onChangedTime:function(){var e=this._nbTime.getState(),t=e.value&&e.value.match(/^(\d{2}):(\d{2})$/);if(t){var n=parseInt(t[1],10);n!==this._date.getHours()&&(this._date.setHours(n,0,0,0),this._updateDisplay()),this.close()}},_updateDisplay:function(){if(this._dateValidation())this._updateDisplay();else{this.$node.find(".send_time-date").text(Jane.Date.toHumanFormat(this._date));var e=new Date(Daria.passportNow());e.setHours(e.getHours(),0,0,0);var t=new Date(this._date),n=_.times(24).filter((function(n){return t.setHours(n,0,0,0),t>e})).map(this._dateItemGenerate);this._nbTime.setSource(n),this._nbTime.setState(this._dateItemGenerate(this._date.getHours())),this._updateData()}},_dateItemGenerate:function(e){var t=Jane.Common.n(e)+":00";return{text:t,value:t}},_dateToString:function(e){return Jane.Date.format("%F",e)},_stringToDate:function(e){var t=String(e||"").match(/^(\d{2,4})\-(\d{2})\-(\d{2})$/);return t?new Date(parseInt(t[1],10),parseInt(t[2],10)-1,parseInt(t[3],10)):null},_dateValidation:function(){var e=new Date(Daria.passportNow());return e.setHours(e.getHours()+1,0,0,0),(!this._date||this._date<e)&&(this._date=e,!0)},_onClickShowHelp:function(){this.$node.find(".js-compose-sendtime-help-text").toggleClass("is-hidden")},_updateData:function(){var e=this.getModel("compose-message"),t=null;this._nbActivate.isChecked()&&this._date&&(t=Daria.convertPassportDateToTimestamp(this._date)),e.setIfChanged(".send_time",t)}}})},4036:function(e,t){ns.View.edefine("compose-button-translate-apply",{models:{"compose-message":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.translationEnabled":"composeUpdate"},"compose-fsm":!1},events:{"click@show .js-click":"onClick"},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onClick:function(){this.getModel("compose-state").trigger("daria:mComposeState:translate-edit"),Jane.c("Написание письма","Подвал письма","Переводчик","Редактировать")}}},"compose-send-link")},4037:function(e,t){ns.View.edefine("compose-button-translate-close",{models:{"compose-message":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.translationEnabled":"composeUpdate"},"compose-fsm":!1},events:{"click@show .js-click":"onClick"},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onClick:function(){this.getModel("compose-state").trigger("daria:mComposeState:translate-cancel"),Jane.c("Написание письма","Подвал письма","Переводчик","Отмена")}}},"compose-send-link")},4038:function(e,t){ns.View.define("compose-message-toolbar-button-common",{events:{"ns-view-show":"_onNsViewShow"},yateModule:"compose2",methods:{_onNsViewShow:function(){this.rect=this.node.getBoundingClientRect()},checkShortlink:function(){return this.$node.hasClass("is-shortlink")},isShortlink:function(){return this._isShortlink},setShortlink:function(){this._isShortlink=!0,this.$node.addClass("is-shortlink")},removeShortlink:function(){this._isShortlink=!1,this.$node.removeClass("is-shortlink")}}})},4039:function(e,t){ns.View.edefine("compose-message-toolbar-spellcheck",{models:{"compose-state":!1},yateModule:"compose2"},"compose-message-toolbar-button-common")},4040:function(e,t){!(function(){ns.View.defineNg("compose-attach-area",{events:{"ns-view-show":"onShow","click@show .js-eml-preview":"previewEml","daria:vComposeAttachArea:retryAttach@show":"onRetryAttach"},models:{"compose-state":!1,"compose-message":{"ns-model-changed":!1,"ns-model:draft-saved":"onDraftSaved"},"compose-attachments":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onShow:function(){var e=this.getModel("compose-attachments"),t=this.getModel("compose-message"),n=this.getModel("compose-state");e.init({node:this.node,ids:this.params.ids,operation:this.params.oper,mComposeMessage:t,mComposeState:n}),(this.params.ids||e.hasFiles())&&(e.drawAttaches(),t.markSaved())},onDraftSaved:function(e,t){if(!this.isVisible())return void this.invalidate();this.getModel("compose-attachments").updateAfterSave(t.attachments,t.mid),this.getModel("compose-message").markSaved()},onRetryAttach:function(e,t){this.getModel("compose-attachments").retryAttach(t.id)}}},"count-attachments-ops-mixin","preview-eml-mixin")})()},4041:function(e,t){!(function(){ns.View.define("compose-footer",{models:{"compose-message":!1,"compose-attachments":{"ns-model-changed":!1,"ns-model:attachments.appended":"onAttachmentsAppended"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onAttachmentsAppended:function(){this.isVisible()&&Jane.DOM.placeInViewport(this.node)}}})})()},4042:function(e,t){!(function(){var e=ns.View.infoLite("compose-field-base");ns.View.edefine("compose-from",{events:{"ns-view-htmlinit":"onHtmlInit","keydown@show .js-compose-field":"onInputKeydown"},models:{"account-information":!1,"index-data":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.focusField":"onFocusFieldChanged"},"compose-message":{"ns-model-changed":!1,"ns-model-changed.from_mailbox":"forceUpdate"}},params:ns.View.info("compose2").params,ctor:function(){e.ctor.apply(this,arguments)},yateModule:"compose2",methods:{FIELD_NAME:"from_name",onHtmlInit:function(){this._nbEmailSelect=nb.$block(".js-compose-changemail",this.$node),this._nbEmailSelect.on("nb-changed",this.onEmailChange.bind(this)),this._$input=this.$node.find(".js-compose-field"),this.shouldResizeByFakeField()&&(this.resizeField=this.resizeFieldIE,this._$inputFakeDiv=this.$node.find(".js-compose-field-fake")),this.resizeField()},resizeField:function(){this.isVisible()&&(this._$input.width(0),this._$input.width(this._$input[0].scrollWidth))},setValueToFakeDivInput:function(){this._$inputFakeDiv.text(this._$input.val())},resizeFieldIE:function(){this.isVisible()&&(this._$input.width(0),this.setValueToFakeDivInput(),this._$input.width(this._$inputFakeDiv.width()+2))},onInputKeydown:function(e){e.keyCode!==Jane.Common.keyCode.ENTER&&e.keyCode!==Jane.Common.keyCode.ESC||(e.preventDefault(),this._$input.blur())},onInput:function(){this.resizeField(),e.methods.onInput.apply(this,arguments)},onEmailChange:function(e,t){this.getModel("compose-message").set(".from_mailbox",t.value)},shouldResizeByFakeField:function(){return Boolean(Modernizr.ie11||Modernizr.edge)}}},"compose-field-base")})()},4043:function(e,t){!(function(){ns.View.define("compose-signature-list-popup",{events:{"click@show .js-signature-add-button":"_onClickAddSignature","click@show .js-signature-list-item":"_onClickSelectFromList"},models:{"compose-signature":!1},params:ns.View.info("compose2").params,yateModule:"compose2",ctor:function(){this._defaultOptions={withoutTail:!0,autofocus:!1,autoclose:!0,how:{at:"center+60px bottom"}},this._options={},this._popup=null},methods:{open:function(e){return this._options=_.extend(this._defaultOptions,e||{}),this.update(this.params,{execFlag:ns.U.EXEC.PARALLEL}).then(this._onAfterRender,this)},_onAfterRender:function(){this._popup=nb.block(ns.renderNode({},"js-compose-signature-list-popup","compose2")),this._popup.setContent(this.node),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open(this._options)},_onOpened:function(){Jane.c("Подписи","Окно выбора","Показ")},_onClosed:function(){this._popup&&(this._popup.destroy(),this._popup=null)},_onDestroyed:function(){this._options={},this.destroy(),this._signatureIsSelected||Jane.c("Подписи","Окно выбора","Закрыто без выбора")},_getSignatureList:function(){return this.getModel("compose-signature").getSignatureList()},_onClickSelectFromList:function(e){this._signatureIsSelected=!0;var t=$(e.currentTarget),n=parseInt(t.attr("data-signature-index"),10);0===n&&Jane.c("Подписи","Окно выбора","Выбор первой"),Jane.c("Подписи","Окно выбора","Выбор подписи");var o=this.getModel("compose-signature"),s=o.getSignatureList(),i=s.signs[n].convert;this.trigger("select",i),this._popup.close()},_onClickAddSignature:function(){this._signatureIsSelected=!0,ns.View.create("compose-signature-add-popup",this.params).open(),this._popup.close()}}})})()},4044:function(e,t,n){"use strict";function o(e,t,n,o,s,i,a){try{var r=e[i](a),c=r.value}catch(e){return void n(e)}r.done?t(c):Promise.resolve(c).then(o,s)}function s(e){return function(){var t=this,n=arguments;return new Promise(function(s,i){function a(e){o(c,s,i,a,r,"next",e)}function r(e){o(c,s,i,a,r,"throw",e)}var c=e.apply(t,n);a(void 0)})}}Object.defineProperty(t,"__esModule",{value:!0});var i=n(138),a=n.n(i);!(function(){ns.View.define("compose-signature-add-popup",{models:{"compose-signature":!1,signs:!1},params:ns.View.info("compose2").params,yateModule:"compose2",ctor:function(){this._defaultOptions={withoutTail:!0,autofocus:!1,autoclose:!0},this._options={},this._popup=null},methods:{open:function(e){return this._options=a.a.extend(this._defaultOptions,e||{}),this.update(this.params,{execFlag:ns.U.EXEC.PARALLEL}).then(this._onAfterRender,this)},_onAfterRender:function(){this._popup=nb.block(ns.renderNode({},"js-compose-signature-add-popup","compose2")),this._popup.setContent(this.node),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open(this._options)},_onOpened:function(){Jane.c("Подписи","Окно выбора","Окно добавления","Показ"),this._popup.$node.on("click",".js-save",this._onSave.bind(this)),this._popup.$node.on("click",".js-cancel",this._onClosed.bind(this))},_onClosed:function(){this._popup&&(this._popup.destroy(),this._popup=null)},_onDestroyed:function(){this._options={},this.destroy(),this._clickSave||Jane.c("Подписи","Окно выбора","Окно добавления","Закрыть без добавления")},_onSave:(function(){function e(){return t.apply(this,arguments)}var t=s(regeneratorRuntime.mark((function e(){var t,n,o;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._clickSave=!0,Jane.c("Подписи","Окно выбора","Окно добавления","Добавление"),t=$.trim(this._popup.$node.find(".js-signature-new").val())){e.next=5;break}return e.abrupt("return");case 5:if(n=Daria.signs.getHtml(),!(o=a.a.any(n,(function(e){return Daria.signs.compare(e.convert,t)})))){e.next=10;break}return this._popup.close(),e.abrupt("return");case 10:return e.prev=10,e.next=13,Daria.signs.addSignature({text:a.a.escape(t)});case 13:e.next=19;break;case 15:return e.prev=15,e.t0=e.catch(10),this._handleAppendError(e.t0),e.abrupt("return");case 19:this._popup.close(),Daria.Statusline.show({name:Daria.signs.actionStatuses.APPENDED,text:i18n("%Signature_append_success")});case 21:case"end":return e.stop()}}),e,this,[[10,15]])})));return e})(),_handleAppendError:function(e){var t=this.getModel("signs").SignsError;if(e&&e.constructor===t)switch(e.code){case t.codes.MAX_COUNT:return this._popup.close(),void Daria.Statusline.show({name:Daria.signs.actionStatuses.ERROR_MAX_SIGNS_COUNT});case t.codes.MAX_LENGTH:return void Daria.Statusline.show({name:Daria.signs.actionStatuses.ERROR_MAX_SIGN_LENGTH})}Daria.debug.error("Error occurred while appending sign:",e),Daria.Statusline.show({name:Daria.signs.actionStatuses.ERROR,text:i18n("%Signature_append_error")})}}})})()},4045:function(e,t){ns.View.define("compose-message-editor-bottom-buttons",{params:ns.View.info("compose2").params,yateModule:"compose2"})},4046:function(e,t){ns.View.define("compose-message-editor-top",{params:ns.View.info("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){return"layout-compose-message-editor-top"}}})},4047:function(e,t){ns.View.define("compose-message-editor-bottom",{models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.editorMaximize":"editorViewUpdate"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){return this.getModel("compose-state").get(".editorMaximize")===CKEDITOR.TRISTATE_ON?"layout-compose-message-editor-bottom":"layout-compose-message-editor-bottom-buttons-empty"},editorViewUpdate:function(){this.getEditor().execCommand("viewUpdate")}}})},4048:function(e,t){!(function(){var e={attachmentcomputer:'Клик на "Прикрепить файл с компьютера"',attachmentdisk:'Клик на "Прикрепить файл из Диска"',attachmentmail:'Клик на "Прикрепить файлы из Почты"',undo:'Клик на "Отменить"',redo:'Клик на "Повторить"',bold:'Клик на "Полужирный"',italic:'Клик на "Курсив"',underline:'Клик на "Подчёркнутый"',strike:'Клик на "Перечёркнутый"',link:'Клик на "Вставить/изменить ссылку"',unlink:'Клик на "Удалить ссылку"',addimage:'Клик на "Добавить изображение"',blockquote:'Клик на "Цитата"',mailtextcolor:'Клик на "Цвет текста"',mailbgcolor:'Клик на "Цвет фона"',mailfont:'Клик на "Шрифт"',mailfontsize:'Клик на "Размер шрифта"',emoticons:'Клик на "Смайлик"',numberedlist:'Клик на "Нумерованный список"',bulletedlist:'Клик на "Маркированный список"',justifyleft:'Клик на "Выравнивание по левому краю"',justifycenter:'Клик на "Выравнивание по центру"',justifyright:'Клик на "Выравнивание по правому краю"',maximize:'Клик на "Развернуть на весь экран"',removeformat:'Клик на "Убрать форматирование"',translate:'Клик на "Переводчик"',switchmode:'Клик на "Без оформления"'};ns.View.define("compose-metrics-mixin",{methods:{saveMetricOfTheToolbarButtonKeypress:function(t){var n=t.currentTarget.className.split(/\s+/),o=_.find(n,(function(e){return 0===e.indexOf("cke_button__")}));if(o){var s=o.slice("cke_button__".length),i=e[s];i&&Jane.c("Написание письма","Визивиг в композе",i)}}}})})()},4049:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(1281),s=n(1856),i=n(88),a=n.n(i);!(function(){var e=ns.View.infoLite("compose-field-base"),t=["onDOMNodeRemoved","onDOMNodeInserted","onFocus","onBlur","syncDataToView","syncViewToData","saveBookmark","onFocusFieldChanged","onChangeHeight","onEditorInit","onEditorShortcutSave","onEditorShortcutSend","onEditorChange","onEditorPaste","onEditorPastefile","onEditorSwitchedMode","onEditorMaximize","_applyTmpContent"];ns.View.edefine("compose-message-editor",{models:{"module-editor":!1,"compose-message":{"ns-model-changed":!1,"ns-model-changed.from_mailbox":"onFromMailboxChanged"},"compose-attachments":!1,"compose-signature":!1,"compose-fsm":{"ns-model-changed":!1,"edit > sending":"syncViewToData","edit > save":"syncViewToData","edit > cancel":"syncViewToData"},"compose-state":{"ns-model-changed":!1,"ns-model-changed.focusField":"onFocusFieldChanged","daria:mComposeState:translate-edit":"onTranslateEdit","daria:mComposeState:translate-cancel":"onTranslateCancel"}},events:{"click@show .cke_button__translate":"onClickShowTranslator","click@show .cke_toolbox .cke_button":"saveMetricOfTheToolbarButtonKeypress","mouseup@show .cke_button__attachmentcomputer":"saveMetricOfTheToolbarButtonKeypress"},params:ns.View.info("compose2").params,ctor:function(){e.ctor.apply(this,arguments),_.bindAll(this,t),this.editorId=_.uniqueId("editor_".concat(Daria.Config.connection_id,"_")),this.onEditorChangeDebounce=_.debounce(this.onEditorChange,s.a.DEBOUNCES.EDITOR_CHANGE),this.onChangeHeightDebounce=_.debounce(this.onChangeHeight,s.a.DEBOUNCES.HEIGHT_CHANGE)},yateModule:"compose2",methods:{TOOLBAR_HEIGHT:47,FIELD_NAME:"send",getConfig:function(){var e,t,n=this,o=this,s={},i=/^([a-z]{2,3})\-([a-z]{2,3})$/,a=_.get(ns.page.current,"params.translate","").match(i);return a?(e=a[1],t=a[2]):this.params.ids&&(e=this.getModel("compose-message").getLanguage(),t=Daria.Translate.getDefaultLangTo(e)),CKEDITOR.editorConfig(s),_.extend(s,CKEDITOR.ConfigFactory.getConfig(CKEDITOR.ConfigFactory.COMPOSE,{blur:this.onBlur,focus:this.onFocus,instanceReady:this.onEditorInit,change:this.onEditorChangeDebounce,paste:this.onEditorPaste,maximize:this.onEditorMaximize,"pastefile:dropfile":this.onEditorPastefile,"hotkeys:save":this.onEditorShortcutSave,"hotkeys:send":this.onEditorShortcutSend,"switchmode:switched":this.onEditorSwitchedMode,"switchmode:savebookmark":this.saveBookmark,"translate:enabled":function(){o.onChangeHeight(),o.$node.addClass("mail-Compose-Field-Translate"),o.getModel("compose-state").setIfChanged(".translationEnabled",!0)},"translate:disabled":function(){o.onChangeHeight(),o.$node.removeClass("mail-Compose-Field-Translate"),o.getModel("compose-state").setIfChanged(".translationEnabled",!1)}},{enableHotkeys:ns.Model.get("settings").isSet("enable_hotkeys"),translateInfo:Daria.Config["help-url"]+"/web/letter/translation.html#translation-outgoing",translateAutoEnable:a,translateFrom:e,translateTo:t,pastefileGetPlaceholderContext:function(){var e=o.$node.closest(".js-pastefile-compose")[0];return e||(e=document.body),new CKEDITOR.dom.element(e)},pastefileGetDropContext:function(){var e=o.$node.closest(".js-pastefile-compose")[0];return e||(e=document),e},translate:function(e,t,n,s){s||(s=Daria.Translate.getDefaultLangTo(o.getModel("compose-message").getLanguage()));var i="wysiwyg"===e.mode?"html":"plain",a={text:t,format:i,lang:s};return n&&s&&(a.lang=n+"-"+s),new vow.Promise(function(e,t){ns.request("do-translate",a).then((function(t){var o=_.find(t,"id","do-translate"),i=(o.get(".text")||[]).join(""),a=o.get(".detected.lang");e({data:i,langFrom:n||a,langTo:s})}),t)})},translateLangSelect:function(e,t,n,s){return new vow.Promise(function(e,i){var a="_popupTranslateSelectLang_"+s,r=o[a];if(r)return r.close(),void i();var c=_.assign({},o.params,{currentLang:t});r=ns.View.create("translate-select-lang",c),r.on("selected",(function(t,n){e({lang:n,direction:s}),this.close()})),r.on("closed",(function(){delete o[a],i()})),r.open({where:n.$}),o[a]=r})},mailAutocomplete:{getDraftId:function(){return n.getModel("compose-message").getDraftMid()||""},getMessageId:function(){return n.getModel("compose-message").get(".message_id")},getThreadId:function(){return n.getModel("compose-message").composeParamsService.relatedThreadId},toggleAutocomplete:function(){ns.Model.get("settings").toggleSetting("disable_compose_autocomplete")}}},this)),s},getEditor:function(){var e=CKEDITOR.instances[this.editorId];if(e&&"ready"===e.status)return e},getEditorId:function(){return this.editorId},onInit:function(){this.messageResizeInit(),e.methods.onInit.apply(this,arguments),this.fpsCounter=new o.a("compose",o.a.defaultConfig)},onShow:function(e,t,n){this._timings=n,this._timings.showEditor=Date.now(),this._timings.versionEditor=CKEDITOR.version,this.messageResizeStart();var o=this.getModel("compose-message"),s=this.getConfig();s.height=this.getHeight()-this.TOOLBAR_HEIGHT,s.startupMode=o.isHtmlType()?"wysiwyg":"source",s.viewParams=_.clone(this.params),s.firstSignature=ns.Model.get("settings").isSet("signature_top"),s.firstSignatureMatch=Daria.signs.getSignatureMatch(),s.hasSignature=this.getModel("compose-signature").hasSignatureControl(),s.fileInputMultiple=Daria.Config["input-multiple"],s.canShowDisk=this.getModel("compose-state").hasDisk()&&!Daria.Config["is-corp"],this._timeoutEditorCreate=setTimeout(function(){this.getControllerNode().width()<795&&(s.toolbar="Min"),CKEDITOR.replace(this.getEditorId(),s)}.bind(this),0),this.getControllerNode().on({"x-attached":this.onDOMNodeInserted,"x-detached":this.onDOMNodeRemoved}),o.on("ns-model-changed."+this.FIELD_NAME,this.onFieldDataChanged),this.getModel("compose-state").setIfChanged(".editorMode",s.startupMode),this.fpsCounter.start()},onHide:function(){clearTimeout(this._timeoutApplyTmpContent),clearTimeout(this._timeoutEditorCreate),this.getControllerNode().off({"x-attached":this.onDOMNodeInserted,"x-detached":this.onDOMNodeRemoved}),this.getModel("compose-message").off("ns-model-changed."+this.FIELD_NAME,this.onFieldDataChanged),this.onEditorChangeDebounce.cancel(),this.onChangeHeightDebounce.cancel(),this.messageResizeStop(),this.destroyEditor(),this.fpsCounter.finish()},onDOMNodeRemoved:function(){if(!this.__removed){var e=this.getModel("compose-state"),t=this.getEditor(),n=t&&t.editable();this.__removed={focusField:e.getFocusField(),scrollTop:n&&n.$.scrollTop},this.saveBookmark()}},onDOMNodeInserted:function(){if(this.__removed){var e=this.getEditor(),t=e&&e.editable();if(t&&(t.$.scrollTop=this.__removed.scrollTop||0),this.__removed.focusField){this.getModel("compose-state").setFocusField(this.__removed.focusField),t&&t.hasFocus?(this.onFocusFieldChanged(),this.onFocus()):this.onFocusFieldChanged()}this.__removed=null}},onBlur:function(){clearTimeout(this._timeoutApplyTmpContent),this.toggleFocus(!1),this.resetBookmark()},onFocus:function(){this.toggleFocus(!0),this.restoreBookmark()},_applyTmpContent:function(e){var t=this.getEditor();t&&("source"===t.mode&&(e=Daria.Html2Text.html2text(e)),t.execCommand("pasteContent",{content:e,breakAfter:!0}),this.syncViewToData())},destroyEditor:function(){var e=this.getEditor();e&&e.destroy(!0)},onChangeHeight:function(){var e=this.getHeight();this.getControllerNode().height(e).css("min-height",e);var t=this.getEditor();t&&t.resize("100%",e)},syncViewToData:function(e){if(this.isVisible()){var t=this.getEditor();if(t&&("edit > sending"===e&&this.getModel("compose-state").get(".translationEnabled")&&(t.execCommand("translate_apply"),Jane.c("Написание письма","Подвал письма","Переводчик","Ответить с переводом")),t.checkDirty())){var n=t.getData();void 0!==n&&(this.setFieldData(n),t.resetDirty())}}},syncDataToView:function(){var e=this.getEditor();if(e&&!e.undoManager.locked){e.fire("saveSnapshot"),e.fire("lockSnapshot");var t=this.getFieldData();e.setData(t,(function(){e.updateElement(),e.resetDirty(),e.fire("unlockSnapshot")}))}},onInput:function(){},onEditorInit:function(){this.logTimings(this._timings,[a.a.write,a.a.message]),this.syncDataToView(),this.onFocusFieldChanged(),this.onChangeHeightDebounce()},onEditorChange:function(){this.syncViewToData()},onEditorPaste:function(e){if("html"===e.data.type&&e.data.dataValue){var t=Daria.bubblingQuote(e.data.dataValue);!1!==t&&(e.data.dataValue=t)}},onEditorPastefile:function(e){this.getModel("compose-attachments").addAttach({input:null,files:e.data.files})},onEditorShortcutSave:function(){this.getModel("compose-fsm").setState("save")},onEditorShortcutSend:function(){this.getModel("compose-fsm").setState("sending")},onEditorSwitchedMode:function(e){var t=e.editor,n="wysiwyg"===t.mode?"html":"plain",o=t.getData();this.getModel("compose-state").setIfChanged(".editorMode",t.mode),this.getModel("compose-message").setIfChanged(".ttype",n),this.setFieldData(o),t.resetDirty();var s=ns.Model.get("settings");"source"===t.mode?s.setSettingOff("enable_richedit"):s.setSettingOn("enable_richedit")},onEditorMaximize:function(e){var t=this.getModel("compose-state");t.setIfChanged(".editorMaximize",e.data),e.data===CKEDITOR.TRISTATE_OFF&&(this.$node.toggleClass("mail-Compose-Field-Translate",t.get(".translationEnabled")),this.onChangeHeightDebounce()),_.defer(function(){this.getModel("compose-message").expandMessage()}.bind(this))},onFromMailboxChanged:function(){var e=this.getEditor(),t="wysiwyg"===e.mode;if(e){var n,o=this.getModel("compose-signature").getSignatureList();n=o.noSuitableSignature?Daria.signs.setEmptySign(t):_.first(o.signs),e.fire("signature:set",n.convert)}},_customFocus:function(){var e=this.getEditor();e&&e.execCommand("retryFocus",function(){var e=this.getModel("compose-state").getFocusField();return this.FIELD_NAME===e}.bind(this))},_customIsFocused:function(){var e=this.getEditor();return e&&e.editable().hasFocus},saveBookmark:function(){var e=this.getEditor();if(e){var t=this.getModel("compose-state");if("source"===e.mode){var n=Daria.getSelection(e.editable().$).start;t.setIfChanged(".bodyPos",n)}else{var o=e.getSelection(),s=o&&!o.isLocked&&o.getRanges();t.setIfChanged(".editorBookmark",s)}}},restoreBookmark:function(){var e=this.getEditor();if(e){var t=this.getModel("compose-state");if("source"===e.mode){var n=t.get(".bodyPos");Daria.setSelection(e.editable().$,n)}else{var o=t.get(".editorBookmark");if(t.set(".editorBookmark",null),Array.isArray(o)&&o.length){var s=e.getSelection();s&&s.selectRanges(o)}}}},resetBookmark:function(){var e=this.getEditor();if(e){var t=e.getSelection();t&&(t.removeAllRanges(),t.reset())}},onTranslateEdit:function(){if(this.isVisible()){var e=this.getEditor();e&&e.execCommand("translate_apply")}},onTranslateCancel:function(){if(this.isVisible()){var e=this.getEditor();e&&e.execCommand("translate_toggle",!1)}},onClickShowTranslator:function(){var e=this.getEditor();if(e){var t=e.getCommand("show_translator");if(t)switch(t.state){case CKEDITOR.TRISTATE_ON:Jane.c("Message view",Daria.is2pane()?"2pane":"3pane","Translator","Click on Translate");break;case CKEDITOR.TRISTATE_OFF:Jane.c("Message view",Daria.is2pane()?"2pane":"3pane","Translator","Click on Cancel")}}}}},"compose-metrics-mixin","compose-field-message-resize","compose-field-base")})()},4050:function(e,t,n){"use strict";t.a={EDITOR_CHANGE:50,HEIGHT_CHANGE:50}},4051:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(139);n.n(o);!(function(){ns.View.define("compose-autosave-status",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-htmldestroy":"onHtmlDestroy","click .mail-ui-Link":"togglePopup"},models:{"compose-message":{"ns-model-changed":!1,"ns-model:draft-saved":"onDraftSaved"},"compose-state":!1,"compose-fsm":!1},params:ns.View.info("compose2").params,ctor:function(){this._nbPopup=null},yateModule:"compose2",methods:{onHtmlInit:function(){nb.init(this.node),this._nbPopup=nb.$block(".js-template-popup",this.node),this.bindEvents()},onHtmlDestroy:function(){this.unbindEvents(),nb.destroy(this.node)},bindEvents:function(){var e=_.get(this._nbPopup,"$node");e&&e.on("click",".js-template-link",this.onClickTemplateLink.bind(this))},unbindEvents:function(){var e=_.get(this._nbPopup,"$node");e&&e.off("click")},onClickTemplateLink:function(e){e.preventDefault(),this._nbPopup.close(),this.getModel("compose-message").set(".save_symbol",o.WellKnownFolderSymbol.TEMPLATE),this.getModel("compose-fsm").setState("save"),Jane.c("Написание письма","Подвал письма",'Клик на "Сохранено как черновик"','Клик на "Шаблон"')},togglePopup:function(e){this._nbPopup.isOpen()?this._nbPopup.close():this._nbPopup.open({where:e.target,how:{at:"top",my:"bottom"},autoclose:!0}),Jane.c("Написание письма","Подвал письма",'Клик на "Сохранено как черновик"')},onDraftSaved:function(){this.getModel("compose-state").setLastSaveTime(),this.composeUpdate()}}})})()},4052:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(1857);ns.View.define("compose-turn-on-beta",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide","mouseenter .js-beta-button":"onMouseEnter","mouseleave .js-beta-button":"onMouseLeave","click .js-beta-button":"onClick","daria:vApp:changeAppWidth":"onResize"},models:{"compose-message":!1,settings:!1,"compose-state":{messageHeight:"onResize"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onClick:function(e){e.preventDefault(),this._closePromo(),Object(o.a)(this.getModel("compose-message")),Jane.c("Написание письма","Подвал письма",'Клик на "Перейти в Новый Композ"')},isPromoMode:function(){return!this.getModel("settings").getSetting("react_compose_promo_closed")},disablePromoMode:function(){this.getModel("settings").setSettings({react_compose_promo_closed:!0})},onShow:function(){this.scopeNode=document.querySelector(".js-compose-scroller"),this.isPromoMode()&&this._showPromo()},_closePromo:function(){this.disablePromoMode(),this._hidePromo()},onHide:function(){this._hidePromo()},onMouseEnter:function(){this._showPromo()},onMouseLeave:function(){this.isPromoMode()||this._hidePromo()},_showPromo:function(){var e=this;Daria.React.promoComposeSwitcher.showPromo(this.node,this.scopeNode,(function(){return e._closePromo()}))},_hidePromo:function(){Daria.React.promoComposeSwitcher.hidePromo(this.node)},onResize:function(){this.isPromoMode()&&this._showPromo()}}})},4053:function(e,t){!(function(){ns.View.edefine("compose-attach-buttons-wrapper",{models:{"compose-state":!1,"compose-fsm":!1},events:{"ns-view-init":"onInit","ns-view-show":"onShow","ns-view-hide":"onHide"},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{onInit:function(){this.disableOnSendingInit()},onShow:function(){this.disableOnSendingStart()},onHide:function(){this.disableOnSendingStop()},patchLayout:function(){return"layout-compose-attach-buttons-wrapper"}}},"compose-disable-on-sending-mixin",ns.View)})()},4054:function(e,t){ns.View.define("compose-attach-button-mail",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide",click:"sendMetric"},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{MODE:"mail",onShow:function(){this.openDiskInit()},onHide:function(){this.openDiskDestroy()},sendMetric:function(){Jane.c("Написание письма","Подвал письма",'Клик на "Прикрепить файлы из Почты"')}}},"compose-attach-open-disk-mixin")},4055:function(e,t){ns.View.define("compose-attach-button-disk",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide",click:"sendMetric"},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{MODE:"disk",onShow:function(){this.openDiskInit()},onHide:function(){this.openDiskDestroy()},sendMetric:function(){Jane.c("Написание письма","Подвал письма",'Клик на "Прикрепить файл из Диска"')}}},"compose-attach-open-disk-mixin")},4056:function(e,t){ns.View.define("compose-attach-button-computer",{events:{"ns-view-htmlinit":"_onNsViewHtmlinit","ns-view-htmldestroy":"_onNsViewHtmldestroy","click@show .js-controller":"_onClickController","change@show .js-controller":"_onChangeController"},models:{"compose-attachments":{"ns-model-changed":!1,"ns-model:attachments.added":"_onNsModelAttachmentsAdded"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{_$controllerNode:null,_onNsViewHtmlinit:function(){this._$controllerNode=this._getControllerNode().clone()},_onNsViewHtmldestroy:function(){this._$controllerNode=null},_onClickController:function(){Jane.c("Написание письма","Подвал письма",'Клик на "Прикрепить файл с компьютера"')},_onChangeController:function(e){var t={input:e.target,files:e.target.files};this.getModel("compose-attachments").addAttach(t)},_getControllerNode:function(){return this.$node.find(".js-controller")},_onNsModelAttachmentsAdded:function(){this._$controllerNode.clone().replaceAll(this._getControllerNode())}}})},4057:function(e,t){!(function(){var e=i18n("%Compose_Captcha_title");ns.View.define("compose-captcha",{events:{"ns-view-show":"onShow","click .js-captcha-submit":"send","keydown .js-captcha-input":"onInputKeydown","click .js-captcha-another-image":"showAnotherImage"},models:{captcha:!1,"compose-message":!1,"compose-fsm":!1},yateModule:"compose2",params:ns.View.info("compose2").params,methods:{popupData:{title:e,width:550},onShow:function(){this.focusInput()},showAnotherImage:function(){this.getModel("captcha").invalidate(),this.update()},onInputKeydown:function(e){e.keyCode===Jane.Common.keyCode.ENTER&&(e.preventDefault(),this.send())},getInputValue:function(){return $.trim(this.$node.find(".js-captcha-input").val())},focusInput:function(){this.$node.find(".js-captcha-input").focus()},send:function(){var e=this.getModel("compose-message"),t=this.getInputValue();if(!t)return this.focusInput(),!1;e.set(".captcha_entered",t),e.set(".captcha_key",this.getModel("captcha").get(".key")),this.getModel("compose-fsm").setState("sending",{force:!0}),Daria.Dialog.close()}}})})()},4058:function(e,t){!(function(){ns.View.define("compose-forgotten-attach",{events:{"click .js-close":"onClose","click .js-forgotten-attach-send":"onSend"},models:{"compose-attachments":{"ns-model-changed":!1,"ns-model:attachments.added":"onAttachAdded"},"compose-fsm":!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{popupData:{width:440},data:{},onSend:function(){Jane.ErrorLog.send({event:"attachStopWord",word:_.get(this.data,"stopWordGroup",""),decision:!0}),this.getModel("compose-fsm").setState("sending",{force:!0}),this.triggerCloseEvent()},onAttachAdded:function(){Jane.ErrorLog.send({event:"attachStopWord",word:_.get(this.data,"stopWordGroup",""),decision:!1}),this.triggerCloseEvent()},onClose:function(){Jane.ErrorLog.send({event:"attachStopWord",word:_.get(this.data,"stopWordGroup",""),decision:!1}),this.triggerCloseEvent()},triggerCloseEvent:function(){this.trigger("ns-view:close")}}})})()},4059:function(e,t){ns.View.edefine("compose-forgotten-attach-button",{models:{"compose-attachments":{"ns-model-changed":!1,"ns-model:attachments.added":"_onNsModelAttachmentsAdded"}},params:function(e){return _.extend({},ns.View.info("compose2").params(e),e)},yateModule:"compose2"},"compose-attach-button-computer")},4060:function(e,t){!(function(){ns.View.define("compose-forwarded-messages",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-htmldestroy":"onHtmlDestroy"},models:{"compose-state":!1,"compose-message":!1,"compose-forwarded-messages":{"ns-model-changed":"composeUpdate"}},params:ns.View.info("compose2").params,ctor:function(){this.onCheckboxChanged=this.onCheckboxChanged.bind(this)},yateModule:"compose2",methods:{onHtmlInit:function(){var e=this;nb.init(this.node),this.$node.find(".js-message-checkbox").each((function(t,n){nb.block(n).on("nb-changed",e.onCheckboxChanged)}))},onHtmlDestroy:function(){nb.destroy(this.node)},onCheckboxChanged:function(e,t){var n=t.isChecked()?"checkMessage":"uncheckMessage";this.getModel("compose-forwarded-messages")[n](t.getValue())}}})})()},4061:function(e,t){ns.View.define("compose-labels-wrapper",{models:{"compose-message":!1},params:ns.View.infoLite("compose2").params,yateModule:"compose2",methods:{patchLayout:function(){return this.getModel("compose-message").hasUserLabels()?"layout-compose-labels":"layout-compose-labels-empty"}}})},4062:function(e,t){!(function(){ns.View.define("compose-labels",{events:{"click@show .js-compose-label-unlabel":"onClickRemoveLabel"},models:{labels:!1,"compose-message":{"ns-model-changed":!1,"ns-model-changed.lids":"invalidate"}},params:ns.View.infoLite("compose2").params,ctor:function(){this.getDataForLabel=this.getDataForLabel.bind(this)},yateModule:"compose2",methods:{getDataForLabel:function(e){return this.getModel("labels").getLabelById(e)},getDataForLabels:function(){var e=this.getModel("compose-message").getUserLabels();return e?_.map(e,this.getDataForLabel):[]},onClickRemoveLabel:function(e){var t=e.currentTarget.dataset.lid;this.getModel("compose-message").removeLid(t)}}})})()},4063:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(1856);!(function(){ns.View.define("compose-notify-noreply-button",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-show":"onShow","ns-view-destroy":"onHtmlDestroy"},models:{"compose-message":!1,"compose-state":{"ns-model-changed":!1,"ns-model-changed.messageHeight":"showFirstVisitPopup","ns-model-changed.translationEnabled":"composeUpdate"},"compose-fsm":{"ns-model-changed":!1,"# sent":"onSendEmail"},"compose-notify-noreply-options":{"ns-model-changed":!1,"ns-model-changed.currentTimeDelta":"onChangedCurrentTimeDelta","ns-model-changed.alwaysNotify":"onChangedAlwaysNotify","ns-model-changed.enabledNotify":"onChangedEnabledNotify"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{ASSERT_CLASS_NAME:"Daria.vComposeNotifyNoreplyButton",nanoislands:{blocks:{notifyCheckbox:".js-compose-notify-noreply-button",popup:".js-compose-noreply-notify-popup",firstVisitPopup:".js-noreply-first-visit-popup",toggleCheckbox:".js-compose-noreply-toggle-checkbox",alwaysCheckbox:".js-compose-noreply-always-notify-checkbox",daysSelect:".js-compose-noreply-days-select"},events:{"click notifyCheckbox":"onNotifyCheckboxClick","nb-checked notifyCheckbox":"onNotifyCheckboxChecked","nb-unchecked notifyCheckbox":"onNotifyCheckboxUnchecked","nb-checked toggleCheckbox":"onToggleCheckboxChecked","nb-unchecked toggleCheckbox":"onToggleCheckboxUnchecked","nb-checked alwaysCheckbox":"onAlwaysCheckboxChecked","nb-unchecked alwaysCheckbox":"onAlwaysCheckboxUnchecked","nb-changed daysSelect":"onDaysSelectChanged","click popup .js-close-popup":"onClosePopupClick"}},containerSelector:".js-compose-notify-noreply-button",onShow:function(){this.isEnabledNotify()?this.addNotifyToMessage():this.removeNotifyFromMessage()},isMinimize:function(){return this.getModel("compose-state").get(".translationEnabled")},isEnabledNotify:function(){return this.getModel("compose-notify-noreply-options").get(".enabledNotify")},isAlwaysNotify:function(){return Boolean(this.getModel("compose-notify-noreply-options").get(".alwaysNotify"))},_showFirstVisitPopup:function(){if(this.isVisible()){var e=this.getModel("compose-notify-noreply-options");if(!e.wasFirstVisitPopupShown()){var t=this.nbs.firstVisitPopup,n={where:this.containerSelector,how:{at:"top",my:"bottom"}};t.isOpen()?t.onposition(null,n):t.open(n),e.setFirstVisitPopupWasShown()}}},showFirstVisitPopup:_.debounce((function(){this._showFirstVisitPopup()}),o.a.DEBOUNCES.HEIGHT_CHANGE),hasCurrentTimeDelta:function(){var e=this.getModel("compose-notify-noreply-options"),t=e.getCurrentTimeDelta(),n=this.nbs.daysSelect.getState(),o=Number(n.value);return t.value===o},replaceTextInWaitForReply:function(e,t){e.$node.find(".js-nb-icon-wait-for-reply").text(t)},resetTextInWaitForReply:function(){this.replaceTextInWaitForReply(this.nbs.notifyCheckbox,i18n("%Compose_Checkbox_No_Reply_Normal_Text"))},onChangedCurrentTimeDelta:function(){if(this.isVisible()&&!this.hasCurrentTimeDelta()){var e=this.getModel("compose-notify-noreply-options"),t=e.getCurrentTimeDelta();this.nbs.daysSelect.setState(t)}},onChangedAlwaysNotify:function(){this.isVisible()&&this.setCheckboxState("alwaysCheckbox",this.isAlwaysNotify())},onChangedEnabledNotify:function(){if(this.isVisible()){var e=this.getModel("compose-notify-noreply-options"),t=this.isEnabledNotify();if(this.setCheckboxState("notifyCheckbox",t),this.setCheckboxState("toggleCheckbox",t),t){var n=e.getCurrentTimeDeltaLocalizedText();this.replaceTextInWaitForReply(this.nbs.notifyCheckbox,n),this.addNotifyToMessage()}else this.resetTextInWaitForReply(),this.removeNotifyFromMessage()}},onNotifyCheckboxClick:function(){this.showBubble()},onNotifyCheckboxChecked:function(){this.isEnabledNotify()||this.nbs.notifyCheckbox.uncheck()},onNotifyCheckboxUnchecked:function(){this.isEnabledNotify()&&this.nbs.notifyCheckbox.check()},getNotifyLabelId:function(){var e=ns.Model.get("labels");return jpath(e.getWaitingForReplyLabel(),".lid")[0]},addNotifyToMessage:function(){var e=this.getNotifyLabelId();if(e){var t=this.getModel("compose-message"),n=this.getModel("compose-notify-noreply-options").getCurrentTimeDelta().value;t.addLid(e),t.setIfChanged(".remind_period",n)}},removeNotifyFromMessage:function(){var e=this.getNotifyLabelId();if(e){var t=this.getModel("compose-message");t.removeLid(e),t.setIfChanged(".remind_period",null)}},onToggleCheckboxChecked:function(){this.getModel("compose-notify-noreply-options").set(".enabledNotify",!0),Jane.c("Написание письма","Подвал письма",'Клик в "Напомнить"','Простановка чекбокса "Напомнить через 5 дней"')},onToggleCheckboxUnchecked:function(){this.getModel("compose-notify-noreply-options").set(".enabledNotify",!1)},onAlwaysCheckboxChecked:function(){this.getModel("compose-notify-noreply-options").setAlwaysNotifyOption(!0),Jane.c("Написание письма","Подвал письма",'Клик в "Напомнить"','Простановка чекбокса "Напоминать всегда"')},onAlwaysCheckboxUnchecked:function(){this.getModel("compose-notify-noreply-options").setAlwaysNotifyOption(!1)},onDaysSelectChanged:function(){if(!this.hasCurrentTimeDelta()){var e=this.getModel("compose-notify-noreply-options"),t=this.nbs.daysSelect.getState();e.setCurrentTimeDelta(t),this.nbs.popup.close()}},onClosePopupClick:function(){this.nbs.popup.close(),Jane.c("Написание письма","Подвал письма",'Клик в "Напомнить"',"Клик в крестик")},onSendEmail:function(){this.isVisible()&&(this.isEnabledNotify()&&Jane.c("Написание письма","Подвал письма",'Клик в "Напомнить"','Отправка письма с настройкой "Напомнить через 5 дней"'),this.isAlwaysNotify()&&Jane.c("Написание письма","Подвал письма",'Клик в "Напомнить"','Отправка письма с настройкой "Напоминать всегда"'))}}},"compose-popup-button")})()},4064:function(e,t){!(function(){ns.View.define("compose-notify-on-send-button",{events:{"ns-view-htmlinit":"onHtmlInit","ns-view-htmldestroy":"onHtmlDestroy"},models:{"compose-state":{"ns-model-changed":!1,"ns-model-changed.translationEnabled":"composeUpdate"},"compose-message":{"ns-model-changed":!1,"ns-model-changed.notify_on_send":"onChangedNotifyOnSend"},"compose-fsm":{"ns-model-changed":!1,"# sent":"onSendEmail"}},params:ns.View.info("compose2").params,yateModule:"compose2",ctor:function(){this.closeBubble=this.closeBubble.bind(this)},methods:{ASSERT_CLASS_NAME:"Daria.vComposeNotifyOnSend",nanoislands:{blocks:{checkbox:".js-compose-remind-button",popup:".js-compose-remind-popup"},events:{"nb-checked checkbox":"onChecked","nb-unchecked checkbox":"onUnchecked","click popup .js-close-popup":"onClosePopupClick"}},containerSelector:".js-compose-remind-button",isMinimize:function(){return this.getModel("compose-state").get(".translationEnabled")},onChangedNotifyOnSend:function(){if(this.isVisible()){switch(this.getModel("compose-message").get(".notify_on_send")){case"yes":this.showBubble(),this.setCheckboxState("checkbox",!0);break;default:this.setCheckboxState("checkbox",!1),clearTimeout(this._popupTimeout)}}},onChecked:function(){this.getModel("compose-message").set(".notify_on_send","yes")},onUnchecked:function(){this.getModel("compose-message").set(".notify_on_send",null)},onClosePopupClick:function(){this.closeBubble(),Jane.c("Написание письма","Подвал письма",'Клик в "Уведомить"',"Клик на крестик")},closeBubble:function(){clearTimeout(this._popupTimeout),this._$window.off("scroll",this.closeBubble),ns.events.off("daria:vScrollerMessage:scroll",this.closeBubble),ns.events.off("daria:vScrollerMessages:scroll",this.closeBubble),ns.events.off("daria:layout-changed",this.closeBubble),this.nbs.popup.close()},showBubble:function(){this.super_.showBubble.call(this).then(this._activateClosingTimeout.bind(this))},_activateClosingTimeout:function(){var e=Daria.timify({seconds:3});this._popupTimeout=setTimeout(this.closeBubble,e),this._$window.one("scroll",this.closeBubble),ns.events.once("daria:vScrollerMessage:scroll",this.closeBubble),ns.events.once("daria:vScrollerMessages:scroll",this.closeBubble),ns.events.once("daria:layout-changed",this.closeBubble)},onSendEmail:function(){this.isVisible()&&this.isNotifyOnSend()&&Jane.c("Написание письма","Подвал письма",'Клик в "Уведомить"',"Отправка письма с настройкой")},isNotifyOnSend:function(){return"yes"===this.getModel("compose-message").get(".notify_on_send")}}},"compose-popup-button")})()},4065:function(e,t){!(function(){var e={split:{byModel:"compose-field-notices",intoViews:function(e){var t=e.get(".type"),n=e.params.field;switch(t){case"error":return"compose-field-"+n+"-error";case"nda":return"compose-field-"+n+"-notice-nda";case"help":return"compose-field-"+n+"-notice-help";case"replyall":return"compose-field-"+n+"-notice-replyall"}return null}}};["phone","to","cc","bcc","att_ids"].forEach((function(t){var n="compose-field-notices-"+t;ns.ViewCollection.define(n,{models:{"compose-field-notices":!0},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:t})},split:_.clone(e.split),yateModule:"compose2"})}))})()},4066:function(e,t){ns.ViewCollection.define("compose-field-extras-to",{models:{"compose-field-extras-collection":!0},params:function(e){return _.extend({},ns.View.infoLite("compose2").params(e),{field:"to"})},split:{byModel:"compose-field-extras-collection",intoViews:function(e){switch(e.get(".type")){case"extras-phone":return"compose-field-to-extras-phone";case"extras-cc":return"compose-field-to-extras-cc";case"extras-bcc":return"compose-field-to-extras-bcc";case"extras-qr-close":return"compose-field-to-extras-qr-close"}return null}},yateModule:"compose2"})},4067:function(e,t){ns.View.define("compose-recipients-diff",{events:{"click@show .js-compose-recipients-diff-close":"onSelectorClick"},models:{"compose-message":{"ns-model-changed":!1,"ns-model-changed.recipients-diff":"selfUpdate"},"compose-state":{"ns-model-changed":!1,"ns-model-changed.recipients-diff-pane-close":"selfUpdate"}},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{selfUpdate:function(){this.invalidate(),this.update()},onSelectorClick:function(){this.getModel("compose-state").set(".recipients-diff-pane-close",!0)},hasRecipients:function(){var e=this.getModel("compose-message"),t=e.get(".recipients-diff");return t.added.length||t.removed.length},getRecipientsEmails:function(){var e=this.getModel("compose-message"),t=e.get(".recipients-diff");return t.added=t.added.map(this.recipientsMapIterator),t.removed=t.removed.map(this.recipientsMapIterator),t},recipientsMapIterator:function(e){var t=e.indexOf("@");return-1===t&&(t=e.length-1),e.substring(0,t+1)}}})},4068:function(e,t){ns.View.define("compose-switchmode-popup",{params:{},yateModule:"compose2",ctor:function(){this._popup=null},methods:{open:function(){this._promise=new Vow.Promise,this._promise.then(this.trigger.bind(this,"resolve"),this.trigger.bind(this,"reject")),this._popup=nb.block(ns.renderNode({},"js-compose-switchmode-popup","compose2")),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open({withoutTail:!0,autofocus:!0,autoclose:!1})},_onOpened:function(){this._popup.$node.on("click",".js-resolve",this._onResolve.bind(this)),this._popup.$node.on("click",".js-reject",this._onClosed.bind(this))},_onResolve:function(){this._promise.fulfill(),this._popup.close()},_onClosed:function(){this._popup&&(this._popup.destroy(),this._popup=null)},_onDestroyed:function(){this._promise.reject("error destroying popup"),this.destroy()}}})},4069:function(e,t){ns.View.define("compose-emoticons-select",{models:{"compose-emoticons":!1},events:{"click@show .js-click":"_onClick","daria:vScrollerMessages:scroll@show":"_onScroll","daria:vScrollerMessage:scroll@show":"_onScroll"},params:ns.View.info("compose2").params,ctor:function(){this._defaultOptions={withoutTail:!0,autofocus:!1,autoclose:!0},this._options={},this._popup=null},yateModule:"compose2",methods:{open:function(e){return this._options=_.extend({},this._defaultOptions,e),this.update(this.params).then(this._onAfterRender,this)},close:function(){this._popup&&this._popup.close()},_onAfterRender:function(){this._popup=nb.block(ns.renderNode({},"js-compose-emoticons-select","compose2")),this._popup.setContent(this.node),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open(this._options)},_onOpened:function(e,t){t.$node.on("mousedown",(function(e){e.preventDefault()})),this.trigger("opened")},_onClosed:function(){this._popup&&(this._popup.destroy(),this._popup=null),this._options={},this.trigger("closed")},_onDestroyed:function(){this.destroy()},_onClick:function(e){e.preventDefault(),this.trigger("select",$(e.currentTarget).data("suid")),this._popup.close()},_onScroll:function(){var e=this._popup&&this._popup.node&&this._popup.node.widget;e&&e._position()}}})},4070:function(e,t){ns.View.define("compose-maillink-dialog",{events:{"click@show .js-update":"_onClickUpdate","click@show .js-cancel":"_onClickCancel"},params:ns.View.info("compose2").params,ctor:function(){this._onKeyup=this._onKeyup.bind(this),this._popup=null,this._data={}},yateModule:"compose2",methods:{REG_CHECK_EMAIL:/^(http(s?):\/\/|ftp:\/\/|mailto:)/,getData:function(e,t){return this._data[e]||t||""},open:function(e){this._data=_.isObject(e)?_.clone(e):{},this.update(this.params).then(this._onAfterRender,this)},close:function(){this._popup&&this._popup.close()},isEdit:function(){return Boolean(this.getData("href"))},getHrefView:function(){return this.getData("href")},getTextView:function(){var e=this.getData("text");return e===this.getData("href")?"":e},isDisableText:function(){return this.getData("isDisableText")},_onAfterRender:function(){this._popup=nb.block(ns.renderNode({},"js-compose-maillink-dialog","compose2")),this._popup.setContent(this.node),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open({autofocus:!0,autoclose:!1,animation:!1})},_onOpened:function(){this._nbInputText=nb.$block(".js-text",this.node),this._nbInputHref=nb.$block(".js-href",this.node),this.$node.on("keyup",this._onKeyup),this.trigger("opened"),this._nbInputHref.focus(),this.getData("href")||Daria.setSelection(this._nbInputHref.$control[0],this.getHrefView().length),this.isDisableText()&&this._nbInputText.disable()},_onClosed:function(){this.$node.off("keyup",this._onKeyup),nb.destroy(this.node),this._popup&&(this._popup.destroy(),this._popup=null),this.trigger("closed"),this._data=null},_onDestroyed:function(){this.destroy()},_onClickCancel:function(){this._popup.close()},_onKeyup:function(e){13===e.keyCode&&this._onClickUpdate()},_onClickUpdate:function(){var e=this._nbInputHref.getValue().trim();if(!e)return void this._nbInputHref.showError({autoclose:!0});this.REG_CHECK_EMAIL.test(e)||(e="http://"+e);var t=this._nbInputText.getValue().trim()||e,n=this.getData("href"),o=this.getData("text");this._popup.close(),e===n&&t===o||this.trigger("update",{text:t,href:e})}}})},4071:function(e,t){ns.View.define("compose-unsaved-popup",{params:{},yateModule:"compose2",ctor:function(){this._popup=null},methods:{open:function(){this._promise=new Vow.Promise,this._promise.then(this.trigger.bind(this,"resolve"),this.trigger.bind(this,"reject")),this._popup=nb.block(ns.renderNode({},"js-compose-unsaved-popup","compose2")),this._popup.on("nb-opened",this._onOpened.bind(this)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.on("nb-destroyed",this._onDestroyed.bind(this)),this._popup.open({withoutTail:!0,autofocus:!0,autoclose:!1})},isOpen:function(){return!!this._popup&&this._popup.isOpen()},_onOpened:function(){this._popup.$node.on("keydown click",".js-resolve",this._onResolve.bind(this)),this._popup.$node.on("keydown click",".js-reject",this._onClosed.bind(this))},_onResolve:function(e){if(!(e instanceof $.Event&&"keydown"===e.type&&e.which!==Jane.Common.keyCode.ENTER)){var t=$(e.currentTarget).data("action");this._promise.fulfill(t),this._popup.close()}},_onClosed:function(e){e instanceof $.Event&&"keydown"===e.type&&e.which!==Jane.Common.keyCode.ENTER||this._popup&&(this._popup.destroy(),this._popup=null)},_onDestroyed:function(){this._promise.reject("error destroying popup"),this.destroy()}}})},4072:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(88),s=n.n(o);!(function(){var e=ns.View.infoLite("compose-field-base"),t=["onDOMNodeRemoved","onDOMNodeInserted","onFocus","onBlur","syncDataToView","syncViewToData","saveBookmark","onFocusFieldChanged","onEditorInit","onEditorShortcutSave","onEditorShortcutSend","onEditorChange","onEditorPaste","onEditorSwitchedMode","_applyTmpContent"];ns.View.edefine("compose-message-editor-tiny",{models:{"module-editor":!1,"compose-message":!1,"compose-attachments":!1,"compose-fsm":{"ns-model-changed":!1,"edit > sending":"syncViewToData","edit > save":"syncViewToData","edit > cancel":"syncViewToData"},"compose-state":{"ns-model-changed":!1,"ns-model-changed.focusField":"onFocusFieldChanged"}},params:ns.View.info("compose2").params,ctor:function(){e.ctor.apply(this,arguments),_.bindAll(this,t),this.editorId=_.uniqueId("editor"),this.onEditorChangeDebounce=_.debounce(this.onEditorChange,50)},yateModule:"compose2",methods:{FIELD_NAME:"send",getConfig:function(){var e=this,t={};return CKEDITOR.editorConfig(t),_.extend(t,CKEDITOR.ConfigFactory.getConfig(CKEDITOR.ConfigFactory.COMPOSE_TINY,{blur:this.onBlur,focus:this.onFocus,instanceReady:this.onEditorInit,change:this.onEditorChangeDebounce,paste:this.onEditorPaste,"hotkeys:save":this.onEditorShortcutSave,"hotkeys:send":this.onEditorShortcutSend,"switchmode:switched":this.onEditorSwitchedMode,"switchmode:savebookmark":this.saveBookmark},{enableHotkeys:ns.Model.get("settings").isSet("enable_hotkeys"),pastefileGetPlaceholderContext:function(){var t=e.$node.closest(".js-pastefile-compose")[0];return t||(t=document.body),new CKEDITOR.dom.element(t)},pastefileGetDropContext:function(){var t=e.$node.closest(".js-pastefile-compose")[0];return t||(t=document),t}},this)),t},getEditor:function(){var e=CKEDITOR.instances[this.editorId];if(e&&"ready"===e.status)return e},getEditorId:function(){return this.editorId},onShow:function(e,t,n){this._timings=n,this._timings.showEditor=Date.now();var o=this.getModel("compose-message"),s=this.getConfig();s.height=60,s.startupMode=o.isHtmlType()?"wysiwyg":"source",s.viewParams=_.clone(this.params),this._timeoutEditorCreate=setTimeout(function(){CKEDITOR.replace(this.getEditorId(),s)}.bind(this),50),this.getControllerNode().on({"x-attached":this.onDOMNodeInserted,"x-detached":this.onDOMNodeRemoved}),o.on("ns-model-changed."+this.FIELD_NAME,this.onFieldDataChanged),this.getModel("compose-state").setIfChanged(".editorMode",s.startupMode)},onHide:function(){clearTimeout(this._timeoutApplyTmpContent),clearTimeout(this._timeoutEditorCreate),this.getControllerNode().off({"x-attached":this.onDOMNodeInserted,"x-detached":this.onDOMNodeRemoved}),this.getModel("compose-message").off("ns-model-changed."+this.FIELD_NAME,this.onFieldDataChanged),this.onEditorChangeDebounce.cancel(),this.destroyEditor()},onDOMNodeRemoved:function(){if(!this.__removed){var e=this.getModel("compose-state"),t=this.getEditor(),n=t&&t.editable();this.__removed={focusField:e.getFocusField(),scrollTop:n&&n.$.scrollTop},this.saveBookmark()}},onDOMNodeInserted:function(){if(this.__removed){var e=this.getEditor(),t=e&&e.editable();if(t&&(t.$.scrollTop=this.__removed.scrollTop||0),this.__removed.focusField){this.getModel("compose-state").setFocusField(this.__removed.focusField),t&&t.hasFocus?(this.onFocusFieldChanged(),this.onFocus()):this.onFocusFieldChanged()}this.__removed=null}},onBlur:function(){clearTimeout(this._timeoutApplyTmpContent),this.toggleFocus(!1),this.resetBookmark()},onFocus:function(){this.toggleFocus(!0),this.restoreBookmark()},_applyTmpContent:function(e){var t=this.getEditor();t&&("source"===t.mode&&(e=Daria.Html2Text.html2text(e)),t.execCommand("pasteContent",{content:e,breakAfter:!0}),this.syncViewToData())},destroyEditor:function(){var e=this.getEditor();e&&e.destroy(!0)},syncViewToData:function(){if(this.isVisible()){var e=this.getEditor();if(e&&e.checkDirty()){var t=e.getData();void 0!==t&&(this.setFieldData(t),e.resetDirty())}}},syncDataToView:function(){var e=this.getEditor();if(e&&!e.undoManager.locked){e.fire("saveSnapshot"),e.fire("lockSnapshot");var t=this.getFieldData();e.setData(t,{callback:function(){e.updateElement(),e.resetDirty(),e.fire("unlockSnapshot")}})}},onInput:function(){},onEditorInit:function(){this.logTimings(this._timings,[s.a.write,s.a.message,s.a.tiny]),this.syncDataToView(),this.onFocusFieldChanged()},onEditorChange:function(){this.syncViewToData()},onEditorPaste:function(e){if("html"===e.data.type&&e.data.dataValue){var t=Daria.bubblingQuote(e.data.dataValue);!1!==t&&(e.data.dataValue=t)}},onEditorShortcutSave:function(){this.getModel("compose-fsm").setState("save")},onEditorShortcutSend:function(){this.getModel("compose-fsm").setState("sending")},onEditorSwitchedMode:function(e){var t=e.editor,n="wysiwyg"===t.mode?"html":"plain",o=t.getData();this.getModel("compose-state").setIfChanged(".editorMode",t.mode),this.getModel("compose-message").setIfChanged(".ttype",n),this.setFieldData(o),t.resetDirty();var s=ns.Model.get("settings");"source"===t.mode?s.setSettingOff("enable_richedit"):s.setSettingOn("enable_richedit")},_customFocus:function(){var e=this.getEditor();e&&e.execCommand("retryFocus",function(){var e=this.getModel("compose-state").getFocusField();return this.FIELD_NAME===e}.bind(this))},_customIsFocused:function(){var e=this.getEditor();return e&&e.editable().hasFocus},saveBookmark:function(){var e=this.getEditor();if(e){var t=this.getModel("compose-state");if("source"===e.mode){var n=Daria.getSelection(e.editable().$).start;t.setIfChanged(".bodyPos",n)}else{var o=e.getSelection(),s=o&&!o.isLocked&&o.getRanges();t.setIfChanged(".editorBookmark",s)}}},restoreBookmark:function(){var e=this.getEditor();if(e){var t=this.getModel("compose-state");if("source"===e.mode){var n=t.get(".bodyPos");n&&Daria.setSelection(e.editable().$,n)}else{var o=t.get(".editorBookmark");if(t.set(".editorBookmark",null),Array.isArray(o)&&o.length){var s=e.getSelection();s&&s.selectRanges(o)}}}},resetBookmark:function(){var e=this.getEditor();if(e){var t=e.getSelection();t&&(t.removeAllRanges(),t.reset())}}}},"compose-field-base")})()},4073:function(e,t){ns.View.define("compose-addimage-popup",{yateModule:"compose2",events:{"wheel window":"onWheel"},methods:{_popup:null,_input:null,open:function(e){this.update({},{execFlag:ns.U.EXEC.PARALLEL}).then((function(){this._popup=nb.block(this.node),this._popup.on("nb-opened",this._onOpened.bind(this,e)),this._popup.on("nb-closed",this._onClosed.bind(this)),this._popup.open({withoutTail:!0,autofocus:!0,autoclose:!1})}),this)},_hideError:function(e){e.data.error&&(e.$node.removeClass("_nb-is-wrong"),e.error.close())},_onOpened:function(e){this._input=nb.$block(".js-imageurl-input",this.node),e&&e.defaultValue&&"string"==typeof e.defaultValue&&this._input.setValue(e.defaultValue),e&&e.showError&&this._input.showError(),this._input.on("nb-changed",(function(){Jane.FormValidation.isUrl(this.getValue())||this.showError()}));var t=function(){this._hideError(this._input)}.bind(this);this._input.$control.on("keydown",t),this._input.$control.on("click",t),this._popup.$node.on("click",".js-resolve",this._onResolve.bind(this)),this._popup.$node.on("click",".js-reject",this._onClosed.bind(this))},_onResolve:function(){this._input&&this._input.getValue&&Jane.FormValidation.isUrl(this._input.getValue())?(this.trigger("resolve",this._input.getValue()),this._popup.close()):this._input.showError()},_onClosed:function(){var e=this;_.defer((function(){e._popup.$node.off("click"),e._input&&(e._input.$control&&e._input.$control.off(),e._input.destroy(),e._input=null),e._popup&&(e._popup.destroy(),e._popup=null),e.trigger("reject"),e.destroy()}))},getScrollContent:function(){return null}}},"prevent-scroll-propagation-mixin",ns.View)},4074:function(e,t,n){"use strict";function o(e,t,n,o,s,i,a){try{var r=e[i](a),c=r.value}catch(e){return void n(e)}r.done?t(c):Promise.resolve(c).then(o,s)}function s(e){return function(){var t=this,n=arguments;return new Promise(function(s,i){function a(e){o(c,s,i,a,r,"next",e)}function r(e){o(c,s,i,a,r,"throw",e)}var c=e.apply(t,n);a(void 0)})}}Object.defineProperty(t,"__esModule",{value:!0});var i=n(656),a=n(1857),r=n(4075);ns.View.define("compose-turn-off-promo",{events:{"ns-view-show":"onShow","ns-view-hide":"onHide"},models:{"compose-message":!1,settings:!1},params:ns.View.info("compose2").params,yateModule:"compose2",methods:{settingName:function(){return"promo_turn_off_ns_compose"},canShow:function(){return!this.getModel("settings").isSet(this.settingName())},onShow:function(){this.canShow()&&Object(i.renderReactComponent)(r.a,this.node,{onCancel:this.close.bind(this),onAction:this.onAction.bind(this)})},onHide:function(){Object(i.unmountReactBox)(this.node)},onAction:(function(){function e(){return t.apply(this,arguments)}var t=s(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.close(),e.next=3,Object(a.a)(this.getModel("compose-message"));case 3:case"end":return e.stop()}}),e,this)})));return e})(),close:function(){this.getModel("settings").setSettingOn(this.settingName()),this.onHide()}}})},4078:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=n(87);n.n(o);!(function(){function e(){var e={"compose-attach-buttons-wrapper":{},"compose-send-button-complex":{},"compose-button-translate-apply":{},"compose-button-translate-close":{},"compose-autosave-status":{},"compose-notify-noreply-button-box@":{}};return"TUR"!==Daria.Config.product&&(e["compose-notify-on-send-button"]={},ns.Model.get("labels").getWaitingForReplyLabel()&&(e["compose-notify-noreply-button-box@"]={"compose-notify-noreply-button":{}})),e["compose-turn-on-beta"]={},e}var t=_.extend({"compose-head":{"compose-action-buttons":{},"compose-from":{},"compose-cancel-button":{}},"compose-footer":e},(function(){return{"compose-fields-wrapper":{},"compose-attach-area":{},"compose-field-att_ids-notices-wrapper":{},"compose-forwarded-messages":{},"compose-message-editor":{}}})());Object(o.hasFeature)(o.Features.WEB_TURN_OFF_NS_COMPOSE_PROMO)&&(t["compose-turn-off-promo"]={}),t["compose-head"]["compose-delete-button"]={},t["compose-head"]["compose-label-button"]={},ns.layout.define("layout-compose-action-buttons",{"compose-action-buttons-box@":{"compose-send-link":{}}}),ns.layout.define("layout-compose-action-buttons-template",{"compose-action-buttons-box@":{"compose-send-link":{},"compose-save-link":{}}}),ns.layout.define("layout-compose-action-buttons-new-template",{"compose-action-buttons-box@":{"compose-save-link":{},"compose-send-link":{}}});var n={compose2:t};Daria.is2pane()&&(n.footer={"footer-help-link":{}});var s={"app right-box@":{"compose-box@":n},"app toolbar-box@":{},"app fake-head-background-box@":function(){return Daria.CompactMode.isCompactHeader()?{"fake-head-background":{}}:{}}};s["app "+Daria.getDirectBlockLayoutInfo("messages-direct").name]={},ns.layout.define("compose2",s,"common+left+toolbar"),ns.layout.define("browse-disk",{"browse-disk":{"browse-disk-crumbs-box@":function(e){return e.path?"browse-disk-crumbs":null},"browse-disk-listing-box@":function(e){return e.path?"browse-disk-listing&":null}}}),ns.layout.define("forgotten-attach",{"compose-forgotten-attach":{"compose-forgotten-attach-button":{}}}),ns.layout.define("compose-attach-select-location",{"compose-attach-select-location":function(){var e={"compose-attach-button-computer":{}};return ns.Model.get("compose-state").hasDisk()&&!Daria.Config["is-corp"]&&(e["compose-attach-button-disk"]={},e["compose-attach-button-mail"]={}),e}}),ns.layout.define("layout-compose-attach-buttons-wrapper",{"compose-attach-buttons-box@":function(){var e={"compose-attach-button-computer":{}};return ns.Model.get("compose-state").hasDisk()&&(e["compose-attach-button-disk"]={},e["compose-attach-button-mail"]={}),e}}),ns.layout.define("compose-template-list",{"compose-template-list":{}}),ns.layout.define("layout-compose-labels",{"compose-labels-box@":{"compose-labels":{}}}),ns.layout.define("layout-compose-labels-empty",{"compose-labels-box@":{}}),ns.layout.define("layout-compose-popular-contacts",{"compose-popular-contacts-box@":{"compose-popular-contacts&":{}}}),ns.layout.define("layout-compose-popular-contacts-empty",{"compose-popular-contacts-box@":{}}),ns.layout.define("layout-compose-field-to-extras",{"compose-field-to-extras-box@":{"compose-field-extras-to":{}}}),ns.layout.define("layout-compose-message-editor-bottom",{"compose-message-editor-bottom-box@":{"compose-message-editor-bottom-buttons":{"compose-action-buttons":{}}}}),ns.layout.define("layout-compose-message-editor-bottom-buttons-empty",{"compose-message-editor-bottom-box@":{}}),ns.layout.define("layout-compose-message-editor-top",{"compose-message-editor-top-box@":{"compose-recipients-diff":{}}}),ns.layout.define("layout-compose-field-notices-att_ids",{"compose-field-notices-box@":{"compose-field-notices-att_ids":{}}}),ns.layout.define("layout-compose-field-notices-to",{"compose-field-notices-box@":{"compose-field-notices-to":{}}}),ns.layout.define("layout-compose-field-notices-phone",{"compose-field-notices-box@":{"compose-field-notices-phone":{}}}),ns.layout.define("layout-compose-field-notices-cc",{"compose-field-notices-box@":{"compose-field-notices-cc":{}}}),ns.layout.define("layout-compose-field-notices-bcc",{"compose-field-notices-box@":{"compose-field-notices-bcc":{}}}),ns.layout.define("layout-compose-fields",{"compose-fields-box@":{"compose-field-to":{"compose-field-to-extras":{}},"compose-field-to-notices-wrapper":{},"compose-popular-contacts-wrapper":{},"compose-field-cc":{},"compose-field-cc-notices-wrapper":{},"compose-field-bcc":{},"compose-field-bcc-notices-wrapper":{},"compose-field-phone":{},"compose-field-phone-notices-wrapper":{},"compose-field-subject":{"compose-template-list-button":{}},"compose-labels-wrapper":{}}}),ns.layout.define("layout-compose-fields-placeholder",{"compose-fields-box@":{"compose-field-placeholder":{"compose-field-to-extras":{}}}}),ns.layout.define("layout-compose-field-phone-input",{"compose-field-phone-input-box@":{"compose-field-phone-input":{}}}),ns.layout.define("layout-compose-field-phone-input-error",{"compose-field-phone-input-box@":{"compose-field-phone-input-error":{}}})})()},4079:function(e,t){!(function(e){function t(o){if(n[o])return n[o].exports;var s=n[o]={exports:{},id:o,loaded:!1};return e[o].call(s.exports,s,s.exports,t),s.loaded=!0,s.exports}var n={};t.m=e,t.c=n,t.p="",t(0)})([(function(e,t,n){function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){return!t||"object"!==o(t)&&"function"!=typeof t?a(e):t}function a(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function r(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function c(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}function u(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}function l(e){var t="function"==typeof Map?new Map:void 0;return(l=function(e){function n(){return h(e,arguments,m(this).constructor)}if(null===e||!p(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),f(n,e)})(e)}function d(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function h(e,t,n){return h=d()?Reflect.construct:function(e,t,n){var o=[null];o.push.apply(o,t);var s=Function.bind.apply(e,o),i=new s;return n&&f(i,n.prototype),i},h.apply(null,arguments)}function p(e){return-1!==Function.toString.call(e).indexOf("[native code]")}function f(e,t){return(f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function m(e){return(m=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function g(e){e.editor||Object.defineProperty(e,"editor",{configurable:!0,value:v.init(e)})}function b(e){e.editor&&(v.destroy(e),delete e.editor)}var _=n(1),v=n(2),y=n(6),C=n(37),S=(function(e){function t(){var e,n;s(this,t);for(var o=arguments.length,a=new Array(o),r=0;r<o;r++)a[r]=arguments[r];var c=n=i(this,(e=m(t)).call.apply(e,[this].concat(a)));return g(c),y.ready(c),i(n,c)}return u(t,e),c(t,null,[{key:"observedAttributes",get:function(){return C.attributes}}]),c(t,[{key:"connectedCallback",value:function(){g(this),this.editor.bubbling()}},{key:"disconnectedCallback",value:function(){b(this)}},{key:"attributeChangedCallback",value:function(){C(this)}},{key:"options",value:function(e,t){return C(this,e,t)}},{key:"setContent",value:function(e){return this.editor.setContent(e)}},{key:"canAddBubble",value:function(){return this.editor.canAddBubble()}},{key:"addBubble",value:function(e,t){return this.editor.addBubble(e,t)}},{key:"removeBubble",value:function(e){return this.editor.removeBubble(e)}},{key:"editBubble",value:function(e){return this.editor.editBubble(e)}},{key:"bubbling",value:function(){return this.editor.bubbling()}},{key:"items",get:function(){return this.editor.getItems()}},{key:"inputValue",get:function(){return this.editor.inputValue()}}]),t})(l(HTMLDivElement));_.customElements.define("x-bubbles",S,{extends:"div"}),e.exports=S}),(function(e,t){e.exports=(function(){return this||(0,eval)("this")})()}),(function(e,t,n){function o(){return g.canAddBubble(this)}function s(){return g.getBubbles(this)}function i(e){var t=m.getSelection();t&&t.removeAllRanges();var n=M.get(this);for(n.length&&(g.removeBubbles(this,n),this.fireChange());this.firstChild;)this.removeChild(this.firstChild);return e=S.html2text(e),this.appendChild(this.ownerDocument.createTextNode(e)),b.bubbling(this),_.restore(this),!0}function a(e,t){var n=b.create(this,e,t);return!(!this.canAddBubble()||!n)&&(!!S.text2bubble(this,n)&&(this.fireInput(),this.fireChange(),_.restore(this),!0))}function r(e){return!!this.contains(e)&&(g.removeBubbles(this,[e]),this.fireChange(),!0)}function c(e){return!!this.contains(e)&&b.edit(this,e)}function u(){var e=S.currentTextRange(this);return e&&S.textClean(e.toString())||""}function l(){b.bubbling(this)}function d(e){D.dispatch(this,y.BUBBLE_EDIT,{bubbles:!1,cancelable:!1,detail:{data:e}})}function h(){D.dispatch(this,y.CHANGE,{bubbles:!1,cancelable:!1})}function p(){var e=u.call(this);this[C.BUBBLE_VALUE]!==e&&(this[C.BUBBLE_VALUE]=e,D.dispatch(this,y.BUBBLE_INPUT,{bubbles:!1,cancelable:!1,detail:{data:e}}))}function f(e){D.dispatch(this,y.BEFORE_REMOVE,{bubbles:!1,cancelable:!1,detail:{data:e}})}var m=n(1),g=n(3),b=n(4),_=n(13),v=n(12),y=v.EV,C=v.PROPS,S=n(5),D=n(10),E=n(6),w=n(15),M=n(14),k={blur:n(21),click:n(22),focus:n(23),keydown:n(24)},A={blur:n(25),click:n(26),mousedown:n(27),focus:n(28),keydown:n(29),keypress:n(30),keyup:n(31),paste:n(32)},T={blur:n(33),click:n(34),keydown:n(35),keypress:n(36)},F={blur:D.proxyLocal,click:D.proxyLocal,mousedown:D.proxyLocal,focus:D.proxyLocal,keydown:D.proxyLocal,keypress:D.proxyLocal,keyup:D.proxyLocal,mscontrolselect:D.prevent,paste:D.proxyLocal,resize:D.prevent,resizestart:D.prevent};t.init=function(e){var t=e;return t.setAttribute("contenteditable","true"),t.setAttribute("spellcheck","false"),D.onLocal(t,k),D.onLocal(t,A),t.options("selection")&&(D.onLocal(t,T),w.init(t)),D.on(t,F),t.fireChange=E.throttle(h,t),t.fireEdit=E.throttle(d,t),t.fireInput=E.throttle(p,t),t.fireBeforeRemove=f.bind(t),{canAddBubble:o.bind(t),addBubble:a.bind(t),bubbling:l.bind(t),editBubble:c.bind(t),getItems:s.bind(t),inputValue:u.bind(t),removeBubble:r.bind(t),setContent:i.bind(t)}},t.destroy=function(e){var t=e;D.off(t,F),D.offLocal(t,k),D.offLocal(t,A),t.options("selection")&&(D.offLocal(t,T),w.destroy(t))}}),(function(e,t,n){function o(e){return e.querySelector("[bubble]:last-child")}function s(e){return e.querySelector("[bubble]:first-child")}function i(e){return Array.prototype.slice.call(e.querySelectorAll("[bubble]"))}function a(e){return i(e).length}function r(e){return Boolean(e.querySelector("[bubble]"))}function c(e){if(e.focusNode&&e.anchorNode){var t=e.focusNode.previousSibling;for(e.anchorNode!==e.focusNode&&e.anchorNode.compareDocumentPosition(e.focusNode)&Node.DOCUMENT_POSITION_FOLLOWING&&(t=e.anchorNode.previousSibling);t;){if(v.isBubbleNode(t))return t;if(t.nodeType===Node.TEXT_NODE&&y.textClean(t.nodeValue))return;t=t.previousSibling}}}function u(e){if(e.focusNode&&e.anchorNode){var t=e.focusNode.nextSibling;for(e.anchorNode!==e.focusNode&&e.anchorNode.compareDocumentPosition(e.focusNode)&Node.DOCUMENT_POSITION_FOLLOWING&&(t=e.anchorNode.nextSibling);t;){if(v.isBubbleNode(t))return t;if(t.nodeType===Node.TEXT_NODE&&y.textClean(t.nodeValue))return;t=t.nextSibling}}}function l(e){for(;e;){if(f(e))return e;e=e.parentNode}}function d(e){for(;e;){if(v.isBubbleNode(e))return e;if(f(e))return;e=e.parentNode}}function h(e){for(var t=e&&e.previousSibling;t;){if(v.isBubbleNode(t))return t;t=t.previousSibling}}function p(e){for(var t=e&&e.nextSibling;t;){if(v.isBubbleNode(t))return t;t=t.nextSibling}}function f(e){return e.nodeType===Node.ELEMENT_NODE&&"x-bubbles"===e.getAttribute("is")}function m(e,t){e.fireBeforeRemove(t),t.forEach((function(t){return e.removeChild(t)}))}function g(e,t,n){var o=_(t);if(!(o<=0)){var s=n.slice(0,o);e.fireBeforeRemove(s),s.forEach((function(e){return t.appendChild(e)}))}}function b(e){var t=e.options("limit");return!t||a(e)<t}function _(e){var t=e.options("limit");return t?t-a(e):Number.POSITIVE_INFINITY}var v=n(4),y=n(5);t.closestNodeBubble=d,t.closestNodeSet=l,t.findBubbleLeft=c,t.findBubbleRight=u,t.getBubbles=i,t.bubblesCount=a,t.hasBubbles=r,t.headBubble=s,t.lastBubble=o,t.nextBubble=p,t.prevBubble=h,t.removeBubbles=m,t.moveBubbles=g,t.canAddBubble=b,t.getRemainingCapacity=_}),(function(e,t,n){function o(e){return!(!e||e.nodeType!==Node.ELEMENT_NODE)&&e.hasAttribute("bubble")}function s(e,t){if(t.hasAttribute("readonly"))return!1;var n=h.getSelection();if(!n)return!1;var o=e.options("bubbleDeformation"),s=o(t);if(!s){var i=p.textClean(t.innerText);s={text:i,startOffset:0,endOffset:i.length}}var a=p.createZws(),r=h.document.createTextNode(s.text);e.fireEdit(t),e.replaceChild(r,t),e.insertBefore(a,r);var c=h.document.createRange();return c.setStart(r,s.startOffset),c.setEnd(r,s.endOffset),n.removeAllRanges(),n.addRange(c),!0}function i(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(t=p.textClean(t)){var o=e.options("bubbleFormation"),s=e.options("classBubble"),i=b&&e.options("draggable")&&e.options("selection"),a=e.ownerDocument.createElement("span");a.innerText=t;for(var r in n)n[r]&&a.setAttribute("data-".concat(r),g(n[r]));if(o(a),s)for(var c=String(s).trim().split(/\s+/),u=c.length;u--;)a.classList.add(c[u]);return a.setAttribute("bubble",""),a.setAttribute("contenteditable","false"),i&&a.setAttribute("draggable","true"),a}}function a(e){var t=e.options("begining"),n=e.options("ending"),o=e.options("separator"),s=e.options("tokenizer"),a=r(e),m=[],g=f.getRemainingCapacity(e);return a.forEach((function(a){var r=p.textClean(a.toString());if(!r)return void a.deleteContents();var f=[r];if(s?f=s(r):(o&&(f=r.split(o).map(c).filter(u)),n?f=f.reduce((function(e,t){return e.concat(l(t,n))}),[]).map(c).filter(u):t&&(f=f.reduce((function(e,n){return e.concat(d(n,t))}),[]).map(c).filter(u))),!Array.isArray(f)||!f.length)return void a.deleteContents();var b=h.document.createDocumentFragment();f.forEach((function(t){if(!(m.length>=g)){var n=i(e,t);n&&(b.appendChild(n),m.push(n))}})),a.deleteContents(),a.insertNode(b)})),e.fireInput(),m.length&&e.fireChange(),m}function r(e){for(var t,n,s=[],i=e.childNodes,a=0;a<i.length;a++)n=i[a],o(n)?t&&(t.setEndBefore(n),s.push(t),t=void 0):t||(t=h.document.createRange(),t.setStartBefore(n));return t&&(t.setEndAfter(n),s.push(t)),s}function c(e){return e.trim()}function u(e){return Boolean(e)}function l(e,t){var n=[],o=0,s=999;for(t.lastIndex=0;null!==t.exec(e)&&s;)s--,n.push(e.substring(o,t.lastIndex)),o=t.lastIndex;return n}function d(e,t){var n,o=[],s=0,i=999;for(t.lastIndex=0;null!==(n=t.exec(e))&&i;)i--,s!==n.index&&(o.push(e.substring(s,n.index)),s=n.index);return o.push(e.substring(s,e.length)),o}var h=n(1),p=n(5),f=n(3),m=n(6),g=m.escape,b=m.canUseDrag;t.isBubbleNode=o,t.bubbling=a,t.create=i,t.edit=s}),(function(e,t,n){function o(e){for(var t=w(e),n=t.startNode,o=t.startOffset,s=!0,i=n;i&&i.nodeType===Node.TEXT_NODE;){if(y(o>0?i.nodeValue.substring(0,o):i.nodeValue)){s=!1;break}o=0,i=i.previousSibling}return s}function s(e){for(var t=w(e),n=t.endNode,o=t.endOffset,s=n;s;){if(s.nodeType!==Node.TEXT_NODE)return!1;if(y(o>-1&&o<s.nodeValue.length?s.nodeValue.substring(o):s.nodeValue))return!1;o=-1,s=s.nextSibling}return!0}function i(e,t){var n=E(e),o=n&&a(e,n);return o?(n.removeAllRanges(),n.addRange(o),c(n,t)):e.appendChild(t),!0}function a(e,t){if(t=t||E(e)){var n=t.focusNode&&t.focusNode.nodeType===Node.TEXT_NODE?t.focusNode:t.anchorNode&&t.anchorNode.nodeType===Node.TEXT_NODE?t.anchorNode:void 0;if(n){for(var o=n,s=n,i=n;i&&i.nodeType===Node.TEXT_NODE;)o=i,i=i.previousSibling;for(i=n;i&&i.nodeType===Node.TEXT_NODE;)s=i,i=i.nextSibling;var a=e.ownerDocument.createRange();return a.setStartBefore(o),a.setEndAfter(s),a}}}function r(e){return c(e,_())}function c(e,t){if(!e||!e.rangeCount)return!1;var n=C.document.createElement("span");if(e.getRangeAt(0).surroundContents(n),n.parentNode.replaceChild(t,n),e.removeAllRanges(),t.nodeType===Node.TEXT_NODE){var o=C.document.createRange();o.setStart(t,t.nodeValue.length),o.collapse(!1),e.addRange(o)}else e.collapse(t,0);return!0}function u(e,t){if(!(e=y(e)))return!1;t=t||C.getSelection();var n=C.document.createTextNode(e);return!!c(t,n)&&(t.collapse(n,n.nodeValue.length),!0)}function l(e,t){if(!(e=e||C.getSelection())||!e.anchorNode||e.anchorNode.nodeType!==Node.TEXT_NODE)return!1;var n=w(e),o=n.startNode,s=n.endNode,i=n.startOffset,a=n.endOffset,r=n.revert;if(!e.isCollapsed&&!t)return e.collapse(o,i),!0;var c=Boolean(e.extend);r=c?r:!r;for(var u=r?o:s,l=r?i:a;u;){if(u.nodeType!==Node.TEXT_NODE)return!1;if(null===l&&(l=u.nodeValue.length),l-1<0)u=u.previousSibling,l=null;else{if(!v(u.nodeValue.substring(l-1,l)))break;l-=1}}if(!u||null===l)return!1;if(t)if(c)e.extend(u,l-1);else{var d=C.document.createRange();r?(d.setStart(u,l-1),d.setEnd(s,a)):(d.setStart(o,i),d.setEnd(u,l-1)),e.removeAllRanges(),e.addRange(d)}else e.collapse(u,l-1);return!0}function d(e,t){if(!(e=e||C.getSelection())||!e.focusNode||e.focusNode.nodeType!==Node.TEXT_NODE)return!1;var n=w(e),o=n.startNode,s=n.endNode,i=n.startOffset,a=n.endOffset,r=n.revert;if(!e.isCollapsed&&!t)return e.collapse(s,a),!0;for(var c=r?o:s,u=r?i:a;c;){if(c.nodeType!==Node.TEXT_NODE)return!1;if(u+1>c.nodeValue.length)c=c.nextSibling,u=0;else{if(!v(c.nodeValue.substring(u,u+1)))break;u+=1}}if(!c)return!1;if(t){if(Boolean(e.extend))e.extend(c,u+1);else{var l=C.document.createRange();r?(l.setStart(c,u+1),l.setEnd(s,a)):(l.setStart(o,i),l.setEnd(c,u+1)),e.removeAllRanges(),e.addRange(l)}}else e.collapse(c,u+1);return!0}function h(e){if(!e)return"";var t=C.document.implementation.createHTMLDocument("").body;return t.innerText=e,t.innerText.replace(/^[\u0020\u00a0]+$/gm,"").replace(/\n/gm," ").trim()}function p(e,t){for(var n=e,o=null,s="begin"===t?"previousSibling":"nextSibling";n&&n.nodeType===Node.TEXT_NODE;)o=n,n=n[s];return o}function f(e,t,n,o){var s=S.hasBubbles(o),i=C.document.createRange();i.setStart(t.node,t.offset),i.setEnd(n.node,n.offset);var a=y(i.toString());return!(!a&&(a||s))&&(a||i.collapse(),e.removeAllRanges(),e.addRange(i),!0)}function m(e,t){e=e||C.getSelection();var n=e&&e.anchorNode;if(!n||n.nodeType!==Node.TEXT_NODE)return!1;var o=e.anchorOffset;return f(e,{node:p(n,"begin"),offset:0},{node:n,offset:o},t)}function g(e,t){e=e||C.getSelection();var n=e&&e.anchorNode;if(!n||n.nodeType!==Node.TEXT_NODE)return!1;var o=p(n,"begin"),s=p(n,"end");return f(e,{node:o,offset:0},{node:s,offset:s.nodeValue?s.nodeValue.length:0},t)}function b(e){e=e||C.getSelection();var t=e&&e.anchorNode;if(!t||t.nodeType!==Node.TEXT_NODE)return!1;var n=p(t,"begin"),o=p(t,"end"),s=C.document.createRange();s.setStart(n,0),s.setEnd(o,o.nodeValue?o.nodeValue.length:0);var i=y(s.toString());return Boolean(i)}function _(){return C.document.createTextNode(A)}function v(e){return k.test(e)}function y(e){return String(e||"").trim().replace(M,"")}var C=n(1),S=n(3),D=n(6),E=D.getSelection,w=D.correctSelection,M=/[\0-\x1F\x7F-\x9F\xAD\u0378\u0379\u037F-\u0383\u038B\u038D\u03A2\u0528-\u0530\u0557\u0558\u0560\u0588\u058B-\u058E\u0590\u05C8-\u05CF\u05EB-\u05EF\u05F5-\u0605\u061C\u061D\u06DD\u070E\u070F\u074B\u074C\u07B2-\u07BF\u07FB-\u07FF\u082E\u082F\u083F\u085C\u085D\u085F-\u089F\u08A1\u08AD-\u08E3\u08FF\u0978\u0980\u0984\u098D\u098E\u0991\u0992\u09A9\u09B1\u09B3-\u09B5\u09BA\u09BB\u09C5\u09C6\u09C9\u09CA\u09CF-\u09D6\u09D8-\u09DB\u09DE\u09E4\u09E5\u09FC-\u0A00\u0A04\u0A0B-\u0A0E\u0A11\u0A12\u0A29\u0A31\u0A34\u0A37\u0A3A\u0A3B\u0A3D\u0A43-\u0A46\u0A49\u0A4A\u0A4E-\u0A50\u0A52-\u0A58\u0A5D\u0A5F-\u0A65\u0A76-\u0A80\u0A84\u0A8E\u0A92\u0AA9\u0AB1\u0AB4\u0ABA\u0ABB\u0AC6\u0ACA\u0ACE\u0ACF\u0AD1-\u0ADF\u0AE4\u0AE5\u0AF2-\u0B00\u0B04\u0B0D\u0B0E\u0B11\u0B12\u0B29\u0B31\u0B34\u0B3A\u0B3B\u0B45\u0B46\u0B49\u0B4A\u0B4E-\u0B55\u0B58-\u0B5B\u0B5E\u0B64\u0B65\u0B78-\u0B81\u0B84\u0B8B-\u0B8D\u0B91\u0B96-\u0B98\u0B9B\u0B9D\u0BA0-\u0BA2\u0BA5-\u0BA7\u0BAB-\u0BAD\u0BBA-\u0BBD\u0BC3-\u0BC5\u0BC9\u0BCE\u0BCF\u0BD1-\u0BD6\u0BD8-\u0BE5\u0BFB-\u0C00\u0C04\u0C0D\u0C11\u0C29\u0C34\u0C3A-\u0C3C\u0C45\u0C49\u0C4E-\u0C54\u0C57\u0C5A-\u0C5F\u0C64\u0C65\u0C70-\u0C77\u0C80\u0C81\u0C84\u0C8D\u0C91\u0CA9\u0CB4\u0CBA\u0CBB\u0CC5\u0CC9\u0CCE-\u0CD4\u0CD7-\u0CDD\u0CDF\u0CE4\u0CE5\u0CF0\u0CF3-\u0D01\u0D04\u0D0D\u0D11\u0D3B\u0D3C\u0D45\u0D49\u0D4F-\u0D56\u0D58-\u0D5F\u0D64\u0D65\u0D76-\u0D78\u0D80\u0D81\u0D84\u0D97-\u0D99\u0DB2\u0DBC\u0DBE\u0DBF\u0DC7-\u0DC9\u0DCB-\u0DCE\u0DD5\u0DD7\u0DE0-\u0DF1\u0DF5-\u0E00\u0E3B-\u0E3E\u0E5C-\u0E80\u0E83\u0E85\u0E86\u0E89\u0E8B\u0E8C\u0E8E-\u0E93\u0E98\u0EA0\u0EA4\u0EA6\u0EA8\u0EA9\u0EAC\u0EBA\u0EBE\u0EBF\u0EC5\u0EC7\u0ECE\u0ECF\u0EDA\u0EDB\u0EE0-\u0EFF\u0F48\u0F6D-\u0F70\u0F98\u0FBD\u0FCD\u0FDB-\u0FFF\u10C6\u10C8-\u10CC\u10CE\u10CF\u1249\u124E\u124F\u1257\u1259\u125E\u125F\u1289\u128E\u128F\u12B1\u12B6\u12B7\u12BF\u12C1\u12C6\u12C7\u12D7\u1311\u1316\u1317\u135B\u135C\u137D-\u137F\u139A-\u139F\u13F5-\u13FF\u169D-\u169F\u16F1-\u16FF\u170D\u1715-\u171F\u1737-\u173F\u1754-\u175F\u176D\u1771\u1774-\u177F\u17DE\u17DF\u17EA-\u17EF\u17FA-\u17FF\u180F\u181A-\u181F\u1878-\u187F\u18AB-\u18AF\u18F6-\u18FF\u191D-\u191F\u192C-\u192F\u193C-\u193F\u1941-\u1943\u196E\u196F\u1975-\u197F\u19AC-\u19AF\u19CA-\u19CF\u19DB-\u19DD\u1A1C\u1A1D\u1A5F\u1A7D\u1A7E\u1A8A-\u1A8F\u1A9A-\u1A9F\u1AAE-\u1AFF\u1B4C-\u1B4F\u1B7D-\u1B7F\u1BF4-\u1BFB\u1C38-\u1C3A\u1C4A-\u1C4C\u1C80-\u1CBF\u1CC8-\u1CCF\u1CF7-\u1CFF\u1DE7-\u1DFB\u1F16\u1F17\u1F1E\u1F1F\u1F46\u1F47\u1F4E\u1F4F\u1F58\u1F5A\u1F5C\u1F5E\u1F7E\u1F7F\u1FB5\u1FC5\u1FD4\u1FD5\u1FDC\u1FF0\u1FF1\u1FF5\u1FFF\u200B-\u200F\u202A-\u202E\u2060-\u206F\u2072\u2073\u208F\u209D-\u209F\u20BB-\u20CF\u20F1-\u20FF\u218A-\u218F\u23F4-\u23FF\u2427-\u243F\u244B-\u245F\u2700\u2B4D-\u2B4F\u2B5A-\u2BFF\u2C2F\u2C5F\u2CF4-\u2CF8\u2D26\u2D28-\u2D2C\u2D2E\u2D2F\u2D68-\u2D6E\u2D71-\u2D7E\u2D97-\u2D9F\u2DA7\u2DAF\u2DB7\u2DBF\u2DC7\u2DCF\u2DD7\u2DDF\u2E3C-\u2E7F\u2E9A\u2EF4-\u2EFF\u2FD6-\u2FEF\u2FFC-\u2FFF\u3040\u3097\u3098\u3100-\u3104\u312E-\u3130\u318F\u31BB-\u31BF\u31E4-\u31EF\u321F\u32FF\u4DB6-\u4DBF\u9FCD-\u9FFF\uA48D-\uA48F\uA4C7-\uA4CF\uA62C-\uA63F\uA698-\uA69E\uA6F8-\uA6FF\uA78F\uA794-\uA79F\uA7AB-\uA7F7\uA82C-\uA82F\uA83A-\uA83F\uA878-\uA87F\uA8C5-\uA8CD\uA8DA-\uA8DF\uA8FC-\uA8FF\uA954-\uA95E\uA97D-\uA97F\uA9CE\uA9DA-\uA9DD\uA9E0-\uA9FF\uAA37-\uAA3F\uAA4E\uAA4F\uAA5A\uAA5B\uAA7C-\uAA7F\uAAC3-\uAADA\uAAF7-\uAB00\uAB07\uAB08\uAB0F\uAB10\uAB17-\uAB1F\uAB27\uAB2F-\uABBF\uABEE\uABEF\uABFA-\uABFF\uD7A4-\uD7AF\uD7C7-\uD7CA\uD7FC-\uF8FF\uFA6E\uFA6F\uFADA-\uFAFF\uFB07-\uFB12\uFB18-\uFB1C\uFB37\uFB3D\uFB3F\uFB42\uFB45\uFBC2-\uFBD2\uFD40-\uFD4F\uFD90\uFD91\uFDC8-\uFDEF\uFDFE\uFDFF\uFE1A-\uFE1F\uFE27-\uFE2F\uFE53\uFE67\uFE6C-\uFE6F\uFE75\uFEFD-\uFF00\uFFBF-\uFFC1\uFFC8\uFFC9\uFFD0\uFFD1\uFFD8\uFFD9\uFFDD-\uFFDF\uFFE7\uFFEF-\uFFFB\uFFFE\uFFFF]/g,k=/\u200B/,A="​";t.isEmptyLeft=o,t.isEmptyRight=s,t.arrowRight=d,t.arrowLeft=l,t.remove=r,t.html2text=h,t.currentTextRange=a,t.text2bubble=i,t.replaceString=u,t.findTextBorderNode=p,t.selectFromCursorToStrBegin=m,t.selectAll=g,t.textClean=y,t.checkZws=v,t.createZws=_,t.hasNear=b}),(function(e,t,n){function o(e){return h[e]}function s(e){return d[e]}var i=n(7),a=n(1),r=n(10),c=r.dispatch,u=n(12),l=u.EV,d={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","`":"&#96;"},h={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'","&#96;":"`"},p=/&(?:amp|lt|gt|quot|#39|#96);/g,f=/[&<>"'`]/g,m=RegExp(p.source),g=RegExp(f.source),b=/Trident|Edge/,_=/IEMobile/;t.getSelection=function(e){var t=a.getSelection();if(t&&t.anchorNode&&e.compareDocumentPosition(t.anchorNode)&Node.DOCUMENT_POSITION_CONTAINED_BY)return t},t.correctSelection=function(e){var t=e.focusNode,n=e.focusOffset,o=e.anchorNode,s=e.anchorOffset,i=!1;if(o===t)s=Math.min(e.anchorOffset,e.focusOffset),n=Math.max(e.anchorOffset,e.focusOffset),i=e.anchorOffset>e.focusOffset;else{e.anchorNode.compareDocumentPosition(e.focusNode)&Node.DOCUMENT_POSITION_PRECEDING&&(o=e.focusNode,s=e.focusOffset,t=e.anchorNode,n=e.anchorOffset,i=!0)}return{startNode:o,endNode:t,startOffset:s,endOffset:n,revert:i}},t.throttle=function(e,t){var n=0,o=function(){n=0};return function(){n||(n=i(o),e.apply(t||this,arguments))}},t.escape=function(e){return e=String(e),e&&g.test(e)?e.replace(f,s):e},t.unescape=function(e){return e=String(e),e&&m.test(e)?e.replace(p,o):e},t.canUseDrag=(function(){return!b.test(a.navigator.userAgent)})(),t.isIE=(function(){return b.test(a.navigator.userAgent)})(),t.isMobileIE=(function(){return _.test(a.navigator.userAgent)})(),t.ready=(function(){function e(){i((function(){a.setTimeout((function(){n.length&&c(a,l.READY,{detail:{data:n.splice(0)}}),o=!0}))}))}function t(){o&&!s&&(s=!0,i((function(){c(a,l.READY,{detail:{data:n.splice(0)}}),s=!1})))}var n=[],o=!1,s=!1;return"complete"===a.document.readyState?e():"interactive"!==a.document.readyState||a.attachEvent||a.HTMLImports&&!a.HTMLImports.ready?a.addEventListener(a.HTMLImports&&!a.HTMLImports.ready?"HTMLImportsLoaded":"DOMContentLoaded",e):e(),function(e){n.push(e),t()}})()}),(function(e,t,n){(function(t){for(var o=n(8),s="undefined"==typeof window?t:window,i=["moz","webkit"],a="AnimationFrame",r=s["request"+a],c=s["cancel"+a]||s["cancelRequest"+a],u=0;!r&&u<i.length;u++)r=s[i[u]+"Request"+a],c=s[i[u]+"Cancel"+a]||s[i[u]+"CancelRequest"+a];if(!r||!c){var l=0,d=0,h=[];r=function(e){if(0===h.length){var t=o(),n=Math.max(0,1e3/60-(t-l));l=n+t,setTimeout((function(){var e=h.slice(0);h.length=0;for(var t=0;t<e.length;t++)if(!e[t].cancelled)try{e[t].callback(l)}catch(e){setTimeout((function(){throw e}),0)}}),Math.round(n))}return h.push({handle:++d,callback:e,cancelled:!1}),d},c=function(e){for(var t=0;t<h.length;t++)h[t].handle===e&&(h[t].cancelled=!0)}}e.exports=function(e){return r.call(s,e)},e.exports.cancel=function(){c.apply(s,arguments)},e.exports.polyfill=function(){s.requestAnimationFrame=r,s.cancelAnimationFrame=c}}).call(t,(function(){return this})())}),(function(e,t,n){(function(t){(function(){var n,o,s;"undefined"!=typeof performance&&null!==performance&&performance.now?e.exports=function(){return performance.now()}:void 0!==t&&null!==t&&t.hrtime?(e.exports=function(){return(n()-s)/1e6},o=t.hrtime,n=function(){var e;return e=o(),1e9*e[0]+e[1]},s=n()):Date.now?(e.exports=function(){return Date.now()-s},s=Date.now()):(e.exports=function(){return(new Date).getTime()-s},s=(new Date).getTime())}).call(this)}).call(t,n(9))}),(function(e,t){function n(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function s(e){if(l===setTimeout)return setTimeout(e,0);if((l===n||!l)&&setTimeout)return l=setTimeout,setTimeout(e,0);try{return l(e,0)}catch(t){try{return l.call(null,e,0)}catch(t){return l.call(this,e,0)}}}function i(e){if(d===clearTimeout)return clearTimeout(e);if((d===o||!d)&&clearTimeout)return d=clearTimeout,clearTimeout(e);try{return d(e)}catch(t){try{return d.call(null,e)}catch(t){return d.call(this,e)}}}function a(){m&&p&&(m=!1,p.length?f=p.concat(f):g=-1,f.length&&r())}function r(){if(!m){var e=s(a);m=!0;for(var t=f.length;t;){for(p=f,f=[];++g<t;)p&&p[g].run();g=-1,t=f.length}p=null,m=!1,i(e)}}function c(e,t){this.fun=e,this.array=t}function u(){}var l,d,h=e.exports={};!(function(){try{l="function"==typeof setTimeout?setTimeout:n}catch(e){l=n}try{d="function"==typeof clearTimeout?clearTimeout:o}catch(e){d=o}})();var p,f=[],m=!1,g=-1;h.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];f.push(new c(e,t)),1!==f.length||m||s(r)},c.prototype.run=function(){this.fun.apply(null,this.array)},h.title="browser",h.browser=!0,h.env={},h.argv=[],h.version="",h.versions={},h.on=u,h.addListener=u,h.once=u,h.off=u,h.removeListener=u,h.removeAllListeners=u,h.emit=u,h.prependListener=u,h.prependOnceListener=u,h.listeners=function(e){return[]},h.binding=function(e){throw new Error("process.binding is not supported")},h.cwd=function(){return"/"},h.chdir=function(e){throw new Error("process.chdir is not supported")},h.umask=function(){return 0}}),(function(e,t,n){function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(){var e=d.document.documentElement,t=d.document.body;return(e&&e.scrollLeft||t&&t.scrollLeft||0)-(e.clientLeft||0)}function i(){var e=d.document.documentElement,t=d.document.body;return(e&&e.scrollTop||t&&t.scrollTop||0)-(e.clientTop||0)}function a(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};e.dispatchEvent(new m(t,n))}function r(e,t){for(var n=e[f.LOCAL_EVENTS]&&e[f.LOCAL_EVENTS][t.type]||[],o={},s=0;s<n.length&&!t.immediatePropagationStopped;s++)n[s](t,o)}function c(e,t,n){return function o(s){e.removeEventListener(t,o),n(s)}}function u(e,t){return e[f.LOCAL_EVENTS]||(e[f.LOCAL_EVENTS]={}),e[f.LOCAL_EVENTS][t]||(e[f.LOCAL_EVENTS][t]=[]),e[f.LOCAL_EVENTS][t]}function l(e,t,n){var s=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],i=arguments.length>4&&void 0!==arguments[4]&&arguments[4],a=arguments.length>5&&void 0!==arguments[5]&&arguments[5],r=n?o({},t,n):t,u="".concat(s?"add":"remove").concat(i?"Local":"","EventListener");for(var l in r){var d=a?c(e,l,r[l]):r[l];g[u](e,l,d)}}var d=n(1),h=n(11),p=n(12),f=p.PROPS;t.scrollX=s,t.scrollY=i,t.dispatch=a,t.keyCode=function(e){return e.charCode||e.keyCode},t.metaKey=function(e){return e.ctrlKey||e.metaKey},t.pageX=function(e){return null===e.pageX&&null!==e.clientX?e.clientX+s():e.pageX},t.pageY=function(e){return null===e.pageY&&null!==e.clientY?e.clientY+i():e.pageY},t.one=function(e,t,n){l(e,t,n,!0,!1,!0)},t.on=function(e,t,n){l(e,t,n)},t.off=function(e,t,n){l(e,t,n,!1)},t.oneLocal=function(e,t,n){l(e,t,n,!0,!0,!0)},t.onLocal=function(e,t,n){l(e,t,n,!0,!0)},t.offLocal=function(e,t,n){l(e,t,n,!1,!0)},t.prevent=function(e){return e.cancelBubble=!0,e.returnValue=!1,e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault(),!1},t.proxyLocal=function(e){r(e.currentTarget,e)};var m=(function(){return"function"==typeof d.CustomEvent?d.CustomEvent:h})(),g={addLocalEventListener:function(e,t,n){u(e,t).push(n)},removeLocalEventListener:function(e,t,n){for(var o=e[f.LOCAL_EVENTS]&&e[f.LOCAL_EVENTS][t]||[],s=0;s<o.length;)o[s]===n?o.splice(s,1):s++},addEventListener:function(e,t,n){e.addEventListener(t,n)},removeEventListener:function(e,t,n){e.removeEventListener(t,n)}}}),(function(e,t,n){var o=n(1),s=o.document,i=o.Event.prototype,a=!1;try{a=Boolean(s.createEvent("CustomEvent"))}catch(e){}var r=i.stopImmediatePropagation;i.stopImmediatePropagation=function(){this.immediatePropagationStopped=!0,r?r.call(this):this.stopPropagation()};var c=(function(){return a?function(e,t){t=t||{};var n=Boolean(t.bubbles),o=Boolean(t.cancelable),i=s.createEvent("CustomEvent");return i.initCustomEvent(e,n,o,t.detail),i}:function(e,t){t=t||{};var n=Boolean(t.bubbles),o=Boolean(t.cancelable),i=s.createEvent("Event");return i.initEvent(e,n,o),i.detail=t.detail,i}})();c.prototype=i,e.exports=c}),(function(e,t){t.KEY={a:65,Backspace:8,Bottom:40,c:67,Cmd:91,Comma:44,Delete:46,Enter:13,Esc:27,Home:36,Left:37,Right:39,Semicolon:59,Space:32,Tab:9,Top:38,x:88},t.CLS={DRAGSTART:"drag",DROPZONE:"dropzone"},t.EV={BEFORE_REMOVE:"before-remove",BUBBLE_EDIT:"bubble-edit",BUBBLE_INPUT:"bubble-input",CHANGE:"change",DRAGEND:"dragend",DRAGENTER:"dragenter",DRAGLEAVE:"dragleave",DRAGSTART:"dragstart",DROP:"drop",READY:"x-bubbles-ready"},t.PROPS={BUBBLE_VALUE:"__bubble_value__",CLICK_TIME:"__click_time__",LOCAL_EVENTS:"__events__",LOCK_COPY:"__lock_copy__",OPTIONS:"__options__"}}),(function(e,t,n){function o(e){if(!c.isMobileIE){if(!e.canAddBubble())return void r.setLast(e);r.clear(e);var t=s(e),n=i.getSelection();n.removeAllRanges(),n.collapse(t,1)}}function s(e){var t=a.createZws();if(e.hasChildNodes()){var n=e.childNodes[e.childNodes.length-1];n.isEqualNode(t)?t=n:e.appendChild(t)}else e.appendChild(t);return t}var i=n(1),a=n(5),r=n(14),c=n(6);t.restore=o,t.restoreBasis=s}),(function(e,t,n){function o(e){if(C.isBubbleNode(e)){var t=e.parentNode,n=u(t);if(!n.length)return void p(e);d(t);var o=n[0];o!==n[n.length-1]&&t.startRangeSelect||(t.startRangeSelect=o);var s,i;if(e.compareDocumentPosition(t.startRangeSelect)&Node.DOCUMENT_POSITION_PRECEDING?(s=t.startRangeSelect,i=e):(s=e,i=t.startRangeSelect),s&&i){for(var a=s;a&&b(a)&&a!==i;)a=a.nextSibling;C.bubbling(t)}}}function s(e){D.call(e.querySelectorAll(w)).forEach((function(e){return b(e)})),e.startRangeSelect=e.querySelector(E),C.bubbling(e);var t=v.getSelection();t&&t.removeAllRanges()}function i(e){var t=c(e);if(t){for(var n=S.prevBubble(t);n;n=S.prevBubble(n))b(n);e.startRangeSelect=e.querySelector(E),C.bubbling(e);var o=v.getSelection();o&&o.removeAllRanges()}}function a(e){return Boolean(e.querySelector(E))}function r(e){return u(e)[0]}function c(e){var t=u(e);return t[t.length-1]}function u(e){return D.call(e.querySelectorAll(E))}function l(e){if(!e.options("selection"))return!1;var t=y.getSelection(e);if(t&&t.rangeCount)return!1;var n=u(e);return 1===n.length&&n[0]}function d(e){u(e).forEach((function(e){return e.removeAttribute("selected")}))}function h(e){if(b(e)){var t=S.closestNodeSet(e);return t.startRangeSelect=e,C.bubbling(t),!0}return!1}function p(e){if(!C.isBubbleNode(e))return!1;var t=S.closestNodeSet(e),n=v.getSelection();return n&&n.removeAllRanges(),d(t),h(e)}function f(e){return p(S.lastBubble(e))}function m(e){if(g(e)){if(1===u(S.closestNodeSet(e)).length)return _(e)}return p(e)}function g(e){return C.isBubbleNode(e)&&e.hasAttribute("selected")||!1}function b(e){return!!C.isBubbleNode(e)&&(e.setAttribute("selected",""),!0)}function _(e){return!!C.isBubbleNode(e)&&(e.removeAttribute("selected"),!0)}var v=n(1),y=n(6),C=n(4),S=n(3),D=Array.prototype.slice,E="[bubble][selected]",w="[bubble]:not([selected])";t.all=s,t.allLeft=i,t.add=h,t.clear=d,t.get=u,t.uniq=p,t.head=r,t.last=c,t.has=a,t.range=o,t.toggleUniq=m,t.setLast=f,t.getEditable=l}),(function(e,t,n){var o=n(16),s=n(19),i=n(6),a=i.canUseDrag;t.init=function(e){return a?o.init(e):s.init(e)},t.destroy=function(e){return a?o.destroy(e):s.destroy(e)}}),(function(e,t,n){function o(e){e.stopPropagation();var t=d.closestNodeSet(e.target),n=d.closestNodeBubble(e.target);if(!t||!n)return void e.preventDefault();var o=u.getSelection();o&&o.removeAllRanges(),y=t,t.classList.add(f.DRAGSTART),l.add(n),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",""),l.get(y).length>1&&e.dataTransfer.setDragImage(g(),_.w,_.h)}function s(e){if(e.stopPropagation(),e.preventDefault(),y){var t=d.closestNodeSet(e.target);if(t&&t!==y){var n=t.options("checkBubbleDrop"),o=l.get(y);o.length&&n(o)&&(d.moveBubbles(y,t,o),u.setTimeout(b,0,y,t))}}}function i(e){e.stopPropagation(),e.preventDefault(),y&&(e.dataTransfer.dropEffect="move")}function a(e){if(e.stopPropagation(),e.preventDefault(),y){var t=d.closestNodeSet(e.target);t&&t!==y&&t.classList.add(f.DROPZONE)}}function r(e){if(e.stopPropagation(),e.preventDefault(),y){var t=d.closestNodeSet(e.target);t&&t!==y&&t.classList.remove(f.DROPZONE)}}function c(e){if(e.stopPropagation(),e.preventDefault(),y){y.classList.remove(f.DRAGSTART);var t=d.closestNodeSet(e.target);t&&t!==y&&t.classList.remove(f.DROPZONE),y=null}}var u=n(1),l=n(14),d=n(3),h=n(10),p=n(12),f=p.CLS,m=n(17),g=m.getDragImage,b=m.onDropSuccess,_=m.DRAG_IMG,v={dragend:c,dragenter:a,dragleave:r,dragover:i,dragstart:o,drop:s},y=null;t.init=function(e){h.on(e,v)},t.destroy=function(e){h.off(e,v)}}),(function(e,t,n){var o={w:16,h:16},s=null;t.DRAG_IMG=o,t.getDragImage=function(){return s||(s=new Image,s.src=n(18)),s},t.onDropSuccess=function(e,t){e.fireChange(),t.focus(),t.fireChange()}}),(function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAE8AAAAVCAMAAAAw/0MlAAABblBMVEUAAABOXIZJWIKCkbeNnMKMmsJNW4VNW4VWZY57ibFHV4KVpMxRYImCkLh9jbpgcJ1fcJ1JWoaZqdNUZpaHmMaVpdJIWolTZJKHmMZEV4iXqNdkdqhjdal2iLx2ib2Knc6PodNJXpJJXpNOYpdpfLKCk8JPYpdofLNugblugrqUptdZdLdZd8Nfeb93js1+ksuGm9SGm9VHaLhJarxKZqxKbL9La7pNbr9Pb71Ucr1Wbag/XqU/X6pAVopffMdjf8ZphMpwicx2js9BW51CWZN/ldCBl9KCmNNFYKRFZbGJndWOodVKX5RKX5ZKYJdWdcNXbKJYdL1KYJtAVYpaeMVJXpJKbMBgebpjeLBjf8VLYp5kd65kgMlofLRog8log8tJYqBth8xugrpviMtNabBxi851jc8/X6t3i8BOaK56kdB9lNFOaa5Ob8FPY5qBl9NGXJODmNOEmdNQbrpRcsJUb7RGXJSTptmUptiUp9kfFguNAAAAK3RSTlMAJCQkJDw8P0JCRUVubpaWlpmZwMDAw8nJzMzV29vb7e3t7fDw+Pn5+fn8jndhZAAAAQhJREFUeF6tz2VXwgAYBtBnhBKKkgoGKPY2urvT7u7ujn/vtsM5fN/e+w8uJEaLa+HvR7Zfl8WILo293Qq8vykQaLXtGnRoPcH6i1L1oEcLidpde6BQc6shslXvaVSHIdD7S9c0Sv5+ACbfFRXftBoYuzijUry1AXPHJ1QK5349pvYOqeSPfCaM8Dkq/EFxHAMst0mDY3cL89Clkis0kqmd/CxgvUt8Ukg8rub4UYCZicTiT0rFY5HnNY4dBNC32GiGwtFt+aLhULOx9CWMdRAMbVXK6cyNfJl0ubL8IYytEDHe0/XX7IZ82e/9S3HsZSDpmSQZT/SiQ+UgGDtU6DKYnYrGTrMBon97+TS1J80efgAAAABJRU5ErkJggg=="}),(function(e,t,n){function o(e){var t=d.closestNodeBubble(e.target);if(t){var n=d.closestNodeSet(e.target);if(n){e.preventDefault(),n.focus();var o=n.__drag__={nodeBubble:t,nodeOffsetX:e.offsetX,nodeOffsetY:e.offsetY,onMousemove:u.throttle(i.bind(this,n)),onMouseup:s.bind(this,n),onScroll:u.throttle(a.bind(this,n)),x:0,y:0};y=null,C=null,S=null,c.one(document,"mouseup",o.onMouseup),c.on(document,"mousemove",o.onMousemove),c.on(document,"scroll",o.onScroll)}}}function s(e,t){var n=e.__drag__;if(n){if(c.off(document,"mousemove",n.onMousemove),c.off(document,"scroll",n.onScroll),delete e.__drag__,S&&(S.parentNode&&S.parentNode.removeChild(S),S=null),C){var o=C;C=null,o.classList.remove(f.DROPZONE),c.dispatch(o,m.DRAGLEAVE,{bubbles:!1,cancelable:!1})}if(y){var s=d.closestNodeSet(t.target);if(s&&s!==y){var i=l.get(y),a=s.options("checkBubbleDrop");i.length&&a(i)&&(d.moveBubbles(y,s,i),r.setTimeout(_,0,y,s))}var u=y;y=null,u.classList.remove(f.DRAGSTART),c.dispatch(u,m.DROP,{bubbles:!1,cancelable:!1}),c.dispatch(u,m.DRAGEND,{bubbles:!1,cancelable:!1,detail:{target:l.head(u)}})}}}function i(e){var t=e.__drag__;if(t){if(!y){var n=r.getSelection();n&&n.removeAllRanges(),y=e,y.classList.add(f.DRAGSTART),l.add(t.nodeBubble);var o;1===l.get(y).length&&(o=t.nodeBubble.cloneNode(!0)),o||(o=b(),t.nodeOffsetX=v.w,t.nodeOffsetY=v.h),S=document.body.appendChild(document.createElement("div")),S.style.cssText="position:absolute;z-index:9999;pointer-events:none;top:0;left:0;",S.appendChild(o),c.dispatch(y,m.DRAGSTART,{bubbles:!1,cancelable:!1,detail:{target:l.head(y)}})}t.x=event.clientX,t.y=event.clientY,a(e);var s=d.closestNodeSet(event.target);if(s&&s!==y)C&&C!==s?(C.classList.remove(f.DROPZONE),s.classList.add(f.DROPZONE),C=s,c.dispatch(C,m.DRAGENTER,{bubbles:!1,cancelable:!1})):C||(s.classList.add(f.DROPZONE),C=s,c.dispatch(C,m.DRAGENTER,{bubbles:!1,cancelable:!1}));else if(C){var i=C;C=null,i.classList.remove(f.DROPZONE),c.dispatch(i,m.DRAGLEAVE,{bubbles:!1,cancelable:!1})}}}function a(e){var t=e.__drag__;if(t&&S){var n=t.x-t.nodeOffsetX+c.scrollX(),o=t.y-t.nodeOffsetY+c.scrollY();h.csstransforms3d?S.style.transform="translate3d(".concat(n,"px, ").concat(o,"px, 0px)"):h.csstransforms?S.style.transform="translate(".concat(n,"px, ").concat(o,"px)"):(S.style.top="".concat(o,"px"),S.style.left="".concat(n,"px"))}}var r=n(1),c=n(10),u=n(6),l=n(14),d=n(3),h=n(20),p=n(12),f=p.CLS,m=p.EV,g=n(17),b=g.getDragImage,_=g.onDropSuccess,v=g.DRAG_IMG,y=null,C=null,S=null;t.init=function(e){c.on(e,"mousedown",o)},t.destroy=function(e){c.off(e,"mousedown",o)}}),(function(e,t){e.exports=window.Modernizr}),(function(e,t,n){var o=n(10),s=n(12),i=s.PROPS;e.exports=function(e){if(e.currentTarget[i.LOCK_COPY])return o.prevent(e)}}),(function(e,t,n){var o=n(10),s=n(3),i=n(12),a=i.PROPS;e.exports=function(e,t){var n=s.closestNodeSet(e.target);if(!n)return o.prevent(e);if(t.nodeEditor=n,t.nodeBubble=s.closestNodeBubble(e.target),t.isDblclick=!1,t.canAddBubble=n.canAddBubble(),t.nodeBubble){var i=Date.now();t.isDblclick=n[a.CLICK_TIME]&&i-n[a.CLICK_TIME]<200,n[a.CLICK_TIME]=i}}}),(function(e,t,n){var o=n(7),s=n(1),i=n(10),a=n(12),r=a.PROPS;e.exports=function(e){var t=e.currentTarget;if(t[r.LOCK_COPY])return i.prevent(e),delete t[r.LOCK_COPY],o((function(){var e=s.getSelection();e&&e.removeAllRanges()})),!1}}),(function(e,t,n){var o=n(6),s=n(10),i=n(12),a=i.KEY;e.exports=function(e,t){var n=s.keyCode(e);switch(t.nodeEditor=e.currentTarget,n){case a.Left:case a.Right:case a.Delete:case a.Backspace:e.preventDefault(),t.selection=o.getSelection(e.currentTarget)}}}),(function(e,t,n){var o=n(4);e.exports=function(e){o.bubbling(e.currentTarget)}}),(function(e,t,n){var o=n(10),s=n(4),i=n(13),a=n(6);e.exports=function(e,t){var n=t.nodeEditor,r=t.nodeBubble,c=t.isDblclick;if(r)c?e.shiftKey||o.metaKey(e)||s.edit(n,r):n.options("selection")||(s.bubbling(n),i.restore(n));else{var u=a.getSelection(n);u&&u.anchorNode.nodeType===Node.TEXT_NODE||i.restore(n)}}}),(function(e,t,n){var o=n(3);e.exports=function(e){var t=o.closestNodeSet(e.target);if(t){o.closestNodeBubble(e.target)||t.canAddBubble()||(t.focus(),e.preventDefault())}}}),(function(e,t,n){var o=n(7),s=n(13),i=n(1);e.exports=function(e){var t=e.currentTarget;t.canAddBubble()||o((function(){var e=i.getSelection();e&&e.removeAllRanges()})),s.restore(t)}}),(function(e,t,n){function o(e,t){var n=t.selection;if(n){var o=t.nodeEditor;if(!n.isCollapsed||l.arrowLeft(n,!0))l.remove(n),o.fireInput(),l.hasNear(n)||o.fireChange();else if(o.options("selection"))t.isEmptyLeft=!0;else{var s=d.findBubbleLeft(n);s&&(d.removeBubbles(o,[s]),o.fireChange())}}}function s(e,t){var n=t.selection;if(n){var o=t.nodeEditor;if(!n.isCollapsed||l.arrowRight(n,!0))l.remove(n),o.fireInput(),l.hasNear(n)||o.fireChange();else if(o.options("selection"))t.isEmptyRight=!0;else{var s=d.findBubbleRight(n);s&&(d.removeBubbles(o,[s]),o.fireChange())}}}function i(e,t){t.isEmptyLeft=!l.arrowLeft(t.selection,e.shiftKey)}function a(e,t){t.isEmptyRight=!l.arrowRight(t.selection,e.shiftKey)}var r=n(10),c=n(4),u=n(13),l=n(5),d=n(3),h=n(12),p=h.KEY;e.exports=function(e,t){var n=r.keyCode(e),d=r.metaKey(e);switch(n){case p.Esc:e.preventDefault(),c.bubbling(t.nodeEditor),u.restore(t.nodeEditor);break;case p.Backspace:o(e,t);break;case p.Delete:s(e,t);break;case p.Left:i(e,t);break;case p.Right:a(e,t);break;case p.Home:e.shiftKey&&(e.preventDefault(),t.isTextSelectedFromBeginToCursor=l.selectFromCursorToStrBegin(null,t.nodeEditor));break;case p.a:d&&(e.preventDefault(),t.isTextSelectAll=l.selectAll(null,t.nodeEditor))}}}),(function(e,t,n){var o=n(10),s=n(4),i=n(13),a=n(14),r=n(12),c=r.KEY;e.exports=function(e,t){var n=o.keyCode(e),r=e.currentTarget;if(t.enterBubbling=!1,n===c.Enter)e.preventDefault(),r.options("disableControls")||a.getEditable(r)||(s.bubbling(r),i.restore(r),t.enterBubbling=!0);else if(r.canAddBubble()){var u=r.options("separator");if(u&&u.test(String.fromCharCode(n))){var l=r.options("separatorCond");l&&!l(r.inputValue)||(e.preventDefault(),s.bubbling(r),i.restore(r))}}else e.preventDefault()}}),(function(e,t,n){var o=n(10),s=n(12),i=s.KEY;e.exports=function(e){var t=e.currentTarget,n=o.keyCode(e);(e.key?1===e.key.length:(n>47||n===i.Space||n===i.Backspace)&&n!==i.Cmd)&&t.canAddBubble()&&t.fireInput()}}),(function(e,t,n){function o(e,t){var n=e.options("checkBubblePaste"),o=e.options("lineBreakReplacer"),r=a.getSelection();t&&o&&(t=t.replace(/\n/g,o));var c=!(!t||!r.isCollapsed||e.inputValue)&&n(t);return!!u.replaceString(t,r)&&(c?d?i((function(){return s(e)})):s(e):e.fireInput(),!0)}function s(e){r.bubbling(e),e.focus(),i((function(){return c.restore(e)}))}var i=n(7),a=n(1),r=n(4),c=n(13),u=n(5),l=n(6),d=l.isIE;e.exports=function(e){e.preventDefault();var t=e.currentTarget;if(t.canAddBubble())if(a.clipboardData&&a.clipboardData.getData)o(t,a.clipboardData.getData("Text"));else if(e.clipboardData){var n=e.clipboardData,s=n.getData&&n.getData("text/plain");!o(t,s)&&n.items&&Array.prototype.slice.call(n.items).filter((function(e){return"string"===e.kind&&"text/plain"===e.type})).some((function(e){return e.getAsString((function(e){o(t,e)})),!0}))}}}),(function(e,t,n){var o=n(14);e.exports=function(e){o.clear(e.currentTarget)}}),(function(e,t,n){var o=n(10),s=n(14);e.exports=function(e,t){var n=t.nodeEditor,i=t.nodeBubble,a=t.isDblclick,r=t.canAddBubble;i?o.metaKey(e)?s.add(i):e.shiftKey?n.startRangeSelect?s.range(i):s.uniq(i):a||(r?s.toggleUniq(i):s.uniq(i)):r&&s.clear(n)}}),(function(e,t,n){function o(e,t){var n=t.nodeEditor;if(!n.options("disableControls")){var o=g.headBubble(n);o&&m.uniq(o)}}function s(e,t){var n=t.nodeEditor;n.options("disableControls")||m.has(n)&&b.restore(n)}function i(e,t){var n=t.nodeEditor,o=t.selection;if(o){if(t.isEmptyLeft){var s=g.findBubbleLeft(o);s&&m.uniq(s)}}else u(n)||(n.focus(),d((function(){return b.restore(n)})))}function a(e,t){var n=t.nodeEditor,o=t.selection;if(o){if(t.isEmptyRight){var s=g.findBubbleRight(o);s&&m.uniq(s)}}else u(n,!0)||(n.focus(),d((function(){return b.restore(n)})))}function r(e,t){var n=t.selection;if(n){if(t.isEmptyLeft){var o=g.findBubbleLeft(n);o&&m.uniq(o)}}else{var s=t.nodeEditor,i=m.get(s),a=i.length>1&&i[0]===s.startRangeSelect?i[i.length-1]:i[0],r=g.prevBubble(a);r&&(e.shiftKey?m.range(r):m.uniq(r))}}function c(e,t){var n=t.selection;if(n){if(t.isEmptyRight){var o=g.findBubbleRight(n);o&&m.uniq(o)}}else{var s=t.nodeEditor,i=m.get(s),a=i.length>1&&i[i.length-1]===s.startRangeSelect?i[0]:i[i.length-1],r=g.nextBubble(a);r?e.shiftKey?m.range(r):m.uniq(r):b.restore(s)}}function u(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=m.get(e);if(!n.length)return!1;var o=n[0].previousSibling,s=n[n.length-1].nextSibling;if(t){var i=o;o=s,s=i}return g.removeBubbles(e,n),f.isBubbleNode(o)?m.uniq(o):f.isBubbleNode(s)?m.uniq(s):(e.focus(),d((function(){return b.restore(e)}))),e.fireChange(),!0}function l(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};if(p.getSelection(e))return!1;var n=m.get(e);if(!n.length)return!1;var o=e.options("bubbleCopy"),s=o(n);if(!s)return!1;e[y.LOCK_COPY]=!0;var i=e.ownerDocument.createElement("input");return i.value=s,i.style.cssText="\n        position: absolute;\n        left: -9999px;\n        width: 1px;\n        height: 1px;\n        margin: 0;\n        padding: 0;\n        border: none;",e.parentNode.appendChild(i),h.one(i,{keyup:function(){return e.focus()},blur:function(){i&&i.parentNode&&i.parentNode.removeChild(i),d(t)}}),i.select(),!0}var d=n(7),h=n(10),p=n(6),f=n(4),m=n(14),g=n(3),b=n(13),_=n(12),v=_.KEY,y=_.PROPS;e.exports=function(e,t){var n=h.keyCode(e),u=h.metaKey(e);switch(n){case v.Backspace:i(e,t);break;case v.Delete:a(e,t);break;case v.Left:r(e,t);break;case v.Right:c(e,t);break;case v.Top:e.preventDefault(),o(e,t);break;case v.Bottom:e.preventDefault(),s(e,t);break;case v.Home:e.shiftKey&&!t.isTextSelectedFromBeginToCursor&&m.has(t.nodeEditor)&&(e.preventDefault(),m.allLeft(t.nodeEditor));break;case v.a:u&&!t.isTextSelectAll&&(e.preventDefault(),m.all(t.nodeEditor));break;case v.c:u&&l(t.nodeEditor);break;case v.x:u&&l(t.nodeEditor,(function(){return a(e,t)}))}}}),(function(e,t,n){function o(e){var t=a.getEditable(e);return!!t&&i.edit(e,t)}var s=n(10),i=n(4),a=n(14),r=n(12),c=r.KEY;e.exports=function(e,t){var n=s.keyCode(e),i=e.currentTarget;n===c.Enter?(e.preventDefault(),i.options("disableControls")||t.enterBubbling||o(i)):n===c.Space&&o(i)&&e.preventDefault()}}),(function(e,t,n){function o(e,t){return a(e)||i(e,t)||s()}function s(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function i(e,t){var n=[],o=!0,s=!1,i=void 0;try{for(var a,r=e[Symbol.iterator]();!(o=(a=r.next()).done)&&(n.push(a.value),!t||n.length!==t);o=!0);}catch(e){s=!0,i=e}finally{try{o||null==r.return||r.return()}finally{if(s)throw i}}return n}function a(e){if(Array.isArray(e))return e}function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function c(e){var t=arguments.length<=1?void 0:arguments[1];if(t){if(e[p.OPTIONS]||u(e),"object"===r(t)&&null!==t){var n=t;return Object.keys(n).forEach((function(t){e[p.OPTIONS][t]=n[t]})),void l(e[p.OPTIONS])}var o=t,s=arguments.length<=2?void 0:arguments[2];if(void 0===s)return e[p.OPTIONS][o];e[p.OPTIONS][o]=s,l(e[p.OPTIONS])}else u(e)}function u(e){var t=e[p.OPTIONS]=e[p.OPTIONS]||{};for(var n in m){var o="data-".concat(m[n][2]);e.hasAttribute(o)&&(t[n]=e.getAttribute(o))}l(t)}function l(e){for(var t in m){var n=o(m[t],2),s=n[0],i=n[1];e[t]=g[s](e[t]),void 0===e[t]&&(e[t]=i)}}var d=n(1),h=n(12),p=h.PROPS,f=/\/(.+)\/([gimy]{0,3})/i,m={begining:["reg",null,"begining"],bubbleCopy:["func",function(e){return e.map((function(e){return e.innerHTML})).join(", ")},"bubble-copy"],bubbleDeformation:["func",function(){},"bubble-deformation"],bubbleFormation:["func",function(){},"bubble-formation"],checkBubblePaste:["func",function(){return!0},"check-bubble-paste"],checkBubbleDrop:["func",function(){return!0},"check-bubble-drop"],classBubble:["str","bubble","class-bubble"],disableControls:["bool",!1,"disable-controls"],draggable:["bool",!0,"draggable"],ending:["reg",null,"ending"],limit:["uint",0,"limit"],selection:["bool",!0,"selection"],separator:["reg",/[,;]/,"separator"],separatorCond:["func",null,"separator-cond"],tokenizer:["func",null,"tokenizer"]},g={func:function(e){switch(r(e)){case"string":return new Function("context","return context.".concat(e,";"))(d);case"function":return e}},bool:function(e){switch(r(e)){case"string":return"true"===e||"on"===e;case"boolean":return e}},noop:function(e){return e},reg:function(e){switch(r(e)){case"string":if(e){var t=e.match(f);if(t)return new RegExp(t[1],t[2])}return null;case"object":if(e instanceof d.RegExp||null===e)return e}},str:function(e){if(void 0!==e)return e?String(e):""},uint:function(e){if(e=Number(e),!isNaN(e)&&e>0)return e}};c.attributes=Object.keys(m).map((function(e){return"data-".concat(m[e][2])})),e.exports=c})])},432:function(e,t,n){"use strict";n.d(t,"h",(function(){return o})),n.d(t,"a",(function(){return s})),n.d(t,"f",(function(){return i})),n.d(t,"g",(function(){return a})),n.d(t,"c",(function(){return r})),n.d(t,"b",(function(){return c})),n.d(t,"d",(function(){return u})),n.d(t,"e",(function(){return l}));var o="blockquote",s="data-cke-role",i="placeholder",a="js-compose-Quote-Container",r="js-expand-quote",c="js-expand-all-quotes",u=10,l=1e4},496:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VALIDATION_ERROR=t.SEND_RETRYABLE_FAILED=t.SEND_FAILED=t.REMOVE_DRAFT=t.LIMITED_RECIPIENTS=t.EMPTY_SUBJECT=t.DISK_RESOURCES=t.CONTACTS_SUGGEST=t.CONFIRM_REMOVE=t.CHECKBOX_CAPTCHA=t.CAPTCHA=t.ATTACHMENTS_ERROR=void 0,t.ATTACHMENTS_ERROR="AttachmentsError",t.CAPTCHA="Captcha",t.CHECKBOX_CAPTCHA="CheckboxCaptcha",t.CONFIRM_REMOVE="ConfirmRemove",t.CONTACTS_SUGGEST="ContactsSuggest",t.DISK_RESOURCES="DiskResources",t.EMPTY_SUBJECT="EmptySubject",t.LIMITED_RECIPIENTS="LimitedRecipients",t.REMOVE_DRAFT="RemoveDraft",t.SEND_FAILED="SendFailed",t.SEND_RETRYABLE_FAILED="SendRetryableFailed",t.VALIDATION_ERROR="ValidationError"},499:function(e,t,n){"use strict";function o(e){return(e.innerText||"").replace(/[\n\r]/g,"")}t.a=o},500:function(e,t,n){"use strict";n.d(t,"c",(function(){return o})),n.d(t,"d",(function(){return s})),n.d(t,"b",(function(){return i})),n.d(t,"e",(function(){return a})),n.d(t,"a",(function(){return r}));var o=40,s="dir",i=60,a=200,r=200},518:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NEXT_WEEK=t.WEEKEND=t.TOMORROW=t.TODAY=void 0,t.TODAY="today",t.TOMORROW="tomorrow",t.WEEKEND="weekend",t.NEXT_WEEK="next week"},529:function(e,t,n){"use strict";t.a=function(e){if("number"!=typeof e.size&&e.file){var t=e.file;e.size="number"==typeof t.size?t.size:t.fileSize}return Number(e.size)}},531:function(e,t,n){"use strict";n.d(t,"a",(function(){return o})),n.d(t,"b",(function(){return s}));var o="/disk/",s="/mail/"},557:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SENT=t.DELETE=t.CLOSE=t.COLLAPSE=void 0,t.COLLAPSE="collapse",t.CLOSE="close",t.DELETE="delete",t.SENT="sent"},558:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MAX_SUGGEST_ITEMS_FOR_POPUP=void 0,t.MAX_SUGGEST_ITEMS_FOR_POPUP=3},559:function(e,t,n){"use strict";var o=n(762);n.d(t,"a",(function(){return o}))},597:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NONE=t.SMALL=t.NORMAL=void 0,t.NORMAL="normal",t.SMALL="small",t.NONE="none"},598:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.INSERT_MULTIPLE=t.INSERT_TEXT=t.INSERT_LINE_BREAK=t.INSERT_FROM_PASTE=t.DELETE_CONTENT_BACKWARD=t.DELETE_BY_CUT=void 0,t.DELETE_BY_CUT="deleteByCut",t.DELETE_CONTENT_BACKWARD="deleteContentBackward",t.INSERT_FROM_PASTE="insertFromPaste",t.INSERT_LINE_BREAK="insertLineBreak",t.INSERT_TEXT="insertText",t.INSERT_MULTIPLE="insertMultiple"},599:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NONE=t.NS_COMPOSE=t.AUTOCOMPLETE=void 0,t.AUTOCOMPLETE="Autocomplete",t.NS_COMPOSE="NsCompose",t.NONE="None"},600:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DRAFT_NOT_SAVED=t.DRAFT_REMOVED=t.DRAFT_SAVED=t.NO_CHANGES=void 0,t.NO_CHANGES="no changes",t.DRAFT_SAVED="draft saved",t.DRAFT_REMOVED="draft removed",t.DRAFT_NOT_SAVED="draft not saved"},601:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n.d(t,"MUTE_AUTOSAVE_PROMO_UNTIL",(function(){return o})),n.d(t,"BEAUTIFUL_EMAIL_PROMO_CLOSED",(function(){return s})),n.d(t,"SUGGEST_BEAUTIFUL_EMAIL_PROMO_CLOSED",(function(){return i})),n.d(t,"DISABLE_AUTOCOMPLETE_REACT",(function(){return a})),n.d(t,"EMPTY_SUBJECT_POPUP_DISABLED",(function(){return r})),n.d(t,"ENABLE_AUTOSAVE",(function(){return c})),n.d(t,"ENABLE_HOTKEYS",(function(){return u})),n.d(t,"FROM_NAME",(function(){return l})),n.d(t,"LAST_USED_COMPOSE_SIZE",(function(){return d})),n.d(t,"NUMBER_OF_AUTOSAVE_PROMO_SHOW",(function(){return h})),n.d(t,"NS_COMPOSE_PROMO_CLOSED",(function(){return p})),n.d(t,"RECIPIENTS_DIFF_PROMO_CLOSED",(function(){return f})),n.d(t,"SIGNATURE_TOP",(function(){return m})),n.d(t,"SIZE_LAYOUT",(function(){return g})),n.d(t,"SIZE_LAYOUT_LEFT",(function(){return b})),n.d(t,"STORED_COMPOSE_STATES",(function(){return _})),n.d(t,"TIMELINE_EXPANDED",(function(){return v})),n.d(t,"TODO_ENABLED",(function(){return y})),n.d(t,"TWO_SIZES_HEADER_PROMO",(function(){return C})),n.d(t,"CAN_WRITE_LETTERS",(function(){return S}));var o="mute_autosave_promo_until",s="beautiful_email_compose_promo",i="beautiful_email_compose_promo",a="disable_autocomplete_react",r="empty_subject_popup_disabled",c="enable_autosave",u="enable_hotkeys",l="from_name",d="last_used_compose_size",h="number_of_autosave_promo_show",p="ns_compose_promo_closed",f="kukutz-promo-closed",m="signature_top",g="size-view-app",b="size-layout-left",_="storedComposeStates",v="timeline-is-open",y="show_todo",C="two_sizes_header_promo",S="can_write_letters"},602:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.POPUP=t.INPUT=void 0,t.INPUT="line",t.POPUP="popup"},603:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QUERY=t.POPULAR=void 0,t.POPULAR="popular",t.QUERY="query"},604:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BACKGROUND=t.FOREGROUND=void 0,t.FOREGROUND="foreground",t.BACKGROUND="background"},605:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BanReason=void 0;!(function(e){e.RfcFail="RfcFail",e.UrlRbl="UrlRbl",e.BadKarma="BadKarma",e.MailLimits="MailLimits",e.PddAdminKarma="PddAdminKarma",e.Bounces="Bounces",e.SpamCompl="SpamCompl"})(t.BanReason||(t.BanReason={}))},606:function(e,t,n){"use strict";n.d(t,"b",(function(){return s})),n.d(t,"a",(function(){return i})),n.d(t,"c",(function(){return r}));var o=n(559),s=function(){return!Daria.isReactiveCompose()},i=function(){var e=a();return ns.Model.get("settings").isSet(e)?o.a.NONE:Daria.isReactiveCompose()?o.a.REACT:o.a.NOSCRIPT},a=function(){return Daria.isReactiveCompose()?"disable_autocomplete_react":"disable_compose_autocomplete"},r=function(){var e=i();return Daria.isReactiveCompose()?e===o.a.REACT:Daria.isReactiveCompose()?null:e===o.a.NOSCRIPT}},609:function(e,t,n){"use strict";function o(e,t){e&&e.parentNode&&t&&e.parentNode.replaceChild(t,e)}t.a=o},620:function(e,t,n){"use strict";function o(){return i.default.useContext(a.MobXProviderContext)}var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.useStores=void 0;var i=s(n(137)),a=n(353);t.useStores=o},666:function(e,t,n){"use strict";function o(e,t){if(s(e))return{isMatch:!1,targetMatch:null};var n=Daria.Html2Text.html2text(e.innerHTML),o=!0,i=!1,a=void 0;try{for(var r,c=t[Symbol.iterator]();!(o=(r=c.next()).done);o=!0){var u=r.value;if(u.match&&new RegExp("^"+u.match).test(n))return{isMatch:!0,targetMatch:u}}}catch(e){i=!0,a=e}finally{try{o||null==c.return||c.return()}finally{if(i)throw a}}return g.test(n)?{isMatch:!0,targetMatch:null}:{isMatch:!1,targetMatch:null}}function s(e){return(e.tagName||"").toUpperCase()===p.h.toUpperCase()}function i(e){var t=Object(h.a)(e);return m.test(t)}function a(e){return!(Object(h.a)(e).trim()||(e.tagName||"").toUpperCase()===f||e.getElementsByTagName&&0!==e.getElementsByTagName(f).length)}function r(e,t){for(var n=!1,s=0;s<e.childNodes.length;s++){var a=e.childNodes[s],r=i(a);if(r&&(n=!n),!n&&!r){var c=o(a,t),u=c.isMatch,l=c.targetMatch;if(u)return{idx:s,targetMatch:l}}}return{idx:-1,targetMatch:null}}function c(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=r(e,t),o=n.idx,c=n.targetMatch;if(o<0)return null;for(var l={current:o,prev:o},d=!1,h=!1,p=o+1;p<e.childNodes.length;p++){var f=e.childNodes[p];if(s(f)){d=!0;break}if(i(f))break;h=a(f),h||(l.prev=l.current,l.current=p)}return h&&l.prev++,c&&c.leadingLineBreaks>0&&u(e.childNodes[o],c.leadingLineBreaks)&&(o-=c.leadingLineBreaks),{node:e,start:o,finish:d?l.prev:l.current,targetMatch:c}}function u(e,t){for(;t--;)if(!(e=e.previousElementSibling)||!a(e))return!1;return!0}function l(e){for(;e.childNodes.length;){var t=e.childNodes[e.childNodes.length-1];if(!a(t))break;e.removeChild(t)}}function d(e){for(var t=-1,n=-1,o=0;o<e.childNodes.length;o++){if(i(e.childNodes[o])){if(-1===t){t=o;continue}n=o;break}}return-1===t||-1===n?null:{node:e,start:t,finish:n}}t.b=c,t.c=l,t.a=d;var h=n(499),p=n(432),f="IMG",m=/^--------[^\-]+.*--------$/,g=/^--\s?$|^--\s/},667:function(e,t,n){"use strict";function o(e){if(!e)return 0;var t=Array.prototype.slice.call(e.getElementsByTagName(s.h)),n=t.map((function(e){return e.parentNode})),o=Object(i.uniq)(n).length;return e.tagName.toLowerCase()===s.h.toLowerCase()?o+1:o}t.a=o;var s=n(432),i=n(138);n.n(i)},679:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n.d(t,"UNKNOWN",(function(){return o})),n.d(t,"FILE_LIMIT",(function(){return s})),n.d(t,"TOTAL_LIMIT",(function(){return i})),n.d(t,"YADISK_ERROR",(function(){return a})),n.d(t,"VIRUS",(function(){return r})),n.d(t,"DISK_FULL",(function(){return c})),n.d(t,"STATUS_DISK_FULL",(function(){return u})),n.d(t,"DISK_TRAFFIC_LIMIT",(function(){return l})),n.d(t,"DISK_TECHNICAL_WORK",(function(){return d}));var o=0,s=1,i=2,a=6,r=106,c=85,u=507,l=311,d=312},680:function(e,t,n){"use strict";var o=n(138),s=(n.n(o),function(){return Object(o.uniqueId)("attach-")});t.a=function(e){return e.id||e.hid&&e.hid.replace(/\./g,"-")||s()}},681:function(e,t,n){"use strict";n.d(t,"d",(function(){return o})),n.d(t,"a",(function(){return s})),n.d(t,"i",(function(){return i})),n.d(t,"h",(function(){return a})),n.d(t,"f",(function(){return r})),n.d(t,"g",(function(){return c})),n.d(t,"e",(function(){return u})),n.d(t,"b",(function(){return l})),n.d(t,"c",(function(){return d}));var o="compose-have-opened",s="captcha-have-shown",i="SSItemsShow",a="SSItemClick",r="sending-has-been-triggered",c="sending-have-failed",u="delayed-sending-have-failed",l="changed-size-to-small",d="changed-size-to-large"},762:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n.d(t,"NOSCRIPT",(function(){return o})),n.d(t,"NONE",(function(){return s})),n.d(t,"REACT",(function(){return i}));var o="noscript",s="none",i="react"},769:function(e,t,n){"use strict";function o(e){e&&e.parentNode&&e.parentNode.removeChild(e)}t.a=o},770:function(e,t,n){"use strict";function o(e){for(var t=e&&e.parentNode;t;){if(t.tagName.toUpperCase()===a.h.toUpperCase())return t;t=t.parentNode}return null}function s(e){var t=e.getAttribute(l);if(!t){t=1e4*Object(u.a)(e)+Object(r.a)(e).length,e.setAttribute(l,t)}return t}function i(e,t){if(!e)return null;var n=Array.prototype.slice.call(e.getElementsByTagName(a.h)).filter((function(t){var n=o(t);return!n||n===e})).map((function(e){return{quote:e,weight:s(e)}})).sort((function(e,t){return e.weight-t.weight})),i=null;return n.length&&(i=n[n.length-1].quote,Object(c.a)(i,t)),i}t.a=i;var a=n(432),r=n(499),c=n(609),u=n(667),l="data-weight"},785:function(e,t,n){"use strict";var o=n(1260);n.d(t,"a",(function(){return o.a}));var s=(n(786),n(899));n.d(t,"b",(function(){return s.a}));var i=n(900);n.d(t,"c",(function(){return i.a}))},786:function(e,t,n){"use strict";function o(e){return a(e)||i(e)||s()}function s(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function i(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function a(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){u(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function d(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function h(e,t,n){return t&&d(e.prototype,t),n&&d(e,n),e}n.d(t,"a",(function(){return f}));var p=n(139),f=(n.n(p),(function(){function e(){l(this,e)}return h(e,[{key:"getPageAfterSent",value:function(){return Daria.isReactiveCompose()&&Daria.IS_CORP?"prev":Daria.is3pane()?"prev":ns.Model.get("settings").getSetting("page_after_send")}},{key:"whereToGoAfterSend",value:function(){var e,t=ns.Model.get("folders");switch(this.getPageAfterSent()){case"done":e=ns.router.generateUrl("done");break;case"sent_list":e=ns.router.generateUrl("messages",{current_folder:t.getFidBySymbol(p.WellKnownFolderSymbol.SENT)});break;case"current_list":e=ns.page.history.getPreviousPageUrl({match:"messages"});break;case"prev":e=ns.page.history.getPreviousPageUrl({mismatch:"compose2"})}if(!e){e=ns.router.generateUrl("messages",{current_folder:t.getFidBySymbol(p.WellKnownFolderSymbol.INBOX)})}return e}},{key:"showMessageSentNotification",value:function(e){var t=e.fromQR,n=e.sentMid,o=e.wasSendCancelled,s=e.withUndo,i=e.isDelayed,a=e.sendTime;if(o)return!1;var r={};if(s){var c=Daria.SendMail.getUndoSendLogger(n);r.onClose=function(){c.logClose()},r.onCancel=function(){c.logCancel()}}if(i)return Daria.SendMail.showMessageSentDelayed(n,a,r),!0;var u=!1;if(t)u=s;else{u=!("done"===this.getPageAfterSent())||s}return!!u&&(Daria.SendMail.showMessageSent(n,r),!0)}},{key:"sendMetrika",value:function(){Jane.Metrika.counter&&Jane.Metrika.counter.reachGoal("SEND")}},{key:"leaveCompose",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.clearPageBlock,o=t.neverReturn;n&&ns.page.block.clear();var s=this.pageGoUrl||ns.page.history.getPreviousPageUrl({mismatch:"compose2"})||ns.page.HOME_HASH,i=ns.router(s);i.page===ns.R.REDIRECT&&(i=ns.router(i.redirect)),i.params=_.omit(i.params,"_cuid");var a=_.delay((function(){Jane.ErrorLog.send({event:"after_send_wait_10_sec"})}),1e4),r=_.delay((function(){Jane.ErrorLog.send({event:"after_send_wait_20_sec"}),ns.page.go(ns.page.HOME_HASH)}),2e4),c=ns.router.generateUrl(i.page,i.params);return ns.page.go(c,o?"replace":null).fail((function(t){return e.handleLeaveComposeFail(c,t)})).always((function(e){return window.clearTimeout(a),window.clearTimeout(r),e}))}},{key:"handleLeaveComposeFail",value:function(e,t){var n=this,o=c({},t,{event:"compose_leave_failed",loadingHash:e});return Jane.ErrorLog.send(o),this.handleTransitionFail(t,(function(e,t){return ns.page.go(t).fail(n.handleTransitionFail)}),[ns.page.HOME_HASH])}},{key:"handleTransitionFail",value:function(e,t,n){if(t=t||Vow.reject,n=Array.isArray(n)?n:[],"expired"!==(e&&e.error)){var s=t.apply(null,[e].concat(o(n)));return s instanceof Vow.Promise?s:Vow.reject(s)}return Vow.resolve(e)}}]),e})())},787:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n.d(t,"NEW",(function(){return o})),n.d(t,"UPLOADING",(function(){return s})),n.d(t,"COMPLETED",(function(){return i})),n.d(t,"FAILED",(function(){return a})),n.d(t,"VIRUS",(function(){return r})),n.d(t,"ABORTED",(function(){return c})),n.d(t,"RESTRICTED",(function(){return u}));var o=0,s=1,i=2,a=3,r=4,c=5,u=6},788:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n.d(t,"FILE",(function(){return o})),n.d(t,"YADISK",(function(){return s})),n.d(t,"FORWARDED_MAIL",(function(){return i}));var o="simple",s="narod",i="forwarded"},789:function(e,t,n){"use strict";t.a=function(e,t){var n=t.handlerName,o=t.isOk,s=t.errorCode;Daria.monitoring.workflow.attachToDisk({params:{size:e&&e.size,checkLimit:!0},handler:n,status:o?"success":"error",errorCode:s})}},790:function(e,t,n){"use strict";t.a=function(e,t){e.upload&&e.upload.addEventListener("progress",(function(e,n){e&&e.lengthComputable&&(n=e.loaded/e.total*100),n=parseInt(n,10),n=isNaN(n)?-1:n,t(n)}),!1)}},791:function(e,t,n){"use strict";function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e){if(e.mid){var t=c(e);e.previewHref=Daria.url.attachment(t,e.mid,{no_disposition:!0}),e.previewSrc=Daria.url.attachment(t,e.mid,{no_disposition:!0,thumb:!0})}}function r(e){e.narodPreview&&(e.previewSrc=e.narodPreview,e.previewHref=e.narodUrl||e.narodPreview)}function c(e){return e.mid&&e.from_template?s({},e,{mid:e.template_mid,hid:e.template_hid}):e}t.a=function(e){a(e),r(e)}},801:function(e,t,n){"use strict";var o=this&&this.__assign||function(){return o=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++){t=arguments[n];for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s])}return e},o.apply(this,arguments)},s=this&&this.__rest||function(e,t){var n={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(n[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var s=0,o=Object.getOwnPropertySymbols(e);s<o.length;s++)t.indexOf(o[s])<0&&Object.prototype.propertyIsEnumerable.call(e,o[s])&&(n[o[s]]=e[o[s]]);return n},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Modal=void 0;var a=i(n(137)),r=i(n(350)),c=n(353),u=n(144);n(1313);var l=n(620),d={Block:"ComposeModal",Block_mobile:"ComposeModal_mobile",Block_tablet:"ComposeModal_tablet",Block_desktop:"ComposeModal_desktop",Block_fullscreen:"ComposeModal_fullscreen"};t.Modal=c.observer((function(e){var t,n=e.fullscreen,i=e.cls,c=e.className,h=s(e,["fullscreen","cls","className"]),p=l.useStores().services,f=r.default(i,c,d.Block,p.settings.isMobile?d.Block_mobile:d.Block_desktop,(t={},t[d.Block_fullscreen]=n,t[d.Block_tablet]=null===p||void 0===p?void 0:p.settings.isTablet,t));return a.default.createElement(u.Modal,o({className:f,theme:"normal"},h))})),t.default=t.Modal},899:function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function i(e,t,n){return t&&s(e.prototype,t),n&&s(e,n),e}n.d(t,"a",(function(){return r}));var a=n(139),r=(n.n(a),(function(){function e(){o(this,e)}return i(e,[{key:"updateDraftAfterAction",value:function(e,t){if(t){var n=ns.Model.get("message",{ids:t});if(!e){ns.Model.traverse("messages",(function(e){return e.remove(n)}));var o=n.getThreadMessage();o&&o.hasRealData()&&o.updateThreadCount(-1)}var s=function(e){return e.isValid()&&e.params.ids===t};ns.Model.invalidate("message",s),ns.Model.invalidate("message-body",s),this.updateFolders(a.DraftLikeFoldersShort)}}},{key:"updateFolders",value:function(e){var t=Array.isArray(e)?e:[e],n=ns.Model.get("folders");return t.forEach((function(e){var t=n.getFidBySymbol(e);Daria.messages.clearCacheByFID(t)})),ns.forcedRequest(["folders","labels"]).then((function(){ns.router.buildFoldersUrls()}))}},{key:"updateTemplateAfterAction",value:function(e){if(this.updateFolders(a.DraftTemplateLikeFoldersShort),e){var t=ns.Model.get("folders"),n=t.getFidBySymbol(a.WellKnownFolderSymbol.TEMPLATE);ns.Model.get("message",{ids:e}).setIfChanged(".fid",n);var o=function(t){return t.isValid()&&t.params.ids===e};ns.Model.invalidate("message",o),ns.Model.invalidate("message-body",o)}}},{key:"updateMessageFlagsAfterSend",value:function(e,t){var n=t.isForward,o=t.isReply,s=t.replyMessageId;if(e&&e.length){var i=function(t){return e.forEach((function(e){return t(ns.Model.get("message",{ids:e}))}))};n&&i((function(e){return e.markForwarded()})),o&&i((function(e){return e.markAnswered()})),ns.Model.invalidate("message-in-reply-to-ng",(function(e){return e.params.message_id===s}))}}},{key:"resetCheckedMessages",value:function(){if("message"!==ns.page.current.page){ns.Model.get("messages-checked").resetChecked(),ns.events.trigger("daria:vToolbarButton:restruct",{force:!0})}}}]),e})())},900:function(e,t,n){"use strict";function o(e){return Boolean(e.inreplyto)?{initial_to:e.to,initial_cc:e.cc}:{}}t.a=o},901:function(e,t,n){"use strict";t.a=function(e){return function(t){return e*(Math.sqrt(t)/(1+Math.sqrt(t)))}}},902:function(e,t,n){"use strict";function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e){return r(e)||c(e)||u(e)||{uploading:!0}}function r(e){var t=e.narodUrl,n=e.url;return t||n?{url:t||n}:null}function c(e){var t=e.mid,n=e.hid,o=e.bid;return t&&n?{mid:t,hid:n,bid:o}:null}function u(e){return e.from_template?{mid:e.template_mid,hid:e.template_hid}:null}function l(e,t){return t?{"preview-supported":!0,"preview-src":e.previewSrc||!1,"preview-href":e.previewHref||!1}:{}}function d(e,t){var n=e.narodUrl||e.url||t===h.COMPLETED&&Daria.url.attachment(e,e.mid,{no_disposition:!0});return n?{url:n}:{}}var h=n(787),p=n(679),f=n(788),m=n(138);n.n(m);t.a=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.status,o=t.previewSupported,i=e.id,r=e.name,c=e.folder,u=e.size,g=e.stid,b=e.message,_=e.type;if(_===f.FORWARDED_MAIL)return{id:i,name:r,icon:"eml",class:"mail"};var v=Daria.splitName(r),y={id:i,name:r,"name-uri-encoded":e["name-uri-encoded"],filename:v[0],fileext:v[1]?"."+v[1]:"",class:e.class,folder:c,"browser-supports":e["browser-supports"],length:u,status:n,errorCode:n===h.VIRUS?p.VIRUS:void 0,stid:g||void 0,icon:e.extension&&e.extension.icon||void 0,external_transformer:e.external_transformer,external_transformer_filetype:e.external_transformer?e.external_transformer_filetype:void 0,message:Boolean(b)||void 0,narod:_===f.YADISK||void 0},C=s({},Object(m.omit)(y,(function(e){return void 0===e})),{},a(e),{},l(e,o));return s({},C,{},d(C,n))}},903:function(e,t,n){"use strict";function o(e){return Object(s.escape)(e?e.name||e.fileName:i18n("%Без_темы"))}var s=n(138),i=(n.n(s),n(680)),a=n(369),r=n(791),c=n(1273);t.a=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};"mail"===e.class&&"eml"!==Daria.getExtension(Object(s.unescape)(e.name))&&(e.name+=".eml"),e.id=Object(i.a)(e),e.name=Object(s.unescape)(e.name||o(e.file)),e["name-uri-encoded"]=encodeURIComponent(e.name),e.extension=Daria.getExtensionInfo(e.name),e.class=e.class||e.extension.class;var t=Object(c.a)(e);return t&&Object(r.a)(e),{info:e,previewSupported:t,status:e.type?a.c.COMPLETED:a.c.NEW,progress:null}}},904:function(e,t){function n(e,t){for(var n=999,i=1,a=[];e&&n;)i>0?(e=s(e,a,t),i=-1):(e=o(e,a,t),i=1),n--;return a}function o(e,t,n){for(var o=!1,s=0;s<e.length;++s){var i=e[s];if(u(e,s)&&(o=!o),!o&&n[i]){var r=e.substring(0,s).trim();r&&t.push(r),e=a(e,0,s+1),s=-1}}return e&&(t.push(e.trim()),e=""),e}function s(e,t,n){for(var o=0;o<e.length;++o){if(">"===e.charAt(o)){var s=e.substring(0,o+1).trim();if(s&&l.test(s)){var r=[];s=i(s,t,n),r.length&&t.push.apply(t,r),t.push(s),e=a(e,0,o+1),o=-1}}}return e.trim()}function i(e,t,n){for(var o=!1,s=0;s<e.length;++s){var i=e[s];if(u(e,s)&&(o=!o),!o&&n[i]){var r=e.substring(0,s).trim();r&&!c(r,i)||(r&&t.push(r),e=a(e,0,s+1),s=-1)}}return e.trim()}function a(e,t,n){return e.substr(0,t)+(n>0?e.substr(n):"")}function r(e){return'"'===e[0]&&'"'===e[e.length-1]}function c(e,t){return(" "!==t||!r(e))&&Jane.FormValidation.checkEmail(e)}function u(e,t){return'"'===e[t]&&(0===t||"\\"!==e[t-1])}var l=/^(.*)<[^<>]*>$/,d={",":!0,";":!0," ":!0};e.exports=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:d;return function(t){return n(t,e)}},e.exports.SEPARATORS=d},908:function(e,t,n){"use strict";function o(e,t){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.children.length-1,o="",s=t;s<=n;)o+=e.children[s++].outerHTML;return o}function s(e){try{return(new DOMParser).parseFromString(e,"text/html").body}catch(n){var t=document.createElement("div");return t.innerHTML=e,t}}n.d(t,"b",(function(){return c})),n.d(t,"a",(function(){return p})),n.d(t,"c",(function(){return f}));var i=n(770),a=n(769),r=n(666),c=function(e){var t=e.messageBody,n=e.signatureMatches,o=void 0===n?[]:n,s=document.createElement("div");return s.innerHTML=t,{signature:u(s,o),forward:d(s),quotes:h(s)}},u=function(e,t){var n=Object(r.b)(e,t);return n?l(e,n):""},l=function(e,t){for(var n=t.start,o=t.finish,s=document.createElement("div"),i=o-n+1,a=0;a<i;a++)s.appendChild(e.childNodes[n]);return s.innerHTML},d=function(e){var t=Object(r.a)(e);return t?l(e,t):""},h=function(e){var t=document.createElement("div"),n=Object(i.a)(e,t);if(n){var o=document.createElement("div"),s=t.previousSibling;return s&&o.appendChild(s),o.appendChild(n),o.innerHTML}return""},p=function(e){var t=document.createElement("div");t.innerHTML=e;var n=document.createElement("div");if(Object(i.a)(t,n)){var o=n.previousSibling;Object(a.a)(o),Object(a.a)(n)}return Daria.Html2Text.html2text(t.innerHTML).trim().length},f=function(e){var t=e.messageBody,n=e.signatureMatches,i=void 0===n?[]:n,a=s(t),c=Object(r.b)(a,i);return c?{beforeSignature:o(a,0,c.start-1),signature:o(a,c.start,c.finish),afterSignature:o(a,c.finish+1)}:{beforeSignature:a.innerHTML.trim(),signature:"",afterSignature:""}}}});